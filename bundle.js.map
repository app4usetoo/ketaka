{
  "version": 3,
  "sources": [
    "..\\bibitana\\AppData\\Roaming\\npm\\node_modules\\ksana-cli\\node_modules\\browserify\\node_modules\\browser-pack\\_prelude.js",
    "node_modules/ksana-analyzer/configs.js",
    "node_modules/ksana-analyzer/index.js",
    "node_modules/ksana-analyzer/tokenizers.js",
    "node_modules/ksana-database/bsearch.js",
    "node_modules/ksana-database/index.js",
    "node_modules/ksana-database/kde.js",
    "node_modules/ksana-database/listkdb.js",
    "node_modules/ksana-database/platform.js",
    "node_modules/ksana-jsonrom/html5read.js",
    "node_modules/ksana-jsonrom/index.js",
    "node_modules/ksana-jsonrom/kdb.js",
    "node_modules/ksana-jsonrom/kdbfs.js",
    "node_modules/ksana-jsonrom/kdbfs_android.js",
    "node_modules/ksana-jsonrom/kdbfs_ios.js",
    "node_modules/ksana-search/boolsearch.js",
    "node_modules/ksana-search/bsearch.js",
    "node_modules/ksana-search/excerpt.js",
    "node_modules/ksana-search/index.js",
    "node_modules/ksana-search/plist.js",
    "node_modules/ksana-search/search.js",
    "node_modules/ksana2015-webruntime/checkbrowser.js",
    "node_modules/ksana2015-webruntime/downloader.js",
    "node_modules/ksana2015-webruntime/fileinstaller.js",
    "node_modules/ksana2015-webruntime/html5fs.js",
    "node_modules/ksana2015-webruntime/htmlfs.js",
    "node_modules/ksana2015-webruntime/index.js",
    "node_modules/ksana2015-webruntime/installkdb.js",
    "node_modules/ksana2015-webruntime/kfs.js",
    "node_modules/ksana2015-webruntime/kfs_html5.js",
    "node_modules/ksana2015-webruntime/ksanagap.js",
    "node_modules/ksana2015-webruntime/livereload.js",
    "node_modules/ksana2015-webruntime/liveupdate.js",
    "node_modules/ksana2015-webruntime/mkdirp.js",
    "workshop-ksana2015/index.js",
    "workshop-ksana2015/src/about.jsx",
    "workshop-ksana2015/src/buildindex.jsx",
    "workshop-ksana2015/src/caret.js",
    "workshop-ksana2015/src/contentnavigator.jsx",
    "workshop-ksana2015/src/contextmenu_classical.jsx",
    "workshop-ksana2015/src/contextmenu_tibetan.jsx",
    "workshop-ksana2015/src/cssgen.js",
    "workshop-ksana2015/src/devmenu.jsx",
    "workshop-ksana2015/src/docsurface.jsx",
    "workshop-ksana2015/src/document.js",
    "workshop-ksana2015/src/docview.jsx",
    "workshop-ksana2015/src/docview_tibetan.jsx",
    "workshop-ksana2015/src/element_comment_tibetan.jsx",
    "workshop-ksana2015/src/filelist.jsx",
    "workshop-ksana2015/src/imageview.jsx",
    "workshop-ksana2015/src/inlinedialog_accept_tibetan.jsx",
    "workshop-ksana2015/src/inlinedialog_applychange.jsx",
    "workshop-ksana2015/src/inlinedialog_comment_tibetan.jsx",
    "workshop-ksana2015/src/inlinedialog_makelink.jsx",
    "workshop-ksana2015/src/inlinedialog_suggest_tibetan.jsx",
    "workshop-ksana2015/src/legacy2014.js",
    "workshop-ksana2015/src/main.jsx",
    "workshop-ksana2015/src/mainmenu.jsx",
    "workshop-ksana2015/src/mainsearch.jsx",
    "workshop-ksana2015/src/markup.js",
    "workshop-ksana2015/src/nav_tibetan.jsx",
    "workshop-ksana2015/src/persistentmarkup_pouchdb.js",
    "workshop-ksana2015/src/project.js",
    "workshop-ksana2015/src/projectlist.jsx",
    "workshop-ksana2015/src/projectview.jsx",
    "workshop-ksana2015/src/queryinfo.jsx",
    "workshop-ksana2015/src/referenceview.jsx",
    "workshop-ksana2015/src/resultlist.jsx",
    "workshop-ksana2015/src/searchbox.jsx",
    "workshop-ksana2015/src/styles.js",
    "workshop-ksana2015/src/tabui.jsx",
    "workshop-ksana2015/src/userinfo.jsx",
    "workshop-ksana2015/src/userlogin.jsx",
    "workshop-ksana2015/src/usersignup.jsx"
  ],
  "names": [],
  "mappings": "AAAA;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACvDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACpCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACzJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AClCA;AACA;AACA;AACA;;ACHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC3aA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC5DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC1FA;AACA;AACA;AACA;;ACHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC3fA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC3TA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACjHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACnHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC7FA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACjCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACpcA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACrGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACxaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACnkBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC7EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC3GA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC1SA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACpNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AChHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AChEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACtCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACvDA;AACA;AACA;AACA;AACA;AACA;AACA;;ACNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC9EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACrBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC5JA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACpFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACxCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACrFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC1MA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACxGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACpDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACjDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACrDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACnEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACjaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACz3BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACvYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACvaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACtBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC7HA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC1CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACjEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACpHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACxDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC/BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC3FA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC1CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACpdA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC7CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC/JA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACjIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC9JA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC3HA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC5CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACvVA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC7PA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACnHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACfA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACtFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACzEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AChCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AClIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACzJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC/GA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA",
  "file": "generated.js",
  "sourceRoot": "",
  "sourcesContent": [
    "(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})",
    "var tokenizers=require('./tokenizers');\r\nvar normalizeTbl=null;\r\nvar setNormalizeTable=function(tbl,obj) {\r\n\tif (!obj) {\r\n\t\tobj={};\r\n\t\tfor (var i=0;i<tbl.length;i++) {\r\n\t\t\tvar arr=tbl[i].split(\"=\");\r\n\t\t\tobj[arr[0]]=arr[1];\r\n\t\t}\r\n\t}\r\n\tnormalizeTbl=obj;\r\n\treturn obj;\r\n}\r\nvar normalize1=function(token) {\r\n\tif (!token) return \"\";\r\n\ttoken=token.replace(/[ \\n\\.,，。！．「」：；、]/g,'').trim();\r\n\tif (!normalizeTbl) return token;\r\n\tif (token.length==1) {\r\n\t\treturn normalizeTbl[token] || token;\r\n\t} else {\r\n\t\tfor (var i=0;i<token.length;i++) {\r\n\t\t\ttoken[i]=normalizeTbl[token[i]] || token[i];\r\n\t\t}\r\n\t\treturn token;\r\n\t}\r\n}\r\nvar isSkip1=function(token) {\r\n\tvar t=token.trim();\r\n\treturn (t==\"\" || t==\"　\" || t==\"※\" || t==\"\\n\");\r\n}\r\nvar normalize_tibetan=function(token) {\r\n\treturn token.replace(/[།་ ]/g,'').trim();\r\n}\r\n\r\nvar isSkip_tibetan=function(token) {\r\n\tvar t=token.trim();\r\n\treturn (t==\"\" || t==\"　\" ||  t==\"\\n\");\t\r\n}\r\nvar simple1={\r\n\tfunc:{\r\n\t\ttokenize:tokenizers.simple\r\n\t\t,setNormalizeTable:setNormalizeTable\r\n\t\t,normalize: normalize1\r\n\t\t,isSkip:\tisSkip1\r\n\t}\r\n\t\r\n}\r\nvar tibetan1={\r\n\tfunc:{\r\n\t\ttokenize:tokenizers.tibetan\r\n\t\t,setNormalizeTable:setNormalizeTable\r\n\t\t,normalize:normalize_tibetan\r\n\t\t,isSkip:isSkip_tibetan\r\n\t}\r\n}\r\nmodule.exports={\"simple1\":simple1,\"tibetan1\":tibetan1}",
    "/* \r\n  custom func for building and searching ydb\r\n\r\n  keep all version\r\n  \r\n  getAPI(version); //return hash of functions , if ver is omit , return lastest\r\n\t\r\n  postings2Tree      // if version is not supply, get lastest\r\n  tokenize(text,api) // convert a string into tokens(depends on other api)\r\n  normalizeToken     // stemming and etc\r\n  isSpaceChar        // not a searchable token\r\n  isSkipChar         // 0 vpos\r\n\r\n  for client and server side\r\n  \r\n*/\r\nvar configs=require(\"./configs\");\r\nvar config_simple=\"simple1\";\r\nvar optimize=function(json,config) {\r\n\tconfig=config||config_simple;\r\n\treturn json;\r\n}\r\n\r\nvar getAPI=function(config) {\r\n\tconfig=config||config_simple;\r\n\tvar func=configs[config].func;\r\n\tfunc.optimize=optimize;\r\n\tif (config==\"simple1\") {\r\n\t\t//add common custom function here\r\n\t} else if (config==\"tibetan1\") {\r\n\r\n\t} else throw \"config \"+config +\"not supported\";\r\n\r\n\treturn func;\r\n}\r\n\r\nmodule.exports={getAPI:getAPI};",
    "var tibetan =function(s) {\r\n\t//continuous tsheg grouped into same token\r\n\t//shad and space grouped into same token\r\n\tvar offset=0;\r\n\tvar tokens=[],offsets=[];\r\n\ts=s.replace(/\\r\\n/g,'\\n').replace(/\\r/g,'\\n');\r\n\tvar arr=s.split('\\n');\r\n\r\n\tfor (var i=0;i<arr.length;i++) {\r\n\t\tvar last=0;\r\n\t\tvar str=arr[i];\r\n\t\tstr.replace(/[།་ ]+/g,function(m,m1){\r\n\t\t\ttokens.push(str.substring(last,m1)+m);\r\n\t\t\toffsets.push(offset+last);\r\n\t\t\tlast=m1+m.length;\r\n\t\t});\r\n\t\t\r\n\t\tif (last<str.length) {\r\n\t\t\ttokens.push(str.substring(offset));\r\n\t\t\toffsets.push(offset+last);\r\n\t\t}\r\n\t\tif (i===arr.length-1) break;\r\n\t\ttokens.push('\\n');\r\n\t\toffsets.push(offset+last);\r\n\t\toffset+=str.length+1;\r\n\t}\r\n\r\n\treturn {tokens:tokens,offsets:offsets};\r\n};\r\nvar isSpace=function(c) {\r\n\treturn (c==\" \") ;//|| (c==\",\") || (c==\".\");\r\n}\r\nvar isCJK =function(c) {return ((c>=0x3000 && c<=0x9FFF) \r\n|| (c>=0xD800 && c<0xDC00) || (c>=0xFF00) ) ;}\r\nvar simple1=function(s) {\r\n\tvar offset=0;\r\n\tvar tokens=[],offsets=[];\r\n\ts=s.replace(/\\r\\n/g,'\\n').replace(/\\r/g,'\\n');\r\n\tarr=s.split('\\n');\r\n\r\n\tvar pushtoken=function(t,off) {\r\n\t\tvar i=0;\r\n\t\tif (t.charCodeAt(0)>255) {\r\n\t\t\twhile (i<t.length) {\r\n\t\t\t\tvar c=t.charCodeAt(i);\r\n\t\t\t\toffsets.push(off+i);\r\n\t\t\t\ttokens.push(t[i]);\r\n\t\t\t\tif (c>=0xD800 && c<=0xDFFF) {\r\n\t\t\t\t\ttokens[tokens.length-1]+=t[i]; //extension B,C,D\r\n\t\t\t\t}\r\n\t\t\t\ti++;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\ttokens.push(t);\r\n\t\t\toffsets.push(off);\t\r\n\t\t}\r\n\t}\r\n\tfor (var i=0;i<arr.length;i++) {\r\n\t\tvar last=0,sp=\"\";\r\n\t\tstr=arr[i];\r\n\t\tstr.replace(/[_0-9A-Za-z]+/g,function(m,m1){\r\n\t\t\twhile (isSpace(sp=str[last]) && last<str.length) {\r\n\t\t\t\ttokens[tokens.length-1]+=sp;\r\n\t\t\t\tlast++;\r\n\t\t\t}\r\n\t\t\tpushtoken(str.substring(last,m1)+m , offset+last);\r\n\t\t\toffsets.push(offset+last);\r\n\t\t\tlast=m1+m.length;\r\n\t\t});\r\n\r\n\t\tif (last<str.length) {\r\n\t\t\twhile (isSpace(sp=str[last]) && last<str.length) {\r\n\t\t\t\ttokens[tokens.length-1]+=sp;\r\n\t\t\t\tlast++;\r\n\t\t\t}\r\n\t\t\tpushtoken(str.substring(last), offset+last);\r\n\t\t\t\r\n\t\t}\t\t\r\n\t\toffsets.push(offset+last);\r\n\t\toffset+=str.length+1;\r\n\t\tif (i===arr.length-1) break;\r\n\t\ttokens.push('\\n');\r\n\t}\r\n\r\n\treturn {tokens:tokens,offsets:offsets};\r\n\r\n};\r\n\r\nvar simple=function(s) {\r\n\tvar token='';\r\n\tvar tokens=[], offsets=[] ;\r\n\tvar i=0; \r\n\tvar lastspace=false;\r\n\tvar addtoken=function() {\r\n\t\tif (!token) return;\r\n\t\ttokens.push(token);\r\n\t\toffsets.push(i);\r\n\t\ttoken='';\r\n\t}\r\n\twhile (i<s.length) {\r\n\t\tvar c=s.charAt(i);\r\n\t\tvar code=s.charCodeAt(i);\r\n\t\tif (isCJK(code)) {\r\n\t\t\taddtoken();\r\n\t\t\ttoken=c;\r\n\t\t\tif (code>=0xD800 && code<0xDC00) { //high sorragate\r\n\t\t\t\ttoken+=s.charAt(i+1);i++;\r\n\t\t\t}\r\n\t\t\taddtoken();\r\n\t\t} else {\r\n\t\t\tif (c=='&' || c=='<' || c=='?' || c==\",\" || c==\".\"\r\n\t\t\t|| c=='|' || c=='~' || c=='`' || c==';' \r\n\t\t\t|| c=='>' || c==':' \r\n\t\t\t|| c=='=' || c=='@'  || c==\"-\" \r\n\t\t\t|| c==']' || c=='}'  || c==\")\" \r\n\t\t\t//|| c=='{' || c=='}'|| c=='[' || c==']' || c=='(' || c==')'\r\n\t\t\t|| code==0xf0b || code==0xf0d // tibetan space\r\n\t\t\t|| (code>=0x2000 && code<=0x206f)) {\r\n\t\t\t\taddtoken();\r\n\t\t\t\tif (c=='&' || c=='<'){ // || c=='{'|| c=='('|| c=='[') {\r\n\t\t\t\t\tvar endchar='>';\r\n\t\t\t\t\tif (c=='&') endchar=';'\r\n\t\t\t\t\t//else if (c=='{') endchar='}';\r\n\t\t\t\t\t//else if (c=='[') endchar=']';\r\n\t\t\t\t\t//else if (c=='(') endchar=')';\r\n\r\n\t\t\t\t\twhile (i<s.length && s.charAt(i)!=endchar) {\r\n\t\t\t\t\t\ttoken+=s.charAt(i);\r\n\t\t\t\t\t\ti++;\r\n\t\t\t\t\t}\r\n\t\t\t\t\ttoken+=endchar;\r\n\t\t\t\t\taddtoken();\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttoken=c;\r\n\t\t\t\t\taddtoken();\r\n\t\t\t\t}\r\n\t\t\t\ttoken='';\r\n\t\t\t} else {\r\n\t\t\t\tif (c==\" \") {\r\n\t\t\t\t\ttoken+=c;\r\n\t\t\t\t\tlastspace=true;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (lastspace) addtoken();\r\n\t\t\t\t\tlastspace=false;\r\n\t\t\t\t\ttoken+=c;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\ti++;\r\n\t}\r\n\taddtoken();\r\n\treturn {tokens:tokens,offsets:offsets};\r\n}\r\nmodule.exports={simple:simple,tibetan:tibetan};",
    "var indexOfSorted = function (array, obj, near) { \r\n  var low = 0,\r\n  high = array.length;\r\n  while (low < high) {\r\n    var mid = (low + high) >> 1;\r\n    if (array[mid]==obj) return mid;\r\n    array[mid] < obj ? low = mid + 1 : high = mid;\r\n  }\r\n  if (near) return low;\r\n  else if (array[low]==obj) return low;else return -1;\r\n};\r\nvar indexOfSorted_str = function (array, obj, near) { \r\n  var low = 0,\r\n  high = array.length;\r\n  while (low < high) {\r\n    var mid = (low + high) >> 1;\r\n    if (array[mid]==obj) return mid;\r\n    //(array[mid].localeCompare(obj)<0) ? low = mid + 1 : high = mid;\r\n    array[mid]<obj ? low=mid+1 : high=mid;\r\n  }\r\n  if (near) return low;\r\n  else if (array[low]==obj) return low;else return -1;\r\n};\r\n\r\n\r\nvar bsearch=function(array,value,near) {\r\n\tvar func=indexOfSorted;\r\n\tif (typeof array[0]==\"string\") func=indexOfSorted_str;\r\n\treturn func(array,value,near);\r\n}\r\nvar bsearchNear=function(array,value) {\r\n\treturn bsearch(array,value,true);\r\n}\r\n\r\nmodule.exports=bsearch;//{bsearchNear:bsearchNear,bsearch:bsearch};",
    "var KDE=require(\"./kde\");\r\n//currently only support node.js fs, ksanagap native fs, html5 file system\r\n//use socket.io to read kdb from remote server in future\r\nmodule.exports=KDE;",
    "/* Ksana Database Engine\r\n\r\n   2015/1/2 , \r\n   move to ksana-database\r\n   simplified by removing document support and socket.io support\r\n\r\n\r\n*/\r\nvar pool={},localPool={};\r\nvar apppath=\"\";\r\nvar bsearch=require(\"./bsearch\");\r\nvar Kdb=require('ksana-jsonrom');\r\nvar kdbs=[]; //available kdb , id and absolute path\r\nvar strsep=\"\\uffff\";\r\nvar kdblisted=false;\r\n/*\r\nvar _getSync=function(paths,opts) {\r\n\tvar out=[];\r\n\tfor (var i in paths) {\r\n\t\tout.push(this.getSync(paths[i],opts));\t\r\n\t}\r\n\treturn out;\r\n}\r\n*/\r\nvar _gets=function(paths,opts,cb) { //get many data with one call\r\n\r\n\tif (!paths) return ;\r\n\tif (typeof paths=='string') {\r\n\t\tpaths=[paths];\r\n\t}\r\n\tvar engine=this, output=[];\r\n\r\n\tvar makecb=function(path){\r\n\t\treturn function(data){\r\n\t\t\t\tif (!(data && typeof data =='object' && data.__empty)) output.push(data);\r\n\t\t\t\tengine.get(path,opts,taskqueue.shift());\r\n\t\t};\r\n\t};\r\n\r\n\tvar taskqueue=[];\r\n\tfor (var i=0;i<paths.length;i++) {\r\n\t\tif (typeof paths[i]==\"null\") { //this is only a place holder for key data already in client cache\r\n\t\t\toutput.push(null);\r\n\t\t} else {\r\n\t\t\ttaskqueue.push(makecb(paths[i]));\r\n\t\t}\r\n\t};\r\n\r\n\ttaskqueue.push(function(data){\r\n\t\toutput.push(data);\r\n\t\tcb.apply(engine.context||engine,[output,paths]); //return to caller\r\n\t});\r\n\r\n\ttaskqueue.shift()({__empty:true}); //run the task\r\n}\r\n\r\nvar getFileRange=function(i) {\r\n\tvar engine=this;\r\n\r\n\tvar filesegcount=engine.get([\"filesegcount\"]);\r\n\tif (filesegcount) {\r\n\t\tif (i==0) {\r\n\t\t\treturn {start:0,end:filesegcount[0]-1};\r\n\t\t} else {\r\n\t\t\treturn {start:filesegcount[i-1],end:filesegcount[i]-1};\r\n\t\t}\r\n\t}\r\n\t//old buggy code\r\n\tvar filenames=engine.get([\"filenames\"]);\r\n\tvar fileoffsets=engine.get([\"fileoffsets\"]);\r\n\tvar segoffsets=engine.get([\"segoffsets\"]);\r\n\tvar segnames=engine.get([\"segnames\"]);\r\n\tvar filestart=fileoffsets[i], fileend=fileoffsets[i+1]-1;\r\n\r\n\tvar start=bsearch(segoffsets,filestart,true);\r\n\t//if (segOffsets[start]==fileStart) start--;\r\n\t\r\n\t//work around for jiangkangyur\r\n\twhile (segNames[start+1]==\"_\") start++;\r\n\r\n  //if (i==0) start=0; //work around for first file\r\n\tvar end=bsearch(segoffsets,fileend,true);\r\n\treturn {start:start,end:end};\r\n}\r\n\r\nvar absSegToFileSeg=function(absoluteseg) {\r\n\tvar filesegcount=this.get(\"filesegcount\");\r\n\tvar s=absoluteseg;\r\n\tvar file=0;\r\n\twhile (s>filesegcount[file]) {\r\n\t\ts-=filesegcount[file];\r\n\t\tfile++;\r\n\t}\r\n\treturn {file:file,seg:s};\r\n}\r\n\r\nvar fileSegToAbsSeg=function(file,seg) {\r\n\tif (file==0)return seg;\r\n\treturn this.get(\"filesegcount\")[file]+(seg);\r\n}\r\n/*\r\nvar vposToFileSeg=function(engine,vpos) {\r\n    var segoffsets=engine.get(\"segoffsets\");\r\n    var fileoffsets=engine.get([\"fileoffsets\"]);\r\n    var segnames=engine.get(\"segnames\");\r\n    var fileid=bsearch(fileoffsets,vpos+1,true);\r\n    fileid--;\r\n    var segid=bsearch(segoffsets,vpos+1,true);\r\n\tvar range=engine.getFileRange(fileid);\r\n\tsegid-=range.start;\r\n    return {file:fileid,seg:segid};\r\n}\r\n*/\r\n//return array of object of nfile nseg given segname\r\nvar findSeg=function(segname) {\r\n\tvar segnames=this.get(\"segnames\");\r\n\tvar out=[];\r\n\tfor (var i=0;i<segnames.length;i++) {\r\n\t\tif (segnames[i]==segname) {\r\n\t\t\tvar fileseg=absSegToFileSeg.apply(this,[i]);\r\n\t\t\tout.push({file:fileseg.file,seg:fileseg.seg,absseg:i});\r\n\t\t}\r\n\t}\r\n\treturn out;\r\n}\r\nvar findFile=function(filename) {\r\n\tvar filenames=this.get(\"filenames\");\r\n\tfor (var i=0;i<filenames.length;i++) {\r\n\t\tif (filenames[i]===filename) return i;\r\n\t}\r\n\treturn -1;\r\n}\r\n\r\nvar getFileSegOffsets=function(i) {\r\n\tvar segoffsets=this.get(\"segoffsets\");\r\n\tvar range=getFileRange.apply(this,[i]);\r\n\tif (segoffsets.subarray) {\r\n\t\treturn segoffsets.subarray(range.start,range.end+1);\r\n\t} else {\r\n\t\treturn segoffsets.slice(range.start,range.end+1);\t\r\n\t}\r\n\t\r\n\r\n}\r\nvar absSegFromVpos=function(vpos) { \r\n\tvar segoffsets=this.get([\"segoffsets\"]);\r\n\tvar i=bsearch(segoffsets,vpos,true);\r\n\twhile (segoffsets[i]==vpos) i++;\r\n\treturn i;\r\n}\r\n\r\nvar fileSegFromVpos=function(vpos) { \r\n\tvar seg=absSegFromVpos.call(this,vpos);\r\n\treturn absSegToFileSeg.call(this,seg);\r\n}\r\nvar fileSegToVpos=function(f,s) {\r\n\tvar segoffsets=this.get([\"segoffsets\"]);\r\n\tvar seg=fileSegToAbsSeg(f,s);\r\n\treturn segoffsets[seg-1];\r\n}\r\n\r\nvar getFileSegNames=function(i) {\r\n\tvar range=getFileRange.apply(this,[i]);\r\n\tvar segnames=this.get(\"segnames\");\r\n\treturn segnames.slice(range.start,range.end+1);\r\n}\r\nvar localengine_get=function(path,opts,cb,context) {\r\n\tvar engine=this;\r\n\tif (typeof opts==\"function\") {\r\n\t\tcontext=cb;\r\n\t\tcb=opts;\r\n\t\topts={recursive:false};\r\n\t}\r\n\tif (!path) {\r\n\t\tif (cb) cb.apply(context,[null]);\r\n\t\treturn null;\r\n\t}\r\n\r\n\tif (typeof cb!=\"function\") {\r\n\t\treturn engine.kdb.get(path,opts);\r\n\t}\r\n\r\n\tif (typeof path==\"string\") {\r\n\t\treturn engine.kdb.get([path],opts,cb,context);\r\n\t} else if (typeof path[0] ==\"string\") {\r\n\t\treturn engine.kdb.get(path,opts,cb,context);\r\n\t} else if (typeof path[0] ==\"object\") {\r\n\t\treturn _gets.apply(engine,[path,opts,cb,context]);\r\n\t} else {\r\n\t\tengine.kdb.get([],opts,function(data){\r\n\t\t\tcb.apply(context,[data]);//return top level keys\r\n\t\t},context);\r\n\t}\r\n};\t\r\n\r\nvar getPreloadField=function(user) {\r\n\tvar preload=[[\"meta\"],[\"filenames\"],[\"fileoffsets\"],[\"segnames\"],[\"segoffsets\"],[\"filesegcount\"]];\r\n\t//[\"tokens\"],[\"postingslen\"] kse will load it\r\n\tif (user && user.length) { //user supply preload\r\n\t\tfor (var i=0;i<user.length;i++) {\r\n\t\t\tif (preload.indexOf(user[i])==-1) {\r\n\t\t\t\tpreload.push(user[i]);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn preload;\r\n}\r\nvar createLocalEngine=function(kdb,opts,cb,context) {\r\n\tvar engine={kdb:kdb, queryCache:{}, postingCache:{}, cache:{}};\r\n\r\n\tif (typeof context==\"object\") engine.context=context;\r\n\tengine.get=localengine_get;\r\n\r\n\tengine.segOffset=segOffset;\r\n\tengine.fileOffset=fileOffset;\r\n\tengine.folderOffset=folderOffset;\r\n\tengine.getFileSegNames=getFileSegNames;\r\n\tengine.getFileSegOffsets=getFileSegOffsets;\r\n\tengine.getFileRange=getFileRange;\r\n\tengine.findSeg=findSeg;\r\n\tengine.findFile=findFile;\r\n\tengine.absSegToFileSeg=absSegToFileSeg;\r\n\tengine.fileSegToAbsSeg=fileSegToAbsSeg;\r\n\tengine.fileSegFromVpos=fileSegFromVpos;\r\n\tengine.absSegFromVpos=absSegFromVpos;\r\n\tengine.fileSegToVpos=fileSegToVpos;\r\n\t\r\n\t//engine.fileSegToVpos=fileSegToVpos;\r\n\t//engine.vposToFileSeg=vposToFileSeg;\r\n\t//only local engine allow getSync\r\n\t//if (kdb.fs.getSync) engine.getSync=engine.kdb.getSync;\r\n\t\r\n\t//speedy native functions\r\n\tif (kdb.fs.mergePostings) {\r\n\t\tengine.mergePostings=kdb.fs.mergePostings.bind(kdb.fs);\r\n\t}\r\n\t\r\n\tvar setPreload=function(res) {\r\n\t\tengine.dbname=res[0].name;\r\n\t\t//engine.customfunc=customfunc.getAPI(res[0].config);\r\n\t\tengine.ready=true;\r\n\t}\r\n\r\n\tvar preload=getPreloadField(opts.preload);\r\n\tvar opts={recursive:true};\r\n\t//if (typeof cb==\"function\") {\r\n\t\t_gets.apply(engine,[ preload, opts,function(res){\r\n\t\t\tsetPreload(res);\r\n\t\t\tcb.apply(engine.context,[engine]);\r\n\t\t}]);\r\n\t//} else {\r\n\t//\tsetPreload(_getSync.apply(engine,[preload,opts]));\r\n\t//}\r\n\treturn engine;\r\n}\r\n\r\nvar segOffset=function(segname) {\r\n\tvar engine=this;\r\n\tif (arguments.length>1) throw \"argument : segname \";\r\n\r\n\tvar segNames=engine.get(\"segnames\");\r\n\tvar segOffsets=engine.get(\"segoffsets\");\r\n\r\n\tvar i=segNames.indexOf(segname);\r\n\treturn (i>-1)?segOffsets[i]:0;\r\n}\r\nvar fileOffset=function(fn) {\r\n\tvar engine=this;\r\n\tvar filenames=engine.get(\"filenames\");\r\n\tvar offsets=engine.get(\"fileoffsets\");\r\n\tvar i=filenames.indexOf(fn);\r\n\tif (i==-1) return null;\r\n\treturn {start: offsets[i], end:offsets[i+1]};\r\n}\r\n\r\nvar folderOffset=function(folder) {\r\n\tvar engine=this;\r\n\tvar start=0,end=0;\r\n\tvar filenames=engine.get(\"filenames\");\r\n\tvar offsets=engine.get(\"fileoffsets\");\r\n\tfor (var i=0;i<filenames.length;i++) {\r\n\t\tif (filenames[i].substring(0,folder.length)==folder) {\r\n\t\t\tif (!start) start=offsets[i];\r\n\t\t\tend=offsets[i];\r\n\t\t} else if (start) break;\r\n\t}\r\n\treturn {start:start,end:end};\r\n}\r\n\r\n //TODO delete directly from kdb instance\r\n //kdb.free();\r\nvar closeLocal=function(kdbid) {\r\n\tvar engine=localPool[kdbid];\r\n\tif (engine) {\r\n\t\tengine.kdb.free();\r\n\t\tdelete localPool[kdbid];\r\n\t}\r\n}\r\nvar close=function(kdbid) {\r\n\tvar engine=pool[kdbid];\r\n\tif (engine) {\r\n\t\tengine.kdb.free();\r\n\t\tdelete pool[kdbid];\r\n\t}\r\n}\r\n\r\nvar getLocalTries=function(kdbfn) {\r\n\tif (!kdblisted) {\r\n\t\tkdbs=require(\"./listkdb\")();\r\n\t\tkdblisted=true;\r\n\t}\r\n\r\n\tvar kdbid=kdbfn.replace('.kdb','');\r\n\tvar tries= [\"./\"+kdbid+\".kdb\"\r\n\t           ,\"../\"+kdbid+\".kdb\"\r\n\t];\r\n\r\n\tfor (var i=0;i<kdbs.length;i++) {\r\n\t\tif (kdbs[i][0]==kdbid) {\r\n\t\t\ttries.push(kdbs[i][1]);\r\n\t\t}\r\n\t}\r\n\treturn tries;\r\n}\r\nvar openLocalKsanagap=function(kdbid,opts,cb,context) {\r\n\tvar kdbfn=kdbid;\r\n\tvar tries=getLocalTries(kdbfn);\r\n\r\n\tfor (var i=0;i<tries.length;i++) {\r\n\t\tif (fs.existsSync(tries[i])) {\r\n\t\t\t//console.log(\"kdb path: \"+nodeRequire('path').resolve(tries[i]));\r\n\t\t\tvar kdb=new Kdb.open(tries[i],function(err,kdb){\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\tcb.apply(context,[err]);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tcreateLocalEngine(kdb,opts,function(engine){\r\n\t\t\t\t\t\tlocalPool[kdbid]=engine;\r\n\t\t\t\t\t\tcb.apply(context||engine.context,[0,engine]);\r\n\t\t\t\t\t},context);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\tif (cb) cb.apply(context,[kdbid+\" not found\"]);\r\n\treturn null;\r\n\r\n}\r\nvar openLocalNode=function(kdbid,opts,cb,context) {\r\n\tvar fs=require('fs');\r\n\tvar tries=getLocalTries(kdbid);\r\n\r\n\tfor (var i=0;i<tries.length;i++) {\r\n\t\tif (fs.existsSync(tries[i])) {\r\n\r\n\t\t\tnew Kdb.open(tries[i],function(err,kdb){\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\tcb.apply(context||engine.content,[err]);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tcreateLocalEngine(kdb,opts,function(engine){\r\n\t\t\t\t\t\t\tlocalPool[kdbid]=engine;\r\n\t\t\t\t\t\t\tcb.apply(context||engine.context,[0,engine]);\r\n\t\t\t\t\t},context);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\tif (cb) cb.apply(context,[kdbid+\" not found\"]);\r\n\treturn null;\r\n}\r\n\r\nvar openLocalHtml5=function(kdbid,opts,cb,context) {\t\r\n\tvar engine=localPool[kdbid];\r\n\tvar kdbfn=kdbid;\r\n\tif (kdbfn.indexOf(\".kdb\")==-1) kdbfn+=\".kdb\";\r\n\tnew Kdb.open(kdbfn,function(err,handle){\r\n\t\tif (err) {\r\n\t\t\tcb.apply(context,[err]);\r\n\t\t} else {\r\n\t\t\tcreateLocalEngine(handle,opts,function(engine){\r\n\t\t\t\tlocalPool[kdbid]=engine;\r\n\t\t\t\tcb.apply(context||engine.context,[0,engine]);\r\n\t\t\t},context);\r\n\t\t}\r\n\t});\r\n}\r\n//omit cb for syncronize open\r\nvar openLocal=function(kdbid,opts,cb,context)  {\r\n\tif (typeof opts==\"function\") { //no opts\r\n\t\tif (typeof cb==\"object\") context=cb;\r\n\t\tcb=opts;\r\n\t\topts={};\r\n\t}\r\n\r\n\tvar engine=localPool[kdbid];\r\n\tif (engine) {\r\n\t\tif (cb) cb.apply(context||engine.context,[0,engine]);\r\n\t\treturn engine;\r\n\t}\r\n\r\n\tvar platform=require(\"./platform\").getPlatform();\r\n\tif (platform==\"node-webkit\" || platform==\"node\") {\r\n\t\topenLocalNode(kdbid,opts,cb,context);\r\n\t} else if (platform==\"html5\" || platform==\"chrome\"){\r\n\t\topenLocalHtml5(kdbid,opts,cb,context);\t\t\r\n\t} else {\r\n\t\topenLocalKsanagap(kdbid,opts,cb,context);\t\r\n\t}\r\n}\r\nvar setPath=function(path) {\r\n\tapppath=path;\r\n\tconsole.log(\"set path\",path)\r\n}\r\n\r\nvar enumKdb=function(cb,context){\r\n\t/*if (kdbs.length) return kdbs.map(function(k){return k[0]});*/\r\n\t//close because project tab will disapear after first time\r\n\t/*if (!kdblisted) {*/\r\n\t\trequire(\"./listkdb\")(function(files){\r\n\t\t\tkdbs=files;\r\n\t\t\tcb.call(context, kdbs.map(function(k){return k[0]}) );\r\n\t\t});\r\n\t\tkdblisted=true;\r\n\t/*}*/\r\n}\r\n\r\nmodule.exports={open:openLocal,setPath:setPath, close:closeLocal, enumKdb:enumKdb, bsearch:bsearch};",
    "/* return array of dbid and absolute path*/\r\nvar listkdb_html5=function(cb,context) {\r\n\trequire(\"ksana2015-webruntime\").html5fs.readdir(function(kdbs){\r\n\t\t\tcb.apply(this,[kdbs]);\r\n\t},context||this);\t\t\r\n}\r\n\r\nvar listkdb_node=function(){\r\n\tvar fs=require(\"fs\");\r\n\tvar path=require(\"path\")\r\n\tvar parent=path.resolve(process.cwd(),\"..\");\r\n\tvar files=fs.readdirSync(parent);\r\n\tvar output=[];\r\n\tfiles.map(function(f){\r\n\t\tvar subdir=parent+path.sep+f;\r\n\t\tvar stat=fs.statSync(subdir );\r\n\t\tif (stat.isDirectory()) {\r\n\t\t\tvar subfiles=fs.readdirSync(subdir);\r\n\t\t\tfor (var i=0;i<subfiles.length;i++) {\r\n\t\t\t\tvar file=subfiles[i];\r\n\t\t\t\tvar idx=file.indexOf(\".kdb\");\r\n\t\t\t\tif (idx>-1&&idx==file.length-4) {\r\n\t\t\t\t\toutput.push([ file.substr(0,file.length-4), subdir+path.sep+file]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t})\r\n\treturn output;\r\n}\r\nvar fileNameOnly=function(fn) {\r\n\tvar at=fn.lastIndexOf(\"/\");\r\n\tif (at>-1) return fn.substr(at+1);\r\n\treturn fn;\r\n}\r\nvar listkdb_ksanagap=function() {\r\n\tvar output=[];\r\n\tvar apps=JSON.parse(kfs.listApps());\r\n\tfor (var i=0;i<apps.length;i++) {\r\n\t\tvar app=apps[i];\r\n\t\tif (app.files) for (var j=0;j<app.files.length;j++) {\r\n\t\t\tvar file=app.files[j];\r\n\t\t\tif (file.substr(file.length-4)==\".kdb\") {\r\n\t\t\t\toutput.push([app.dbid,fileNameOnly(file)]);\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\treturn output;\r\n}\r\nvar listkdb=function(cb,context) {\r\n\tvar platform=require(\"./platform\").getPlatform();\r\n\tvar files=[];\r\n\tif (platform==\"node\" || platform==\"node-webkit\") {\r\n\t\tfiles=listkdb_node();\r\n\t} else if (platform==\"chrome\") {\r\n\t\tfiles=listkdb_html5(cb,context);\r\n\t} else {\r\n\t\tfiles=listkdb_ksanagap();\r\n\t}\r\n\treturn files;\r\n}\r\nmodule.exports=listkdb;",
    "var getPlatform=function() {\r\n\tif (typeof ksanagap==\"undefined\") {\r\n\t\tplatform=\"node\";\r\n\t} else {\r\n\t\tplatform=ksanagap.platform;\r\n\t}\r\n\treturn platform;\r\n}\r\nmodule.exports={getPlatform:getPlatform};",
    "\r\n/* emulate filesystem on html5 browser */\r\n/* emulate filesystem on html5 browser */\r\nvar read=function(handle,buffer,offset,length,position,cb) {//buffer and offset is not used\r\n\tvar xhr = new XMLHttpRequest();\r\n\txhr.open('GET', handle.url , true);\r\n\tvar range=[position,length+position-1];\r\n\txhr.setRequestHeader('Range', 'bytes='+range[0]+'-'+range[1]);\r\n\txhr.responseType = 'arraybuffer';\r\n\txhr.send();\r\n\txhr.onload = function(e) {\r\n\t\tvar that=this;\r\n\t\tsetTimeout(function(){\r\n\t\t\tcb(0,that.response.byteLength,that.response);\r\n\t\t},0);\r\n\t}; \r\n}\r\nvar close=function(handle) {}\r\nvar fstatSync=function(handle) {\r\n\tthrow \"not implement yet\";\r\n}\r\nvar fstat=function(handle,cb) {\r\n\tthrow \"not implement yet\";\r\n}\r\nvar _open=function(fn_url,cb) {\r\n\t\tvar handle={};\r\n\t\tif (fn_url.indexOf(\"filesystem:\")==0){\r\n\t\t\thandle.url=fn_url;\r\n\t\t\thandle.fn=fn_url.substr( fn_url.lastIndexOf(\"/\")+1);\r\n\t\t} else {\r\n\t\t\thandle.fn=fn_url;\r\n\t\t\tvar url=API.files.filter(function(f){ return (f[0]==fn_url)});\r\n\t\t\tif (url.length) handle.url=url[0][1];\r\n\t\t\telse cb(null);\r\n\t\t}\r\n\t\tcb(handle);\r\n}\r\nvar open=function(fn_url,cb) {\r\n\t\tif (!API.initialized) {init(1024*1024,function(){\r\n\t\t\t_open.apply(this,[fn_url,cb]);\r\n\t\t},this)} else _open.apply(this,[fn_url,cb]);\r\n}\r\nvar load=function(filename,mode,cb) {\r\n\topen(filename,mode,cb,true);\r\n}\r\nfunction errorHandler(e) {\r\n\tconsole.error('Error: ' +e.name+ \" \"+e.message);\r\n}\r\nvar readdir=function(cb,context) {\r\n\t var dirReader = API.fs.root.createReader();\r\n\t var out=[],that=this;\r\n\t\tdirReader.readEntries(function(entries) {\r\n\t\t\tif (entries.length) {\r\n\t\t\t\tfor (var i = 0, entry; entry = entries[i]; ++i) {\r\n\t\t\t\t\tif (entry.isFile) {\r\n\t\t\t\t\t\tout.push([entry.name,entry.toURL ? entry.toURL() : entry.toURI()]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tAPI.files=out;\r\n\t\t\tif (cb) cb.apply(context,[out]);\r\n\t\t}, function(){\r\n\t\t\tif (cb) cb.apply(context,[null]);\r\n\t\t});\r\n}\r\nvar initfs=function(grantedBytes,cb,context) {\r\n\twebkitRequestFileSystem(PERSISTENT, grantedBytes,  function(fs) {\r\n\t\tAPI.fs=fs;\r\n\t\tAPI.quota=grantedBytes;\r\n\t\treaddir(function(){\r\n\t\t\tAPI.initialized=true;\r\n\t\t\tcb.apply(context,[grantedBytes,fs]);\r\n\t\t},context);\r\n\t}, errorHandler);\r\n}\r\nvar init=function(quota,cb,context) {\r\n\tnavigator.webkitPersistentStorage.requestQuota(quota, \r\n\t\t\tfunction(grantedBytes) {\r\n\t\t\t\tinitfs(grantedBytes,cb,context);\r\n\t\t}, errorHandler \r\n\t);\r\n}\r\nvar API={\r\n\tread:read\r\n\t,readdir:readdir\r\n\t,open:open\r\n\t,close:close\r\n\t,fstatSync:fstatSync\r\n\t,fstat:fstat\r\n}\r\nmodule.exports=API;",
    "module.exports={\r\n\topen:require(\"./kdb\")\r\n}\r\n",
    "/*\r\n\tKDB version 3.0 GPL\r\n\tyapcheahshen@gmail.com\r\n\t2013/12/28\r\n\tasyncronize version of yadb\r\n\r\n  remove dependency of Q, thanks to\r\n  http://stackoverflow.com/questions/4234619/how-to-avoid-long-nesting-of-asynchronous-functions-in-node-js\r\n\r\n  2015/1/2\r\n  moved to ksanaforge/ksana-jsonrom\r\n  add err in callback for node.js compliant\r\n*/\r\nvar Kfs=null;\r\n\r\nif (typeof ksanagap==\"undefined\") {\r\n\tKfs=require('./kdbfs');\t\t\t\r\n} else {\r\n\tif (ksanagap.platform==\"ios\") {\r\n\t\tKfs=require(\"./kdbfs_ios\");\r\n\t} else if (ksanagap.platform==\"node-webkit\") {\r\n\t\tKfs=require(\"./kdbfs\");\r\n\t} else if (ksanagap.platform==\"chrome\") {\r\n\t\tKfs=require(\"./kdbfs\");\r\n\t} else {\r\n\t\tKfs=require(\"./kdbfs_android\");\r\n\t}\r\n\t\t\r\n}\r\n\r\n\r\nvar DT={\r\n\tuint8:'1', //unsigned 1 byte integer\r\n\tint32:'4', // signed 4 bytes integer\r\n\tutf8:'8',  \r\n\tucs2:'2',\r\n\tbool:'^', \r\n\tblob:'&',\r\n\tutf8arr:'*', //shift of 8\r\n\tucs2arr:'@', //shift of 2\r\n\tuint8arr:'!', //shift of 1\r\n\tint32arr:'$', //shift of 4\r\n\tvint:'`',\r\n\tpint:'~',\t\r\n\r\n\tarray:'\\u001b',\r\n\tobject:'\\u001a' \r\n\t//ydb start with object signature,\r\n\t//type a ydb in command prompt shows nothing\r\n}\r\nvar verbose=0, readLog=function(){};\r\nvar _readLog=function(readtype,bytes) {\r\n\tconsole.log(readtype,bytes,\"bytes\");\r\n}\r\nif (verbose) readLog=_readLog;\r\nvar strsep=\"\\uffff\";\r\nvar Create=function(path,opts,cb) {\r\n\t/* loadxxx functions move file pointer */\r\n\t// load variable length int\r\n\tif (typeof opts==\"function\") {\r\n\t\tcb=opts;\r\n\t\topts={};\r\n\t}\r\n\r\n\t\r\n\tvar loadVInt =function(opts,blocksize,count,cb) {\r\n\t\t//if (count==0) return [];\r\n\t\tvar that=this;\r\n\r\n\t\tthis.fs.readBuf_packedint(opts.cur,blocksize,count,true,function(o){\r\n\t\t\t//console.log(\"vint\");\r\n\t\t\topts.cur+=o.adv;\r\n\t\t\tcb.apply(that,[o.data]);\r\n\t\t});\r\n\t}\r\n\tvar loadVInt1=function(opts,cb) {\r\n\t\tvar that=this;\r\n\t\tloadVInt.apply(this,[opts,6,1,function(data){\r\n\t\t\t//console.log(\"vint1\");\r\n\t\t\tcb.apply(that,[data[0]]);\r\n\t\t}])\r\n\t}\r\n\t//for postings\r\n\tvar loadPInt =function(opts,blocksize,count,cb) {\r\n\t\tvar that=this;\r\n\t\tthis.fs.readBuf_packedint(opts.cur,blocksize,count,false,function(o){\r\n\t\t\t//console.log(\"pint\");\r\n\t\t\topts.cur+=o.adv;\r\n\t\t\tcb.apply(that,[o.data]);\r\n\t\t});\r\n\t}\r\n\t// item can be any type (variable length)\r\n\t// maximum size of array is 1TB 2^40\r\n\t// structure:\r\n\t// signature,5 bytes offset, payload, itemlengths\r\n\tvar getArrayLength=function(opts,cb) {\r\n\t\tvar that=this;\r\n\t\tvar dataoffset=0;\r\n\r\n\t\tthis.fs.readUI8(opts.cur,function(len){\r\n\t\t\tvar lengthoffset=len*4294967296;\r\n\t\t\topts.cur++;\r\n\t\t\tthat.fs.readUI32(opts.cur,function(len){\r\n\t\t\t\topts.cur+=4;\r\n\t\t\t\tdataoffset=opts.cur; //keep this\r\n\t\t\t\tlengthoffset+=len;\r\n\t\t\t\topts.cur+=lengthoffset;\r\n\r\n\t\t\t\tloadVInt1.apply(that,[opts,function(count){\r\n\t\t\t\t\tloadVInt.apply(that,[opts,count*6,count,function(sz){\t\t\t\t\t\t\r\n\t\t\t\t\t\tcb({count:count,sz:sz,offset:dataoffset});\r\n\t\t\t\t\t}]);\r\n\t\t\t\t}]);\r\n\t\t\t\t\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tvar loadArray = function(opts,blocksize,cb) {\r\n\t\tvar that=this;\r\n\t\tgetArrayLength.apply(this,[opts,function(L){\r\n\t\t\t\tvar o=[];\r\n\t\t\t\tvar endcur=opts.cur;\r\n\t\t\t\topts.cur=L.offset;\r\n\r\n\t\t\t\tif (opts.lazy) { \r\n\t\t\t\t\t\tvar offset=L.offset;\r\n\t\t\t\t\t\tfor (var i=0;i<L.sz.length;i++) {\r\n\t\t\t\t\t\t\tvar sz=L.sz[i];\r\n\t\t\t\t\t\t\to[o.length]=strsep+offset.toString(16)\r\n\t\t\t\t\t\t\t\t   +strsep+sz.toString(16);\r\n\t\t\t\t\t\t\toffset+=sz;\r\n\t\t\t\t\t\t};\r\n\t\t\t\t} else {\r\n\t\t\t\t\tvar taskqueue=[];\r\n\t\t\t\t\tfor (var i=0;i<L.count;i++) {\r\n\t\t\t\t\t\ttaskqueue.push(\r\n\t\t\t\t\t\t\t(function(sz){\r\n\t\t\t\t\t\t\t\treturn (\r\n\t\t\t\t\t\t\t\t\tfunction(data){\r\n\t\t\t\t\t\t\t\t\t\tif (typeof data=='object' && data.__empty) {\r\n\t\t\t\t\t\t\t\t\t\t\t //not pushing the first call\r\n\t\t\t\t\t\t\t\t\t\t}\telse o.push(data);\r\n\t\t\t\t\t\t\t\t\t\topts.blocksize=sz;\r\n\t\t\t\t\t\t\t\t\t\tload.apply(that,[opts, taskqueue.shift()]);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t})(L.sz[i])\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//last call to child load\r\n\t\t\t\t\ttaskqueue.push(function(data){\r\n\t\t\t\t\t\to.push(data);\r\n\t\t\t\t\t\topts.cur=endcur;\r\n\t\t\t\t\t\tcb.apply(that,[o]);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (opts.lazy) cb.apply(that,[o]);\r\n\t\t\t\telse {\r\n\t\t\t\t\ttaskqueue.shift()({__empty:true});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t])\r\n\t}\t\t\r\n\t// item can be any type (variable length)\r\n\t// support lazy load\r\n\t// structure:\r\n\t// signature,5 bytes offset, payload, itemlengths, \r\n\t//                    stringarray_signature, keys\r\n\tvar loadObject = function(opts,blocksize,cb) {\r\n\t\tvar that=this;\r\n\t\tvar start=opts.cur;\r\n\t\tgetArrayLength.apply(this,[opts,function(L) {\r\n\t\t\topts.blocksize=blocksize-opts.cur+start;\r\n\t\t\tload.apply(that,[opts,function(keys){ //load the keys\r\n\t\t\t\tif (opts.keys) { //caller ask for keys\r\n\t\t\t\t\tkeys.map(function(k) { opts.keys.push(k)});\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar o={};\r\n\t\t\t\tvar endcur=opts.cur;\r\n\t\t\t\topts.cur=L.offset;\r\n\t\t\t\tif (opts.lazy) { \r\n\t\t\t\t\tvar offset=L.offset;\r\n\t\t\t\t\tfor (var i=0;i<L.sz.length;i++) {\r\n\t\t\t\t\t\t//prefix with a \\0, impossible for normal string\r\n\t\t\t\t\t\to[keys[i]]=strsep+offset.toString(16)\r\n\t\t\t\t\t\t\t   +strsep+L.sz[i].toString(16);\r\n\t\t\t\t\t\toffset+=L.sz[i];\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tvar taskqueue=[];\r\n\t\t\t\t\tfor (var i=0;i<L.count;i++) {\r\n\t\t\t\t\t\ttaskqueue.push(\r\n\t\t\t\t\t\t\t(function(sz,key){\r\n\t\t\t\t\t\t\t\treturn (\r\n\t\t\t\t\t\t\t\t\tfunction(data){\r\n\t\t\t\t\t\t\t\t\t\tif (typeof data=='object' && data.__empty) {\r\n\t\t\t\t\t\t\t\t\t\t\t//not saving the first call;\r\n\t\t\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t\t\to[key]=data; \r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\topts.blocksize=sz;\r\n\t\t\t\t\t\t\t\t\t\tif (verbose) readLog(\"key\",key);\r\n\t\t\t\t\t\t\t\t\t\tload.apply(that,[opts, taskqueue.shift()]);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t})(L.sz[i],keys[i-1])\r\n\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//last call to child load\r\n\t\t\t\t\ttaskqueue.push(function(data){\r\n\t\t\t\t\t\to[keys[keys.length-1]]=data;\r\n\t\t\t\t\t\topts.cur=endcur;\r\n\t\t\t\t\t\tcb.apply(that,[o]);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\tif (opts.lazy) cb.apply(that,[o]);\r\n\t\t\t\telse {\r\n\t\t\t\t\ttaskqueue.shift()({__empty:true});\r\n\t\t\t\t}\r\n\t\t\t}]);\r\n\t\t}]);\r\n\t}\r\n\r\n\t//item is same known type\r\n\tvar loadStringArray=function(opts,blocksize,encoding,cb) {\r\n\t\tvar that=this;\r\n\t\tthis.fs.readStringArray(opts.cur,blocksize,encoding,function(o){\r\n\t\t\topts.cur+=blocksize;\r\n\t\t\tcb.apply(that,[o]);\r\n\t\t});\r\n\t}\r\n\tvar loadIntegerArray=function(opts,blocksize,unitsize,cb) {\r\n\t\tvar that=this;\r\n\t\tloadVInt1.apply(this,[opts,function(count){\r\n\t\t\tvar o=that.fs.readFixedArray(opts.cur,count,unitsize,function(o){\r\n\t\t\t\topts.cur+=count*unitsize;\r\n\t\t\t\tcb.apply(that,[o]);\r\n\t\t\t});\r\n\t\t}]);\r\n\t}\r\n\tvar loadBlob=function(blocksize,cb) {\r\n\t\tvar o=this.fs.readBuf(this.cur,blocksize);\r\n\t\tthis.cur+=blocksize;\r\n\t\treturn o;\r\n\t}\t\r\n\tvar loadbysignature=function(opts,signature,cb) {\r\n\t\t  var blocksize=opts.blocksize||this.fs.size; \r\n\t\t\topts.cur+=this.fs.signature_size;\r\n\t\t\tvar datasize=blocksize-this.fs.signature_size;\r\n\t\t\t//basic types\r\n\t\t\tif (signature===DT.int32) {\r\n\t\t\t\topts.cur+=4;\r\n\t\t\t\tthis.fs.readI32(opts.cur-4,cb);\r\n\t\t\t} else if (signature===DT.uint8) {\r\n\t\t\t\topts.cur++;\r\n\t\t\t\tthis.fs.readUI8(opts.cur-1,cb);\r\n\t\t\t} else if (signature===DT.utf8) {\r\n\t\t\t\tvar c=opts.cur;opts.cur+=datasize;\r\n\t\t\t\tthis.fs.readString(c,datasize,'utf8',cb);\r\n\t\t\t} else if (signature===DT.ucs2) {\r\n\t\t\t\tvar c=opts.cur;opts.cur+=datasize;\r\n\t\t\t\tthis.fs.readString(c,datasize,'ucs2',cb);\t\r\n\t\t\t} else if (signature===DT.bool) {\r\n\t\t\t\topts.cur++;\r\n\t\t\t\tthis.fs.readUI8(opts.cur-1,function(data){cb(!!data)});\r\n\t\t\t} else if (signature===DT.blob) {\r\n\t\t\t\tloadBlob(datasize,cb);\r\n\t\t\t}\r\n\t\t\t//variable length integers\r\n\t\t\telse if (signature===DT.vint) {\r\n\t\t\t\tloadVInt.apply(this,[opts,datasize,datasize,cb]);\r\n\t\t\t}\r\n\t\t\telse if (signature===DT.pint) {\r\n\t\t\t\tloadPInt.apply(this,[opts,datasize,datasize,cb]);\r\n\t\t\t}\r\n\t\t\t//simple array\r\n\t\t\telse if (signature===DT.utf8arr) {\r\n\t\t\t\tloadStringArray.apply(this,[opts,datasize,'utf8',cb]);\r\n\t\t\t}\r\n\t\t\telse if (signature===DT.ucs2arr) {\r\n\t\t\t\tloadStringArray.apply(this,[opts,datasize,'ucs2',cb]);\r\n\t\t\t}\r\n\t\t\telse if (signature===DT.uint8arr) {\r\n\t\t\t\tloadIntegerArray.apply(this,[opts,datasize,1,cb]);\r\n\t\t\t}\r\n\t\t\telse if (signature===DT.int32arr) {\r\n\t\t\t\tloadIntegerArray.apply(this,[opts,datasize,4,cb]);\r\n\t\t\t}\r\n\t\t\t//nested structure\r\n\t\t\telse if (signature===DT.array) {\r\n\t\t\t\tloadArray.apply(this,[opts,datasize,cb]);\r\n\t\t\t}\r\n\t\t\telse if (signature===DT.object) {\r\n\t\t\t\tloadObject.apply(this,[opts,datasize,cb]);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tconsole.error('unsupported type',signature,opts)\r\n\t\t\t\tcb.apply(this,[null]);//make sure it return\r\n\t\t\t\t//throw 'unsupported type '+signature;\r\n\t\t\t}\r\n\t}\r\n\r\n\tvar load=function(opts,cb) {\r\n\t\topts=opts||{}; // this will served as context for entire load procedure\r\n\t\topts.cur=opts.cur||0;\r\n\t\tvar that=this;\r\n\t\tthis.fs.readSignature(opts.cur, function(signature){\r\n\t\t\tloadbysignature.apply(that,[opts,signature,cb])\r\n\t\t});\r\n\t\treturn this;\r\n\t}\r\n\tvar CACHE=null;\r\n\tvar KEY={};\r\n\tvar ADDRESS={};\r\n\tvar reset=function(cb) {\r\n\t\tif (!CACHE) {\r\n\t\t\tload.apply(this,[{cur:0,lazy:true},function(data){\r\n\t\t\t\tCACHE=data;\r\n\t\t\t\tcb.call(this);\r\n\t\t\t}]);\t\r\n\t\t} else {\r\n\t\t\tcb.call(this);\r\n\t\t}\r\n\t}\r\n\r\n\tvar exists=function(path,cb) {\r\n\t\tif (path.length==0) return true;\r\n\t\tvar key=path.pop();\r\n\t\tvar that=this;\r\n\t\tget.apply(this,[path,false,function(data){\r\n\t\t\tif (!path.join(strsep)) return (!!KEY[key]);\r\n\t\t\tvar keys=KEY[path.join(strsep)];\r\n\t\t\tpath.push(key);//put it back\r\n\t\t\tif (keys) cb.apply(that,[keys.indexOf(key)>-1]);\r\n\t\t\telse cb.apply(that,[false]);\r\n\t\t}]);\r\n\t}\r\n\r\n\tvar getSync=function(path) {\r\n\t\tif (!CACHE) return undefined;\t\r\n\t\tvar o=CACHE;\r\n\t\tfor (var i=0;i<path.length;i++) {\r\n\t\t\tvar r=o[path[i]];\r\n\t\t\tif (typeof r==\"undefined\") return null;\r\n\t\t\to=r;\r\n\t\t}\r\n\t\treturn o;\r\n\t}\r\n\tvar get=function(path,opts,cb,context) {\r\n\t\tif (typeof path=='undefined') path=[];\r\n\t\tif (typeof path==\"string\") path=[path];\r\n\t\t//opts.recursive=!!opts.recursive;\r\n\t\tif (typeof opts==\"function\") {\r\n\t\t\tcontext=cb;\r\n\t\t\tcb=opts;\r\n\t\t\topts={};\r\n\t\t}\r\n\t\tvar context=context||this;\r\n\t\tvar that=this;\r\n\t\tif (typeof cb!='function') return getSync(path);\r\n\r\n\t\treset.apply(this,[function(){\r\n\t\t\tvar o=CACHE;\r\n\t\t\tif (path.length==0) {\r\n\t\t\t\tif (opts.address) {\r\n\t\t\t\t\tcb.apply(context,[[0,that.fs.size]]);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tcb.apply(context,[Object.keys(CACHE)]);\r\n\t\t\t\t}\r\n\t\t\t\treturn;\r\n\t\t\t} \r\n\t\t\t\r\n\t\t\tvar pathnow=\"\",taskqueue=[],newopts={},r=null;\r\n\t\t\tvar lastkey=\"\";\r\n\r\n\t\t\tfor (var i=0;i<path.length;i++) {\r\n\t\t\t\tvar task=(function(key,k){\r\n\r\n\t\t\t\t\treturn (function(data){\r\n\t\t\t\t\t\tif (!(typeof data=='object' && data.__empty)) {\r\n\t\t\t\t\t\t\tif (typeof o[lastkey]=='string' && o[lastkey][0]==strsep) o[lastkey]={};\r\n\t\t\t\t\t\t\to[lastkey]=data; \r\n\t\t\t\t\t\t\to=o[lastkey];\r\n\t\t\t\t\t\t\tr=data[key];\r\n\t\t\t\t\t\t\tKEY[pathnow]=opts.keys;\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tdata=o[key];\r\n\t\t\t\t\t\t\tr=data;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif (typeof r===\"undefined\") {\r\n\t\t\t\t\t\t\ttaskqueue=null;\r\n\t\t\t\t\t\t\tcb.apply(context,[r]); //return empty value\r\n\t\t\t\t\t\t} else {\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif (parseInt(k)) pathnow+=strsep;\r\n\t\t\t\t\t\t\tpathnow+=key;\r\n\t\t\t\t\t\t\tif (typeof r=='string' && r[0]==strsep) { //offset of data to be loaded\r\n\t\t\t\t\t\t\t\tvar p=r.substring(1).split(strsep).map(function(item){return parseInt(item,16)});\r\n\t\t\t\t\t\t\t\tvar cur=p[0],sz=p[1];\r\n\t\t\t\t\t\t\t\tnewopts.lazy=!opts.recursive || (k<path.length-1) ;\r\n\t\t\t\t\t\t\t\tnewopts.blocksize=sz;newopts.cur=cur,newopts.keys=[];\r\n\t\t\t\t\t\t\t\tlastkey=key; //load is sync in android\r\n\t\t\t\t\t\t\t\tif (opts.address && taskqueue.length==1) {\r\n\t\t\t\t\t\t\t\t\tADDRESS[pathnow]=[cur,sz];\r\n\t\t\t\t\t\t\t\t\ttaskqueue.shift()(null,ADDRESS[pathnow]);\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tload.apply(that,[newopts, taskqueue.shift()]);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tif (opts.address && taskqueue.length==1) {\r\n\t\t\t\t\t\t\t\t\ttaskqueue.shift()(null,ADDRESS[pathnow]);\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\ttaskqueue.shift().apply(that,[r]);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t})\r\n\t\t\t\t(path[i],i);\r\n\t\t\t\t\r\n\t\t\t\ttaskqueue.push(task);\r\n\t\t\t}\r\n\r\n\t\t\tif (taskqueue.length==0) {\r\n\t\t\t\tcb.apply(context,[o]);\r\n\t\t\t} else {\r\n\t\t\t\t//last call to child load\r\n\t\t\t\ttaskqueue.push(function(data,cursz){\r\n\t\t\t\t\tif (opts.address) {\r\n\t\t\t\t\t\tcb.apply(context,[cursz]);\r\n\t\t\t\t\t} else{\r\n\t\t\t\t\t\tvar key=path[path.length-1];\r\n\t\t\t\t\t\to[key]=data; KEY[pathnow]=opts.keys;\r\n\t\t\t\t\t\tcb.apply(context,[data]);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\ttaskqueue.shift()({__empty:true});\t\t\t\r\n\t\t\t}\r\n\r\n\t\t}]); //reset\r\n\t}\r\n\t// get all keys in given path\r\n\tvar getkeys=function(path,cb) {\r\n\t\tif (!path) path=[]\r\n\t\tvar that=this;\r\n\r\n\t\tget.apply(this,[path,false,function(){\r\n\t\t\tif (path && path.length) {\r\n\t\t\t\tcb.apply(that,[KEY[path.join(strsep)]]);\r\n\t\t\t} else {\r\n\t\t\t\tcb.apply(that,[Object.keys(CACHE)]); \r\n\t\t\t\t//top level, normally it is very small\r\n\t\t\t}\r\n\t\t}]);\r\n\t}\r\n\r\n\tvar setupapi=function() {\r\n\t\tthis.load=load;\r\n//\t\tthis.cur=0;\r\n\t\tthis.cache=function() {return CACHE};\r\n\t\tthis.key=function() {return KEY};\r\n\t\tthis.free=function() {\r\n\t\t\tCACHE=null;\r\n\t\t\tKEY=null;\r\n\t\t\tthis.fs.free();\r\n\t\t}\r\n\t\tthis.setCache=function(c) {CACHE=c};\r\n\t\tthis.keys=getkeys;\r\n\t\tthis.get=get;   // get a field, load if needed\r\n\t\tthis.exists=exists;\r\n\t\tthis.DT=DT;\r\n\t\t\r\n\t\t//install the sync version for node\r\n\t\t//if (typeof process!=\"undefined\") require(\"./kdb_sync\")(this);\r\n\t\t//if (cb) setTimeout(cb.bind(this),0);\r\n\t\tvar that=this;\r\n\t\tvar err=0;\r\n\t\tif (cb) {\r\n\t\t\tsetTimeout(function(){\r\n\t\t\t\tcb(err,that);\t\r\n\t\t\t},0);\r\n\t\t}\r\n\t}\r\n\tvar that=this;\r\n\tvar kfs=new Kfs(path,opts,function(err){\r\n\t\tif (err) {\r\n\t\t\tsetTimeout(function(){\r\n\t\t\t\tcb(err,0);\r\n\t\t\t},0);\r\n\t\t\treturn null;\r\n\t\t} else {\r\n\t\t\tthat.size=this.size;\r\n\t\t\tsetupapi.call(that);\t\t\t\r\n\t\t}\r\n\t});\r\n\tthis.fs=kfs;\r\n\treturn this;\r\n}\r\n\r\nCreate.datatypes=DT;\r\n\r\nif (module) module.exports=Create;\r\n//return Create;\r\n",
    "/* node.js and html5 file system abstraction layer*/\r\ntry {\r\n\tvar fs=require(\"fs\");\r\n\tvar Buffer=require(\"buffer\").Buffer;\r\n} catch (e) {\r\n\tvar fs=require('./html5read');\r\n\tvar Buffer=function(){ return \"\"};\r\n\tvar html5fs=true; \t\r\n}\r\nvar signature_size=1;\r\nvar verbose=0, readLog=function(){};\r\nvar _readLog=function(readtype,bytes) {\r\n\tconsole.log(readtype,bytes,\"bytes\");\r\n}\r\nif (verbose) readLog=_readLog;\r\n\r\nvar unpack_int = function (ar, count , reset) {\r\n   count=count||ar.length;\r\n  var r = []\r\n  //var r=new Uint32Array(count);\r\n  var i = 0, v = 0,n=0;\r\n  do {\r\n\tvar shift = 0;\r\n\tdo {\r\n\t  v += ((ar[i] & 0x7F) << shift);\r\n\t  shift += 7;\t  \r\n\t} while (ar[++i] & 0x80);\r\n\tr.push(v);\r\n\t//r[n++]=v;\r\n\tif (reset) v=0;\r\n\tcount--;\r\n  } while (i<ar.length && count);\r\n\r\n  //var rr=r.subarray(0,n);\r\n  return {data:r, adv:i };\r\n}\r\nvar Open=function(path,opts,cb) {\r\n\topts=opts||{};\r\n\r\n\tvar readSignature=function(pos,cb) {\r\n\t\tvar buf=new Buffer(signature_size);\r\n\t\tvar that=this;\r\n\t\tfs.read(this.handle,buf,0,signature_size,pos,function(err,len,buffer){\r\n\t\t\tif (html5fs) var signature=String.fromCharCode((new Uint8Array(buffer))[0])\r\n\t\t\telse var signature=buffer.toString('utf8',0,signature_size);\r\n\t\t\tcb.apply(that,[signature]);\r\n\t\t});\r\n\t}\r\n\r\n\t//this is quite slow\r\n\t//wait for StringView +ArrayBuffer to solve the problem\r\n\t//https://groups.google.com/a/chromium.org/forum/#!topic/blink-dev/ylgiNY_ZSV0\r\n\t//if the string is always ucs2\r\n\t//can use Uint16 to read it.\r\n\t//http://updates.html5rocks.com/2012/06/How-to-convert-ArrayBuffer-to-and-from-String\r\n\tvar decodeutf8 = function (utftext) {\r\n\t\tvar string = \"\";\r\n\t\tvar i = 0;\r\n\t\tvar c=0,c1 = 0, c2 = 0 , c3=0;\r\n\t\tfor (var i=0;i<utftext.length;i++) {\r\n\t\t\tif (utftext.charCodeAt(i)>127) break;\r\n\t\t}\r\n\t\tif (i>=utftext.length) return utftext;\r\n\r\n\t\twhile ( i < utftext.length ) {\r\n\t\t\tc = utftext.charCodeAt(i);\r\n\t\t\tif (c < 128) {\r\n\t\t\t\tstring += utftext[i];\r\n\t\t\t\ti++;\r\n\t\t\t} else if((c > 191) && (c < 224)) {\r\n\t\t\t\tc2 = utftext.charCodeAt(i+1);\r\n\t\t\t\tstring += String.fromCharCode(((c & 31) << 6) | (c2 & 63));\r\n\t\t\t\ti += 2;\r\n\t\t\t} else {\r\n\t\t\t\tc2 = utftext.charCodeAt(i+1);\r\n\t\t\t\tc3 = utftext.charCodeAt(i+2);\r\n\t\t\t\tstring += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));\r\n\t\t\t\ti += 3;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn string;\r\n\t}\r\n\r\n\tvar readString= function(pos,blocksize,encoding,cb) {\r\n\t\tencoding=encoding||'utf8';\r\n\t\tvar buffer=new Buffer(blocksize);\r\n\t\tvar that=this;\r\n\t\tfs.read(this.handle,buffer,0,blocksize,pos,function(err,len,buffer){\r\n\t\t\treadLog(\"string\",len);\r\n\t\t\tif (html5fs) {\r\n\t\t\t\tif (encoding=='utf8') {\r\n\t\t\t\t\tvar str=decodeutf8(String.fromCharCode.apply(null, new Uint8Array(buffer)))\r\n\t\t\t\t} else { //ucs2 is 3 times faster\r\n\t\t\t\t\tvar str=String.fromCharCode.apply(null, new Uint16Array(buffer))\t\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tcb.apply(that,[str]);\r\n\t\t\t} \r\n\t\t\telse cb.apply(that,[buffer.toString(encoding)]);\t\r\n\t\t});\r\n\t}\r\n\r\n\t//work around for chrome fromCharCode cannot accept huge array\r\n\t//https://code.google.com/p/chromium/issues/detail?id=56588\r\n\tvar buf2stringarr=function(buf,enc) {\r\n\t\tif (enc==\"utf8\") \tvar arr=new Uint8Array(buf);\r\n\t\telse var arr=new Uint16Array(buf);\r\n\t\tvar i=0,codes=[],out=[],s=\"\";\r\n\t\twhile (i<arr.length) {\r\n\t\t\tif (arr[i]) {\r\n\t\t\t\tcodes[codes.length]=arr[i];\r\n\t\t\t} else {\r\n\t\t\t\ts=String.fromCharCode.apply(null,codes);\r\n\t\t\t\tif (enc==\"utf8\") out[out.length]=decodeutf8(s);\r\n\t\t\t\telse out[out.length]=s;\r\n\t\t\t\tcodes=[];\t\t\t\t\r\n\t\t\t}\r\n\t\t\ti++;\r\n\t\t}\r\n\t\t\r\n\t\ts=String.fromCharCode.apply(null,codes);\r\n\t\tif (enc==\"utf8\") out[out.length]=decodeutf8(s);\r\n\t\telse out[out.length]=s;\r\n\r\n\t\treturn out;\r\n\t}\r\n\tvar readStringArray = function(pos,blocksize,encoding,cb) {\r\n\t\tvar that=this,out=null;\r\n\t\tif (blocksize==0) return [];\r\n\t\tencoding=encoding||'utf8';\r\n\t\tvar buffer=new Buffer(blocksize);\r\n\t\tfs.read(this.handle,buffer,0,blocksize,pos,function(err,len,buffer){\r\n\t\t\tif (html5fs) {\r\n\t\t\t\treadLog(\"stringArray\",buffer.byteLength);\r\n\r\n\t\t\t\tif (encoding=='utf8') {\r\n\t\t\t\t\tout=buf2stringarr(buffer,\"utf8\");\r\n\t\t\t\t} else { //ucs2 is 3 times faster\r\n\t\t\t\t\tout=buf2stringarr(buffer,\"ucs2\");\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\treadLog(\"stringArray\",buffer.length);\r\n\t\t\t\tout=buffer.toString(encoding).split('\\0');\r\n\t\t\t} \t\r\n\t\t\tcb.apply(that,[out]);\r\n\t\t});\r\n\t}\r\n\tvar readUI32=function(pos,cb) {\r\n\t\tvar buffer=new Buffer(4);\r\n\t\tvar that=this;\r\n\t\tfs.read(this.handle,buffer,0,4,pos,function(err,len,buffer){\r\n\t\t\treadLog(\"ui32\",len);\r\n\t\t\tif (html5fs){\r\n\t\t\t\t//v=(new Uint32Array(buffer))[0];\r\n\t\t\t\tvar v=new DataView(buffer).getUint32(0, false)\r\n\t\t\t\tcb(v);\r\n\t\t\t}\r\n\t\t\telse cb.apply(that,[buffer.readInt32BE(0)]);\t\r\n\t\t});\t\t\r\n\t}\r\n\r\n\tvar readI32=function(pos,cb) {\r\n\t\tvar buffer=new Buffer(4);\r\n\t\tvar that=this;\r\n\t\tfs.read(this.handle,buffer,0,4,pos,function(err,len,buffer){\r\n\t\t\treadLog(\"i32\",len);\r\n\t\t\tif (html5fs){\r\n\t\t\t\tvar v=new DataView(buffer).getInt32(0, false)\r\n\t\t\t\tcb(v);\r\n\t\t\t}\r\n\t\t\telse  \tcb.apply(that,[buffer.readInt32BE(0)]);\t\r\n\t\t});\r\n\t}\r\n\tvar readUI8=function(pos,cb) {\r\n\t\tvar buffer=new Buffer(1);\r\n\t\tvar that=this;\r\n\r\n\t\tfs.read(this.handle,buffer,0,1,pos,function(err,len,buffer){\r\n\t\t\treadLog(\"ui8\",len);\r\n\t\t\tif (html5fs)cb( (new Uint8Array(buffer))[0]) ;\r\n\t\t\telse  \t\t\tcb.apply(that,[buffer.readUInt8(0)]);\t\r\n\t\t\t\r\n\t\t});\r\n\t}\r\n\tvar readBuf=function(pos,blocksize,cb) {\r\n\t\tvar that=this;\r\n\t\tvar buf=new Buffer(blocksize);\r\n\t\tfs.read(this.handle,buf,0,blocksize,pos,function(err,len,buffer){\r\n\t\t\treadLog(\"buf\",len);\r\n\t\t\tvar buff=new Uint8Array(buffer)\r\n\t\t\tcb.apply(that,[buff]);\r\n\t\t});\r\n\t}\r\n\tvar readBuf_packedint=function(pos,blocksize,count,reset,cb) {\r\n\t\tvar that=this;\r\n\t\treadBuf.apply(this,[pos,blocksize,function(buffer){\r\n\t\t\tcb.apply(that,[unpack_int(buffer,count,reset)]);\t\r\n\t\t}]);\r\n\t\t\r\n\t}\r\n\tvar readFixedArray_html5fs=function(pos,count,unitsize,cb) {\r\n\t\tvar func=null;\r\n\t\tif (unitsize===1) {\r\n\t\t\tfunc='getUint8';//Uint8Array;\r\n\t\t} else if (unitsize===2) {\r\n\t\t\tfunc='getUint16';//Uint16Array;\r\n\t\t} else if (unitsize===4) {\r\n\t\t\tfunc='getUint32';//Uint32Array;\r\n\t\t} else throw 'unsupported integer size';\r\n\r\n\t\tfs.read(this.handle,null,0,unitsize*count,pos,function(err,len,buffer){\r\n\t\t\treadLog(\"fix array\",len);\r\n\t\t\tvar out=[];\r\n\t\t\tif (unitsize==1) {\r\n\t\t\t\tout=new Uint8Array(buffer);\r\n\t\t\t} else {\r\n\t\t\t\tfor (var i = 0; i < len / unitsize; i++) { //endian problem\r\n\t\t\t\t//\tout.push( func(buffer,i*unitsize));\r\n\t\t\t\t\tout.push( v=new DataView(buffer)[func](i,false) );\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tcb.apply(that,[out]);\r\n\t\t});\r\n\t}\r\n\t// signature, itemcount, payload\r\n\tvar readFixedArray = function(pos ,count, unitsize,cb) {\r\n\t\tvar func=null;\r\n\t\tvar that=this;\r\n\t\t\r\n\t\tif (unitsize* count>this.size && this.size)  {\r\n\t\t\tconsole.log(\"array size exceed file size\",this.size)\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tif (html5fs) return readFixedArray_html5fs.apply(this,[pos,count,unitsize,cb]);\r\n\r\n\t\tvar items=new Buffer( unitsize* count);\r\n\t\tif (unitsize===1) {\r\n\t\t\tfunc=items.readUInt8;\r\n\t\t} else if (unitsize===2) {\r\n\t\t\tfunc=items.readUInt16BE;\r\n\t\t} else if (unitsize===4) {\r\n\t\t\tfunc=items.readUInt32BE;\r\n\t\t} else throw 'unsupported integer size';\r\n\t\t//console.log('itemcount',itemcount,'buffer',buffer);\r\n\r\n\t\tfs.read(this.handle,items,0,unitsize*count,pos,function(err,len,buffer){\r\n\t\t\treadLog(\"fix array\",len);\r\n\t\t\tvar out=[];\r\n\t\t\tfor (var i = 0; i < items.length / unitsize; i++) {\r\n\t\t\t\tout.push( func.apply(items,[i*unitsize]));\r\n\t\t\t}\r\n\t\t\tcb.apply(that,[out]);\r\n\t\t});\r\n\t}\r\n\r\n\tvar free=function() {\r\n\t\t//console.log('closing ',handle);\r\n\t\tfs.closeSync(this.handle);\r\n\t}\r\n\tvar setupapi=function() {\r\n\t\tvar that=this;\r\n\t\tthis.readSignature=readSignature;\r\n\t\tthis.readI32=readI32;\r\n\t\tthis.readUI32=readUI32;\r\n\t\tthis.readUI8=readUI8;\r\n\t\tthis.readBuf=readBuf;\r\n\t\tthis.readBuf_packedint=readBuf_packedint;\r\n\t\tthis.readFixedArray=readFixedArray;\r\n\t\tthis.readString=readString;\r\n\t\tthis.readStringArray=readStringArray;\r\n\t\tthis.signature_size=signature_size;\r\n\t\tthis.free=free;\r\n\t\tif (html5fs) {\r\n\t\t\tvar fn=path;\r\n\t\t\tif (path.indexOf(\"filesystem:\")==0) fn=path.substr(path.lastIndexOf(\"/\"));\r\n\t\t\tfs.fs.root.getFile(fn,{},function(entry){\r\n\t\t\t  entry.getMetadata(function(metadata) { \r\n\t\t\t\tthat.size=metadata.size;\r\n\t\t\t\tif (cb) setTimeout(cb.bind(that),0);\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tvar stat=fs.fstatSync(this.handle);\r\n\t\t\tthis.stat=stat;\r\n\t\t\tthis.size=stat.size;\t\t\r\n\t\t\tif (cb)\tsetTimeout(cb.bind(this,0),0);\t\r\n\t\t}\r\n\t}\r\n\r\n\tvar that=this;\r\n\tif (html5fs) {\r\n\t\tfs.open(path,function(h){\r\n\t\t\tif (!h) {\r\n\t\t\t\tif (cb)\tsetTimeout(cb.bind(null,\"file not found:\"+path),0);\t\r\n\t\t\t} else {\r\n\t\t\t\tthat.handle=h;\r\n\t\t\t\tthat.html5fs=true;\r\n\t\t\t\tsetupapi.call(that);\r\n\t\t\t\tthat.opened=true;\t\t\t\t\r\n\t\t\t}\r\n\t\t})\r\n\t} else {\r\n\t\tif (fs.existsSync(path)){\r\n\t\t\tthis.handle=fs.openSync(path,'r');//,function(err,handle){\r\n\t\t\tthis.opened=true;\r\n\t\t\tsetupapi.call(this);\r\n\t\t} else {\r\n\t\t\tif (cb)\tsetTimeout(cb.bind(null,\"file not found:\"+path),0);\t\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\treturn this;\r\n}\r\nmodule.exports=Open;",
    "/*\r\n  JAVA can only return Number and String\r\n\tarray and buffer return in string format\r\n\tneed JSON.parse\r\n*/\r\nvar verbose=0;\r\n\r\nvar readSignature=function(pos,cb) {\r\n\tif (verbose) console.debug(\"read signature\");\r\n\tvar signature=kfs.readUTF8String(this.handle,pos,1);\r\n\tif (verbose) console.debug(signature,signature.charCodeAt(0));\r\n\tcb.apply(this,[signature]);\r\n}\r\nvar readI32=function(pos,cb) {\r\n\tif (verbose) console.debug(\"read i32 at \"+pos);\r\n\tvar i32=kfs.readInt32(this.handle,pos);\r\n\tif (verbose) console.debug(i32);\r\n\tcb.apply(this,[i32]);\t\r\n}\r\nvar readUI32=function(pos,cb) {\r\n\tif (verbose) console.debug(\"read ui32 at \"+pos);\r\n\tvar ui32=kfs.readUInt32(this.handle,pos);\r\n\tif (verbose) console.debug(ui32);\r\n\tcb.apply(this,[ui32]);\r\n}\r\nvar readUI8=function(pos,cb) {\r\n\tif (verbose) console.debug(\"read ui8 at \"+pos); \r\n\tvar ui8=kfs.readUInt8(this.handle,pos);\r\n\tif (verbose) console.debug(ui8);\r\n\tcb.apply(this,[ui8]);\r\n}\r\nvar readBuf=function(pos,blocksize,cb) {\r\n\tif (verbose) console.debug(\"read buffer at \"+pos+ \" blocksize \"+blocksize);\r\n\tvar buf=kfs.readBuf(this.handle,pos,blocksize);\r\n\tvar buff=JSON.parse(buf);\r\n\tif (verbose) console.debug(\"buffer length\"+buff.length);\r\n\tcb.apply(this,[buff]);\t\r\n}\r\nvar readBuf_packedint=function(pos,blocksize,count,reset,cb) {\r\n\tif (verbose) console.debug(\"read packed int at \"+pos+\" blocksize \"+blocksize+\" count \"+count);\r\n\tvar buf=kfs.readBuf_packedint(this.handle,pos,blocksize,count,reset);\r\n\tvar adv=parseInt(buf);\r\n\tvar buff=JSON.parse(buf.substr(buf.indexOf(\"[\")));\r\n\tif (verbose) console.debug(\"packedInt length \"+buff.length+\" first item=\"+buff[0]);\r\n\tcb.apply(this,[{data:buff,adv:adv}]);\t\r\n}\r\n\r\n\r\nvar readString= function(pos,blocksize,encoding,cb) {\r\n\tif (verbose) console.debug(\"readstring at \"+pos+\" blocksize \" +blocksize+\" enc:\"+encoding);\r\n\tif (encoding==\"ucs2\") {\r\n\t\tvar str=kfs.readULE16String(this.handle,pos,blocksize);\r\n\t} else {\r\n\t\tvar str=kfs.readUTF8String(this.handle,pos,blocksize);\t\r\n\t}\t \r\n\tif (verbose) console.debug(str);\r\n\tcb.apply(this,[str]);\t\r\n}\r\n\r\nvar readFixedArray = function(pos ,count, unitsize,cb) {\r\n\tif (verbose) console.debug(\"read fixed array at \"+pos+\" count \"+count+\" unitsize \"+unitsize); \r\n\tvar buf=kfs.readFixedArray(this.handle,pos,count,unitsize);\r\n\tvar buff=JSON.parse(buf);\r\n\tif (verbose) console.debug(\"array length\"+buff.length);\r\n\tcb.apply(this,[buff]);\t\r\n}\r\nvar readStringArray = function(pos,blocksize,encoding,cb) {\r\n\tif (verbose) console.log(\"read String array at \"+pos+\" blocksize \"+blocksize +\" enc \"+encoding); \r\n\tencoding = encoding||\"utf8\";\r\n\tvar buf=kfs.readStringArray(this.handle,pos,blocksize,encoding);\r\n\t//var buff=JSON.parse(buf);\r\n\tif (verbose) console.debug(\"read string array\");\r\n\tvar buff=buf.split(\"\\uffff\"); //cannot return string with 0\r\n\tif (verbose) console.debug(\"array length\"+buff.length);\r\n\tcb.apply(this,[buff]);\t\r\n}\r\nvar mergePostings=function(positions,cb) {\r\n\tvar buf=kfs.mergePostings(this.handle,JSON.stringify(positions));\r\n\tif (!buf || buf.length==0) return [];\r\n\telse return JSON.parse(buf);\r\n}\r\n\r\nvar free=function() {\r\n\t//console.log('closing ',handle);\r\n\tkfs.close(this.handle);\r\n}\r\nvar Open=function(path,opts,cb) {\r\n\topts=opts||{};\r\n\tvar signature_size=1;\r\n\tvar setupapi=function() { \r\n\t\tthis.readSignature=readSignature;\r\n\t\tthis.readI32=readI32;\r\n\t\tthis.readUI32=readUI32;\r\n\t\tthis.readUI8=readUI8;\r\n\t\tthis.readBuf=readBuf;\r\n\t\tthis.readBuf_packedint=readBuf_packedint;\r\n\t\tthis.readFixedArray=readFixedArray;\r\n\t\tthis.readString=readString;\r\n\t\tthis.readStringArray=readStringArray;\r\n\t\tthis.signature_size=signature_size;\r\n\t\tthis.mergePostings=mergePostings;\r\n\t\tthis.free=free;\r\n\t\tthis.size=kfs.getFileSize(this.handle);\r\n\t\tif (verbose) console.log(\"filesize  \"+this.size);\r\n\t\tif (cb)\tcb.call(this);\r\n\t}\r\n\r\n\tthis.handle=kfs.open(path);\r\n\tthis.opened=true;\r\n\tsetupapi.call(this);\r\n\treturn this;\r\n}\r\n\r\nmodule.exports=Open;",
    "/*\r\n  JSContext can return all Javascript types.\r\n*/\r\nvar verbose=1;\r\n\r\nvar readSignature=function(pos,cb) {\r\n\tif (verbose)  ksanagap.log(\"read signature at \"+pos);\r\n\tvar signature=kfs.readUTF8String(this.handle,pos,1);\r\n\tif (verbose)  ksanagap.log(signature+\" \"+signature.charCodeAt(0));\r\n\tcb.apply(this,[signature]);\r\n}\r\nvar readI32=function(pos,cb) {\r\n\tif (verbose)  ksanagap.log(\"read i32 at \"+pos);\r\n\tvar i32=kfs.readInt32(this.handle,pos);\r\n\tif (verbose)  ksanagap.log(i32);\r\n\tcb.apply(this,[i32]);\t\r\n}\r\nvar readUI32=function(pos,cb) {\r\n\tif (verbose)  ksanagap.log(\"read ui32 at \"+pos);\r\n\tvar ui32=kfs.readUInt32(this.handle,pos);\r\n\tif (verbose)  ksanagap.log(ui32);\r\n\tcb.apply(this,[ui32]);\r\n}\r\nvar readUI8=function(pos,cb) {\r\n\tif (verbose)  ksanagap.log(\"read ui8 at \"+pos); \r\n\tvar ui8=kfs.readUInt8(this.handle,pos);\r\n\tif (verbose)  ksanagap.log(ui8);\r\n\tcb.apply(this,[ui8]);\r\n}\r\nvar readBuf=function(pos,blocksize,cb) {\r\n\tif (verbose)  ksanagap.log(\"read buffer at \"+pos);\r\n\tvar buf=kfs.readBuf(this.handle,pos,blocksize);\r\n\tif (verbose)  ksanagap.log(\"buffer length\"+buf.length);\r\n\tcb.apply(this,[buf]);\t\r\n}\r\nvar readBuf_packedint=function(pos,blocksize,count,reset,cb) {\r\n\tif (verbose)  ksanagap.log(\"read packed int fast, blocksize \"+blocksize+\" at \"+pos);var t=new Date();\r\n\tvar buf=kfs.readBuf_packedint(this.handle,pos,blocksize,count,reset);\r\n\tif (verbose)  ksanagap.log(\"return from packedint, time\" + (new Date()-t));\r\n\tif (typeof buf.data==\"string\") {\r\n\t\tbuf.data=eval(\"[\"+buf.data.substr(0,buf.data.length-1)+\"]\");\r\n\t}\r\n\tif (verbose)  ksanagap.log(\"unpacked length\"+buf.data.length+\" time\" + (new Date()-t) );\r\n\tcb.apply(this,[buf]);\r\n}\r\n\r\n\r\nvar readString= function(pos,blocksize,encoding,cb) {\r\n\r\n\tif (verbose)  ksanagap.log(\"readstring at \"+pos+\" blocksize \"+blocksize+\" \"+encoding);var t=new Date();\r\n\tif (encoding==\"ucs2\") {\r\n\t\tvar str=kfs.readULE16String(this.handle,pos,blocksize);\r\n\t} else {\r\n\t\tvar str=kfs.readUTF8String(this.handle,pos,blocksize);\t\r\n\t}\r\n\tif (verbose)  ksanagap.log(str+\" time\"+(new Date()-t));\r\n\tcb.apply(this,[str]);\t\r\n}\r\n\r\nvar readFixedArray = function(pos ,count, unitsize,cb) {\r\n\tif (verbose)  ksanagap.log(\"read fixed array at \"+pos); var t=new Date();\r\n\tvar buf=kfs.readFixedArray(this.handle,pos,count,unitsize);\r\n\tif (verbose)  ksanagap.log(\"array length \"+buf.length+\" time\"+(new Date()-t));\r\n\tcb.apply(this,[buf]);\t\r\n}\r\nvar readStringArray = function(pos,blocksize,encoding,cb) {\r\n\t//if (verbose)  ksanagap.log(\"read String array \"+blocksize +\" \"+encoding); \r\n\tencoding = encoding||\"utf8\";\r\n\tif (verbose)  ksanagap.log(\"read string array at \"+pos);var t=new Date();\r\n\tvar buf=kfs.readStringArray(this.handle,pos,blocksize,encoding);\r\n\tif (typeof buf==\"string\") buf=buf.split(\"\\0\");\r\n\t//var buff=JSON.parse(buf);\r\n\t//var buff=buf.split(\"\\uffff\"); //cannot return string with 0\r\n\tif (verbose)  ksanagap.log(\"string array length\"+buf.length+\" time\"+(new Date()-t));\r\n\tcb.apply(this,[buf]);\r\n}\r\n\r\nvar mergePostings=function(positions) {\r\n\tvar buf=kfs.mergePostings(this.handle,positions);\r\n\tif (typeof buf==\"string\") {\r\n\t\tbuf=eval(\"[\"+buf.substr(0,buf.length-1)+\"]\");\r\n\t}\r\n\treturn buf;\r\n}\r\nvar free=function() {\r\n\t////if (verbose)  ksanagap.log('closing ',handle);\r\n\tkfs.close(this.handle);\r\n}\r\nvar Open=function(path,opts,cb) {\r\n\topts=opts||{};\r\n\tvar signature_size=1;\r\n\tvar setupapi=function() { \r\n\t\tthis.readSignature=readSignature;\r\n\t\tthis.readI32=readI32;\r\n\t\tthis.readUI32=readUI32;\r\n\t\tthis.readUI8=readUI8;\r\n\t\tthis.readBuf=readBuf;\r\n\t\tthis.readBuf_packedint=readBuf_packedint;\r\n\t\tthis.readFixedArray=readFixedArray;\r\n\t\tthis.readString=readString;\r\n\t\tthis.readStringArray=readStringArray;\r\n\t\tthis.signature_size=signature_size;\r\n\t\tthis.mergePostings=mergePostings;\r\n\t\tthis.free=free;\r\n\t\tthis.size=kfs.getFileSize(this.handle);\r\n\t\tif (verbose)  ksanagap.log(\"filesize  \"+this.size);\r\n\t\tif (cb)\tcb.call(this);\r\n\t}\r\n\r\n\tthis.handle=kfs.open(path);\r\n\tthis.opened=true;\r\n\tsetupapi.call(this);\r\n\treturn this;\r\n}\r\n\r\nmodule.exports=Open;",
    "/*\r\n  TODO\r\n  and not\r\n\r\n*/\r\n\r\n// http://jsfiddle.net/neoswf/aXzWw/\r\nvar plist=require('./plist');\r\nfunction intersect(I, J) {\r\n  var i = j = 0;\r\n  var result = [];\r\n\r\n  while( i < I.length && j < J.length ){\r\n     if      (I[i] < J[j]) i++; \r\n     else if (I[i] > J[j]) j++; \r\n     else {\r\n       result[result.length]=l[i];\r\n       i++;j++;\r\n     }\r\n  }\r\n  return result;\r\n}\r\n\r\n/* return all items in I but not in J */\r\nfunction subtract(I, J) {\r\n  var i = j = 0;\r\n  var result = [];\r\n\r\n  while( i < I.length && j < J.length ){\r\n    if (I[i]==J[j]) {\r\n      i++;j++;\r\n    } else if (I[i]<J[j]) {\r\n      while (I[i]<J[j]) result[result.length]= I[i++];\r\n    } else {\r\n      while(J[j]<I[i]) j++;\r\n    }\r\n  }\r\n\r\n  if (j==J.length) {\r\n    while (i<I.length) result[result.length]=I[i++];\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nvar union=function(a,b) {\r\n\tif (!a || !a.length) return b;\r\n\tif (!b || !b.length) return a;\r\n    var result = [];\r\n    var ai = 0;\r\n    var bi = 0;\r\n    while (true) {\r\n        if ( ai < a.length && bi < b.length) {\r\n            if (a[ai] < b[bi]) {\r\n                result[result.length]=a[ai];\r\n                ai++;\r\n            } else if (a[ai] > b[bi]) {\r\n                result[result.length]=b[bi];\r\n                bi++;\r\n            } else {\r\n                result[result.length]=a[ai];\r\n                result[result.length]=b[bi];\r\n                ai++;\r\n                bi++;\r\n            }\r\n        } else if (ai < a.length) {\r\n            result.push.apply(result, a.slice(ai, a.length));\r\n            break;\r\n        } else if (bi < b.length) {\r\n            result.push.apply(result, b.slice(bi, b.length));\r\n            break;\r\n        } else {\r\n            break;\r\n        }\r\n    }\r\n    return result;\r\n}\r\nvar OPERATION={'include':intersect, 'union':union, 'exclude':subtract};\r\n\r\nvar boolSearch=function(opts) {\r\n  opts=opts||{};\r\n  ops=opts.op||this.opts.op;\r\n  this.docs=[];\r\n\tif (!this.phrases.length) return;\r\n\tvar r=this.phrases[0].docs;\r\n  /* ignore operator of first phrase */\r\n\tfor (var i=1;i<this.phrases.length;i++) {\r\n\t\tvar op= ops[i] || 'union';\r\n\t\tr=OPERATION[op](r,this.phrases[i].docs);\r\n\t}\r\n\tthis.docs=plist.unique(r);\r\n\treturn this;\r\n}\r\nmodule.exports={search:boolSearch}",
    "var indexOfSorted = function (array, obj, near) { \r\n  var low = 0,\r\n  high = array.length;\r\n  while (low < high) {\r\n    var mid = (low + high) >> 1;\r\n    if (array[mid]==obj) return mid;\r\n    array[mid] < obj ? low = mid + 1 : high = mid;\r\n  }\r\n  if (near) return low;\r\n  else if (array[low]==obj) return low;else return -1;\r\n};\r\nvar indexOfSorted_str = function (array, obj, near) { \r\n  var low = 0,\r\n  high = array.length;\r\n  while (low < high) {\r\n    var mid = (low + high) >> 1;\r\n    if (array[mid]==obj) return mid;\r\n    (array[mid].localeCompare(obj)<0) ? low = mid + 1 : high = mid;\r\n  }\r\n  if (near) return low;\r\n  else if (array[low]==obj) return low;else return -1;\r\n};\r\n\r\n\r\nvar bsearch=function(array,value,near) {\r\n\tvar func=indexOfSorted;\r\n\tif (typeof array[0]==\"string\") func=indexOfSorted_str;\r\n\treturn func(array,value,near);\r\n}\r\nvar bsearchNear=function(array,value) {\r\n\treturn bsearch(array,value,true);\r\n}\r\n\r\nmodule.exports=bsearch;//{bsearchNear:bsearchNear,bsearch:bsearch};",
    "var plist=require(\"./plist\");\r\n\r\nvar getPhraseWidths=function (Q,phraseid,vposs) {\r\n\tvar res=[];\r\n\tfor (var i in vposs) {\r\n\t\tres.push(getPhraseWidth(Q,phraseid,vposs[i]));\r\n\t}\r\n\treturn res;\r\n}\r\nvar getPhraseWidth=function (Q,phraseid,vpos) {\r\n\tvar P=Q.phrases[phraseid];\r\n\tvar width=0,varwidth=false;\r\n\tif (P.width) return P.width; // no wildcard\r\n\tif (P.termid.length<2) return P.termlength[0];\r\n\tvar lasttermposting=Q.terms[P.termid[P.termid.length-1]].posting;\r\n\r\n\tfor (var i in P.termid) {\r\n\t\tvar T=Q.terms[P.termid[i]];\r\n\t\tif (T.op=='wildcard') {\r\n\t\t\twidth+=T.width;\r\n\t\t\tif (T.wildcard=='*') varwidth=true;\r\n\t\t} else {\r\n\t\t\twidth+=P.termlength[i];\r\n\t\t}\r\n\t}\r\n\tif (varwidth) { //width might be smaller due to * wildcard\r\n\t\tvar at=plist.indexOfSorted(lasttermposting,vpos);\r\n\t\tvar endpos=lasttermposting[at];\r\n\t\tif (endpos-vpos<width) width=endpos-vpos+1;\r\n\t}\r\n\r\n\treturn width;\r\n}\r\n/* return [vpos, phraseid, phrasewidth, optional_tagname] by slot range*/\r\nvar hitInRange=function(Q,startvpos,endvpos) {\r\n\tvar res=[];\r\n\tif (!Q || !Q.rawresult || !Q.rawresult.length) return res;\r\n\tfor (var i=0;i<Q.phrases.length;i++) {\r\n\t\tvar P=Q.phrases[i];\r\n\t\tif (!P.posting) continue;\r\n\t\tvar s=plist.indexOfSorted(P.posting,startvpos);\r\n\t\tvar e=plist.indexOfSorted(P.posting,endvpos);\r\n\t\tvar r=P.posting.slice(s,e+1);\r\n\t\tvar width=getPhraseWidths(Q,i,r);\r\n\r\n\t\tres=res.concat(r.map(function(vpos,idx){ return [vpos,width[idx],i] }));\r\n\t}\r\n\t// order by vpos, if vpos is the same, larger width come first.\r\n\t// so the output will be\r\n\t// <tag1><tag2>one</tag2>two</tag1>\r\n\t//TODO, might cause overlap if same vpos and same width\r\n\t//need to check tag name\r\n\tres.sort(function(a,b){return a[0]==b[0]? b[1]-a[1] :a[0]-b[0]});\r\n\r\n\treturn res;\r\n}\r\n\r\nvar tagsInRange=function(Q,renderTags,startvpos,endvpos) {\r\n\tvar res=[];\r\n\tif (typeof renderTags==\"string\") renderTags=[renderTags];\r\n\r\n\trenderTags.map(function(tag){\r\n\t\tvar starts=Q.engine.get([\"fields\",tag+\"_start\"]);\r\n\t\tvar ends=Q.engine.get([\"fields\",tag+\"_end\"]);\r\n\t\tif (!starts) return;\r\n\r\n\t\tvar s=plist.indexOfSorted(starts,startvpos);\r\n\t\tvar e=s;\r\n\t\twhile (e<starts.length && starts[e]<endvpos) e++;\r\n\t\tvar opentags=starts.slice(s,e);\r\n\r\n\t\ts=plist.indexOfSorted(ends,startvpos);\r\n\t\te=s;\r\n\t\twhile (e<ends.length && ends[e]<endvpos) e++;\r\n\t\tvar closetags=ends.slice(s,e);\r\n\r\n\t\topentags.map(function(start,idx) {\r\n\t\t\tres.push([start,closetags[idx]-start,tag]);\r\n\t\t})\r\n\t});\r\n\t// order by vpos, if vpos is the same, larger width come first.\r\n\tres.sort(function(a,b){return a[0]==b[0]? b[1]-a[1] :a[0]-b[0]});\r\n\r\n\treturn res;\r\n}\r\n\r\n/*\r\ngiven a vpos range start, file, convert to filestart, fileend\r\n   filestart : starting file\r\n   start   : vpos start\r\n   showfile: how many files to display\r\n   showpage: how many pages to display\r\n\r\noutput:\r\n   array of fileid with hits\r\n*/\r\nvar getFileWithHits=function(engine,Q,range) {\r\n\tvar fileOffsets=engine.get(\"fileoffsets\");\r\n\tvar out=[],filecount=100;\r\n\tvar start=0 , end=Q.byFile.length;\r\n\tQ.excerptOverflow=false;\r\n\tif (range.start) {\r\n\t\tvar first=range.start ;\r\n\t\tvar last=range.end;\r\n\t\tif (!last) last=Number.MAX_SAFE_INTEGER;\r\n\t\tfor (var i=0;i<fileOffsets.length;i++) {\r\n\t\t\t//if (fileOffsets[i]>first) break;\r\n\t\t\tif (fileOffsets[i]>last) {\r\n\t\t\t\tend=i;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tif (fileOffsets[i]<first) start=i;\r\n\t\t}\t\t\r\n\t} else {\r\n\t\tstart=range.filestart || 0;\r\n\t\tif (range.maxfile) {\r\n\t\t\tfilecount=range.maxfile;\r\n\t\t} else if (range.showseg) {\r\n\t\t\tthrow \"not implement yet\"\r\n\t\t}\r\n\t}\r\n\r\n\tvar fileWithHits=[],totalhit=0;\r\n\trange.maxhit=range.maxhit||1000;\r\n\r\n\tfor (var i=start;i<end;i++) {\r\n\t\tif(Q.byFile[i].length>0) {\r\n\t\t\ttotalhit+=Q.byFile[i].length;\r\n\t\t\tfileWithHits.push(i);\r\n\t\t\trange.nextFileStart=i;\r\n\t\t\tif (fileWithHits.length>=filecount) {\r\n\t\t\t\tQ.excerptOverflow=true;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tif (totalhit>range.maxhit) {\r\n\t\t\t\tQ.excerptOverflow=true;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tif (i>=end) { //no more file\r\n\t\tQ.excerptStop=true;\r\n\t}\r\n\treturn fileWithHits;\r\n}\r\nvar resultlist=function(engine,Q,opts,cb) {\r\n\tvar output=[];\r\n\tif (!Q.rawresult || !Q.rawresult.length) {\r\n\t\tcb(output);\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (opts.range) {\r\n\t\tif (opts.range.maxhit && !opts.range.maxfile) {\r\n\t\t\topts.range.maxfile=opts.range.maxhit;\r\n\t\t\topts.range.maxseg=opts.range.maxhit;\r\n\t\t}\r\n\t\tif (!opts.range.maxseg) opts.range.maxseg=100;\r\n\t\tif (!opts.range.end) {\r\n\t\t\topts.range.end=Number.MAX_SAFE_INTEGER;\r\n\t\t}\r\n\t}\r\n\tvar fileWithHits=getFileWithHits(engine,Q,opts.range);\r\n\tif (!fileWithHits.length) {\r\n\t\tcb(output);\r\n\t\treturn;\r\n\t}\r\n\r\n\tvar output=[],files=[];//temporary holder for segnames\r\n\tfor (var i=0;i<fileWithHits.length;i++) {\r\n\t\tvar nfile=fileWithHits[i];\r\n\t\tvar segoffsets=engine.getFileSegOffsets(nfile);\r\n\t\tvar segnames=engine.getFileSegNames(nfile);\r\n\t\tfiles[nfile]={segoffsets:segoffsets};\r\n\t\tvar segwithhit=plist.groupbyposting2(Q.byFile[ nfile ],  segoffsets);\r\n\t\t//if (segoffsets[0]==1)\r\n\t\t//segwithhit.shift(); //the first item is not used (0~Q.byFile[0] )\r\n\r\n\t\tfor (var j=0; j<segwithhit.length;j++) {\r\n\t\t\tif (!segwithhit[j].length) continue;\r\n\t\t\t//var offsets=segwithhit[j].map(function(p){return p- fileOffsets[i]});\r\n\t\t\tif (segoffsets[j]>opts.range.end) break;\r\n\t\t\toutput.push(  {file: nfile, seg:j,  segname:segnames[j]});\r\n\t\t\tif (output.length>opts.range.maxseg) break;\r\n\t\t}\r\n\t}\r\n\r\n\tvar segpaths=output.map(function(p){\r\n\t\treturn [\"filecontents\",p.file,p.seg];\r\n\t});\r\n\t//prepare the text\r\n\tengine.get(segpaths,function(segs){\r\n\t\tvar seq=0;\r\n\t\tif (segs) for (var i=0;i<segs.length;i++) {\r\n\t\t\tvar startvpos=files[output[i].file].segoffsets[output[i].seg-1] ||0;\r\n\t\t\tvar endvpos=files[output[i].file].segoffsets[output[i].seg];\r\n\t\t\tvar hl={};\r\n\r\n\t\t\tif (opts.range && opts.range.start  ) {\r\n\t\t\t\tif ( startvpos<opts.range.start) startvpos=opts.range.start;\r\n\t\t\t//\tif (endvpos>opts.range.end) endvpos=opts.range.end;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (opts.nohighlight) {\r\n\t\t\t\thl.text=segs[i];\r\n\t\t\t\thl.hits=hitInRange(Q,startvpos,endvpos);\r\n\t\t\t} else {\r\n\t\t\t\tvar o={nocrlf:true,nospan:true,\r\n\t\t\t\t\ttext:segs[i],startvpos:startvpos, endvpos: endvpos, \r\n\t\t\t\t\tQ:Q,fulltext:opts.fulltext};\r\n\t\t\t\thl=highlight(Q,o);\r\n\t\t\t}\r\n\t\t\tif (hl.text) {\r\n\t\t\t\toutput[i].text=hl.text;\r\n\t\t\t\toutput[i].hits=hl.hits;\r\n\t\t\t\toutput[i].seq=seq;\r\n\t\t\t\tseq+=hl.hits.length;\r\n\r\n\t\t\t\toutput[i].start=startvpos;\t\t\t\t\r\n\t\t\t} else {\r\n\t\t\t\toutput[i]=null; //remove item vpos less than opts.range.start\r\n\t\t\t}\r\n\t\t} \r\n\t\toutput=output.filter(function(o){return o!=null});\r\n\t\tcb(output);\r\n\t});\r\n}\r\nvar injectTag=function(Q,opts){\r\n\tvar hits=opts.hits;\r\n\tvar tags=opts.tags;\r\n\tif (!tags) tags=[];\r\n\tvar hitclass=opts.hitclass||'hl';\r\n\tvar output='',O=[],j=0,k=0;\r\n\tvar surround=opts.surround||5;\r\n\r\n\tvar tokens=Q.tokenize(opts.text).tokens;\r\n\tvar vpos=opts.vpos;\r\n\tvar i=0,previnrange=!!opts.fulltext ,inrange=!!opts.fulltext;\r\n\tvar hitstart=0,hitend=0,tagstart=0,tagend=0,tagclass=\"\";\r\n\twhile (i<tokens.length) {\r\n\t\tvar skip=Q.isSkip(tokens[i]);\r\n\t\tvar hashit=false;\r\n\t\tinrange=opts.fulltext || (j<hits.length && vpos+surround>=hits[j][0] ||\r\n\t\t\t\t(j>0 && j<=hits.length &&  hits[j-1][0]+surround*2>=vpos));\t\r\n\r\n\t\tif (previnrange!=inrange) {\r\n\t\t\toutput+=opts.abridge||\"...\";\r\n\t\t}\r\n\t\tprevinrange=inrange;\r\n\t\tvar token=tokens[i];\r\n\t\tif (opts.nocrlf && token==\"\\n\") token=\"\";\r\n\r\n\t\tif (inrange && i<tokens.length) {\r\n\t\t\tif (skip) {\r\n\t\t\t\toutput+=token;\r\n\t\t\t} else {\r\n\t\t\t\tvar classes=\"\";\t\r\n\r\n\t\t\t\t//check hit\r\n\t\t\t\tif (j<hits.length && vpos==hits[j][0]) {\r\n\t\t\t\t\tvar nphrase=hits[j][2] % 10, width=hits[j][1];\r\n\t\t\t\t\thitstart=hits[j][0];\r\n\t\t\t\t\thitend=hitstart+width;\r\n\t\t\t\t\tj++;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t//check tag\r\n\t\t\t\tif (k<tags.length && vpos==tags[k][0]) {\r\n\t\t\t\t\tvar width=tags[k][1];\r\n\t\t\t\t\ttagstart=tags[k][0];\r\n\t\t\t\t\ttagend=tagstart+width;\r\n\t\t\t\t\ttagclass=tags[k][2];\r\n\t\t\t\t\tk++;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (vpos>=hitstart && vpos<hitend) classes=hitclass+\" \"+hitclass+nphrase;\r\n\t\t\t\tif (vpos>=tagstart && vpos<tagend) classes+=\" \"+tagclass;\r\n\r\n\t\t\t\tif (classes || !opts.nospan) {\r\n\t\t\t\t\toutput+='<span vpos=\"'+vpos+'\"';\r\n\t\t\t\t\tif (classes) classes=' class=\"'+classes+'\"';\r\n\t\t\t\t\toutput+=classes+'>';\r\n\t\t\t\t\toutput+=token+'</span>';\r\n\t\t\t\t} else {\r\n\t\t\t\t\toutput+=token;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (!skip) vpos++;\r\n\t\ti++; \r\n\t}\r\n\r\n\tO.push(output);\r\n\toutput=\"\";\r\n\r\n\treturn O.join(\"\");\r\n}\r\nvar highlight=function(Q,opts) {\r\n\tif (!opts.text) return {text:\"\",hits:[]};\r\n\tvar opt={text:opts.text,\r\n\t\thits:null,abridge:opts.abridge,vpos:opts.startvpos,\r\n\t\tfulltext:opts.fulltext,renderTags:opts.renderTags,nospan:opts.nospan,nocrlf:opts.nocrlf,\r\n\t};\r\n\r\n\topt.hits=hitInRange(opts.Q,opts.startvpos,opts.endvpos);\r\n\treturn {text:injectTag(Q,opt),hits:opt.hits};\r\n}\r\n\r\nvar addspan=function(text,startvpos){\r\n\tengine=this;\r\n\tvar output=\"\";\r\n\tvar tokens=engine.analyzer.tokenize(text).tokens;\r\n\tvar isSkip=engine.analyzer.isSkip;\r\n\tvar vpos=startvpos;\r\n\tfor (var i=0;i<tokens.length;i++) {\r\n\t\toutput+='<span vpos=\"'+(vpos)+'\">'+tokens[i]+\"</span>\";\r\n\t\tif (!isSkip(tokens[i])) vpos++;\r\n\t}\t\t\r\n\treturn output;\r\n}\r\nvar addtoken=function(text,startvpos) {\r\n\tengine=this;\r\n\tvar output=[];\r\n\tvar tokens=engine.analyzer.tokenize(text).tokens;\r\n\tvar isSkip=engine.analyzer.isSkip;\r\n\tvar vpos=startvpos;\r\n\tfor (var i=0;i<tokens.length;i++) {\r\n\t\toutput.push([tokens[i],vpos]);\r\n\t\tif (!isSkip(tokens[i])) vpos++;\r\n\t}\t\t\r\n\treturn output;\r\n}\r\nvar getSeg=function(engine,fileid,segid,opts,cb,context) {\r\n\tif (typeof opts==\"function\") {\r\n\t\tcontext=cb;\r\n\t\tcb=opts;\r\n\t\topts={};\r\n\t}\r\n\r\n\tvar fileOffsets=engine.get(\"fileoffsets\");\r\n\tvar segpaths=[\"filecontents\",fileid,segid];\r\n\tvar segnames=engine.getFileSegNames(fileid);\r\n\tvar vpos=engine.fileSegToVpos(fileid,segid);\r\n\r\n\tengine.get(segpaths,function(text){\r\n\t\tvar out=text;\r\n\t\tif (opts.span) out=addspan.apply(engine,[text,vpos]);\r\n\t\telse if(opts.token) out=addtoken.apply(engine,[text,vpos]);\r\n\t\tcb.apply(context||engine.context,[{text:out,file:fileid,seg:segid,segname:segnames[segid]}]);\r\n\t});\r\n}\r\n\r\nvar getSegSync=function(engine,fileid,segid) {\r\n\tvar fileOffsets=engine.get(\"fileoffsets\");\r\n\tvar segpaths=[\"filecontents\",fileid,segid];\r\n\tvar segnames=engine.getFileSegNames(fileid);\r\n\r\n\tvar text=engine.get(segpaths);\r\n\treturn {text:text,file:fileid,seg:segid,segname:segnames[segid]};\r\n}\r\n\r\nvar getRange=function(engine,start,end,cb) {\r\n\tvar fileoffsets=engine.get(\"fileoffsets\");\r\n\t//var pagepaths=[\"fileContents\",];\r\n\t//find first page and last page\r\n\t//create get paths\r\n\r\n}\r\n\r\nvar getFile=function(engine,fileid,cb) {\r\n\tvar filename=engine.get(\"filenames\")[fileid];\r\n\tvar segnames=engine.getFileSegNames(fileid);\r\n\tvar filestart=engine.get(\"fileoffsets\")[fileid];\r\n\tvar offsets=engine.getFileSegOffsets(fileid);\r\n\tvar pc=0;\r\n\tengine.get([\"fileContents\",fileid],true,function(data){\r\n\t\tvar text=data.map(function(t,idx) {\r\n\t\t\tif (idx==0) return \"\"; \r\n\t\t\tvar pb='<pb n=\"'+segnames[idx]+'\"></pb>';\r\n\t\t\treturn pb+t;\r\n\t\t});\r\n\t\tcb({texts:data,text:text.join(\"\"),segnames:segnames,filestart:filestart,offsets:offsets,file:fileid,filename:filename}); //force different token\r\n\t});\r\n}\r\n\r\nvar highlightRange=function(Q,startvpos,endvpos,opts,cb){\r\n\t//not implement yet\r\n}\r\n\r\nvar highlightFile=function(Q,fileid,opts,cb) {\r\n\tif (typeof opts==\"function\") {\r\n\t\tcb=opts;\r\n\t}\r\n\r\n\tif (!Q || !Q.engine) return cb(null);\r\n\r\n\tvar segoffsets=Q.engine.getFileSegOffsets(fileid);\r\n\tvar output=[];\t\r\n\t//console.log(startvpos,endvpos)\r\n\tQ.engine.get([\"filecontents\",fileid],true,function(data){\r\n\t\tif (!data) {\r\n\t\t\tconsole.error(\"wrong file id\",fileid);\r\n\t\t} else {\r\n\t\t\tfor (var i=0;i<data.length-1;i++ ){\r\n\t\t\t\tvar startvpos=segoffsets[i];\r\n\t\t\t\tvar endvpos=segoffsets[i+1];\r\n\t\t\t\tvar segnames=Q.engine.getFileSegNames(fileid);\r\n\t\t\t\tvar seg=getSegSync(Q.engine, fileid,i+1);\r\n\t\t\t\tvar opt={text:seg.text,hits:null,tag:'hl',vpos:startvpos,\r\n\t\t\t\t\tfulltext:true,nospan:opts.nospan,nocrlf:opts.nocrlf};\r\n\t\t\t\tvar segname=segnames[i+1];\r\n\t\t\t\topt.hits=hitInRange(Q,startvpos,endvpos);\r\n\t\t\t\tvar pb='<pb n=\"'+segname+'\"></pb>';\r\n\t\t\t\tvar withtag=injectTag(Q,opt);\r\n\t\t\t\toutput.push(pb+withtag);\r\n\t\t\t}\t\t\t\r\n\t\t}\r\n\r\n\t\tcb.apply(Q.engine.context,[{text:output.join(\"\"),file:fileid}]);\r\n\t})\r\n}\r\nvar highlightSeg=function(Q,fileid,segid,opts,cb,context) {\r\n\tif (typeof opts==\"function\") {\r\n\t\tcb=opts;\r\n\t}\r\n\r\n\tif (!Q || !Q.engine) return cb.apply(context,[null]);\r\n\tvar segoffsets=Q.engine.getFileSegOffsets(fileid);\r\n\tvar startvpos=segoffsets[segid-1];\r\n\tvar endvpos=segoffsets[segid];\r\n\tvar segnames=Q.engine.getFileSegNames(fileid);\r\n\r\n\tthis.getSeg(Q.engine,fileid,segid,function(res){\r\n\t\tvar opt={text:res.text,hits:null,vpos:startvpos,fulltext:true,\r\n\t\t\tnospan:opts.nospan,nocrlf:opts.nocrlf};\r\n\t\t\topt.hits=hitInRange(Q,startvpos,endvpos);\r\n\t\t\tif (opts.renderTags) {\r\n\t\t\t\topt.tags=tagsInRange(Q,opts.renderTags,startvpos,endvpos);\r\n\t\t\t}\r\n\r\n\t\tvar segname=segnames[segid];\r\n\t\tcb.apply(context||Q.engine.context,[{text:injectTag(Q,opt),seg:segid,file:fileid,hits:opt.hits,segname:segname}]);\r\n\t});\r\n}\r\nmodule.exports={resultlist:resultlist, \r\n\thitInRange:hitInRange, \r\n\thighlightSeg:highlightSeg,\r\n\tgetSeg:getSeg,\r\n\thighlightFile:highlightFile,\r\n\tgetFile:getFile\r\n\t//highlightRange:highlightRange,\r\n  //getRange:getRange,\r\n};",
    "/*\r\n  Ksana Search Engine.\r\n\r\n  need a KDE instance to be functional\r\n  \r\n*/\r\nvar bsearch=require(\"./bsearch\");\r\nvar dosearch=require(\"./search\");\r\n\r\nvar prepareEngineForSearch=function(engine,cb){\r\n\tif (engine.get(\"tokens\") && engine.tokenizer) {\r\n\t\tcb();\r\n\t\treturn;\r\n\t}\r\n\r\n\tengine.get([[\"tokens\"],[\"postingslength\"]],function(){\r\n\t\tif (!engine.analyzer) {\r\n\t\t\tvar analyzer=require(\"ksana-analyzer\");\r\n\t\t\tvar config=engine.get(\"meta\").config;\r\n\t\t\tengine.analyzer=analyzer.getAPI(config);\t\t\t\r\n\t\t}\r\n\t\tcb();\r\n\t});\r\n}\r\n\r\nvar _search=function(engine,q,opts,cb,context) {\r\n\tif (typeof engine==\"string\") {//browser only\r\n\t\tvar kde=require(\"ksana-database\");\r\n\t\tif (typeof opts==\"function\") { //user didn't supply options\r\n\t\t\tif (typeof cb==\"object\")context=cb;\r\n\t\t\tcb=opts;\r\n\t\t\topts={};\r\n\t\t}\r\n\t\topts.q=q;\r\n\t\topts.dbid=engine;\r\n\t\tkde.open(opts.dbid,function(err,db){\r\n\t\t\tif (err) {\r\n\t\t\t\tcb(err);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tprepareEngineForSearch(db,function(){\r\n\t\t\t\treturn dosearch(db,q,opts,cb);\t\r\n\t\t\t});\r\n\t\t},context);\r\n\t} else {\r\n\t\tprepareEngineForSearch(engine,function(){\r\n\t\t\treturn dosearch(engine,q,opts,cb);\t\r\n\t\t});\r\n\t}\r\n}\r\n\r\nvar _highlightSeg=function(engine,fileid,segid,opts,cb,context){\r\n\tif (!opts.q) {\r\n\t\tif (!engine.analyzer) {\r\n\t\t\tvar analyzer=require(\"ksana-analyzer\");\r\n\t\t\tvar config=engine.get(\"meta\").config;\r\n\t\t\tengine.analyzer=analyzer.getAPI(config);\t\t\t\r\n\t\t}\r\n\t\tapi.excerpt.getSeg(engine,fileid,segid,opts,cb,context);\r\n\t} else {\r\n\t\t_search(engine,opts.q,opts,function(err,Q){\r\n\t\t\tapi.excerpt.highlightSeg(Q,fileid,segid,opts,cb,context);\r\n\t\t});\t\t\t\r\n\t}\r\n}\r\nvar _highlightRange=function(engine,start,end,opts,cb,context){\r\n\r\n\tif (opts.q) {\r\n\t\t_search(engine,opts.q,opts,function(err,Q){\r\n\t\t\tapi.excerpt.highlightRange(Q,start,end,opts,cb,context);\r\n\t\t});\r\n\t} else {\r\n\t\tprepareEngineForSearch(engine,function(){\r\n\t\t\tapi.excerpt.getRange(engine,start,end,cb,context);\r\n\t\t});\r\n\t}\r\n}\r\nvar _highlightFile=function(engine,fileid,opts,cb){\r\n\tif (!opts.q) opts.q=\"\"; \r\n\t_search(engine,opts.q,opts,function(err,Q){\r\n\t\tapi.excerpt.highlightFile(Q,fileid,opts,cb);\r\n\t});\r\n\t/*\r\n\t} else {\r\n\t\tapi.excerpt.getFile(engine,fileid,function(data) {\r\n\t\t\tcb.apply(engine.context,[data]);\r\n\t\t});\r\n\t}\r\n\t*/\r\n}\r\n\r\nvar api={\r\n\tsearch:_search\r\n//\t,concordance:require(\"./concordance\")\r\n//\t,regex:require(\"./regex\")\r\n\t,highlightSeg:_highlightSeg\r\n\t,highlightFile:_highlightFile\r\n//\t,highlightRange:_highlightRange\r\n\t,excerpt:require(\"./excerpt\")\r\n\t//,vpos2fileseg:vpos2fileseg\r\n}\r\nmodule.exports=api;",
    "\r\nvar unpack = function (ar) { // unpack variable length integer list\r\n  var r = [],\r\n  i = 0,\r\n  v = 0;\r\n  do {\r\n\tvar shift = 0;\r\n\tdo {\r\n\t  v += ((ar[i] & 0x7F) << shift);\r\n\t  shift += 7;\r\n\t} while (ar[++i] & 0x80);\r\n\tr[r.length]=v;\r\n  } while (i < ar.length);\r\n  return r;\r\n}\r\n\r\n/*\r\n   arr:  [1,1,1,1,1,1,1,1,1]\r\n   levels: [0,1,1,2,2,0,1,2]\r\n   output: [5,1,3,1,1,3,1,1]\r\n*/\r\n\r\nvar groupsum=function(arr,levels) {\r\n  if (arr.length!=levels.length+1) return null;\r\n  var stack=[];\r\n  var output=new Array(levels.length);\r\n  for (var i=0;i<levels.length;i++) output[i]=0;\r\n  for (var i=1;i<arr.length;i++) { //first one out of toc scope, ignored\r\n    if (stack.length>levels[i-1]) {\r\n      while (stack.length>levels[i-1]) stack.pop();\r\n    }\r\n    stack.push(i-1);\r\n    for (var j=0;j<stack.length;j++) {\r\n      output[stack[j]]+=arr[i];\r\n    }\r\n  }\r\n  return output;\r\n}\r\n/* arr= 1 , 2 , 3 ,4 ,5,6,7 //token posting\r\n  posting= 3 , 5  //tag posting\r\n  out = 3 , 2, 2\r\n*/\r\nvar countbyposting = function (arr, posting) {\r\n  if (!posting.length) return [arr.length];\r\n  var out=[];\r\n  for (var i=0;i<posting.length;i++) out[i]=0;\r\n  out[posting.length]=0;\r\n  var p=0,i=0,lasti=0;\r\n  while (i<arr.length && p<posting.length) {\r\n    if (arr[i]<=posting[p]) {\r\n      while (p<posting.length && i<arr.length && arr[i]<=posting[p]) {\r\n        out[p]++;\r\n        i++;\r\n      }      \r\n    } \r\n    p++;\r\n  }\r\n  out[posting.length] = arr.length-i; //remaining\r\n  return out;\r\n}\r\n\r\nvar groupbyposting=function(arr,gposting) { //relative vpos\r\n  if (!gposting.length) return [arr.length];\r\n  var out=[];\r\n  for (var i=0;i<=gposting.length;i++) out[i]=[];\r\n  \r\n  var p=0,i=0,lasti=0;\r\n  while (i<arr.length && p<gposting.length) {\r\n    if (arr[i]<gposting[p]) {\r\n      while (p<gposting.length && i<arr.length && arr[i]<gposting[p]) {\r\n        var start=0;\r\n        if (p>0) start=gposting[p-1];\r\n        out[p].push(arr[i++]-start);  // relative\r\n      }      \r\n    } \r\n    p++;\r\n  }\r\n  //remaining\r\n  while(i<arr.length) out[out.length-1].push(arr[i++]-gposting[gposting.length-1]);\r\n  return out;\r\n}\r\nvar groupbyposting2=function(arr,gposting) { //absolute vpos\r\n  if (!arr || !arr.length) return [];\r\n  if (!gposting.length) return [arr.length];\r\n  var out=[];\r\n  for (var i=0;i<=gposting.length;i++) out[i]=[];\r\n  \r\n  var p=0,i=0,lasti=0;\r\n  while (i<arr.length && p<gposting.length) {\r\n    if (arr[i]<gposting[p]) {\r\n      while (p<gposting.length && i<arr.length && arr[i]<gposting[p]) {\r\n        var start=0;\r\n        if (p>0) start=gposting[p-1]; //absolute\r\n        out[p].push(arr[i++]);\r\n      }      \r\n    } \r\n    p++;\r\n  }\r\n  //remaining\r\n  while(i<arr.length) out[out.length-1].push(arr[i++]-gposting[gposting.length-1]);\r\n  return out;\r\n}\r\nvar groupbyblock2 = function(ar, ntoken,slotshift,opts) {\r\n  if (!ar.length) return [{},{}];\r\n  \r\n  slotshift = slotshift || 16;\r\n  var g = Math.pow(2,slotshift);\r\n  var i = 0;\r\n  var r = {}, ntokens={};\r\n  var groupcount=0;\r\n  do {\r\n    var group = Math.floor(ar[i] / g) ;\r\n    if (!r[group]) {\r\n      r[group] = [];\r\n      ntokens[group]=[];\r\n      groupcount++;\r\n    }\r\n    r[group].push(ar[i] % g);\r\n    ntokens[group].push(ntoken[i]);\r\n    i++;\r\n  } while (i < ar.length);\r\n  if (opts) opts.groupcount=groupcount;\r\n  return [r,ntokens];\r\n}\r\nvar groupbyslot = function (ar, slotshift, opts) {\r\n  if (!ar.length)\r\n\treturn {};\r\n  \r\n  slotshift = slotshift || 16;\r\n  var g = Math.pow(2,slotshift);\r\n  var i = 0;\r\n  var r = {};\r\n  var groupcount=0;\r\n  do {\r\n\tvar group = Math.floor(ar[i] / g) ;\r\n\tif (!r[group]) {\r\n\t  r[group] = [];\r\n\t  groupcount++;\r\n\t}\r\n\tr[group].push(ar[i] % g);\r\n\ti++;\r\n  } while (i < ar.length);\r\n  if (opts) opts.groupcount=groupcount;\r\n  return r;\r\n}\r\n/*\r\nvar identity = function (value) {\r\n  return value;\r\n};\r\nvar sortedIndex = function (array, obj, iterator) { //taken from underscore\r\n  iterator || (iterator = identity);\r\n  var low = 0,\r\n  high = array.length;\r\n  while (low < high) {\r\n\tvar mid = (low + high) >> 1;\r\n\titerator(array[mid]) < iterator(obj) ? low = mid + 1 : high = mid;\r\n  }\r\n  return low;\r\n};*/\r\n\r\nvar indexOfSorted = function (array, obj) { \r\n  var low = 0,\r\n  high = array.length-1;\r\n  while (low < high) {\r\n    var mid = (low + high) >> 1;\r\n    array[mid] < obj ? low = mid + 1 : high = mid;\r\n  }\r\n  return low;\r\n};\r\nvar plhead=function(pl, pltag, opts) {\r\n  opts=opts||{};\r\n  opts.max=opts.max||1;\r\n  var out=[];\r\n  if (pltag.length<pl.length) {\r\n    for (var i=0;i<pltag.length;i++) {\r\n       k = indexOfSorted(pl, pltag[i]);\r\n       if (k>-1 && k<pl.length) {\r\n        if (pl[k]==pltag[i]) {\r\n          out[out.length]=pltag[i];\r\n          if (out.length>=opts.max) break;\r\n        }\r\n      }\r\n    }\r\n  } else {\r\n    for (var i=0;i<pl.length;i++) {\r\n       k = indexOfSorted(pltag, pl[i]);\r\n       if (k>-1 && k<pltag.length) {\r\n        if (pltag[k]==pl[i]) {\r\n          out[out.length]=pltag[k];\r\n          if (out.length>=opts.max) break;\r\n        }\r\n      }\r\n    }\r\n  }\r\n  return out;\r\n}\r\n/*\r\n pl2 occur after pl1, \r\n pl2>=pl1+mindis\r\n pl2<=pl1+maxdis\r\n*/\r\nvar plfollow2 = function (pl1, pl2, mindis, maxdis) {\r\n  var r = [],i=0;\r\n  var swap = 0;\r\n  \r\n  while (i<pl1.length){\r\n    var k = indexOfSorted(pl2, pl1[i] + mindis);\r\n    var t = (pl2[k] >= (pl1[i] +mindis) && pl2[k]<=(pl1[i]+maxdis)) ? k : -1;\r\n    if (t > -1) {\r\n      r[r.length]=pl1[i];\r\n      i++;\r\n    } else {\r\n      if (k>=pl2.length) break;\r\n      var k2=indexOfSorted (pl1,pl2[k]-maxdis);\r\n      if (k2>i) {\r\n        var t = (pl2[k] >= (pl1[i] +mindis) && pl2[k]<=(pl1[i]+maxdis)) ? k : -1;\r\n        if (t>-1) r[r.length]=pl1[k2];\r\n        i=k2;\r\n      } else break;\r\n    }\r\n  }\r\n  return r;\r\n}\r\n\r\nvar plnotfollow2 = function (pl1, pl2, mindis, maxdis) {\r\n  var r = [],i=0;\r\n  \r\n  while (i<pl1.length){\r\n    var k = indexOfSorted(pl2, pl1[i] + mindis);\r\n    var t = (pl2[k] >= (pl1[i] +mindis) && pl2[k]<=(pl1[i]+maxdis)) ? k : -1;\r\n    if (t > -1) {\r\n      i++;\r\n    } else {\r\n      if (k>=pl2.length) {\r\n        r=r.concat(pl1.slice(i));\r\n        break;\r\n      } else {\r\n        var k2=indexOfSorted (pl1,pl2[k]-maxdis);\r\n        if (k2>i) {\r\n          r=r.concat(pl1.slice(i,k2));\r\n          i=k2;\r\n        } else break;\r\n      }\r\n    }\r\n  }\r\n  return r;\r\n}\r\n/* this is incorrect */\r\nvar plfollow = function (pl1, pl2, distance) {\r\n  var r = [],i=0;\r\n\r\n  while (i<pl1.length){\r\n    var k = indexOfSorted(pl2, pl1[i] + distance);\r\n    var t = (pl2[k] === (pl1[i] + distance)) ? k : -1;\r\n    if (t > -1) {\r\n      r.push(pl1[i]);\r\n      i++;\r\n    } else {\r\n      if (k>=pl2.length) break;\r\n      var k2=indexOfSorted (pl1,pl2[k]-distance);\r\n      if (k2>i) {\r\n        t = (pl2[k] === (pl1[k2] + distance)) ? k : -1;\r\n        if (t>-1) {\r\n           r.push(pl1[k2]);\r\n           k2++;\r\n        }\r\n        i=k2;\r\n      } else break;\r\n    }\r\n  }\r\n  return r;\r\n}\r\nvar plnotfollow = function (pl1, pl2, distance) {\r\n  var r = [];\r\n  var r = [],i=0;\r\n  var swap = 0;\r\n  \r\n  while (i<pl1.length){\r\n    var k = indexOfSorted(pl2, pl1[i] + distance);\r\n    var t = (pl2[k] === (pl1[i] + distance)) ? k : -1;\r\n    if (t > -1) { \r\n      i++;\r\n    } else {\r\n      if (k>=pl2.length) {\r\n        r=r.concat(pl1.slice(i));\r\n        break;\r\n      } else {\r\n        var k2=indexOfSorted (pl1,pl2[k]-distance);\r\n        if (k2>i) {\r\n          r=r.concat(pl1.slice(i,k2));\r\n          i=k2;\r\n        } else break;\r\n      }\r\n    }\r\n  }\r\n  return r;\r\n}\r\nvar pland = function (pl1, pl2, distance) {\r\n  var r = [];\r\n  var swap = 0;\r\n  \r\n  if (pl1.length > pl2.length) { //swap for faster compare\r\n    var t = pl2;\r\n    pl2 = pl1;\r\n    pl1 = t;\r\n    swap = distance;\r\n    distance = -distance;\r\n  }\r\n  for (var i = 0; i < pl1.length; i++) {\r\n    var k = indexOfSorted(pl2, pl1[i] + distance);\r\n    var t = (pl2[k] === (pl1[i] + distance)) ? k : -1;\r\n    if (t > -1) {\r\n      r.push(pl1[i] - swap);\r\n    }\r\n  }\r\n  return r;\r\n}\r\nvar combine=function (postings) {\r\n  var out=[];\r\n  for (var i in postings) {\r\n    out=out.concat(postings[i]);\r\n  }\r\n  out.sort(function(a,b){return a-b});\r\n  return out;\r\n}\r\n\r\nvar unique = function(ar){\r\n   if (!ar || !ar.length) return [];\r\n   var u = {}, a = [];\r\n   for(var i = 0, l = ar.length; i < l; ++i){\r\n    if(u.hasOwnProperty(ar[i])) continue;\r\n    a.push(ar[i]);\r\n    u[ar[i]] = 1;\r\n   }\r\n   return a;\r\n}\r\n\r\n\r\n\r\nvar plphrase = function (postings,ops) {\r\n  var r = [];\r\n  for (var i=0;i<postings.length;i++) {\r\n  \tif (!postings[i])  return [];\r\n  \tif (0 === i) {\r\n  \t  r = postings[0];\r\n  \t} else {\r\n      if (ops[i]=='andnot') {\r\n        r = plnotfollow(r, postings[i], i);  \r\n      }else {\r\n        r = pland(r, postings[i], i);  \r\n      }\r\n  \t}\r\n  }\r\n  \r\n  return r;\r\n}\r\n//return an array of group having any of pl item\r\nvar matchPosting=function(pl,gupl,start,end) {\r\n  start=start||0;\r\n  end=end||-1;\r\n  if (end==-1) end=Math.pow(2, 53); // max integer value\r\n\r\n  var count=0, i = j= 0,  result = [] ,v=0;\r\n  var docs=[], freq=[];\r\n  if (!pl) return {docs:[],freq:[]};\r\n  while( i < pl.length && j < gupl.length ){\r\n     if (pl[i] < gupl[j] ){ \r\n       count++;\r\n       v=pl[i];\r\n       i++; \r\n     } else {\r\n       if (count) {\r\n        if (v>=start && v<end) {\r\n          docs.push(j);\r\n          freq.push(count);          \r\n        }\r\n       }\r\n       j++;\r\n       count=0;\r\n     }\r\n  }\r\n  if (count && j<gupl.length && v>=start && v<end) {\r\n    docs.push(j);\r\n    freq.push(count);\r\n    count=0;\r\n  }\r\n  else {\r\n    while (j==gupl.length && i<pl.length && pl[i] >= gupl[gupl.length-1]) {\r\n      i++;\r\n      count++;\r\n    }\r\n    if (v>=start && v<end) {\r\n      docs.push(j);\r\n      freq.push(count);      \r\n    }\r\n  } \r\n  return {docs:docs,freq:freq};\r\n}\r\n\r\nvar trim=function(arr,start,end) {\r\n  var s=indexOfSorted(arr,start);\r\n  var e=indexOfSorted(arr,end);\r\n  return arr.slice(s,e+1);\r\n}\r\nvar plist={};\r\nplist.unpack=unpack;\r\nplist.plphrase=plphrase;\r\nplist.plhead=plhead;\r\nplist.plfollow2=plfollow2;\r\nplist.plnotfollow2=plnotfollow2;\r\nplist.plfollow=plfollow;\r\nplist.plnotfollow=plnotfollow;\r\nplist.unique=unique;\r\nplist.indexOfSorted=indexOfSorted;\r\nplist.matchPosting=matchPosting;\r\nplist.trim=trim;\r\n\r\nplist.groupbyslot=groupbyslot;\r\nplist.groupbyblock2=groupbyblock2;\r\nplist.countbyposting=countbyposting;\r\nplist.groupbyposting=groupbyposting;\r\nplist.groupbyposting2=groupbyposting2;\r\nplist.groupsum=groupsum;\r\nplist.combine=combine;\r\nmodule.exports=plist;",
    "/*\r\nvar dosearch2=function(engine,opts,cb,context) {\r\n\topts\r\n\t\tnfile,npage  //return a highlighted page\r\n\t\tnfile,[pages] //return highlighted pages \r\n\t\tnfile        //return entire highlighted file\r\n\t\tabs_npage\r\n\t\t[abs_pages]  //return set of highlighted pages (may cross file)\r\n\r\n\t\tfilename, pagename\r\n\t\tfilename,[pagenames]\r\n\r\n\t\texcerpt      //\r\n\t    sortBy       //default natural, sortby by vsm ranking\r\n\r\n\t//return err,array_of_string ,Q  (Q contains low level search result)\r\n}\r\n\r\n*/\r\n/* TODO sorted tokens */\r\nvar plist=require(\"./plist\");\r\nvar boolsearch=require(\"./boolsearch\");\r\nvar excerpt=require(\"./excerpt\");\r\nvar parseTerm = function(engine,raw,opts) {\r\n\tif (!raw) return;\r\n\tvar res={raw:raw,variants:[],term:'',op:''};\r\n\tvar term=raw, op=0;\r\n\tvar firstchar=term[0];\r\n\tvar termregex=\"\";\r\n\tif (firstchar=='-') {\r\n\t\tterm=term.substring(1);\r\n\t\tfirstchar=term[0];\r\n\t\tres.exclude=true; //exclude\r\n\t}\r\n\tterm=term.trim();\r\n\tvar lastchar=term[term.length-1];\r\n\tterm=engine.analyzer.normalize(term);\r\n\t\r\n\tif (term.indexOf(\"%\")>-1) {\r\n\t\tvar termregex=\"^\"+term.replace(/%+/g,\".+\")+\"$\";\r\n\t\tif (firstchar==\"%\") \ttermregex=\".+\"+termregex.substr(1);\r\n\t\tif (lastchar==\"%\") \ttermregex=termregex.substr(0,termregex.length-1)+\".+\";\r\n\t}\r\n\r\n\tif (termregex) {\r\n\t\tres.variants=expandTerm(engine,termregex);\r\n\t}\r\n\r\n\tres.key=term;\r\n\treturn res;\r\n}\r\nvar expandTerm=function(engine,regex) {\r\n\tvar r=new RegExp(regex);\r\n\tvar tokens=engine.get(\"tokens\");\r\n\tvar postingsLength=engine.get(\"postingslength\");\r\n\tif (!postingsLength) postingsLength=[];\r\n\tvar out=[];\r\n\tfor (var i=0;i<tokens.length;i++) {\r\n\t\tvar m=tokens[i].match(r);\r\n\t\tif (m) {\r\n\t\t\tout.push([m[0],postingsLength[i]||1]);\r\n\t\t}\r\n\t}\r\n\tout.sort(function(a,b){return b[1]-a[1]});\r\n\treturn out;\r\n}\r\nvar isWildcard=function(raw) {\r\n\treturn !!raw.match(/[\\*\\?]/);\r\n}\r\n\r\nvar isOrTerm=function(term) {\r\n\tterm=term.trim();\r\n\treturn (term[term.length-1]===',');\r\n}\r\nvar orterm=function(engine,term,key) {\r\n\t\tvar t={text:key};\r\n\t\tif (engine.analyzer.simplifiedToken) {\r\n\t\t\tt.simplified=engine.analyzer.simplifiedToken(key);\r\n\t\t}\r\n\t\tterm.variants.push(t);\r\n}\r\nvar orTerms=function(engine,tokens,now) {\r\n\tvar raw=tokens[now];\r\n\tvar term=parseTerm(engine,raw);\r\n\tif (!term) return;\r\n\torterm(engine,term,term.key);\r\n\twhile (isOrTerm(raw))  {\r\n\t\traw=tokens[++now];\r\n\t\tvar term2=parseTerm(engine,raw);\r\n\t\torterm(engine,term,term2.key);\r\n\t\tfor (var i in term2.variants){\r\n\t\t\tterm.variants[i]=term2.variants[i];\r\n\t\t}\r\n\t\tterm.key+=','+term2.key;\r\n\t}\r\n\treturn term;\r\n}\r\n\r\nvar getOperator=function(raw) {\r\n\tvar op='';\r\n\tif (raw[0]=='+') op='include';\r\n\tif (raw[0]=='-') op='exclude';\r\n\treturn op;\r\n}\r\nvar parsePhrase=function(q) {\r\n\tvar match=q.match(/(\".+?\"|'.+?'|\\S+)/g)\r\n\tmatch=match.map(function(str){\r\n\t\tvar n=str.length, h=str.charAt(0), t=str.charAt(n-1)\r\n\t\tif (h===t&&(h==='\"'|h===\"'\")) str=str.substr(1,n-2)\r\n\t\treturn str;\r\n\t})\r\n\treturn match;\r\n}\r\nvar tibetanNumber={\r\n\t\"\\u0f20\":\"0\",\"\\u0f21\":\"1\",\"\\u0f22\":\"2\",\t\"\\u0f23\":\"3\",\t\"\\u0f24\":\"4\",\r\n\t\"\\u0f25\":\"5\",\"\\u0f26\":\"6\",\"\\u0f27\":\"7\",\"\\u0f28\":\"8\",\"\\u0f29\":\"9\"\r\n}\r\nvar parseNumber=function(raw) {\r\n\tvar n=parseInt(raw,10);\r\n\tif (isNaN(n)){\r\n\t\tvar converted=[];\r\n\t\tfor (var i=0;i<raw.length;i++) {\r\n\t\t\tvar nn=tibetanNumber[raw[i]];\r\n\t\t\tif (typeof nn !=\"undefined\") converted[i]=nn;\r\n\t\t\telse break;\r\n\t\t}\r\n\t\treturn parseInt(converted,10);\r\n\t} else {\r\n\t\treturn n;\r\n\t}\r\n}\r\nvar parseWildcard=function(raw) {\r\n\tvar n=parseNumber(raw) || 1;\r\n\tvar qcount=raw.split('?').length-1;\r\n\tvar scount=raw.split('*').length-1;\r\n\tvar type='';\r\n\tif (qcount) type='?';\r\n\telse if (scount) type='*';\r\n\treturn {wildcard:type, width: n , op:'wildcard'};\r\n}\r\n\r\nvar newPhrase=function() {\r\n\treturn {termid:[],posting:[],raw:'',termlength:[]};\r\n} \r\nvar parseQuery=function(q,sep) {\r\n\tif (sep && q.indexOf(sep)>-1) {\r\n\t\tvar match=q.split(sep);\r\n\t} else {\r\n\t\tvar match=q.match(/(\".+?\"|'.+?'|\\S+)/g)\r\n\t\tmatch=match.map(function(str){\r\n\t\t\tvar n=str.length, h=str.charAt(0), t=str.charAt(n-1)\r\n\t\t\tif (h===t&&(h==='\"'|h===\"'\")) str=str.substr(1,n-2)\r\n\t\t\treturn str\r\n\t\t})\r\n\t\t//console.log(input,'==>',match)\t\t\r\n\t}\r\n\treturn match;\r\n}\r\nvar loadPhrase=function(phrase) {\r\n\t/* remove leading and ending wildcard */\r\n\tvar Q=this;\r\n\tvar cache=Q.engine.postingCache;\r\n\tif (cache[phrase.key]) {\r\n\t\tphrase.posting=cache[phrase.key];\r\n\t\treturn Q;\r\n\t}\r\n\tif (phrase.termid.length==1) {\r\n\t\tif (!Q.terms.length){\r\n\t\t\tphrase.posting=[];\r\n\t\t} else {\r\n\t\t\tcache[phrase.key]=phrase.posting=Q.terms[phrase.termid[0]].posting;\t\r\n\t\t}\r\n\t\treturn Q;\r\n\t}\r\n\r\n\tvar i=0, r=[],dis=0;\r\n\twhile(i<phrase.termid.length) {\r\n\t  var T=Q.terms[phrase.termid[i]];\r\n\t\tif (0 === i) {\r\n\t\t\tr = T.posting;\r\n\t\t} else {\r\n\t\t    if (T.op=='wildcard') {\r\n\t\t    \tT=Q.terms[phrase.termid[i++]];\r\n\t\t    \tvar width=T.width;\r\n\t\t    \tvar wildcard=T.wildcard;\r\n\t\t    \tT=Q.terms[phrase.termid[i]];\r\n\t\t    \tvar mindis=dis;\r\n\t\t    \tif (wildcard=='?') mindis=dis+width;\r\n\t\t    \tif (T.exclude) r = plist.plnotfollow2(r, T.posting, mindis, dis+width);\r\n\t\t    \telse r = plist.plfollow2(r, T.posting, mindis, dis+width);\t\t    \t\r\n\t\t    \tdis+=(width-1);\r\n\t\t    }else {\r\n\t\t    \tif (T.posting) {\r\n\t\t    \t\tif (T.exclude) r = plist.plnotfollow(r, T.posting, dis);\r\n\t\t    \t\telse r = plist.plfollow(r, T.posting, dis);\r\n\t\t    \t}\r\n\t\t    }\r\n\t\t}\r\n\t\tdis += phrase.termlength[i];\r\n\t\ti++;\r\n\t\tif (!r) return Q;\r\n  }\r\n  phrase.posting=r;\r\n  cache[phrase.key]=r;\r\n  return Q;\r\n}\r\nvar trimSpace=function(engine,query) {\r\n\tif (!query) return \"\";\r\n\tvar i=0;\r\n\tvar isSkip=engine.analyzer.isSkip;\r\n\twhile (i<query.length && isSkip(query[i])) i++;\r\n\treturn query.substring(i);\r\n}\r\nvar getSegWithHit=function(fileid,offsets) {\r\n\tvar Q=this,engine=Q.engine;\r\n\tvar segWithHit=plist.groupbyposting2(Q.byFile[fileid ], offsets);\r\n\tif (segWithHit.length) segWithHit.shift(); //the first item is not used (0~Q.byFile[0] )\r\n\tvar out=[];\r\n\tsegWithHit.map(function(p,idx){if (p.length) out.push(idx)});\r\n\treturn out;\r\n}\r\nvar segWithHit=function(fileid) {\r\n\tvar Q=this,engine=Q.engine;\r\n\tvar offsets=engine.getFileSegOffsets(fileid);\r\n\treturn getSegWithHit.apply(this,[fileid,offsets]);\r\n}\r\nvar isSimplePhrase=function(phrase) {\r\n\tvar m=phrase.match(/[\\?%^]/);\r\n\treturn !m;\r\n}\r\n\r\n// 發菩提心   ==> 發菩  提心       2 2   \r\n// 菩提心     ==> 菩提  提心       1 2\r\n// 劫劫       ==> 劫    劫         1 1   // invalid\r\n// 因緣所生道  ==> 因緣  所生   道   2 2 1\r\nvar splitPhrase=function(engine,simplephrase,bigram) {\r\n\tvar bigram=bigram||engine.get(\"meta\").bigram||[];\r\n\tvar tokens=engine.analyzer.tokenize(simplephrase).tokens;\r\n\tvar loadtokens=[],lengths=[],j=0,lastbigrampos=-1;\r\n\twhile (j+1<tokens.length) {\r\n\t\tvar token=engine.analyzer.normalize(tokens[j]);\r\n\t\tvar nexttoken=engine.analyzer.normalize(tokens[j+1]);\r\n\t\tvar bi=token+nexttoken;\r\n\t\tvar i=plist.indexOfSorted(bigram,bi);\r\n\t\tif (bigram[i]==bi) {\r\n\t\t\tloadtokens.push(bi);\r\n\t\t\tif (j+3<tokens.length) {\r\n\t\t\t\tlastbigrampos=j;\r\n\t\t\t\tj++;\r\n\t\t\t} else {\r\n\t\t\t\tif (j+2==tokens.length){ \r\n\t\t\t\t\tif (lastbigrampos+1==j ) {\r\n\t\t\t\t\t\tlengths[lengths.length-1]--;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tlastbigrampos=j;\r\n\t\t\t\t\tj++;\r\n\t\t\t\t}else {\r\n\t\t\t\t\tlastbigrampos=j;\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tlengths.push(2);\r\n\t\t} else {\r\n\t\t\tif (!bigram || lastbigrampos==-1 || lastbigrampos+1!=j) {\r\n\t\t\t\tloadtokens.push(token);\r\n\t\t\t\tlengths.push(1);\t\t\t\t\r\n\t\t\t}\r\n\t\t}\r\n\t\tj++;\r\n\t}\r\n\r\n\twhile (j<tokens.length) {\r\n\t\tvar token=engine.analyzer.normalize(tokens[j]);\r\n\t\tloadtokens.push(token);\r\n\t\tlengths.push(1);\r\n\t\tj++;\r\n\t}\r\n\r\n\treturn {tokens:loadtokens, lengths: lengths , tokenlength: tokens.length};\r\n}\r\n/* host has fast native function */\r\nvar fastPhrase=function(engine,phrase) {\r\n\tvar phrase_term=newPhrase();\r\n\t//var tokens=engine.analyzer.tokenize(phrase).tokens;\r\n\tvar splitted=splitPhrase(engine,phrase);\r\n\r\n\tvar paths=postingPathFromTokens(engine,splitted.tokens);\r\n//create wildcard\r\n\r\n\tphrase_term.width=splitted.tokenlength; //for excerpt.js to getPhraseWidth\r\n\r\n\tengine.get(paths,{address:true},function(postingAddress){ //this is sync\r\n\t\tphrase_term.key=phrase;\r\n\t\tvar postingAddressWithWildcard=[];\r\n\t\tfor (var i=0;i<postingAddress.length;i++) {\r\n\t\t\tpostingAddressWithWildcard.push(postingAddress[i]);\r\n\t\t\tif (splitted.lengths[i]>1) {\r\n\t\t\t\tpostingAddressWithWildcard.push([splitted.lengths[i],0]); //wildcard has blocksize==0 \r\n\t\t\t}\r\n\t\t}\r\n\t\tengine.postingCache[phrase]=engine.mergePostings(postingAddressWithWildcard);\r\n\t});\r\n\treturn phrase_term;\r\n\t// put posting into cache[phrase.key]\r\n}\r\nvar slowPhrase=function(engine,terms,phrase) {\r\n\tvar j=0,tokens=engine.analyzer.tokenize(phrase).tokens;\r\n\tvar phrase_term=newPhrase();\r\n\tvar termid=0;\r\n\twhile (j<tokens.length) {\r\n\t\tvar raw=tokens[j], termlength=1;\r\n\t\tif (isWildcard(raw)) {\r\n\t\t\tif (phrase_term.termid.length==0)  { //skip leading wild card\r\n\t\t\t\tj++\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\tterms.push(parseWildcard(raw));\r\n\t\t\ttermid=terms.length-1;\r\n\t\t\tphrase_term.termid.push(termid);\r\n\t\t\tphrase_term.termlength.push(termlength);\r\n\t\t} else if (isOrTerm(raw)){\r\n\t\t\tvar term=orTerms.apply(this,[tokens,j]);\r\n\t\t\tif (term) {\r\n\t\t\t\tterms.push(term);\r\n\t\t\t\ttermid=terms.length-1;\r\n\t\t\t\tj+=term.key.split(',').length-1;\t\t\t\t\t\r\n\t\t\t}\r\n\t\t\tj++;\r\n\t\t\tphrase_term.termid.push(termid);\r\n\t\t\tphrase_term.termlength.push(termlength);\r\n\t\t} else {\r\n\t\t\tvar phrase=\"\";\r\n\t\t\twhile (j<tokens.length) {\r\n\t\t\t\tif (!(isWildcard(tokens[j]) || isOrTerm(tokens[j]))) {\r\n\t\t\t\t\tphrase+=tokens[j];\r\n\t\t\t\t\tj++;\r\n\t\t\t\t} else break;\r\n\t\t\t}\r\n\r\n\t\t\tvar splitted=splitPhrase(engine,phrase);\r\n\t\t\tfor (var i=0;i<splitted.tokens.length;i++) {\r\n\t\t\t\tvar term=parseTerm(engine,splitted.tokens[i]);\r\n\t\t\t\tif (!term) continue;\r\n\t\t\t\tvar termidx=terms.map(function(a){return a.key}).indexOf(term.key);\r\n\t\t\t\tif (termidx==-1) {\r\n\t\t\t\t\tterms.push(term);\r\n\t\t\t\t\ttermid=terms.length-1;\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttermid=termidx;\r\n\t\t\t\t}\t\t\t\t\r\n\t\t\t\tphrase_term.termid.push(termid);\r\n\t\t\t\tphrase_term.termlength.push(splitted.lengths[i]);\r\n\t\t\t}\r\n\t\t}\r\n\t\tj++;\r\n\t}\r\n\tphrase_term.key=phrase;\r\n\t//remove ending wildcard\r\n\tvar P=phrase_term , T=null;\r\n\tdo {\r\n\t\tT=terms[P.termid[P.termid.length-1]];\r\n\t\tif (!T) break;\r\n\t\tif (T.wildcard) P.termid.pop(); else break;\r\n\t} while(T);\t\t\r\n\treturn phrase_term;\r\n}\r\nvar newQuery =function(engine,query,opts) {\r\n\t//if (!query) return;\r\n\topts=opts||{};\r\n\tquery=trimSpace(engine,query);\r\n\r\n\tvar phrases=query,phrases=[];\r\n\tif (typeof query=='string' && query) {\r\n\t\tphrases=parseQuery(query,opts.phrase_sep || \"\");\r\n\t}\r\n\t\r\n\tvar phrase_terms=[], terms=[],variants=[],operators=[];\r\n\tvar pc=0;//phrase count\r\n\tfor  (var i=0;i<phrases.length;i++) {\r\n\t\tvar op=getOperator(phrases[pc]);\r\n\t\tif (op) phrases[pc]=phrases[pc].substring(1);\r\n\r\n\t\t/* auto add + for natural order ?*/\r\n\t\t//if (!opts.rank && op!='exclude' &&i) op='include';\r\n\t\toperators.push(op);\r\n\r\n\t\tif (isSimplePhrase(phrases[pc]) && engine.mergePostings ) {\r\n\t\t\tvar phrase_term=fastPhrase(engine,phrases[pc]);\r\n\t\t} else {\r\n\t\t\tvar phrase_term=slowPhrase(engine,terms,phrases[pc]);\r\n\t\t}\r\n\t\tphrase_terms.push(phrase_term);\r\n\r\n\t\tif (!engine.mergePostings && phrase_terms[pc].termid.length==0) {\r\n\t\t\tphrase_terms.pop();\r\n\t\t} else pc++;\r\n\t}\r\n\topts.op=operators;\r\n\r\n\tvar Q={dbname:engine.dbname,engine:engine,opts:opts,query:query,\r\n\t\tphrases:phrase_terms,terms:terms\r\n\t};\r\n\tQ.tokenize=function() {return engine.analyzer.tokenize.apply(engine,arguments);}\r\n\tQ.isSkip=function() {return engine.analyzer.isSkip.apply(engine,arguments);}\r\n\tQ.normalize=function() {return engine.analyzer.normalize.apply(engine,arguments);}\r\n\tQ.segWithHit=segWithHit;\r\n\r\n\t//Q.getRange=function() {return that.getRange.apply(that,arguments)};\r\n\t//API.queryid='Q'+(Math.floor(Math.random()*10000000)).toString(16);\r\n\treturn Q;\r\n}\r\nvar postingPathFromTokens=function(engine,tokens) {\r\n\tvar alltokens=engine.get(\"tokens\");\r\n\r\n\tvar tokenIds=tokens.map(function(t){ return 1+alltokens.indexOf(t)});\r\n\tvar postingid=[];\r\n\tfor (var i=0;i<tokenIds.length;i++) {\r\n\t\tpostingid.push( tokenIds[i]); // tokenId==0 , empty token\r\n\t}\r\n\treturn postingid.map(function(t){return [\"postings\",t]});\r\n}\r\nvar loadPostings=function(engine,tokens,cb) {\r\n\tvar toloadtokens=tokens.filter(function(t){\r\n\t\treturn !engine.postingCache[t.key]; //already in cache\r\n\t});\r\n\tif (toloadtokens.length==0) {\r\n\t\tcb();\r\n\t\treturn;\r\n\t}\r\n\tvar postingPaths=postingPathFromTokens(engine,tokens.map(function(t){return t.key}));\r\n\tengine.get(postingPaths,function(postings){\r\n\t\tpostings.map(function(p,i) { tokens[i].posting=p });\r\n\t\tif (cb) cb();\r\n\t});\r\n}\r\nvar groupBy=function(Q,posting) {\r\n\tphrases.forEach(function(P){\r\n\t\tvar key=P.key;\r\n\t\tvar docfreq=docfreqcache[key];\r\n\t\tif (!docfreq) docfreq=docfreqcache[key]={};\r\n\t\tif (!docfreq[that.groupunit]) {\r\n\t\t\tdocfreq[that.groupunit]={doclist:null,freq:null};\r\n\t\t}\t\t\r\n\t\tif (P.posting) {\r\n\t\t\tvar res=matchPosting(engine,P.posting);\r\n\t\t\tP.freq=res.freq;\r\n\t\t\tP.docs=res.docs;\r\n\t\t} else {\r\n\t\t\tP.docs=[];\r\n\t\t\tP.freq=[];\r\n\t\t}\r\n\t\tdocfreq[that.groupunit]={doclist:P.docs,freq:P.freq};\r\n\t});\r\n\treturn this;\r\n}\r\nvar groupByFolder=function(engine,filehits) {\r\n\tvar files=engine.get(\"filenames\");\r\n\tvar prevfolder=\"\",hits=0,out=[];\r\n\tfor (var i=0;i<filehits.length;i++) {\r\n\t\tvar fn=files[i];\r\n\t\tvar folder=fn.substring(0,fn.indexOf('/'));\r\n\t\tif (prevfolder && prevfolder!=folder) {\r\n\t\t\tout.push(hits);\r\n\t\t\thits=0;\r\n\t\t}\r\n\t\thits+=filehits[i].length;\r\n\t\tprevfolder=folder;\r\n\t}\r\n\tout.push(hits);\r\n\treturn out;\r\n}\r\nvar phrase_intersect=function(engine,Q) {\r\n\tvar intersected=null;\r\n\tvar fileoffsets=Q.engine.get(\"fileoffsets\");\r\n\tvar empty=[],emptycount=0,hashit=0;\r\n\tfor (var i=0;i<Q.phrases.length;i++) {\r\n\t\tvar byfile=plist.groupbyposting2(Q.phrases[i].posting,fileoffsets);\r\n\t\tif (byfile.length) byfile.shift();\r\n\t\tif (byfile.length) byfile.pop();\r\n\t\tbyfile.pop();\r\n\t\tif (intersected==null) {\r\n\t\t\tintersected=byfile;\r\n\t\t} else {\r\n\t\t\tfor (var j=0;j<byfile.length;j++) {\r\n\t\t\t\tif (!(byfile[j].length && intersected[j] && intersected[j].length)) {\r\n\t\t\t\t\tintersected[j]=empty; //reuse empty array\r\n\t\t\t\t\temptycount++;\r\n\t\t\t\t} else hashit++;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tQ.byFile=intersected;\r\n\tQ.byFolder=groupByFolder(engine,Q.byFile);\r\n\tvar out=[];\r\n\t//calculate new rawposting\r\n\tfor (var i=0;i<Q.byFile.length;i++) {\r\n\t\tif (Q.byFile[i].length) out=out.concat(Q.byFile[i]);\r\n\t}\r\n\tQ.rawresult=out;\r\n\tcountFolderFile(Q);\r\n}\r\nvar countFolderFile=function(Q) {\r\n\tQ.fileWithHitCount=0;\r\n\tQ.byFile.map(function(f){if (f.length) Q.fileWithHitCount++});\r\n\t\t\t\r\n\tQ.folderWithHitCount=0;\r\n\tQ.byFolder.map(function(f){if (f) Q.folderWithHitCount++});\r\n}\r\n\r\nvar main=function(engine,q,opts,cb){\r\n\r\n\tvar starttime=new Date();\r\n\tvar meta=engine.get(\"meta\");\r\n\tif (meta.normalize && engine.analyzer.setNormalizeTable) {\r\n\t\tmeta.normalizeObj=engine.analyzer.setNormalizeTable(meta.normalize,meta.normalizeObj);\r\n\t}\r\n\tif (typeof opts==\"function\") cb=opts;\r\n\topts=opts||{};\r\n\tvar Q=engine.queryCache[q];\r\n\tif (!Q) Q=newQuery(engine,q,opts); \r\n\tif (!Q) {\r\n\t\tengine.searchtime=new Date()-starttime;\r\n\t\tengine.totaltime=engine.searchtime;\r\n\t\tif (engine.context) cb.apply(engine.context,[\"empty result\",{rawresult:[]}]);\r\n\t\telse cb(\"empty result\",{rawresult:[]});\r\n\t\treturn;\r\n\t};\r\n\tengine.queryCache[q]=Q;\r\n\tif (Q.phrases.length) {\r\n\t\t\r\n\t\tloadPostings(engine,Q.terms,function(){\r\n\t\t\tif (!Q.phrases[0].posting) {\r\n\t\t\t\tengine.searchtime=new Date()-starttime;\r\n\t\t\t\tengine.totaltime=engine.searchtime;\r\n\t\t\t\tcb.apply(engine.context,[\"no such posting\",{rawresult:[]}]);\r\n\t\t\t\treturn;\t\t\t\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (!Q.phrases[0].posting.length) { //\r\n\t\t\t\tQ.phrases.forEach(loadPhrase.bind(Q));\r\n\t\t\t}\r\n\t\t\tif (Q.phrases.length==1) {\r\n\t\t\t\tQ.rawresult=Q.phrases[0].posting;\r\n\t\t\t} else {\r\n\t\t\t\tphrase_intersect(engine,Q);\r\n\t\t\t}\r\n\t\t\tvar fileoffsets=Q.engine.get(\"fileoffsets\");\r\n\t\t\t//console.log(\"search opts \"+JSON.stringify(opts));\r\n\r\n\t\t\tif (!Q.byFile && Q.rawresult && !opts.nogroup) {\r\n\t\t\t\tQ.byFile=plist.groupbyposting2(Q.rawresult, fileoffsets);\r\n\t\t\t\tQ.byFile.shift();Q.byFile.pop();\r\n\t\t\t\tQ.byFolder=groupByFolder(engine,Q.byFile);\r\n\r\n\t\t\t\tcountFolderFile(Q);\r\n\t\t\t}\r\n\r\n\t\t\tif (opts.range) {\r\n\t\t\t\tengine.searchtime=new Date()-starttime;\r\n\t\t\t\texcerpt.resultlist(engine,Q,opts,function(data) { \r\n\t\t\t\t\t//console.log(\"excerpt ok\");\r\n\t\t\t\t\tQ.excerpt=data;\r\n\t\t\t\t\tengine.totaltime=new Date()-starttime;\r\n\t\t\t\t\tcb.apply(engine.context,[0,Q]);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tengine.searchtime=new Date()-starttime;\r\n\t\t\t\tengine.totaltime=new Date()-starttime;\r\n\t\t\t\tcb.apply(engine.context,[0,Q]);\r\n\t\t\t}\r\n\t\t});\r\n\t} else { //empty search\r\n\t\tengine.searchtime=new Date()-starttime;\r\n\t\tengine.totaltime=new Date()-starttime;\r\n\t\tcb.apply(engine.context,[0,Q]);\r\n\t};\r\n}\r\n\r\nmain.splitPhrase=splitPhrase; //just for debug\r\nmodule.exports=main;",
    "/*\r\nconvert to pure js\r\nsave -g reactify\r\n*/\r\nvar React=(window&&window.React)||require(\"react\");\r\nvar E=React.createElement;\r\n\r\nvar hasksanagap=(typeof ksanagap!=\"undefined\");\r\nif (hasksanagap && (typeof console==\"undefined\" || typeof console.log==\"undefined\")) {\r\n\t\twindow.console={log:ksanagap.log,error:ksanagap.error,debug:ksanagap.debug,warn:ksanagap.warn};\r\n\t\tconsole.log(\"install console output funciton\");\r\n}\r\n\r\nvar checkfs=function() {\r\n\treturn (navigator && navigator.webkitPersistentStorage) || hasksanagap;\r\n}\r\nvar featurechecks={\r\n\t\"fs\":checkfs\r\n}\r\nvar checkbrowser = React.createClass({\r\n\tgetInitialState:function() {\r\n\r\n\t\tvar missingFeatures=this.getMissingFeatures();\r\n\t\treturn {ready:false, missing:missingFeatures};\r\n\t},\r\n\tgetMissingFeatures:function() {\r\n\t\tvar feature=this.props.feature.split(\",\");\r\n\t\tvar status=[];\r\n\t\tfeature.map(function(f){\r\n\t\t\tvar checker=featurechecks[f];\r\n\t\t\tif (checker) checker=checker();\r\n\t\t\tstatus.push([f,checker]);\r\n\t\t});\r\n\t\treturn status.filter(function(f){return !f[1]});\r\n\t},\r\n\tdownloadbrowser:function() {\r\n\t\twindow.location=\"https://www.google.com/chrome/\"\r\n\t},\r\n\trenderMissing:function() {\r\n\t\tvar showMissing=function(m) {\r\n\t\t\treturn E(\"div\", null, m);\r\n\t\t}\r\n\t\treturn (\r\n\t\t E(\"div\", {ref: \"dialog1\", className: \"modal fade\", \"data-backdrop\": \"static\"}, \r\n\t\t    E(\"div\", {className: \"modal-dialog\"}, \r\n\t\t      E(\"div\", {className: \"modal-content\"}, \r\n\t\t        E(\"div\", {className: \"modal-header\"}, \r\n\t\t          E(\"button\", {type: \"button\", className: \"close\", \"data-dismiss\": \"modal\", \"aria-hidden\": \"true\"}, \"×\"), \r\n\t\t          E(\"h4\", {className: \"modal-title\"}, \"Browser Check\")\r\n\t\t        ), \r\n\t\t        E(\"div\", {className: \"modal-body\"}, \r\n\t\t          E(\"p\", null, \"Sorry but the following feature is missing\"), \r\n\t\t          this.state.missing.map(showMissing)\r\n\t\t        ), \r\n\t\t        E(\"div\", {className: \"modal-footer\"}, \r\n\t\t          E(\"button\", {onClick: this.downloadbrowser, type: \"button\", className: \"btn btn-primary\"}, \"Download Google Chrome\")\r\n\t\t        )\r\n\t\t      )\r\n\t\t    )\r\n\t\t  )\r\n\t\t );\r\n\t},\r\n\trenderReady:function() {\r\n\t\treturn E(\"span\", null, \"browser ok\")\r\n\t},\r\n\trender:function(){\r\n\t\treturn  (this.state.missing.length)?this.renderMissing():this.renderReady();\r\n\t},\r\n\tcomponentDidMount:function() {\r\n\t\tif (!this.state.missing.length) {\r\n\t\t\tthis.props.onReady();\r\n\t\t} else {\r\n\t\t\t$(this.refs.dialog1.getDOMNode()).modal('show');\r\n\t\t}\r\n\t}\r\n});\r\n\r\nmodule.exports=checkbrowser;",
    "\r\nvar userCancel=false;\r\nvar files=[];\r\nvar totalDownloadByte=0;\r\nvar targetPath=\"\";\r\nvar tempPath=\"\";\r\nvar nfile=0;\r\nvar baseurl=\"\";\r\nvar result=\"\";\r\nvar downloading=false;\r\nvar startDownload=function(dbid,_baseurl,_files) { //return download id\r\n\tvar fs     = require(\"fs\");\r\n\tvar path   = require(\"path\");\r\n\r\n\t\r\n\tfiles=_files.split(\"\\uffff\");\r\n\tif (downloading) return false; //only one session\r\n\tuserCancel=false;\r\n\ttotalDownloadByte=0;\r\n\tnextFile();\r\n\tdownloading=true;\r\n\tbaseurl=_baseurl;\r\n\tif (baseurl[baseurl.length-1]!='/')baseurl+='/';\r\n\ttargetPath=ksanagap.rootPath+dbid+'/';\r\n\ttempPath=ksanagap.rootPath+\".tmp/\";\r\n\tresult=\"\";\r\n\treturn true;\r\n}\r\n\r\nvar nextFile=function() {\r\n\tsetTimeout(function(){\r\n\t\tif (nfile==files.length) {\r\n\t\t\tnfile++;\r\n\t\t\tendDownload();\r\n\t\t} else {\r\n\t\t\tdownloadFile(nfile++);\t\r\n\t\t}\r\n\t},100);\r\n}\r\n\r\nvar downloadFile=function(nfile) {\r\n\tvar url=baseurl+files[nfile];\r\n\tvar tmpfilename=tempPath+files[nfile];\r\n\tvar mkdirp = require(\"./mkdirp\");\r\n\tvar fs     = require(\"fs\");\r\n\tvar http   = require(\"http\");\r\n\r\n\tmkdirp.sync(path.dirname(tmpfilename));\r\n\tvar writeStream = fs.createWriteStream(tmpfilename);\r\n\tvar datalength=0;\r\n\tvar request = http.get(url, function(response) {\r\n\t\tresponse.on('data',function(chunk){\r\n\t\t\twriteStream.write(chunk);\r\n\t\t\ttotalDownloadByte+=chunk.length;\r\n\t\t\tif (userCancel) {\r\n\t\t\t\twriteStream.end();\r\n\t\t\t\tsetTimeout(function(){nextFile();},100);\r\n\t\t\t}\r\n\t\t});\r\n\t\tresponse.on(\"end\",function() {\r\n\t\t\twriteStream.end();\r\n\t\t\tsetTimeout(function(){nextFile();},100);\r\n\t\t});\r\n\t});\r\n}\r\n\r\nvar cancelDownload=function() {\r\n\tuserCancel=true;\r\n\tendDownload();\r\n}\r\nvar verify=function() {\r\n\treturn true;\r\n}\r\nvar endDownload=function() {\r\n\tnfile=files.length+1;//stop\r\n\tresult=\"cancelled\";\r\n\tdownloading=false;\r\n\tif (userCancel) return;\r\n\tvar fs     = require(\"fs\");\r\n\tvar mkdirp = require(\"./mkdirp\");\r\n\r\n\tfor (var i=0;i<files.length;i++) {\r\n\t\tvar targetfilename=targetPath+files[i];\r\n\t\tvar tmpfilename   =tempPath+files[i];\r\n\t\tmkdirp.sync(path.dirname(targetfilename));\r\n\t\tfs.renameSync(tmpfilename,targetfilename);\r\n\t}\r\n\tif (verify()) {\r\n\t\tresult=\"success\";\r\n\t} else {\r\n\t\tresult=\"error\";\r\n\t}\r\n}\r\n\r\nvar downloadedByte=function() {\r\n\treturn totalDownloadByte;\r\n}\r\nvar doneDownload=function() {\r\n\tif (nfile>files.length) return result;\r\n\telse return \"\";\r\n}\r\nvar downloadingFile=function() {\r\n\treturn nfile-1;\r\n}\r\n\r\nvar downloader={startDownload:startDownload, downloadedByte:downloadedByte,\r\n\tdownloadingFile:downloadingFile, cancelDownload:cancelDownload,doneDownload:doneDownload};\r\nmodule.exports=downloader;",
    "/* todo , optional kdb */\r\nvar React=(window&&window.React)||require(\"react\");\r\nvar HtmlFS=require(\"./htmlfs\");\r\nvar html5fs=require(\"./html5fs\");\r\nvar CheckBrowser=require(\"./checkbrowser\");\r\nvar E=React.createElement;\r\n  \r\n\r\nvar FileList = React.createClass({\r\n\tgetInitialState:function() {\r\n\t\treturn {downloading:false,progress:0};\r\n\t},\r\n\tupdatable:function(f) {\r\n        var classes=\"btn btn-warning\";\r\n        if (this.state.downloading) classes+=\" disabled\";\r\n\t\tif (f.hasUpdate) return   E(\"button\", {className: classes, \r\n\t\t\t\"data-filename\": f.filename, \"data-url\": f.url, \r\n\t            onClick: this.download\r\n\t       }, \"Update\")\r\n\t\telse return null;\r\n\t},\r\n\tshowLocal:function(f) {\r\n        var classes=\"btn btn-danger\";\r\n        if (this.state.downloading) classes+=\" disabled\";\r\n\t  return E(\"tr\", null, E(\"td\", null, f.filename), \r\n\t      E(\"td\", null), \r\n\t      E(\"td\", {className: \"pull-right\"}, \r\n\t      this.updatable(f), E(\"button\", {className: classes, \r\n\t               onClick: this.deleteFile, \"data-filename\": f.filename}, \"Delete\")\r\n\t        \r\n\t      )\r\n\t  )\r\n\t},  \r\n\tshowRemote:function(f) { \r\n\t  var classes=\"btn btn-warning\";\r\n\t  if (this.state.downloading) classes+=\" disabled\";\r\n\t  return (E(\"tr\", {\"data-id\": f.filename}, E(\"td\", null, \r\n\t      f.filename), \r\n\t      E(\"td\", null, f.desc), \r\n\t      E(\"td\", null, \r\n\t      E(\"span\", {\"data-filename\": f.filename, \"data-url\": f.url, \r\n\t            className: classes, \r\n\t            onClick: this.download}, \"Download\")\r\n\t      )\r\n\t  ));\r\n\t},\r\n\tshowFile:function(f) {\r\n\t//\treturn <span data-id={f.filename}>{f.url}</span>\r\n\t\treturn (f.ready)?this.showLocal(f):this.showRemote(f);\r\n\t},\r\n\treloadDir:function() {\r\n\t\tthis.props.action(\"reload\");\r\n\t},\r\n\tdownload:function(e) {\r\n\t\tvar url=e.target.dataset[\"url\"];\r\n\t\tvar filename=e.target.dataset[\"filename\"];\r\n\t\tthis.setState({downloading:true,progress:0,url:url});\r\n\t\tthis.userbreak=false;\r\n\t\thtml5fs.download(url,filename,function(){\r\n\t\t\tthis.reloadDir();\r\n\t\t\tthis.setState({downloading:false,progress:1});\r\n\t\t\t},function(progress,total){\r\n\t\t\t\tif (progress==0) {\r\n\t\t\t\t\tthis.setState({message:\"total \"+total})\r\n\t\t\t \t}\r\n\t\t\t \tthis.setState({progress:progress});\r\n\t\t\t \t//if user press abort return true\r\n\t\t\t \treturn this.userbreak;\r\n\t\t\t}\r\n\t\t,this);\r\n\t},\r\n\tdeleteFile:function( e) {\r\n\t\tvar filename=e.target.attributes[\"data-filename\"].value;\r\n\t\tthis.props.action(\"delete\",filename);\r\n\t},\r\n\tallFilesReady:function(e) {\r\n\t\treturn this.props.files.every(function(f){ return f.ready});\r\n\t},\r\n\tdismiss:function() {\r\n\t\t$(this.refs.dialog1.getDOMNode()).modal('hide');\r\n\t\tthis.props.action(\"dismiss\");\r\n\t},\r\n\tabortdownload:function() {\r\n\t\tthis.userbreak=true;\r\n\t},\r\n\tshowProgress:function() {\r\n\t     if (this.state.downloading) {\r\n\t      var progress=Math.round(this.state.progress*100);\r\n\t      return (\r\n\t      \tE(\"div\", null, \r\n\t      \t\"Downloading from \", this.state.url, \r\n\t      E(\"div\", {key: \"progress\", className: \"progress col-md-8\"}, \r\n\t          E(\"div\", {className: \"progress-bar\", role: \"progressbar\", \r\n\t              \"aria-valuenow\": progress, \"aria-valuemin\": \"0\", \r\n\t              \"aria-valuemax\": \"100\", style: {width: progress+\"%\"}}, \r\n\t            progress, \"%\"\r\n\t          )\r\n\t        ), \r\n\t        E(\"button\", {onClick: this.abortdownload, \r\n\t        \tclassName: \"btn btn-danger col-md-4\"}, \"Abort\")\r\n\t        )\r\n\t        );\r\n\t      } else {\r\n\t      \t\tif ( this.allFilesReady() ) {\r\n\t      \t\t\treturn E(\"button\", {onClick: this.dismiss, className: \"btn btn-success\"}, \"Ok\")\r\n\t      \t\t} else return null;\r\n\t      \t\t\r\n\t      }\r\n\t},\r\n\tshowUsage:function() {\r\n\t\tvar percent=this.props.remainPercent;\r\n           return (E(\"div\", null, E(\"span\", {className: \"pull-left\"}, \"Usage:\"), E(\"div\", {className: \"progress\"}, \r\n\t\t  E(\"div\", {className: \"progress-bar progress-bar-success progress-bar-striped\", role: \"progressbar\", style: {width: percent+\"%\"}}, \r\n\t\t    \tpercent+\"%\"\r\n\t\t  )\r\n\t\t)));\r\n\t},\r\n\trender:function() {\r\n\t  \treturn (\r\n\t\tE(\"div\", {ref: \"dialog1\", className: \"modal fade\", \"data-backdrop\": \"static\"}, \r\n\t\t    E(\"div\", {className: \"modal-dialog\"}, \r\n\t\t      E(\"div\", {className: \"modal-content\"}, \r\n\t\t        E(\"div\", {className: \"modal-header\"}, \r\n\t\t          E(\"h4\", {className: \"modal-title\"}, \"File Installer\")\r\n\t\t        ), \r\n\t\t        E(\"div\", {className: \"modal-body\"}, \r\n\t\t        \tE(\"table\", {className: \"table\"}, \r\n\t\t        \tE(\"tbody\", null, \r\n\t\t          \tthis.props.files.map(this.showFile)\r\n\t\t          \t)\r\n\t\t          )\r\n\t\t        ), \r\n\t\t        E(\"div\", {className: \"modal-footer\"}, \r\n\t\t        \tthis.showUsage(), \r\n\t\t           this.showProgress()\r\n\t\t        )\r\n\t\t      )\r\n\t\t    )\r\n\t\t  )\r\n\t\t);\r\n\t},\t\r\n\tcomponentDidMount:function() {\r\n\t\t$(this.refs.dialog1.getDOMNode()).modal('show');\r\n\t}\r\n});\r\n/*TODO kdb check version*/\r\nvar Filemanager = React.createClass({\r\n\tgetInitialState:function() {\r\n\t\tvar quota=this.getQuota();\r\n\t\treturn {browserReady:false,noupdate:true,\trequestQuota:quota,remain:0};\r\n\t},\r\n\tgetQuota:function() {\r\n\t\tvar q=this.props.quota||\"128M\";\r\n\t\tvar unit=q[q.length-1];\r\n\t\tvar times=1;\r\n\t\tif (unit==\"M\") times=1024*1024;\r\n\t\telse if (unit=\"K\") times=1024;\r\n\t\treturn parseInt(q) * times;\r\n\t},\r\n\tmissingKdb:function() {\r\n\t\tif (ksanagap.platform!=\"chrome\") return [];\r\n\t\tvar missing=this.props.needed.filter(function(kdb){\r\n\t\t\tfor (var i in html5fs.files) {\r\n\t\t\t\tif (html5fs.files[i][0]==kdb.filename) return false;\r\n\t\t\t}\r\n\t\t\treturn true;\r\n\t\t},this);\r\n\t\treturn missing;\r\n\t},\r\n\tgetRemoteUrl:function(fn) {\r\n\t\tvar f=this.props.needed.filter(function(f){return f.filename==fn});\r\n\t\tif (f.length ) return f[0].url;\r\n\t},\r\n\tgenFileList:function(existing,missing){\r\n\t\tvar out=[];\r\n\t\tfor (var i in existing) {\r\n\t\t\tvar url=this.getRemoteUrl(existing[i][0]);\r\n\t\t\tout.push({filename:existing[i][0], url :url, ready:true });\r\n\t\t}\r\n\t\tfor (var i in missing) {\r\n\t\t\tout.push(missing[i]);\r\n\t\t}\r\n\t\treturn out;\r\n\t},\r\n\treload:function() {\r\n\t\thtml5fs.readdir(function(files){\r\n  \t\t\tthis.setState({files:this.genFileList(files,this.missingKdb())});\r\n  \t\t},this);\r\n\t },\r\n\tdeleteFile:function(fn) {\r\n\t  html5fs.rm(fn,function(){\r\n\t  \tthis.reload();\r\n\t  },this);\r\n\t},\r\n\tonQuoteOk:function(quota,usage) {\r\n\t\tif (ksanagap.platform!=\"chrome\") {\r\n\t\t\t//console.log(\"onquoteok\");\r\n\t\t\tthis.setState({noupdate:true,missing:[],files:[],autoclose:true\r\n\t\t\t\t,quota:quota,remain:quota-usage,usage:usage});\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t//console.log(\"quote ok\");\r\n\t\tvar files=this.genFileList(html5fs.files,this.missingKdb());\r\n\t\tvar that=this;\r\n\t\tthat.checkIfUpdate(files,function(hasupdate) {\r\n\t\t\tvar missing=this.missingKdb();\r\n\t\t\tvar autoclose=this.props.autoclose;\r\n\t\t\tif (missing.length) autoclose=false;\r\n\t\t\tthat.setState({autoclose:autoclose,\r\n\t\t\t\tquota:quota,usage:usage,files:files,\r\n\t\t\t\tmissing:missing,\r\n\t\t\t\tnoupdate:!hasupdate,\r\n\t\t\t\tremain:quota-usage});\r\n\t\t});\r\n\t},  \r\n\tonBrowserOk:function() {\r\n\t  this.totalDownloadSize();\r\n\t}, \r\n\tdismiss:function() {\r\n\t\tthis.props.onReady(this.state.usage,this.state.quota);\r\n\t\tsetTimeout(function(){\r\n\t\t\tvar modalin=$(\".modal.in\");\r\n\t\t\tif (modalin.modal) modalin.modal('hide');\r\n\t\t},500);\r\n\t}, \r\n\ttotalDownloadSize:function() {\r\n\t\tvar files=this.missingKdb();\r\n\t\tvar taskqueue=[],totalsize=0;\r\n\t\tfor (var i=0;i<files.length;i++) {\r\n\t\t\ttaskqueue.push(\r\n\t\t\t\t(function(idx){\r\n\t\t\t\t\treturn (function(data){\r\n\t\t\t\t\t\tif (!(typeof data=='object' && data.__empty)) totalsize+=data;\r\n\t\t\t\t\t\thtml5fs.getDownloadSize(files[idx].url,taskqueue.shift());\r\n\t\t\t\t\t});\r\n\t\t\t\t})(i)\r\n\t\t\t);\r\n\t\t}\r\n\t\tvar that=this;\r\n\t\ttaskqueue.push(function(data){\t\r\n\t\t\ttotalsize+=data;\r\n\t\t\tsetTimeout(function(){that.setState({requireSpace:totalsize,browserReady:true})},0);\r\n\t\t});\r\n\t\ttaskqueue.shift()({__empty:true});\r\n\t},\r\n\tcheckIfUpdate:function(files,cb) {\r\n\t\tvar taskqueue=[];\r\n\t\tfor (var i=0;i<files.length;i++) {\r\n\t\t\ttaskqueue.push(\r\n\t\t\t\t(function(idx){\r\n\t\t\t\t\treturn (function(data){\r\n\t\t\t\t\t\tif (!(typeof data=='object' && data.__empty)) files[idx-1].hasUpdate=data;\r\n\t\t\t\t\t\thtml5fs.checkUpdate(files[idx].url,files[idx].filename,taskqueue.shift());\r\n\t\t\t\t\t});\r\n\t\t\t\t})(i)\r\n\t\t\t);\r\n\t\t}\r\n\t\tvar that=this;\r\n\t\ttaskqueue.push(function(data){\t\r\n\t\t\tif (files.length) files[files.length-1].hasUpdate=data;\r\n\t\t\tvar hasupdate=files.some(function(f){return f.hasUpdate});\r\n\t\t\tif (cb) cb.apply(that,[hasupdate]);\r\n\t\t});\r\n\t\ttaskqueue.shift()({__empty:true});\r\n\t},\r\n\trender:function(){\r\n    \t\tif (!this.state.browserReady) {   \r\n      \t\t\treturn E(CheckBrowser, {feature: \"fs\", onReady: this.onBrowserOk})\r\n    \t\t} if (!this.state.quota || this.state.remain<this.state.requireSpace) {  \r\n    \t\t\tvar quota=this.state.requestQuota;\r\n    \t\t\tif (this.state.usage+this.state.requireSpace>quota) {\r\n    \t\t\t\tquota=(this.state.usage+this.state.requireSpace)*1.5;\r\n    \t\t\t}\r\n      \t\t\treturn E(HtmlFS, {quota: quota, autoclose: \"true\", onReady: this.onQuoteOk})\r\n      \t\t} else {\r\n\t\t\tif (!this.state.noupdate || this.missingKdb().length || !this.state.autoclose) {\r\n\t\t\t\tvar remain=Math.round((this.state.usage/this.state.quota)*100);\t\t\t\t\r\n\t\t\t\treturn E(FileList, {action: this.action, files: this.state.files, remainPercent: remain})\r\n\t\t\t} else {\r\n\t\t\t\tsetTimeout( this.dismiss ,0);\r\n\t\t\t\treturn E(\"span\", null, \"Success\");\r\n\t\t\t}\r\n      \t\t}\r\n\t},\r\n\taction:function() {\r\n\t  var args = Array.prototype.slice.call(arguments);\r\n\t  var type=args.shift();\r\n\t  var res=null, that=this;\r\n\t  if (type==\"delete\") {\r\n\t    this.deleteFile(args[0]);\r\n\t  }  else if (type==\"reload\") {\r\n\t  \tthis.reload();\r\n\t  } else if (type==\"dismiss\") {\r\n\t  \tthis.dismiss();\r\n\t  }\r\n\t}\r\n});\r\n\r\nmodule.exports=Filemanager;",
    "/* emulate filesystem on html5 browser */\r\nvar get_head=function(url,field,cb){\r\n\tvar xhr = new XMLHttpRequest();\r\n\txhr.open(\"HEAD\", url, true);\r\n\txhr.onreadystatechange = function() {\r\n\t\t\tif (this.readyState == this.DONE) {\r\n\t\t\t\tcb(xhr.getResponseHeader(field));\r\n\t\t\t} else {\r\n\t\t\t\tif (this.status!==200&&this.status!==206) {\r\n\t\t\t\t\tcb(\"\");\r\n\t\t\t\t}\r\n\t\t\t} \r\n\t};\r\n\txhr.send();\t\r\n}\r\nvar get_date=function(url,cb) {\r\n\tget_head(url,\"Last-Modified\",function(value){\r\n\t\tcb(value);\r\n\t});\r\n}\r\nvar get_size=function(url, cb) {\r\n\tget_head(url,\"Content-Length\",function(value){\r\n\t\tcb(parseInt(value));\r\n\t});\r\n};\r\nvar checkUpdate=function(url,fn,cb) {\r\n\tif (!url) {\r\n\t\tcb(false);\r\n\t\treturn;\r\n\t}\r\n\tget_date(url,function(d){\r\n\t\tAPI.fs.root.getFile(fn, {create: false, exclusive: false}, function(fileEntry) {\r\n\t\t\tfileEntry.getMetadata(function(metadata){\r\n\t\t\t\tvar localDate=Date.parse(metadata.modificationTime);\r\n\t\t\t\tvar urlDate=Date.parse(d);\r\n\t\t\t\tcb(urlDate>localDate);\r\n\t\t\t});\r\n\t\t},function(){\r\n\t\t\tcb(false);\r\n\t\t});\r\n\t});\r\n}\r\nvar download=function(url,fn,cb,statuscb,context) {\r\n\t var totalsize=0,batches=null,written=0;\r\n\t var fileEntry=0, fileWriter=0;\r\n\t var createBatches=function(size) {\r\n\t\tvar bytes=1024*1024, out=[];\r\n\t\tvar b=Math.floor(size / bytes);\r\n\t\tvar last=size %bytes;\r\n\t\tfor (var i=0;i<=b;i++) {\r\n\t\t\tout.push(i*bytes);\r\n\t\t}\r\n\t\tout.push(b*bytes+last);\r\n\t\treturn out;\r\n\t }\r\n\t var finish=function() {\r\n\t\t rm(fn,function(){\r\n\t\t\t\tfileEntry.moveTo(fileEntry.filesystem.root, fn,function(){\r\n\t\t\t\t\tsetTimeout( cb.bind(context,false) , 0) ; \r\n\t\t\t\t},function(e){\r\n\t\t\t\t\tconsole.log(\"failed\",e)\r\n\t\t\t\t});\r\n\t\t },this); \r\n\t };\r\n\t\tvar tempfn=\"temp.kdb\";\r\n\t\tvar batch=function(b) {\r\n\t\tvar abort=false;\r\n\t\tvar xhr = new XMLHttpRequest();\r\n\t\tvar requesturl=url+\"?\"+Math.random();\r\n\t\txhr.open('get', requesturl, true);\r\n\t\txhr.setRequestHeader('Range', 'bytes='+batches[b]+'-'+(batches[b+1]-1));\r\n\t\txhr.responseType = 'blob';    \r\n\t\txhr.addEventListener('load', function() {\r\n\t\t\tvar blob=this.response;\r\n\t\t\tfileEntry.createWriter(function(fileWriter) {\r\n\t\t\t\tfileWriter.seek(fileWriter.length);\r\n\t\t\t\tfileWriter.write(blob);\r\n\t\t\t\twritten+=blob.size;\r\n\t\t\t\tfileWriter.onwriteend = function(e) {\r\n\t\t\t\t\tif (statuscb) {\r\n\t\t\t\t\t\tabort=statuscb.apply(context,[ fileWriter.length / totalsize,totalsize ]);\r\n\t\t\t\t\t\tif (abort) setTimeout( cb.bind(context,false) , 0) ;\r\n\t\t\t\t \t}\r\n\t\t\t\t\tb++;\r\n\t\t\t\t\tif (!abort) {\r\n\t\t\t\t\t\tif (b<batches.length-1) setTimeout(batch.bind(context,b),0);\r\n\t\t\t\t\t\telse                    finish();\r\n\t\t\t\t \t}\r\n\t\t\t \t};\r\n\t\t\t}, console.error);\r\n\t\t},false);\r\n\t\txhr.send();\r\n\t}\r\n\r\n\tget_size(url,function(size){\r\n\t\ttotalsize=size;\r\n\t\tif (!size) {\r\n\t\t\tif (cb) cb.apply(context,[false]);\r\n\t\t} else {//ready to download\r\n\t\t\trm(tempfn,function(){\r\n\t\t\t\t batches=createBatches(size);\r\n\t\t\t\t if (statuscb) statuscb.apply(context,[ 0, totalsize ]);\r\n\t\t\t\t API.fs.root.getFile(tempfn, {create: 1, exclusive: false}, function(_fileEntry) {\r\n\t\t\t\t\t\t\tfileEntry=_fileEntry;\r\n\t\t\t\t\t\tbatch(0);\r\n\t\t\t\t });\r\n\t\t\t},this);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nvar readFile=function(filename,cb,context) {\r\n\tAPI.fs.root.getFile(filename, function(fileEntry) {\r\n\t\t\tvar reader = new FileReader();\r\n\t\t\treader.onloadend = function(e) {\r\n\t\t\t\t\tif (cb) cb.apply(cb,[this.result]);\r\n\t\t\t\t};            \r\n\t}, console.error);\r\n}\r\nvar writeFile=function(filename,buf,cb,context){\r\n\tAPI.fs.root.getFile(filename, {create: true, exclusive: true}, function(fileEntry) {\r\n\t\t\tfileEntry.createWriter(function(fileWriter) {\r\n\t\t\t\tfileWriter.write(buf);\r\n\t\t\t\tfileWriter.onwriteend = function(e) {\r\n\t\t\t\t\tif (cb) cb.apply(cb,[buf.byteLength]);\r\n\t\t\t\t};            \r\n\t\t\t}, console.error);\r\n\t}, console.error);\r\n}\r\n\r\nvar readdir=function(cb,context) {\r\n\tvar dirReader = API.fs.root.createReader();\r\n\tvar out=[],that=this;\r\n\tdirReader.readEntries(function(entries) {\r\n\t\tif (entries.length) {\r\n\t\t\tfor (var i = 0, entry; entry = entries[i]; ++i) {\r\n\t\t\t\tif (entry.isFile) {\r\n\t\t\t\t\tout.push([entry.name,entry.toURL ? entry.toURL() : entry.toURI()]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tAPI.files=out;\r\n\t\tif (cb) cb.apply(context,[out]);\r\n\t}, function(){\r\n\t\tif (cb) cb.apply(context,[null]);\r\n\t});\r\n}\r\nvar getFileURL=function(filename) {\r\n\tif (!API.files ) return null;\r\n\tvar file= API.files.filter(function(f){return f[0]==filename});\r\n\tif (file.length) return file[0][1];\r\n}\r\nvar rm=function(filename,cb,context) {\r\n\tvar url=getFileURL(filename);\r\n\tif (url) rmURL(url,cb,context);\r\n\telse if (cb) cb.apply(context,[false]);\r\n}\r\n\r\nvar rmURL=function(filename,cb,context) {\r\n\twebkitResolveLocalFileSystemURL(filename, function(fileEntry) {\r\n\t\tfileEntry.remove(function() {\r\n\t\t\tif (cb) cb.apply(context,[true]);\r\n\t\t}, console.error);\r\n\t},  function(e){\r\n\t\tif (cb) cb.apply(context,[false]);//no such file\r\n\t});\r\n}\r\nfunction errorHandler(e) {\r\n\tconsole.error('Error: ' +e.name+ \" \"+e.message);\r\n}\r\nvar initfs=function(grantedBytes,cb,context) {\r\n\twebkitRequestFileSystem(PERSISTENT, grantedBytes,  function(fs) {\r\n\t\tAPI.fs=fs;\r\n\t\tAPI.quota=grantedBytes;\r\n\t\treaddir(function(){\r\n\t\t\tAPI.initialized=true;\r\n\t\t\tcb.apply(context,[grantedBytes,fs]);\r\n\t\t},context);\r\n\t}, errorHandler);\r\n}\r\nvar init=function(quota,cb,context) {\r\n\tnavigator.webkitPersistentStorage.requestQuota(quota, \r\n\t\t\tfunction(grantedBytes) {\r\n\t\t\t\tinitfs(grantedBytes,cb,context);\r\n\t\t}, errorHandler\r\n\t);\r\n}\r\nvar queryQuota=function(cb,context) {\r\n\tvar that=this;\r\n\tnavigator.webkitPersistentStorage.queryUsageAndQuota( \r\n\t function(usage,quota){\r\n\t\t\tinitfs(quota,function(){\r\n\t\t\t\tcb.apply(context,[usage,quota]);\r\n\t\t\t},context);\r\n\t});\r\n}\r\nvar API={\r\n\tinit:init\r\n\t,readdir:readdir\r\n\t,checkUpdate:checkUpdate\r\n\t,rm:rm\r\n\t,rmURL:rmURL\r\n\t,getFileURL:getFileURL\r\n\t,writeFile:writeFile\r\n\t,readFile:readFile\r\n\t,download:download\r\n\t,get_head:get_head\r\n\t,get_date:get_date\r\n\t,get_size:get_size\r\n\t,getDownloadSize:get_size\r\n\t,queryQuota:queryQuota\r\n}\r\nmodule.exports=API;",
    "var html5fs=require(\"./html5fs\");\r\nvar React=(window&&window.React)||require(\"react\");\r\nvar E=React.createElement;\r\n\r\nvar htmlfs = React.createClass({\r\n\tgetInitialState:function() { \r\n\t\treturn {ready:false, quota:0,usage:0,Initialized:false,autoclose:this.props.autoclose};\r\n\t},\r\n\tinitFilesystem:function() {\r\n\t\tvar quota=this.props.quota||1024*1024*128; // default 128MB\r\n\t\tquota=parseInt(quota);\r\n\t\thtml5fs.init(quota,function(q){\r\n\t\t\tthis.dialog=false;\r\n\t\t\t$(this.refs.dialog1.getDOMNode()).modal('hide');\r\n\t\t\tthis.setState({quota:q,autoclose:true});\r\n\t\t},this);\r\n\t},\r\n\twelcome:function() {\r\n\t\treturn (\r\n\t\tE(\"div\", {ref: \"dialog1\", className: \"modal fade\", id: \"myModal\", \"data-backdrop\": \"static\"}, \r\n\t\t    E(\"div\", {className: \"modal-dialog\"}, \r\n\t\t      E(\"div\", {className: \"modal-content\"}, \r\n\t\t        E(\"div\", {className: \"modal-header\"}, \r\n\t\t          E(\"h4\", {className: \"modal-title\"}, \"Welcome\")\r\n\t\t        ), \r\n\t\t        E(\"div\", {className: \"modal-body\"}, \r\n\t\t          \"Browser will ask for your confirmation.\"\r\n\t\t        ), \r\n\t\t        E(\"div\", {className: \"modal-footer\"}, \r\n\t\t          E(\"button\", {onClick: this.initFilesystem, type: \"button\", \r\n\t\t            className: \"btn btn-primary\"}, \"Initialize File System\")\r\n\t\t        )\r\n\t\t      )\r\n\t\t    )\r\n\t\t  )\r\n\t\t );\r\n\t},\r\n\trenderDefault:function(){\r\n\t\tvar used=Math.floor(this.state.usage/this.state.quota *100);\r\n\t\tvar more=function() {\r\n\t\t\tif (used>50) return E(\"button\", {type: \"button\", className: \"btn btn-primary\"}, \"Allocate More\");\r\n\t\t\telse null;\r\n\t\t}\r\n\t\treturn (\r\n\t\tE(\"div\", {ref: \"dialog1\", className: \"modal fade\", id: \"myModal\", \"data-backdrop\": \"static\"}, \r\n\t\t    E(\"div\", {className: \"modal-dialog\"}, \r\n\t\t      E(\"div\", {className: \"modal-content\"}, \r\n\t\t        E(\"div\", {className: \"modal-header\"}, \r\n\t\t          E(\"h4\", {className: \"modal-title\"}, \"Sandbox File System\")\r\n\t\t        ), \r\n\t\t        E(\"div\", {className: \"modal-body\"}, \r\n\t\t          E(\"div\", {className: \"progress\"}, \r\n\t\t            E(\"div\", {className: \"progress-bar\", role: \"progressbar\", style: {width: used+\"%\"}}, \r\n\t\t               used, \"%\"\r\n\t\t            )\r\n\t\t          ), \r\n\t\t          E(\"span\", null, this.state.quota, \" total , \", this.state.usage, \" in used\")\r\n\t\t        ), \r\n\t\t        E(\"div\", {className: \"modal-footer\"}, \r\n\t\t          E(\"button\", {onClick: this.dismiss, type: \"button\", className: \"btn btn-default\", \"data-dismiss\": \"modal\"}, \"Close\"), \r\n\t\t          more()\r\n\t\t        )\r\n\t\t      )\r\n\t\t    )\r\n\t\t  )\r\n\t\t  );\r\n\t},\r\n\tdismiss:function() {\r\n\t\tvar that=this;\r\n\t\tsetTimeout(function(){\r\n\t\t\tthat.props.onReady(that.state.quota,that.state.usage);\t\r\n\t\t},0);\r\n\t},\r\n\tqueryQuota:function() {\r\n\t\tif (ksanagap.platform==\"chrome\") {\r\n\t\t\thtml5fs.queryQuota(function(usage,quota){\r\n\t\t\t\tthis.setState({usage:usage,quota:quota,initialized:true});\r\n\t\t\t},this);\t\t\t\r\n\t\t} else {\r\n\t\t\tthis.setState({usage:333,quota:1000*1000*1024,initialized:true,autoclose:true});\r\n\t\t}\r\n\t},\r\n\trender:function() {\r\n\t\tvar that=this;\r\n\t\tif (!this.state.quota || this.state.quota<this.props.quota) {\r\n\t\t\tif (this.state.initialized) {\r\n\t\t\t\tthis.dialog=true;\r\n\t\t\t\treturn this.welcome();\t\r\n\t\t\t} else {\r\n\t\t\t\treturn E(\"span\", null, \"checking quota\");\r\n\t\t\t}\t\t\t\r\n\t\t} else {\r\n\t\t\tif (!this.state.autoclose) {\r\n\t\t\t\tthis.dialog=true;\r\n\t\t\t\treturn this.renderDefault(); \r\n\t\t\t}\r\n\t\t\tthis.dismiss();\r\n\t\t\tthis.dialog=false;\r\n\t\t\treturn null;\r\n\t\t}\r\n\t},\r\n\tcomponentDidMount:function() {\r\n\t\tif (!this.state.quota) {\r\n\t\t\tthis.queryQuota();\r\n\r\n\t\t};\r\n\t},\r\n\tcomponentDidUpdate:function() {\r\n\t\tif (this.dialog) $(this.refs.dialog1.getDOMNode()).modal('show');\r\n\t}\r\n});\r\n\r\nmodule.exports=htmlfs;",
    "var ksana={\"platform\":\"remote\"};\r\nif (typeof window!=\"undefined\") {\r\n\twindow.ksana=ksana;\r\n\tif (typeof ksanagap==\"undefined\") {\r\n\t\twindow.ksanagap=require(\"./ksanagap\"); //compatible layer with mobile\r\n\t}\r\n}\r\nif (typeof process !=\"undefined\") {\r\n\tif (process.versions && process.versions[\"node-webkit\"]) {\r\n  \t\tif (typeof nodeRequire!=\"undefined\") ksana.require=nodeRequire;\r\n  \t\tksana.platform=\"node-webkit\";\r\n  \t\twindow.ksanagap.platform=\"node-webkit\";\r\n\t\tvar ksanajs=require(\"fs\").readFileSync(\"ksana.js\",\"utf8\").trim();\r\n\t\tksana.js=JSON.parse(ksanajs.substring(14,ksanajs.length-1));\r\n\t\twindow.kfs=require(\"./kfs\");\r\n  \t}\r\n} else if (typeof chrome!=\"undefined\"){//} && chrome.fileSystem){\r\n//\twindow.ksanagap=require(\"./ksanagap\"); //compatible layer with mobile\r\n\twindow.ksanagap.platform=\"chrome\";\r\n\twindow.kfs=require(\"./kfs_html5\");\r\n\tif(window.location.origin.indexOf(\"//127.0.0.1\")>-1) {\r\n\t\trequire(\"./livereload\")();\r\n\t}\r\n\tksana.platform=\"chrome\";\r\n} else {\r\n\tif (typeof ksanagap!=\"undefined\" && typeof fs!=\"undefined\") {//mobile\r\n\t\tvar ksanajs=fs.readFileSync(\"ksana.js\",\"utf8\").trim(); //android extra \\n at the end\r\n\t\tksana.js=JSON.parse(ksanajs.substring(14,ksanajs.length-1));\r\n\t\tksana.platform=ksanagap.platform;\r\n\t\tif (typeof ksanagap.android !=\"undefined\") {\r\n\t\t\tksana.platform=\"android\";\r\n\t\t}\r\n\t}\r\n}\r\nvar timer=null;\r\nvar React=window.React||require(\"react\");\r\nvar boot=function(appId,cb) {\r\n\tif (typeof React!=\"undefined\") {\r\n\t\tReact.initializeTouchEvents(true);\r\n\t}\r\n\tksana.appId=appId;\r\n\tif (ksanagap.platform==\"chrome\") { //need to wait for jsonp ksana.js\r\n\t\ttimer=setInterval(function(){\r\n\t\t\tif (ksana.ready){\r\n\t\t\t\tclearInterval(timer);\r\n\t\t\t\tif (ksana.js && ksana.js.files && ksana.js.files.length) {\r\n\t\t\t\t\trequire(\"./installkdb\")(ksana.js,cb);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tcb();\t\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},300);\r\n\t} else {\r\n\t\tcb();\r\n\t}\r\n}\r\n\r\nmodule.exports={boot:boot\r\n\t,htmlfs:require(\"./htmlfs\")\r\n\t,html5fs:require(\"./html5fs\")\r\n\t,liveupdate:require(\"./liveupdate\")\r\n\t,fileinstaller:require(\"./fileinstaller\")\r\n\t,downloader:require(\"./downloader\")\r\n\t,installkdb:require(\"./installkdb\")\r\n};",
    "var React=(window&&window.React)||require(\"react\");\r\nvar Fileinstaller=require(\"./fileinstaller\");\r\n\r\nvar getRequire_kdb=function() {\r\n    var required=[];\r\n    ksana.js.files.map(function(f){\r\n      if (f.indexOf(\".kdb\")==f.length-4) {\r\n        var slash=f.lastIndexOf(\"/\");\r\n        if (slash>-1) {\r\n          var dbid=f.substring(slash+1,f.length-4);\r\n          required.push({url:f,dbid:dbid,filename:dbid+\".kdb\"});\r\n        } else {\r\n          var dbid=f.substring(0,f.length-4);\r\n          required.push({url:ksana.js.baseurl+f,dbid:dbid,filename:f});\r\n        }        \r\n      }\r\n    });\r\n    return required;\r\n}\r\nvar callback=null;\r\nvar onReady=function() {\r\n\tcallback();\r\n}\r\nvar openFileinstaller=function(keep) {\r\n\tvar require_kdb=getRequire_kdb().map(function(db){\r\n\t  return {\r\n\t    url:window.location.origin+window.location.pathname.replace(\"index.html\",\"\")+db.dbid+\".kdb\",\r\n\t    dbdb:db.dbid,\r\n\t    filename:db.filename\r\n\t  }\r\n\t})\r\n\treturn React.createElement(Fileinstaller, {quota: \"512M\", autoclose: !keep, needed: require_kdb, \r\n\t                 onReady: onReady});\r\n}\r\nvar installkdb=function(ksanajs,cb,context) {\r\n\tReact.render(openFileinstaller(),document.getElementById(\"main\"));\r\n\tcallback=cb;\r\n}\r\nmodule.exports=installkdb;",
    "//Simulate feature in ksanagap\r\n/* \r\n  runs on node-webkit only\r\n*/\r\n\r\nvar readDir=function(path) { //simulate Ksanagap function\r\n\tvar fs=nodeRequire(\"fs\");\r\n\tpath=path||\"..\";\r\n\tvar dirs=[];\r\n\tif (path[0]==\".\") {\r\n\t\tif (path==\".\") dirs=fs.readdirSync(\".\");\r\n\t\telse {\r\n\t\t\tdirs=fs.readdirSync(\"..\");\r\n\t\t}\r\n\t} else {\r\n\t\tdirs=fs.readdirSync(path);\r\n\t}\r\n\r\n\treturn dirs.join(\"\\uffff\");\r\n}\r\nvar listApps=function() {\r\n\r\n\tvar fs=nodeRequire(\"fs\");\r\n\tvar ksanajsfile=function(d) {return \"../\"+d+\"/ksana.js\"};\r\n\tvar dirs=fs.readdirSync(\"..\").filter(function(d){\r\n\t\t\t\treturn fs.statSync(\"../\"+d).isDirectory() && d[0]!=\".\"\r\n\t\t\t\t   && fs.existsSync(ksanajsfile(d));\r\n\t});\r\n\t\r\n\tvar out=dirs.map(function(d){\r\n\r\n\t\tvar fn=ksanajsfile(d);\r\n\t\tif (!fs.existsSync(fn)) return;\r\n\t\tvar content=fs.readFileSync(fn,\"utf8\");\r\n  \t\tcontent=content.replace(\"})\",\"}\");\r\n  \t\tcontent=content.replace(\"jsonp_handler(\",\"\");\r\n  \t\ttry{\r\n  \t\t\tvar obj= JSON.parse(content);\r\n\t\t\tobj.dbid=d;\r\n\t\t\tobj.path=d;\r\n\t\t\treturn obj;\r\n  \t\t} catch(e) {\r\n  \t\t\tconsole.log(e);\r\n  \t\t\treturn null;\r\n  \t\t}\r\n\t});\r\n\r\n\tout=out.filter(function(o){return !!o});\r\n\treturn JSON.stringify(out);\r\n}\r\n\r\n\r\n\r\nvar kfs={readDir:readDir,listApps:listApps};\r\n\r\nmodule.exports=kfs;",
    "var readDir=function(){\r\n\treturn \"[]\";\r\n}\r\nvar listApps=function(){\r\n\treturn \"[]\";\r\n}\r\nmodule.exports={readDir:readDir,listApps:listApps};",
    "var appname=\"installer\";\r\nvar switchApp=function(path) {\r\n\tvar fs=require(\"fs\");\r\n\tpath=\"../\"+path;\r\n\tappname=path;\r\n\tdocument.location.href= path+\"/index.html\"; \r\n\tprocess.chdir(path);\r\n}\r\nvar downloader={};\r\nvar rootPath=\"\";\r\n\r\nvar deleteApp=function(app) {\r\n\tconsole.error(\"not allow on PC, do it in File Explorer/ Finder\");\r\n}\r\nvar username=function() {\r\n\treturn \"\";\r\n}\r\nvar useremail=function() {\r\n\treturn \"\"\r\n}\r\nvar runtime_version=function() {\r\n\treturn \"1.4\";\r\n}\r\n\r\n//copy from liveupdate\r\nvar jsonp=function(url,dbid,callback,context) {\r\n  var script=document.getElementById(\"jsonp2\");\r\n  if (script) {\r\n    script.parentNode.removeChild(script);\r\n  }\r\n  window.jsonp_handler=function(data) {\r\n    if (typeof data==\"object\") {\r\n      data.dbid=dbid;\r\n      callback.apply(context,[data]);    \r\n    }  \r\n  }\r\n  window.jsonp_error_handler=function() {\r\n    console.error(\"url unreachable\",url);\r\n    callback.apply(context,[null]);\r\n  }\r\n  script=document.createElement('script');\r\n  script.setAttribute('id', \"jsonp2\");\r\n  script.setAttribute('onerror', \"jsonp_error_handler()\");\r\n  url=url+'?'+(new Date().getTime());\r\n  script.setAttribute('src', url);\r\n  document.getElementsByTagName('head')[0].appendChild(script); \r\n}\r\n\r\nvar ksanagap={\r\n\tplatform:\"node-webkit\",\r\n\tstartDownload:downloader.startDownload,\r\n\tdownloadedByte:downloader.downloadedByte,\r\n\tdownloadingFile:downloader.downloadingFile,\r\n\tcancelDownload:downloader.cancelDownload,\r\n\tdoneDownload:downloader.doneDownload,\r\n\tswitchApp:switchApp,\r\n\trootPath:rootPath,\r\n\tdeleteApp: deleteApp,\r\n\tusername:username, //not support on PC\r\n\tuseremail:username,\r\n\truntime_version:runtime_version,\r\n\t\r\n}\r\n\r\nif (typeof process!=\"undefined\" && !process.browser) {\r\n\tvar ksanajs=require(\"fs\").readFileSync(\"./ksana.js\",\"utf8\").trim();\r\n\tdownloader=require(\"./downloader\");\r\n\t//ksana.js=JSON.parse(ksanajs.substring(14,ksanajs.length-1));\r\n\trootPath=process.cwd();\r\n\trootPath=require(\"path\").resolve(rootPath,\"..\").replace(/\\\\/g,\"/\")+'/';\r\n\tksana.ready=true;\r\n} else{\r\n\tvar url=window.location.origin+window.location.pathname.replace(\"index.html\",\"\")+\"ksana.js\";\r\n\tjsonp(url,appname,function(data){\r\n\t\tksana.js=data;\r\n\t\tksana.ready=true;\r\n\t});\r\n}\r\nmodule.exports=ksanagap;",
    "var started=false;\r\nvar timer=null;\r\nvar bundledate=null;\r\nvar get_date=require(\"./html5fs\").get_date;\r\nvar checkIfBundleUpdated=function() {\r\n\tget_date(\"bundle.js\",function(date){\r\n\t\tif (bundledate &&bundledate!=date){\r\n\t\t\tlocation.reload();\r\n\t\t}\r\n\t\tbundledate=date;\r\n\t});\r\n}\r\nvar livereload=function() {\r\n\tif (started) return;\r\n\r\n\ttimer1=setInterval(function(){\r\n\t\tcheckIfBundleUpdated();\r\n\t},2000);\r\n\tstarted=true;\r\n}\r\n\r\nmodule.exports=livereload;",
    "\r\nvar jsonp=function(url,dbid,callback,context) {\r\n  var script=document.getElementById(\"jsonp\");\r\n  if (script) {\r\n    script.parentNode.removeChild(script);\r\n  }\r\n  if (typeof dbid==\"function\") {\r\n    context=callback;\r\n    callback=dbid;\r\n    dbid=\"\";\r\n  }\r\n  window.jsonp_handler=function(data) {\r\n    //console.log(\"receive from ksana.js\",data);\r\n    if (typeof data==\"object\" && dbid) {\r\n      if (typeof data.dbid==\"undefined\") {\r\n        data.dbid=dbid;\r\n      }\r\n    }\r\n    callback.apply(context,[data]);\r\n  }\r\n\r\n  window.jsonp_error_handler=function() {\r\n    console.error(\"url unreachable\",url);\r\n    callback.apply(context,[null]);\r\n  }\r\n\r\n  script=document.createElement('script');\r\n  script.setAttribute('id', \"jsonp\");\r\n  script.setAttribute('onerror', \"jsonp_error_handler()\");\r\n  url=url+'?'+(new Date().getTime());\r\n  script.setAttribute('src', url);\r\n  document.getElementsByTagName('head')[0].appendChild(script); \r\n}\r\nvar runtime_version_ok=function(minruntime) {\r\n  if (!minruntime) return true;//not mentioned.\r\n  var min=parseFloat(minruntime);\r\n  var runtime=parseFloat( ksanagap.runtime_version()||\"1.0\");\r\n  if (min>runtime) return false;\r\n  return true;\r\n}\r\n\r\nvar needToUpdate=function(fromjson,tojson) {\r\n  var needUpdates=[];\r\n  for (var i=0;i<fromjson.length;i++) { \r\n    var to=tojson[i];\r\n    var from=fromjson[i];\r\n    var newfiles=[],newfilesizes=[],removed=[];\r\n    \r\n    if (!to || !to.files) continue; //cannot reach host\r\n    if (!runtime_version_ok(to.minruntime)) {\r\n      console.warn(\"runtime too old, need \"+to.minruntime);\r\n      continue; \r\n    }\r\n    if (!from.filedates) {\r\n      console.warn(\"missing filedates in ksana.js of \"+from.dbid);\r\n      continue;\r\n    }\r\n    from.filedates.map(function(f,idx){\r\n      var newidx=to.files.indexOf( from.files[idx]);\r\n      if (newidx==-1) {\r\n        //file removed in new version\r\n        removed.push(from.files[idx]);\r\n      } else {\r\n        var fromdate=Date.parse(f);\r\n        var todate=Date.parse(to.filedates[newidx]);\r\n        if (fromdate<todate) {\r\n          newfiles.push( to.files[newidx] );\r\n          newfilesizes.push(to.filesizes[newidx]);\r\n        }        \r\n      }\r\n    });\r\n    if (newfiles.length) {\r\n      from.newfiles=newfiles;\r\n      from.newfilesizes=newfilesizes;\r\n      from.removed=removed;\r\n      needUpdates.push(from);\r\n    }\r\n  }\r\n  return needUpdates;\r\n}\r\nvar getUpdatables=function(apps,cb,context) {\r\n  getRemoteJson(apps,function(jsons){\r\n    var hasUpdates=needToUpdate(apps,jsons);\r\n    cb.apply(context,[hasUpdates]);\r\n  },context);\r\n}\r\nvar getRemoteJson=function(apps,cb,context) {\r\n  var taskqueue=[],output=[];\r\n  var makecb=function(app){\r\n    return function(data){\r\n        if (!(data && typeof data =='object' && data.__empty)) output.push(data);\r\n        if (!app.baseurl) {\r\n          taskqueue.shift({__empty:true});\r\n        } else {\r\n          var url=app.baseurl+\"/ksana.js\";\r\n          try {\r\n            jsonp( url ,app.dbid,taskqueue.shift(), context);             \r\n          } catch(e) {\r\n            console.log(e);\r\n            taskqueue.shift({__empty:true});\r\n          }\r\n        }\r\n    };\r\n  };\r\n  apps.forEach(function(app){taskqueue.push(makecb(app))});\r\n\r\n  taskqueue.push(function(data){\r\n    output.push(data);\r\n    cb.apply(context,[output]);\r\n  });\r\n\r\n  taskqueue.shift()({__empty:true}); //run the task\r\n}\r\nvar humanFileSize=function(bytes, si) {\r\n    var thresh = si ? 1000 : 1024;\r\n    if(bytes < thresh) return bytes + ' B';\r\n    var units = si ? ['kB','MB','GB','TB','PB','EB','ZB','YB'] : ['KiB','MiB','GiB','TiB','PiB','EiB','ZiB','YiB'];\r\n    var u = -1;\r\n    do {\r\n        bytes /= thresh;\r\n        ++u;\r\n    } while(bytes >= thresh);\r\n    return bytes.toFixed(1)+' '+units[u];\r\n};\r\nvar humanDate=function(datestring) {\r\n    var d=Date.parse(datestring);\r\n    if (isNaN(d)) {\r\n      return \"invalid date\";\r\n    } else {\r\n      return new Date(d).toLocaleString();\r\n    }\r\n}\r\nvar start=function(ksanajs,cb,context){\r\n  var files=ksanajs.newfiles||ksanajs.files;\r\n  var baseurl=ksanajs.baseurl|| \"http://127.0.0.1:8080/\"+ksanajs.dbid+\"/\";\r\n  var started=ksanagap.startDownload(ksanajs.dbid,baseurl,files.join(\"\\uffff\"));\r\n  cb.apply(context,[started]);\r\n}\r\nvar status=function(){\r\n  var nfile=ksanagap.downloadingFile();\r\n  var downloadedByte=ksanagap.downloadedByte();\r\n  var done=ksanagap.doneDownload();\r\n  return {nfile:nfile,downloadedByte:downloadedByte, done:done};\r\n}\r\n\r\nvar cancel=function(){\r\n  return ksanagap.cancelDownload();\r\n}\r\n\r\nvar liveupdate={ humanFileSize: humanFileSize, humanDate:humanDate,\r\n  needToUpdate: needToUpdate , jsonp:jsonp, \r\n  getUpdatables:getUpdatables,\r\n  start:start,\r\n  cancel:cancel,\r\n  status:status\r\n  };\r\nmodule.exports=liveupdate;",
    "function mkdirP (p, mode, f, made) {\r\n     var path = nodeRequire('path');\r\n     var fs = nodeRequire('fs');\r\n\t\r\n    if (typeof mode === 'function' || mode === undefined) {\r\n        f = mode;\r\n        mode = 0x1FF & (~process.umask());\r\n    }\r\n    if (!made) made = null;\r\n\r\n    var cb = f || function () {};\r\n    if (typeof mode === 'string') mode = parseInt(mode, 8);\r\n    p = path.resolve(p);\r\n\r\n    fs.mkdir(p, mode, function (er) {\r\n        if (!er) {\r\n            made = made || p;\r\n            return cb(null, made);\r\n        }\r\n        switch (er.code) {\r\n            case 'ENOENT':\r\n                mkdirP(path.dirname(p), mode, function (er, made) {\r\n                    if (er) cb(er, made);\r\n                    else mkdirP(p, mode, cb, made);\r\n                });\r\n                break;\r\n\r\n            // In the case of any other error, just see if there's a dir\r\n            // there already.  If so, then hooray!  If not, then something\r\n            // is borked.\r\n            default:\r\n                fs.stat(p, function (er2, stat) {\r\n                    // if the stat fails, then that's super weird.\r\n                    // let the original error be the failure reason.\r\n                    if (er2 || !stat.isDirectory()) cb(er, made)\r\n                    else cb(null, made);\r\n                });\r\n                break;\r\n        }\r\n    });\r\n}\r\n\r\nmkdirP.sync = function sync (p, mode, made) {\r\n    var path = nodeRequire('path');\r\n    var fs = nodeRequire('fs');\r\n    if (mode === undefined) {\r\n        mode = 0x1FF & (~process.umask());\r\n    }\r\n    if (!made) made = null;\r\n\r\n    if (typeof mode === 'string') mode = parseInt(mode, 8);\r\n    p = path.resolve(p);\r\n\r\n    try {\r\n        fs.mkdirSync(p, mode);\r\n        made = made || p;\r\n    }\r\n    catch (err0) {\r\n        switch (err0.code) {\r\n            case 'ENOENT' :\r\n                made = sync(path.dirname(p), mode, made);\r\n                sync(p, mode, made);\r\n                break;\r\n\r\n            // In the case of any other error, just see if there's a dir\r\n            // there already.  If so, then hooray!  If not, then something\r\n            // is borked.\r\n            default:\r\n                var stat;\r\n                try {\r\n                    stat = fs.statSync(p);\r\n                }\r\n                catch (err1) {\r\n                    throw err0;\r\n                }\r\n                if (!stat.isDirectory()) throw err0;\r\n                break;\r\n        }\r\n    }\r\n\r\n    return made;\r\n};\r\n\r\nmodule.exports = mkdirP.mkdirp = mkdirP.mkdirP = mkdirP;\r\n",
    "//var boot=require(\"boot\");\n//boot(\"ksanaforge-workshop\",\"main\",\"main\");\n\nvar React=require(\"react\");\nvar runtime=require(\"ksana2015-webruntime\");\nruntime.boot(\"workshop\",function(){\n\tvar Main=React.createElement(require(\"./src/main.jsx\"));\n\tksana.mainComponent=React.render(Main,document.getElementById(\"main\"));\n});",
    "/** @jsx React.DOM */\n\n//var othercomponent=Require(\"other\"); \nvar React=require(\"react\");\nvar about = React.createClass({displayName: \"about\",\n  getInitialState: function() {\n    return {bar: \"world\"};\n  },\n  pro_logout:function() {\n     this.props.action(\"logout\");\n  },\n  pro_profile:function() {\n     this.props.action(\"index\");\n  },\n  popoverphoto_error:function() {\n     this.getDOMNode().querySelector('#pop_photo').src = 'images/photo.png';\n  },\n  getadmin:function() {\n    if(this.props.tab[0].profile.admin ==true && this.props.tab[0].profile.su ==true){\n      return \"Administrator\";\n    }else if(this.props.tab[0].profile.admin ==true){\n      return \"Chief editor\";\n    }else {\n      return \"Proof reader\";\n    }\n  },\n  render: function() {\n    return (\n      React.createElement(\"div\", null, \n         React.createElement(\"div\", {className: \"col-md-5\"}, React.createElement(\"img\", {src: \"photo/\"+this.props.tab[0].text+\".jpg?\"+ new Date().getTime(), className: \"photo_style\", id: \"pop_photo\", onError: this.popoverphoto_error})), \n         React.createElement(\"div\", {className: \"col-md-7\"}, React.createElement(\"h4\", null, this.props.tab[0].profile.name), \n         React.createElement(\"h2\", {className: \"label label-info\"}, this.getadmin()), React.createElement(\"br\", null), React.createElement(\"br\", null), \n         React.createElement(\"div\", null, React.createElement(\"button\", {className: \"btn btn-block btn-success col-md-1 about_button_style\", onClick: this.pro_profile}, \"Profile\"), \n         React.createElement(\"button\", {className: \"btn btn-block btn-success pull-right about_button_style\", onClick: this.pro_logout}, \"Logout\")\n         )\n         )\n      )\n    );\n  } \n});\nmodule.exports=about;",
    "var React=require(\"react\");\nvar emptystatus={done:false,progress:0,message:\"\"};\nvar buildindex = React.createClass({displayName: \"buildindex\",\n  //mixins: Require('kse-mixins'),\n  getInitialState: function() {\n    return {status:emptystatus};\n  },\n  stoptimer:function() {\n    clearInterval(this.buildtimer);\n    this.buildtimer=0;\n  },\n  getstatus:function() {\n    /*\n    this.$ksana('buildStatus',this.state.status).done(function(status){\n      var elapsed=Math.floor((new Date()-this.state.starttime)/1000);\n      if (status.done) this.stoptimer();\n      this.setState({status:status, elapsed:elapsed});\n    });\n*/\n  },\n  start:function(proj) {\n    if (this.buildtimer) return;//cannot start another instance\n    this.setState({status:emptystatus,starttime:new Date(),elapsed:0});\n    /*\n    this.$ksana('buildIndex',proj).done(function(status){\n      this.state.status=status;\n      $(this.refs.dialog.getDOMNode()).modal({backdrop:'static'}).modal('show');\n      this.buildtimer=setInterval( this.getstatus,1000);\n    });\n*/\n  },\n  close:function() {\n    $(this.refs.dialog.getDOMNode()).modal('hide');\n  },\n  stop:function() {\n    /*\n    this.$ksana('stopIndex',this.state.status).done(function(s){\n      this.setState({status:s});\n    });\n*/\n  }, \n  buttons:function() {\n    if (this.state.status.done) {\n      return (\n        React.createElement(\"div\", null, \n        React.createElement(\"button\", {ref: \"btnclose\", onClick: this.close, className: \"btn btn-success\"}, \"Close\")\n        )\n      );\n    } else {\n      return (\n        React.createElement(\"div\", null, \n        React.createElement(\"button\", {ref: \"btnstop\", onClick: this.stop, className: \"btn btn-danger\"}, \"Stop Building\")\n        )\n      )\n    }\n  },\n  componentWillUnmount:function() {\n    clearInterval(this.buildtimer);\n  },\n  render: function() {\n    var p=Math.floor(this.state.status.progress * 100);\n    var pp=Math.floor(this.state.status.progress * 1000) / 10;\n    var msg=this.state.status.message;\n    var proj=this.state.status.projectname;\n    return (\n    React.createElement(\"div\", {ref: \"dialog\", className: \"modal fade\", tabIndex: \"-1\", role: \"dialog\", \"aria-labelledby\": \"mySmallModalLabel\", \"aria-hidden\": \"true\"}, \n      React.createElement(\"div\", {className: \"modal-dialog modal-sm\"}, \n        React.createElement(\"div\", {className: \"modal-content well\"}, \n        React.createElement(\"h3\", null, \"Building Index for \", proj, \" \", pp, \"%\"), \n        React.createElement(\"h4\", null, \"time elapsed \", this.state.elapsed, \" seconds\"), \n        React.createElement(\"div\", {className: \"progress progress-striped\"}, \n          React.createElement(\"div\", {className: \"progress-bar progress-bar-warning\", role: \"progressbar\", \"aria-valuenow\": p, \"aria-valuemin\": \"0\", \"aria-valuemax\": \"100\", style: {\"width\": p+\"%\"}}, \n            React.createElement(\"span\", {className: \"sr-only\"}, p, \"% Complete\")\n          )\n        ), \n        React.createElement(\"span\", null, msg), \n        React.createElement(\"div\", {className: \"pull-right\"}, \n        this.buttons()\n        )\n      )\n    )\n  )\n    );\n  }\n});\nmodule.exports=buildindex;",
    "var hasClass=function (el, selector) {\n   var className = \" \" + selector + \" \";\n   return (\" \" + el.className + \" \").replace(/[\\n\\t]/g, \" \").indexOf(className) > -1;\n};\n\nvar Create=function(_surface) {\n\tvar surface=_surface;\n\tvar caretnode,carettimer,shiftkey;\n\n  var moveCaret=function(domnode) {\n    if (!domnode) return; \n    caretnode=domnode;\n    var rect=domnode.getBoundingClientRect();\n    var caretdiv=surface.refs.caretdiv.getDOMNode();\n    var caret=surface.refs.caret.getDOMNode();\n    var surfacerect=surface.refs.surface.getDOMNode().getBoundingClientRect();\n    var left=rect.left  -3;\n    var top=rect.top;\n    caretdiv.style.top=top +\"px\";\n    caretdiv.style.left=left +\"px\";\n    caretdiv.style.height=rect.height +\"px\";\n    surface.refs.surface.getDOMNode().focus();\n    surface.props.action(\"caretmoved\",left,top,rect.height);\n    //this.moveInputBox(rect);\n  };\n\n  var selstartFromCaret=function() {\n    if (!caretnode || !caretnode.attributes['data-n']) return ;\n    var len=0;\n    var sel=parseInt(caretnode.attributes['data-n'].value);\n    if (sel!==surface.props.selstart) {\n      if (shiftkey) {\n        if (sel>surface.props.selstart) {\n          len=sel-surface.props.selstart;\n          sel=surface.props.selstart;\n        }\n      }\n    }\n    return {start:sel,len:len}\n  };\n  var updateSelStart=function() {\n    if (!carettimer) clearTimeout(carettimer);\n    carettimer=setTimeout(function(){\n      var sel=selstartFromCaret();\n      if (!sel) return;//cannot select last token...\n      surface.props.onSelection(sel.start,sel.len);\n    },100);\n  };\n\n\n  var beginOfLine=function() {\n    var n=caretnode.previousSibling;\n    while (n&& !hasClass(n,\"br\")) {\n      if (n.previousSibling) n=n.previousSibling;\n      else break;\n    }\n    if (!n) return null;\n    return (n.previousSibling==null)?n:n.nextSibling;\n  }\n\n  var endOfLine=function() {\n    var n=caretnode.nextSibling;\n    while (n&& !hasClass(n,\"br\")) {\n      if (n.nextSibling) n=n.nextSibling;\n      else break;\n    }\n    return n;\n  }  \n\n  var distance=function(x1,y1,x2,y2) {\n    return Math.sqrt((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2));\n  }\n  var moveCaretUp=function() {\n    var n=beginOfLine(),ox=caretnode.offsetLeft, oy=caretnode.offsetTop;\n    var mindis=100000000, closest=null;\n    if (!n) return;\n    if (n.previousSibling==null) return;//top line\n    n=n.previousSibling;\n    while (n) {\n      var dis=distance(ox,oy,n.offsetLeft,n.offsetTop);\n      if (dis<mindis) {mindis=dis;closest=n;}\n      n=n.previousSibling;\n    }\n    moveCaret(closest);\n  };\n\n  var moveCaretDown=function(){\n    var n=endOfLine(),ox=caretnode.offsetLeft, oy=caretnode.offsetTop;\n    if (!n) return;\n    var mindis=100000000, closest=null;\n    if (n.nextSibling==null) return;//top line\n    n=n.nextSibling;\n    while (n) {\n      var dis=distance(ox,oy,n.offsetLeft,n.offsetTop);\n      if (dis<mindis) {mindis=dis;closest=n;}\n      n=n.nextSibling;\n    }\n    moveCaret(closest);\n  };\n\n\n  var strikeout=function() {\n    surface.props.action(\"strikeout\");\n  };\n  var caretPos=function() {\n    var caretpos=0;\n    if (surface.props.sellength>0) {\n      caretpos=surface.props.selstart+surface.props.sellength;\n    } else {\n      caretpos=surface.props.selstart;\n    }\n    return caretpos;\n  };\n\n  var addSuggestion=function(start,len,defaulttext) {\n    var prev=caretPos();\n    if (prev===0) return 0;  \n    \n    var len=prev-start;\n    surface.props.action(\"addsuggestion\",start,len,defaulttext);\n  };\n\n  var inlinedialog=function(thekey) {\n    var sel={};\n    //if (surface.props.sellength==0) {\n      var here=selstartFromCaret();\n      moveCaret(caretnode.previousSibling);\n      var sel=selstartFromCaret();\n      moveCaret(caretnode.nextSibling);\n      sel.len=here.start-sel.start;\n\n    if (surface.hasMarkupAt(sel.start)) {\n      surface.openinlinedialog(sel.start);\n    } else {\n      addSuggestion(sel.start,sel.len,thekey||\"\");\n    }\n  }\n\n  var enter=function() {\n    var prev=caretPos();\n    if (prev===0) return 0;  \n    var sel=selstartFromCaret();\n    var len=prev-sel.start;\n    surface.props.action(\"enter\",sel.start,len);\n    moveCaret(caretnode.nextSibling);\n    updateSelStart();\n  }\nvar validchar=function(kc) {\n  return  (kc>=0x41 && kc<=0x5F);\n}\nthis.keypress=function(e) {\n  var kc=e.which;\n  inlinedialog(String.fromCharCode(kc));\n}\nthis.keydown=function(e) {\n   var prevent=true;\n    shiftkey=e.shiftKey;\n    var kc=e.which;\n    if (kc==37) {\n      if (e.ctrlKey) {\n        if (!surface.inlinedialogopened) surface.props.action(\"prevmistake\");\n      } else {\n        moveCaret(caretnode.previousSibling);\n      }\n    }\n    else if (kc==39) {\n      if (e.ctrlKey) {\n        if (!surface.inlinedialogopened) surface.props.action(\"nextmistake\");\n      } else {\n        moveCaret(caretnode.nextSibling);  \n      }\n      \n    }\n    else if (kc==40) moveCaretDown();\n    else if (kc==38) moveCaretUp();\n    else if (kc==46) strikeout();\n    else if (kc==36) moveCaret(beginOfLine());\n    else if (kc==35) moveCaret(endOfLine());\n    else if (kc==32) inlinedialog();\n    else if (kc==13) enter();\n    else if (kc==27) surface.closeinlinedialog();\n    else if (validchar(kc) || (kc>=112 && kc<=123))  {\n      //if (kc==67 && e.ctrlKey) {\n      //  surface.props.action(\"copy\",surface.selectedText());\n      //} else {\n        prevent=false;\n      //}\n    }\n    if (kc>=27&&kc<50)  updateSelStart();\n    if (prevent) e.preventDefault();\n\n  }\n  this.show=function() {\n    //this.refs.surface.getDOMNode().focus();\n    var pos=surface.props.selstart+surface.props.sellength;\n    var c=surface.refs.surface.getDOMNode().querySelector(\n      'span[data-n=\"'+(pos)+'\"]');\n    moveCaret(c);\n  } \n\n}\n\nmodule.exports={Create:Create};",
    "/** @jsx React.DOM */\n\nvar React=require(\"react\"); \n\nvar contentnavigator = React.createClass({displayName: \"contentnavigator\",\n  getInitialState: function() {\n    return {pagename:this.pageName()};\n  },\n  pageName:function() {\n    return  this.props.page?this.props.page.name:\"\";\n  },\n  setPageId:function() {\n    var pagename=this.refs.pageid.getDOMNode().value;\n    this.setState({pagename:pagename});\n    this.props.action(\"gopage\",pagename);\n    this.pageidtimer=null;\n  },\n  pageIdChange:function() {\n    clearTimeout(this.pageidtimer);\n    this.pageidtimer=setTimeout(this.setPageId.bind(this) ,500);\n  },\n  nextPage:function() {\n    this.props.action(\"next\");\n  },\n  prevPage:function() {\n    this.props.action(\"prev\");\n  },\n  firstPage:function() {\n    this.props.action(\"first\");\n  },\n  lastPage:function() {\n    this.props.action(\"last\");\n  },\n  componentDidUpdate:function() {\n    if (this.refs&&this.refs.pageid) {\n      this.refs.pageid.getDOMNode().value=this.pageName();\n    }\n  }, \n  nextMistake:function() {\n    this.props.action(\"nextmistake\");\n  },\n  prevMistake:function() {\n    this.props.action(\"prevmistake\");\n  },\n  preview:function() {\n    this.props.action(\"preview\");\n  },\n  endpreview:function() {\n    this.props.action(\"endpreview\");\n  },\n  previewmenu:function() {\n\n    if (this.props.preview) {\n      return React.createElement(\"button\", {className: \"btn btn-warning\", onClick: this.endpreview}, \"End Preview\")\n    } else {\n      return React.createElement(\"button\", {className: \"btn btn-success\", onClick: this.preview}, \"Preview\")\n    }\n  },\n  adminmenu:function() {\n    if (this.props.user.admin) {\n      return (\n              React.createElement(\"button\", {className: \"btn btn-default\", onClick: this.nextMistake}, \"Next mistake\")\n              );\n    } else return React.createElement(\"div\", null);\n\n  } ,\n  renderStatus:function() {\n    if (!this.props.selecting)return;\n    var out=[];\n    out.push(React.createElement(\"span\", {className: \"label label-default\"}, this.props.selecting.start));\n    if (this.props.selecting.end!=this.props.selecting.start) {\n      out.push(React.createElement(\"span\", {className: \"label label-default\"}, this.props.selecting.end));\n    }\n      \n    return out;      \n  },\n  render: function() {\n    if (!this.props.page) return React.createElement(\"div\", null)\n    return (\n      React.createElement(\"div\", {className: \"row\"}, \n      React.createElement(\"div\", {className: \"col-md-4\"}, \n        React.createElement(\"div\", {className: \"input-group\"}, \n             React.createElement(\"span\", {className: \"input-group-btn\"}, \n              React.createElement(\"button\", {id: \"btnfirstpage\", className: \"btn btn-default\", onClick: this.firstPage}, \"First\"), \n              React.createElement(\"button\", {className: \"btn btn-default\", onClick: this.prevPage}, \"Prev\")\n             ), \n            React.createElement(\"input\", {id: \"pageid\", ref: \"pageid\", defaultValue: this.pageName(), onChange: this.pageIdChange, className: \"form-control\"}), \n            React.createElement(\"span\", {className: \"input-group-btn\"}, \n              React.createElement(\"button\", {className: \"btn btn-default\", onClick: this.nextPage}, \"Next\"), \n              React.createElement(\"button\", {id: \"btnlastpage\", className: \"btn btn-default\", onClick: this.lastPage}, \"Last\")\n            )\n        )\n      ), \n\n      React.createElement(\"div\", {className: \"col-md-5\"}, \n        this.adminmenu(), \n        this.previewmenu(), \n        this.renderStatus()\n      )\n      )\n    );\n  }\n});\n\nmodule.exports=contentnavigator;",
    "var React=require(\"react\");\nvar contextmenu_classical = React.createClass({displayName: \"contextmenu_classical\",\n  getInitialState: function() {\n    return {selectedText:\"\",bar: \"world\"};\n  },  \n  onPopup:function(context) {\n    this.setState(context);\n  },  \n  copy:function(e) {\n    if (!process) return;\n    var gui = nodeRequire('nw.gui');\n    var clipboard = gui.Clipboard.get();\n    var text=e.target.attributes['data-text'].value;\n    clipboard.set(text); \n  },  \n  searchkeyword:function(e) {\n    this.props.action(\"searchkeyword\",this.state.text);\n  },\n\n  markup:function(e) {\n    var type=(typeof e ==\"string\")?e:e.target.attributes[\"data-markup\"].value;\n    this.props.action(\"addmarkup\",{type:type});\n  }, \n  linebreak:function(e) {\n    this.props.action(\"addmarkup\",{type:\"suggest\",text:\"※\",insert:\"true\"},true);\n  },\n  deleteText:function(e) {\n    this.props.action(\"strikeout\");\n  },\n  clearMarkup:function() { \n    this.props.action(\"clearmarkup\");\n  },\n  render: function() {\n    return ( \n    React.createElement(\"div\", {className: \"dropdown\"}, \n      React.createElement(\"button\", {className: \"btn dropdown-toggle sr-only\", type: \"button\", id: \"dropdownMenu1\", \"data-toggle\": \"dropdown\"}, \n        \"Dropdown\", \n        React.createElement(\"span\", {className: \"caret\"})\n      ), \n      React.createElement(\"ul\", {className: \"dropdown-menu\", role: \"menu\", \"aria-labelledby\": \"dropdownMenu1\"}, \n        React.createElement(\"li\", null, React.createElement(\"a\", {role: \"menuitem\", tabIndex: \"-1\", href: \"#\", onClick: this.markup, \"data-markup\": \"suggest\"}, \"Suggest\")), \n        React.createElement(\"li\", null, React.createElement(\"a\", {role: \"menuitem\", tabIndex: \"-1\", href: \"#\", onClick: this.deleteText}, \"Delete\")), \n        React.createElement(\"li\", null, React.createElement(\"a\", {role: \"menuitem\", tabIndex: \"-1\", href: \"#\", onClick: this.linebreak}, \"line break\")), \n        React.createElement(\"li\", null, React.createElement(\"a\", {role: \"menuitem\", tabIndex: \"-1\", href: \"#\", onClick: this.clearMarkup}, \"Clear Markup\")), \n        React.createElement(\"li\", {className: \"divider\"}), \n        React.createElement(\"li\", null, React.createElement(\"a\", {role: \"menuitem\", tabIndex: \"-1\", href: \"#\", onClick: this.copy, \"data-text\": this.state.text}, \"Copy\")), \n        React.createElement(\"li\", null, React.createElement(\"a\", {role: \"menuitem\", tabIndex: \"-1\", href: \"#\", onClick: this.searchkeyword}, \"Search\"))\n      )\n    ) \n    );\n  }\n});\nmodule.exports=contextmenu_classical;",
    "var React=require(\"react\");\nvar contextmenu_tibetan = React.createClass({displayName: \"contextmenu_tibetan\",\n  getInitialState: function() {\n    return {selectedText:\"\",bar: \"world\"};\n  },  \n  onPopup:function(context) {\n    this.setState(context);\n  },  \n  copy:function(e) {\n    this.props.action(\"copy\",this.state.text);\n  },\n  searchkeyword:function(e) {\n    this.props.action(\"searchkeyword\",this.state.text);\n  },\n  addSuggestion:function(e){\n    this.props.action(\"addsuggestion\");\n  },\n  markup:function(e) {\n    var type=(typeof e ==\"string\")?e:e.target.attributes[\"data-markup\"].value;\n    this.props.action(\"addmarkup\",{type:type});\n  },\n  deleteText:function(e) {\n    this.props.action(\"strikeout\");\n  },\n  clearMarkup:function(e) { \n    var start=e.target.attributes[\"data-reactid\"].value.search(\"lj\");\n    var filename = e.target.attributes[\"data-reactid\"].value.substring(start,10+start);\n    this.props.action(\"clearmarkup\",filename);\n  },\n  render: function() {\n    var disabled=(this.props.len>1)?\"disabled\":\"\";\n    return ( \n    React.createElement(\"div\", {className: \"dropdown\"}, \n      React.createElement(\"button\", {className: \"btn dropdown-toggle sr-only\", type: \"button\", id: \"dropdownMenu1\", \"data-toggle\": \"dropdown\"}, \n        \"Dropdown\", \n        React.createElement(\"span\", {className: \"caret\"})\n      ), \n      React.createElement(\"ul\", {className: \"dropdown-menu\", role: \"menu\", \"aria-labelledby\": \"dropdownMenu1\"}, \n        React.createElement(\"li\", {className: disabled}, React.createElement(\"a\", {role: \"menuitem\", tabIndex: \"-1\", href: \"#\", onClick: this.addSuggestion}, \"Suggest\")), \n        React.createElement(\"li\", null, React.createElement(\"a\", {role: \"menuitem\", tabIndex: \"-1\", href: \"#\", onClick: this.markup, \"data-markup\": \"comment\"}, \"Comment\")), \n        React.createElement(\"li\", null, React.createElement(\"a\", {role: \"menuitem\", tabIndex: \"-1\", href: \"#\", onClick: this.deleteText}, \"Delete\")), \n        React.createElement(\"li\", null, React.createElement(\"a\", {role: \"menuitem\", tabIndex: \"-1\", href: \"#\", onClick: this.clearMarkup}, \"Clear Markup\")), \n        React.createElement(\"li\", {className: \"divider\"}), \n        React.createElement(\"li\", null, React.createElement(\"a\", {role: \"menuitem\", tabIndex: \"-1\", href: \"#\", onClick: this.searchkeyword}, \"Search\"))\n      )\n    ) \n    );\n  }\n});\nmodule.exports=contextmenu_tibetan;",
    "var createStyleSheet=function() {\n\tvar style = document.createElement(\"style\");\n\tstyle.appendChild(document.createTextNode(\"\"));\n\tdocument.head.appendChild(style);\n\treturn style.sheet;\n};\n/*\n\tstyles is a object mapping tagname with css rule\n\ttagset is tag used in the page, overlap tag are concat with ,\n\tuse prefix to prepend all rules\n*/\nvar insertRule=function(sheet,tags,prefix,SS) {\n\tvar background_images=[]; \n\tvar combined=\" \";\n\tfor (var j=0;j<SS.length;j++) {\n\t\tvar S=SS[j];\n\t\tfor (var k in S) {\n\t\t\tif (k===\"background-image\") {\n\t\t\t\tbackground_images.push(S[k]);\n\t\t\t} else {\n\t\t\t\tcombined+=k+\":\"+S[k]+\";\";\n\t\t\t}\n\t\t}\n\t}\n\tif (background_images.length) {\n\t\tcombined+='background-image:'+background_images.join(\",\");\n\t}\n\tvar rule=prefix+\".\"+tags.join(\"__\")+\" {\"+combined+\"}\";\n \ttry {\n \t\tsheet.insertRule(rule,sheet.rules.length);\t\n \t} catch(e) {\n \t\tconsole.log(e);\n \t}\n}\nvar applyStyles=function(styles,tagset,prefix) {\n\tprefix=prefix||\"\";\n\tvar sheet=document.styleSheets[1];\n\tif (!sheet) sheet=createStyleSheet() ;\n\telse { //remove all children\n\t\twhile (sheet.firstChild) sheet.removeChild(sheet.firstChild);\n\t} \n\t\n\tfor (var i=0;i<tagset.length;i++) {\n\t\tvar tags=tagset[i].split(\",\");\n\t\tvar SS=[];\n\t\tfor (var j in tags) {\n\t\t\tvar s=styles[tags[j]]; \n\t\t\tif (s) SS.push(s);\n\t\t}\n\t\tinsertRule(sheet,tags,prefix,SS);\n\t}\n}\nvar api={applyStyles:applyStyles};\nmodule.exports=api;",
    "var React=require(\"react\");\n//var surfacetest=require(\"./surfacetest\");\n\nvar devmenu = React.createClass({displayName: \"devmenu\",\n  getInitialState: function() {\n    return {bar: \"world\"};\n  },\n  closeImageViewer:function() {\n    if (!this.new_win) return;\n    this.new_win.close();\n  },\n  openImageViewer:function() {\n    var gui = nodeRequire('nw.gui'); \n    this.new_win = gui.Window.get(\n      window.open('imageviewer.html')\n    ); \n    this.new_win.isFullscreen=true; \n  }, \n  openFiles:function() { //platform dependent\n\n  },\n  maintest:function() {\n    var gui = nodeRequire('nw.gui');\n    if (this.tester) this.tester.close(true);\n\n    var tester = gui.Window.get(\n      window.open('../test.html')\n    );\n\n    tester.on(\"loaded\",function(){\n      var res=tester.window.startdebugger(\n        \"workshop\", { nw: gui.Window.get() , react:ksana.mainComponent});\n\n      tester.moveTo(1920,-350);\n      tester.resizeTo(550,950);\n    })\n    this.tester=tester;\n    \n  },\n  \n  surfacetest:function() {\n   // React.renderComponent(surfacetest(),document.getElementById(\"main\"));\n  },\n  moveWindow:function() {\n    //if (!this.new_win) return;\n    var gui = nodeRequire('nw.gui');\n    var win = gui.Window.get();\n    //home\n    win.moveTo(1920,-500);\n     win.resizeTo(1080,500);\n    //office\n    win.moveTo(2460,-350)\n    win.resizeTo(1380,900);\n    //this.new_win.resizeTo();\n    //var d=this.new_win.window.document;\n    //d.getElementById(\"test\").innerHTML=\"test\"\n  },\n  render: function() {\n    return (\n      React.createElement(\"div\", null, \n        React.createElement(\"button\", {onClick: this.moveWindow}, \"move window\"), \n        React.createElement(\"button\", {onClick: this.surfacetest}, \"surface test\"), \n        React.createElement(\"button\", {onClick: this.maintest}, \"main test\")\n      )\n    );\n  }\n});\nmodule.exports=devmenu;",
    "/** @jsx React.DOM */\n//if (typeof $==\"undefined\") $=require(\"jquery\");\nvar React=require(\"react\");\nvar Token = React.createClass({displayName: \"Token\",\n  render:function() {\n    var classname=this.props.cls?this.props.cls.trim():\"\";\n    var opts={ 'data-n':this.props.n}\n    if (this.props.appendtext) opts['data-to']=this.props.appendtext;\n    if (classname) opts.className=classname;\n    return React.DOM.span(opts,this.props.ch);\n  } \n});\nvar caret=require(\"./caret\");  \nvar Surface = React.createClass({displayName: \"Surface\",\n  componentWillUpdate:function(nextProps,nextState) {\n    if (nextProps.selstart!=this.props.selstart\n      && nextProps.selstart!=this.props.selstart+this.props.sellength) {\n      //nextState.markup=null;\n      //this.inlinedialogopened=null;\n    } \n    if (nextProps.page!=this.props.page) {\n      nextState.markup=null;\n      this.inlinedialogopened=null;\n    }\n  },\n  selectedText:function() {\n    return this.props.page.inscription.substr(this.props.selstart,this.props.sellength);\n  },\n  moveInputBox:function(rect) {\n    var inputbox=this.refs.inputbox.getDOMNode();\n    var surfacerect=this.refs.surface.getDOMNode().getBoundingClientRect();\n    inputbox.focus();\n  },        \n  showinlinedialog:function(start) {\n    if (!this.refs.inlinedialog) return;\n    if (!start && this.state.markup) start=this.state.markup.start;\n    if (!start) return;\n\n    var domnode=this.getDOMNode().querySelector('span[data-n=\"'+start+'\"]');\n    if (!domnode) return;\n\n    var dialog=this.refs.inlinedialog.getDOMNode();\n    var dialogheight=dialog.firstChild.offsetHeight;\n    /*\n    dialog.style.left=(domnode.offsetLeft - this.getDOMNode().offsetLeft)+\"px\" ;\n    dialog.style.top=(domnode.offsetTop - this.getDOMNode().offsetTop + domnode.offsetHeight)+\"px\" ;\n    \n    if (dialogheight>0 && dialogheight<parseInt(dialog.style.top)) {\n      dialog.style.top=parseInt(dialog.style.top)-dialogheight-domnode.offsetHeight;\n    }\n    */\n    dialog.style.left=\"0px\";\n    dialog.style.top=\"0px\";\n\n    dialog.style.display='inline';\n    this.inlinedialogopened=dialog;\n  },\n  getRange:function() {\n    var sel = getSelection();\n    if (!sel.rangeCount) return;\n    var range = sel.getRangeAt(0);\n    var s=range.startContainer.parentElement;\n    var e=range.endContainer.parentElement;\n    if (s.nodeName!='SPAN' || e.nodeName!='SPAN') return;\n    var start=parseInt(s.getAttribute('data-n'),10);\n    var end=parseInt(e.getAttribute('data-n'),10);\n    return [start,end];\n  },\n  getSelection:function() {\n    var R=this.getRange();\n    if (!R) return;\n    var start=R[0];\n    var end=R[1];\n    var length=0;\n    var sel = getSelection();\n    if (!sel.rangeCount) return;\n    var range = sel.getRangeAt(0);    \n    var s=range.startContainer.parentElement;\n    var e=range.endContainer.parentElement;\n    var n=e.nextSibling,nextstart=0;\n    if (!n) return null;           \n    if (n.nodeName==\"SPAN\") {\n      nextstart=parseInt(n.getAttribute('data-n'),10);  \n    }\n    var selectionlength=end-start+sel.extentOffset-sel.anchorOffset;\n    if (start+selectionlength==nextstart) {//select till end of last token\n      length=selectionlength;\n    } else {\n      if (selectionlength)   length=nextstart-start; //https://github.com/ksanaforge/workshop/issues/50\n      else length=end-start;\n      //if (range.endOffset>range.startOffset &&!length) length=1;\n      if (length<0) {\n          var temp=end; end=start; start=end;\n      }\n    }\n\n    //sel.empty();\n    this.refs.surface.getDOMNode().focus();\n    return {start:start,len:length};\n  },\n  openinlinedialog:function(n) {\n    var n=parseInt(n); \n    var m=this.getMarkupsAt(n);\n    if (!m.length || !this.props.template.inlinedialog) return;\n    var mm=m[0];//find markup at position\n    for (var i=1;i<m.length;i++) {\n      if (m[i].start==n) mm=m[i];\n    }\n    this.props.onSelection(mm.start,mm.len);\n    var dialog=this.props.template.inlinedialog[mm.payload.type];\n    if (dialog) {\n      this.setState({markup:mm});\n    }\n  },\n  hasMarkupAt:function(n) {\n    return this.getMarkupsAt(n).length>0;\n  },\n  tokenclicked:function(e) {\n    if (!e.target.attributes['data-n']) return;\n    var n=e.target.attributes['data-n'].value;\n    if (n) this.openinlinedialog(n);\n    return (!!n);\n  },\n  mouseDown:function(e) {\n    if (this.inlinedialogopened) {\n        e.preventDefault();\n        return;\n    }\n    if(e.button === 0) this.leftMButtonDown = true;\n  },\n  mouseMove:function(e) {\n    if (!this.leftMButtonDown) return;\n    var sel=this.getRange();\n    if (!sel) return;\n    if (sel[0]!=this.laststart || this.lastend!=sel[1]) {\n      this.props.action(\"makingselection\",sel[0],sel[1]);\n    }\n    this.laststart=sel[0];\n    this.lastend=sel[1];\n  },\n  nextTokenStart:function(pos) {\n    if (!this.offsets)return 0;\n    for (var i=0;i<this.offsets.length;i++) {\n      if (this.offsets[i]>pos) return this.offsets[i];\n    }\n    return 0;\n  },\n  mouseUp:function(e) {\n    this.leftMButtonDown=false;\n    if (this.inlinedialogopened) return;\n\n    //if (this.inInlineDialog(e.target))return;\n    var sel=this.getSelection();\n    if (!sel) return;\n\n\n    if (sel.len==0 && e.button==0 ) { //use e.target\n      var n=e.target.attributes['data-n'];\n      if (n) {\n        if (e.shiftKey && sel.start>this.props.selstart) { //shift key pressed, extend mouse selection\n          sel.len=parseInt(n.value)-this.props.selstart;\n          sel.start=this.props.selstart;\n        } else {\n          //this.setState({selstart:parseInt(n.value),sellength:0});\n          sel.start=parseInt(n.value);\n        }\n        var attributes=e.target.getAttribute(\"class\");\n        if (attributes && attributes.indexOf(\"linkto\")>-1) {\n          var M=this.props.page.markupAt(sel.start);\n          this.props.action(\"openlink\",M[0].payload);\n        } else{\n          this.props.onSelection(sel.start,sel.len,e.pageX,e.pageY,e);\n        } \n      }\n      return;\n    }\n    if (!sel) return;\n    if (e.button==2) {\n      if (this.props.sellength>0) {\n        if (sel.start>=this.props.selstart && sel.start<=this.props.selstart+this.props.sellength) {\n          sel.start=this.props.selstart;\n          sel.len=this.props.sellength;\n        } \n      } else if (sel.start>-1) {\n        var next=this.nextTokenStart(sel.start);\n        if (next) {\n          sel.len=next-sel.start;\n        }\n      }   \n    } \n    this.showMakelinkDialog(sel.start);\n    this.props.onSelection(sel.start,sel.len,e.pageX,e.pageY,e);\n  },\n  closeinlinedialog:function() {\n    if (this.inlinedialogopened) {\n      this.inlinedialogopened.style.display='none';\n    }\n    this.inlinedialogopened=false;\n    this.refs.surface.getDOMNode().focus();\n    this.setState({markup:false})\n  },\n  inlinedialogaction:function() {\n    this.props.action.apply(this.props,arguments);\n    this.closeinlinedialog();\n  },\n  addMakelinkDialog:function() {\n    return React.createElement(\"span\", {ref: \"inlinedialog\", className: \"inlinedialog\"}, \n        this.props.template.makelinkdialog({action:this.inlinedialogaction,\n          linktarget:this.state.linktarget,\n          linksource:this.state.linksource,\n          page:this.props.page,\n          user:this.props.user})\n      )\n\n  },\n  addInlinedialog:function() {\n    if (!this.props.template.inlinedialog) return null;\n    if (this.state.linktarget) {\n      return this.addMakelinkDialog();\n    }\n    if (!this.state.markup) return null;\n\n    var m=this.state.markup;\n    var text=this.props.page.inscription.substr(m.start,m.len);\n    var dialog=this.props.template.inlinedialog[m.payload.type];\n    if (dialog) return (\n      React.createElement(\"span\", {ref: \"inlinedialog\", className: \"inlinedialog\"}, \n        dialog({action:this.inlinedialogaction,text:text,markup:m,\n          user:this.props.user})\n      )\n    );\n    return null;\n  },\n  \n  renderRevision:function(R,xml) {\n    var extraclass=\"\";\n    if (R[0].len===0) {\n      extraclass+=\" insert\"; \n//          replaceto=R[0].payload.text;\n      xml.push(React.createElement(\"span\", {className: extraclass+\" inserttext\"}, R[0].payload.text));\n    } else  {\n      if (R[0].payload.text) {\n        if (i>=R[0].start && i<R[0].start+R[0].len) extraclass+=\" replace\"; \n        if (i===R[0].start+R[0].len) {\n          xml.push(React.createElement(\"span\", {className: extraclass+\" replacetext\"}, R[0].payload.text));\n        } \n      }\n      else if (i>=R[0].start && i<R[0].start+R[0].len) extraclass+=\" delete\";  \n    }\n      //if (R[0].start!=i)replaceto=\"\";\n    return extraclass;\n  },\n  getMarkupsAt:function(offset) {\n    return this.props.action(\"getmarkupsat\",offset);\n  },\n  prepareViewonly:function(page) {\n    var admin_viewable_tags=this.props.template.admin_viewable_tags||[];\n    if (admin_viewable_tags.length==0) return [];\n    var author=this.props.user.name;\n    var viewonly=page.filterMarkup(function(m){\n      return (admin_viewable_tags.indexOf(m.payload.type)>-1) \n        && (author!=m.payload.author);\n    })\n    return viewonly;\n  },\n  putSurfaceElement:function(viewonlys,offsets,idx) {\n    var surface_elements=this.props.template.surface_elements; //from workshop-project\n    var res=[];\n    if (surface_elements)  {\n        var viewonly=viewonlys.filter(function(v){return (v.start==offsets[idx]);});\n        if (viewonly) viewonly.map(function(v){\n          var element=surface_elements[v.payload.type];\n          if (element) res.push(React.createElement(element,{payload:v.payload}));\n          else {\n            console.error(\"element \",v.payload.type,\"not defined in surface_elements\")\n          }\n        });        \n    }\n    return res;\n  },\n  toXML : function(opts) {\n    var page=this.props.page;\n    if (!page) return [];\n    var inscription=page.inscription;\n    var res=this.props.template.tokenize(inscription+\"　\");\n    var isSkip=this.props.isSkip;\n    var TK=res.tokens;\n    var offsets=res.offsets;\n    this.offsets=offsets;\n    if (!TK || !TK.length) return [] ;\n    var xml=[], hits=this.props.hits ||[], nhit=0, voff=0;\n    //hits format [vpos, phrase_width, phrase_id]\n    var tagset={};//tags used in the page, comma to seperate overlap tag \n    var selstart=opts.selstart||0,sellength=opts.sellength||0;\n    var viewonlys = this.prepareViewonly(page);\n\n    for (var i=0;i<TK.length;i++) {\n      var tk=TK[i];\n      var classes=\"\",extraclass=\"\";\n      var markupclasses=[],appendtext=\"\";\n      var M=this.getMarkupsAt(offsets[i]);\n      if (offsets[i]>=selstart && offsets[i]<selstart+sellength) extraclass+=' selected';\n      if (nhit<hits.length){ \n        if (voff>=hits[nhit][0]&& voff<hits[nhit][0]+hits[nhit][1] ) {\n          extraclass+=' hl'+hits[nhit][2];\n        } else if (voff>=hits[nhit][0]+hits[nhit][1]) {\n          nhit++;\n        }\n      }\n      if (!isSkip(tk)) voff++;\n      var inlinedialog=null;      \n      for (var j in M) {\n        markupclasses.push(M[j].payload.type);\n        if (M[j].start==offsets[i]) {\n          markupclasses.push(M[j].payload.type+\"_b\");\n        }\n        if (M[j].start+M[j].len==offsets[i]+1) {\n          markupclasses.push(M[j].payload.type+\"_e\");\n        }\n        /*\n        if (M[j].start+M[j].len==i+1) { //last token\n          var text=page.inscription.substr(M[j].start,M[j].len);\n          inlinedialog=this.addInlinedialog(M[j],text);\n        }\n        */\n        //append text\n        if (M[j].payload.selected) {\n          appendtext=M[j].payload.choices[M[j].payload.selected-1].text;\n          var insert=M[j].payload.choices[M[j].payload.selected-1].insert;\n          if (!insert) extraclass+=\" remove\";\n          if (M[j].start+M[j].len!=offsets[i]+tk.length) appendtext=\"\"; \n        }\n\n        if (typeof M[j].payload.text!='undefined') {\n          appendtext=M[j].payload.text;\n          var insert=M[j].payload.insert;\n          if (!insert) extraclass+=\" remove\";\n          if (M[j].start+M[j].len!=offsets[i]+tk.length) appendtext=\"\"; \n        }\n      }  \n      markupclasses.sort();\n   \n      if (markupclasses.length) tagset[markupclasses.join(\",\")]=true;\n      var ch=tk;  \n      if (ch===\"\\n\") {ch=\"\\u21a9\";extraclass+=' br';}\n      classes=(markupclasses.join(\"__\")).trim()+\" \"+extraclass;\n      xml.push(React.createElement(Token,{ key:i , cls:classes ,n:offsets[i],ch:ch, appendtext:appendtext}));\n      if (inlinedialog) xml.push(inlinedialog);\n      var res=this.putSurfaceElement(viewonlys,offsets,i);\n      if (res.length) xml.push(res);\n    }     \n    xml.push(React.createElement(Token, {key: i, n: offsets[i]}));\n\n    if (this.props.onTagSet) {\n      this.props.onTagSet(Object.keys(tagset).sort(),this.state.uuid);\n    }\n    if (this.props.preview && this.props.template.typeset) {\n      xml=this.props.template.typeset(xml);\n    }\n    return xml;\n  },  \n  render: function() {\n    var opts={selstart:this.props.selstart, sellength:this.props.sellength};\n    var xml=this.toXML(opts); \n \n    return (\n      React.createElement(\"div\", {\"data-id\": this.state.uuid, className: \"surface\"}, \n          this.addInlinedialog(), \n          React.createElement(\"div\", {ref: \"surface\", tabIndex: \"0\", \n            onKeyDown: this.caret.keydown, \n            onKeyPress: this.caret.keypress, \n            onClick: this.tokenclicked, \n            onMouseDown: this.mouseDown, \n            onMouseUp: this.mouseUp, \n            onMouseMove: this.mouseMove\n            }, xml\n          ), \n          React.createElement(\"div\", {ref: \"caretdiv\", className: \"surface-caret-container\"}, \n             React.createElement(\"div\", {ref: \"caret\", className: \"surface-caret\"}, \"|\")\n          )\n\n      )\n    );\n  },\n  getInitialState:function() {\n    return {uuid:'u'+Math.random().toString().substring(2), \n    markup:null,linktarget:this.props.linktarget,linksource:this.props.linksource};\n  },\n  componentWillMount:function() {\n    this.caret=new caret.Create(this);\n\n  }, \n  showMakelinkDialog:function(dialgpos) {\n    if (!this.state.linktarget) return;\n\n    var markups=this.getMarkupsAt(dialogpos);\n    var linkby=markups.filter(function(m){return m.payload.type==\"linkby\"});\n \n    //already build link\n    if (linkby.length && linkby[0].start==this.state.linktarget.start) return;\n    //has other markup at same pos\n    if (markups.length !=linkby.length) return; \n    this.showinlinedialog(dialogpos);\n  },\n  componentDidMount:function() {\n    this.showMakelinkDialog(this.props.selstart);\n    this.caret.show();\n  },\n  componentDidUpdate:function() {\n    if (this.props.scrollto) this.scrollToSelection();\n    this.caret.show();\n    this.showinlinedialog();\n    \n    //$(\".viewonlyHolder\").popover();\n  }\n});\n\nmodule.exports=Surface;",
    "/*\n  Multiversion text with external durable markups\n  define a \"fail to migrate markup\" by setting length to -1\n*/\n(function(){\"use strict\";})();\nvar createMarkup=function(textlen,start,len,payload) {\n\tif (textlen==-1) textlen=1024*1024*1024; //max string size 1GB\n\t//the only function create a new markup instance, be friendly to V8 Hidden Class\n\n\tif (len<0) len=textlen;\n\tif (start<0) start=0;\n\tif (start>textlen) start=textlen;\n\tif (start+len>textlen) {\n\t\tlen-=start+len-textlen;\n\t\tif (len<0) len=0;\n\t}\n\n\treturn {start:start,len:len,payload:payload};\n};\nvar cloneMarkup=function(m) {\n\tif (typeof m=='undefined') return null;\n\treturn createMarkup(-1,m.start,m.len,JSON.parse(JSON.stringify(m.payload)));\n};\n/*\nTODO , handle migration of fission page\n*/\nvar migrateMarkup=function(markup, rev) {\n\tvar end=markup.start+markup.len;\n\tvar text=rev.payload.text||\"\";\n\tvar newlen=(text.length-rev.len);\n\tvar revend=rev.start+rev.len;\n\tvar m=cloneMarkup(markup); //return a new copy\n\n\tif (end<=rev.start) return m;\n\telse if (revend<=markup.start) {\n\t\tm.start+=newlen;\n\t\treturn m;\n\t} else { //overlap\n\t\t//  markup    x    xx      xx    xyz      xyyyz        xyz  \n\t\t//  delete   ---   ---    ---     ---      ---        ---     \n\t\t//  dout     |     |      |\t\t   x        xz          z            \n\t\t//  insert   +++   +++    +++     +++      +++        +++\n\t\t//  iout     +++x  +++xx  +++xx  x+++yz   x+++yyyz    +++ xyz\n\t\tif (rev.start>markup.start) {\n\t\t\tvar adv=rev.start-markup.start;  //markup in advance of rev\n\t\t\tvar remain=( markup.len -adv) + newlen ; // remaining character after \n\t\t\tif (remain<0) remain=0;\n\t\t\tm.len = adv + remain ;\n\t\t} else {\n\t\t\tm.start=rev.start;\n\t\t\tvar behind=markup.start-rev.start;\n\t\t\tm.len=markup.len - (rev.len-behind);\n\t\t}\n\t\tif (m.len<0) m.len=0;\n\t\treturn m;\n\t}\n};\nvar applyChanges=function(sourcetext ,revisions) {\n\trevisions.sort(function(r1,r2){return r2.start-r1.start;});\n\tvar text2=sourcetext;\n\trevisions.map(function(r){\n\t\ttext2=text2.substring(0,r.start)+r.payload.text+text2.substring(r.start+r.len);\n\t});\n\treturn text2;\n};\nvar addMarkup=function(start,len,payload) {\n\tthis.__markups__().push(createMarkup(this.inscription.length,start, len, payload ));\n\tthis.doc.markDirty();\n};\nvar addRevision=function(start,len,str) {\n\tvar valid=this.__revisions__().every(function(r) {\n\t\treturn (r.start+r.len<=start || r.start>=start+len);\n\t});\n\tvar newrevision=createMarkup(this.inscription.length,start,len,{text:str});\n\tif (valid) this.__revisions__().push(newrevision);\n\tthis.doc.markDirty();\n\treturn valid;\n};\n\nvar diff2revision=function(diff) {\n\tvar out=[],offset=0,i=0;\n\twhile (i<diff.length) {\n\t\tvar d=diff[i];\n\t\tif (0==d[0]) {\n\t\t\toffset+=d[1].length;\n\t\t} else  if (d[0]<0) { //delete\n\t\t\tif (i<diff.length-1 && diff[i+1][0]==1) { //combine to modify\n\t\t\t\tout.push({start:offset,len:d[1].length,payload:{text:diff[i+1][1]}});\n\t\t\t\ti++;\n\t\t\t} else {\n\t\t\t\tout.push({start:offset,len:d[1].length,payload:{text:\"\"}});\n\t\t\t}\n\t\t\toffset+=d[1].length;\n\t\t} else { //insert\n\t\t\tout.push({start:offset,len:0,payload:{text:d[1]}});\n\t\t\t//offset-=d[1].length;\n\t\t}\n\t\ti++;\n\t}\n\treturn out;\n}\n\n\nvar addRevisionsFromDiff=function(diff,opts) { //Google Diff format\n\tvar revisions=diff2revision(diff);\n\tthis.addRevisions(revisions,opts);\n\treturn revisions.length;\n}\n\nvar addMarkups=function(newmarkups,opts) {\n\tif (!newmarkups) return;\n\tif (!newmarkups.length) return;\n\tif (opts &&opts.clear) this.clearMarkups();\n\tvar maxlength=this.inscription.length;\n\tvar markups=this.__markups__();\n\tfor (var i=0;i<newmarkups.length;i++) {\n\t\tvar m=newmarkups[i];\n\t\tvar newmarkup=createMarkup(maxlength, m.start, m.len, m.payload);\n\t\tmarkups.push(newmarkup);\n\t}\n};\nvar addRevisions=function(newrevisions,opts) {\n\tif (!(newrevisions instanceof Array)) return;\n\tif (!newrevisions.length) return;\n\tif (opts &&opts.clear) this.clearRevisions();\n\tvar revisions=this.__revisions__();\n\tvar maxlength=this.inscription.length;\n\tfor (var i=0;i<newrevisions.length;i++) {\n\t\tvar m=newrevisions[i];\n\t\tvar newrevision=createMarkup(maxlength, m.start, m.len, m.payload );\n\t\trevisions.push(newrevision);\t\n\t}\n};\nvar downgradeMarkups=function(markups) {\n\tvar downgraded=[];\n\n\tfor (var i in markups) {\n\t\tvar m=markups[i];\n\t\tfor (var j=0;j<this.revert.length;j++) {\n\t\t\tm=migrateMarkup(m,this.revert[j]);\n\t\t}\n\t\tdowngraded.push(m);\n\t}\n\treturn downgraded;\n};\nvar upgradeMarkups=function(markups,revs) {\n\tvar migratedmarkups=[];\n\tmarkups.map(function(m){\n\t\tvar s=m.start, l=m.len, delta=0, deleted=false;\n\t\trevs.map(function(rev){\n\t\t\tif (rev.start<=s) { //this will affect the offset\n\t\t\t\tdelta+= (rev.payload.text.length-rev.len);\n\t\t\t}\n\t\t\tif (rev.start<=s && rev.start+rev.len>=s+l) {\n\t\t\t\tdeleted=true;\n\t\t\t}\n\t\t});\n\t\tvar m2=cloneMarkup(m);\n\t\tm2.start+=delta;\n\t\tif (deleted) m2.len=0;\n\t\tmigratedmarkups.push(m2);\n\t});\n\treturn migratedmarkups;\n};\nvar upgradeMarkupsTo=function(M,targetPage) {\n\tvar pg=targetPage, lineage=[], doc=this.doc;\n\twhile (true) {\n\t\t\tvar pid=pg.parentId;\n\t\t\tif (!pid) break; // root\t\n\t\t\tif (pid==pg.id)break;\n\t\t\tlineage.unshift(pg);\n\t\t\tpg=doc.getPage(pid);\n\t}\n\tlineage.map(function(pg){\n\t\tvar parentPage=doc.getPage(pg.parentId);\n\t\tvar rev=revertRevision(pg.revert,parentPage.inscription);\n\t\tM=parentPage.upgradeMarkups(M,rev);\n\t});\n\treturn M;\n};\n\nvar downgradeMarkupsTo=function(M,targetPage) {\n\tvar pg=this,doc=this.doc;\n\tvar ancestorId=targetPage.id;\n\twhile (true) {\n\t\t\tvar pid=pg.parentId;\n\t\t\tif (!pid) break; // root\t\n\t\t\tM=pg.downgradeMarkups(M);\n\t\t\tif (pid==ancestorId)break;\n\t\t\tpg=doc.getPage(pid);\n\t}\n\treturn M;\n};\nvar offsprings=function() {\n\tvar out=[];\n\tvar page=this;\n\twhile (page.__mutant__().length) {\n\t\tvar mu=page.__mutant__();\n\t\tpage=mu[mu.length-1];\n\t\tout.push(page);\n\t}\n\treturn out;\n}\nvar version=function() {  //return version number of this page\n\tvar v=0, page=this, doc=this.doc;\n\twhile (page.parentId) {\n\t\tv++;\n\t\tpage=doc.getPage(page.parentId);\n\t}\n\treturn v;\n}\n\nvar hasAncestor=function(ancestor) {\n\tvar ancestorId=ancestor.id;\n\tvar pg=this,doc=this.doc;\n\t\n\twhile (true) {\n\t\tif (!pg.parentId) return false; // root\t\n\t\tif (pg.parentId==ancestorId) return true;\n\t\tpg=doc.getPage(pg.parentId);\n\t}\n\treturn false;\n};\nvar getAncestors=function() {\n\tvar pg=this,ancestor=[], doc=this.doc;\n\twhile (true) {\n\t\t\tvar pid=pg.parentId;\n\t\t\tif (!pid) break; // root\t\n\t\t\tpg=doc.getPage(pid);\n\t\t\tancestor.unshift(pg);\n\t}\n\treturn ancestor;\n};\n\nvar clear=function(M,start,len,author) { //return number of item removed\n\tvar count=0;\n\tif (typeof start=='undefined') {\n\t\tcount=M.length;\n\t  M.splice(0, M.length);\n\t  return count;\n\t}\n\tif (len<0) len=this.inscription.length;\n\tvar end=start+len;\n\tfor (var i=M.length-1;i>=0;--i) {\n\t\tif (M[i].start>=start && M[i].start+M[i].len<=end) {\n\t\t\tif (author && author!=M[i].payload.author) continue;\n\t\t\tM.splice(i,1);\n\t\t\tcount++;\n\t\t}\n\t}\n\tthis.doc.markDirty();\n\treturn count;\n};\nvar clearRevisions=function(start,len,author) {\n\tclear.apply(this,[this.__revisions__(),start,len,author]);\n\tthis.doc.markDirty();\n};\nvar clearMarkups=function(start,len,author,filename) {\n\tvar ip = location.host.split(\":\")[0];\n\tvar pouch=require(\"./persistentmarkup_pouchdb\");\n\tvar db =  new PouchDB('http://'+ip+':5984/'+filename);\n\tfor(var i=0;i<this.__markups__().length;i++){\n\t\tif(this.__markups__()[i].start >= start && this.__markups__()[i].start <= start+len){\n\t\t\tvar docid = filename+\"_\"+author+\"_\"+this.__markups__()[i].start;\n\t\t\tpouch.removetopouch(db,docid);\n\t\t}\n\t}\n\tclear.apply(this,[this.__markups__(),start,len,author]);\n\tthis.doc.markDirty();\n};\nvar getOrigin=function() {\n\tvar pg=this;\n\twhile (pg && pg.parentId) {\n\t\tpg=this.doc.getPage(pg.parentId);\n\t}\n\treturn pg;\n}\nvar isLeafPage=function() {\n\treturn (this.__mutant__().length===0);\n};\n//convert revert and revision back and forth\nvar revertRevision=function(revs,parentinscription) {\n\tvar revert=[], offset=0;\n\trevs.sort(function(m1,m2){return m1.start-m2.start;});\n\trevs.map(function(r){\n\t\tvar newinscription=\"\";\n\t\tvar\tm=cloneMarkup(r);\n\t\tvar newtext=parentinscription.substr(r.start,r.len);\n\t\tm.start+=offset;\n\t\tvar text=m.payload.text||\"\";\n\t\tm.len=text.length;\n\t\tm.payload.text=newtext;\n\t\toffset+=m.len-newtext.length;\n\t\trevert.push(m);\n\t});\n\trevert.sort(function(a,b){return b.start-a.start;});\n\treturn revert;\n};\nvar markupAt=function(pos,markups) {\n\tvar markups=markups||this.__markups__();\n\treturn markups.filter(function(m){\n\t\tvar len=m.len;if (!m.len) len=1;\n\t\treturn (pos>=m.start && pos<m.start+len);\n\t});\n};\nvar revisionAt=function(pos) {\n\treturn this.__revisions__().filter(function(m){\n\t\treturn (pos>=m.start && pos<=m.start+m.len);\n\t});\n};\n\nvar compressRevert=function(R) {\n\tvar out=[];\n\tfor (var i in R) {\n\t\tif (R[i].payload.text===\"\") {\n\t\t\tout.push([R[i].start,R[i].len]);\n\t\t} else out.push([R[i].start,R[i].len,R[i].payload.text]);\n\t}\n\treturn out;\n};\nvar decompressRevert=function(R) {\n\tvar out=[];\n\tfor (var i=0;i<R.length;i++) {\n\t\tif (R[i].length) { //array format\n\t\t\tout.push({start:R[i][0],len:R[i][1], payload:{text:R[i][2]||\"\"}})\n\t\t} else {\n\t\t\tout.push({start:R[i].s,len:R[i].l, payload:{text:R[i].t||\"\"}});\t\n\t\t}\n\t}\n\treturn out;\n};\n\nvar toJSONString=function(opts) {\n\tvar obj={};\n\topts=opts||{};\n\tif (this.name) obj.n=this.name;\n\tif (opts.withtext) obj.t=this.inscription;\n\tif (this.parentId) obj.p=this.parentId;\n\tif (this.revert) obj.r=compressRevert(this.revert);\n\tvar meta=this.__meta__();\n\t/*\n\tif (meta.daugtherStart) {\n\t\tobj.ds=meta.daugtherStart;\n\t\tobj.dc=meta.daugtherCount;\n\t}\n\t*/\n\treturn JSON.stringify(obj);\n};\nvar compressedRevert=function() {\n\treturn compressRevert(this.revert);\n}\nvar filterMarkup=function(cb) {\n\treturn this.__markups__().filter(function(m){\n\t\treturn cb(m);\n\t});\n}\nvar findMarkup=function(query) { //same like jquery\n\tvar name=query.name;\n\tvar output=[];\n\tthis.__markups__().map(function(M){\n\t\tif (M.payload.name==name) {\n\t\t\toutput.push(M);\n\t\t}\n\t});\n\treturn output;\n};\n/*\nvar fission=function(breakpoints,opts){\n\tvar meta=this.__meta__();\n\tvar movetags=function(newpage,start,end) {\n\t\tvar M=this.__markups__();\n\t\tM.map(function(m){\n\t\t\tif (m.start>=start && m.start<end) {\n\t\t\t\tnewpage.addMarkup(m.start-start,m.len, m.payload);\n\t\t\t}\n\t\t});\n\t};\n\tmeta.daugtherStart=this.doc.version;\n\tmeta.daugtherCount=breakpoints.length+1;\n\t// create page ,add transclude from\n\tvar start=0, t=\"\";\n\tfor (var i=0;i<=breakpoints.length;i++) {\n\t\tvar end=breakpoints[i]||this.inscription.length;\n\t\tt=this.inscription.substring(start,end);\n\t\tvar transclude={id:this.id, start:start };//\n\t\tvar newpage=this.doc.createPage({text:t, transclude:transclude});\n\t\tnewpage.__setParentId__(this.id);\n\t\tmovetags.apply(this,[newpage,start,end]);\n\t\tstart=end;\n\t}\n\n\t//when convert to json, remove the inscription in origin text\n\t//and retrived from fission mutant\n};\n*/\nvar toggleMarkup=function(start,len,payload) {\n\tvar M=this.__markups__();\n\tfor (var i=0;i<M.length;i++){\n\t\tif (start===M[i].start && len==M[i].len && payload.type==M[i].payload.type) {\n\t\t\tM.splice(i, 1);\n\t\t\treturn;\n\t\t} \n\t}\n\tthis.addMarkup(start,len,payload);\n};\n\nvar mergeMarkup = function(markups,offsets,type) {\n\tmarkups=markups||this.__markups__();\n\tvar M=require(\"./markup\");\n\tM.addTokenOffset(markups,offsets);\n\tvar res= M.merge(markups, type||\"suggest\");\n\treturn M.applyTokenOffset(res,offsets);\n}\n\nvar strikeout=function(start,length,user,type) {\n\tthis.clearMarkups(start,length,user);\n\tvar markups=this.__markups__();\n\tvar M=require(\"./markup\");\n\ttype=type||\"suggest\";\n\treturn M.strikeout(markups,start,length,user,type);\n}\n\nvar preview=function(opts) { \n\t//suggestion is from UI , with insert in payload\n\tvar revisions=require(\"./markup\").suggestion2revision(opts.suggestions);\n\treturn this.doc.evolvePage(this,{preview:true,revisions:revisions,markups:[]});\n}\n\n/*\n  change to prototype\n*/\nvar newPage = function(opts) {\n\tvar PG={};\n\tvar inscription=\"\";\n\tvar hasInscription=false;\n\tvar markups=[];\n\tvar revisions=[];\n\tvar mutant=[];\n\n\topts=opts||{};\n\topts.id=opts.id || 0; //root id==0\n\tvar parentId=0 ,name=\"\";\n\tif (typeof opts.parent==='object') {\n\t\tinscription=opts.parent.inscription;\n\t\tname=opts.parent.name;\n\t\thasInscription=true;\n\t\tparentId=opts.parent.id;\n\t}\n\tvar doc=opts.doc;\n\tvar meta= {name:name,id:opts.id, parentId:parentId, revert:null };\n\n\t//these are the only 2 function changing inscription,use by Doc only\n\tvar checkLength=function(ins) {\n\t\tif (ins.length>doc.maxInscriptionLength) {\n\t\t\tconsole.error(\"exceed size\",ins.length, ins.substring(0,100));\n\t\t\tins=ins.substring(0,doc.maxInscriptionLength);\n\t\t}\n\t\treturn ins;\n\t};\n\tPG.__selfEvolve__  =function(revs,M) { \n\t\t//TODO ;make sure inscription is loaded\n\t\tvar newinscription=applyChanges(inscription, revs);\n\t\tvar migratedmarkups=[];\n\t\tmeta.revert=revertRevision(revs,inscription);\n\t\tinscription=checkLength(newinscription);\n\t\thasInscription=true;\n\t\tmarkups=upgradeMarkups(M,revs);\n\t};\n\tObject.defineProperty(PG,'inscription',{\n\t\tget : function() {\n\t\t\tif (meta.id===0) return \"\"; //root page\n\t\t\tif (hasInscription) return inscription;\n\t\t\t/*\n\t\t\tif (meta.daugtherStart) {\n\t\t\t\tinscription=\"\";\n\t\t\t\tfor (var i=0;i<meta.daugtherCount;i++) {//combine from daugther\n\t\t\t\t\tvar pg=this.doc.getPage(meta.daugtherStart+i);\n\t\t\t\t\tinscription+=pg.inscription;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t*/\n\t\t\t\tvar mu=this.getMutant(0); //revert from Mutant\n\t\t\t\tif (mu) {\n\t\t\t\t\tinscription=checkLength(applyChanges(mu.inscription,mu.revert));\t\t\t\t\t\n\t\t\t\t} else {\n\t\t\t\t\tinscription=\"\";\n\t\t\t\t}\n\t\t\t\t\n\t\t\t//}\n\t\t\thasInscription=true;\n\t\t\treturn inscription;\n\t}});\n\t//protected functions\n\n\tPG.__markups__     = function() { return markups;} ; \n\tPG.__revisions__   = function() { return revisions;} ;\n\tPG.hasRevision     = function() { return revisions.length>0;} ;\n\tObject.defineProperty(PG,'id',{value:meta.id});\n\tObject.defineProperty(PG,'doc',{value:doc});\n\tObject.defineProperty(PG,'parentId',{get:function() {return meta.parentId;}});\n\tPG.__setParentId__ = function(i) { meta.parentId=i;\t};\n\tPG.getMarkup       = function(i){ return cloneMarkup(markups[i]);} ;//protect from modification\n\tObject.defineProperty(PG,'markupCount',{get:function(){return markups.length;}});\n\n\tObject.defineProperty(PG,'revert',{get:function(){return meta.revert;}});\n\tPG.__setRevert__   = function(r) { meta.revert=decompressRevert(r);};\n\t//PG.__setDaugther__ = function(s,c) { meta.daugtherStart=s;meta.daugtherCount=c;};\n\tPG.getRevision     = function(i) { return cloneMarkup(revisions[i]);};\n\tPG.getMutant       = function(i) { return mutant[i]; };\n\tPG.__mutant__      = function()  { return mutant;};\n\tPG.__setmutant__   = function(c)  { mutant=c;};\n\tObject.defineProperty(PG,'revisionCount',{get:function(){return revisions.length;}});\n\t\t\n\tPG.setName           = function(n){ meta.name=n; return this;};\n\tObject.defineProperty(PG,'name',{get:function(){return meta.name;}});\n\tPG.__meta__        = function() {return meta;};\n\tObject.defineProperty(PG,'version',{get:version});\n\t//Object.defineProperty(PG,'daugtherStart',{get:function(){return meta.daugtherStart;}});\n\t//Object.defineProperty(PG,'daugtherCount',{get:function(){return meta.daugtherCount;}});\n\tPG.clearRevisions    = clearRevisions;\n\tPG.clearMarkups      = clearMarkups;\n\tPG.addMarkup         = addMarkup;\n\tPG.toggleMarkup      = toggleMarkup;\n\tPG.addMarkups        = addMarkups;\n\tPG.addRevision       = addRevision;\n\tPG.addRevisions      = addRevisions;\n\tPG.addRevisionsFromDiff=addRevisionsFromDiff;\n\tPG.hasAncestor       = hasAncestor;\n\tPG.upgradeMarkups    = upgradeMarkups;\n\tPG.downgradeMarkups  = downgradeMarkups;\n\tPG.upgradeMarkupsTo  = upgradeMarkupsTo;\n\tPG.downgradeMarkupsTo=downgradeMarkupsTo;\n\tPG.getAncestors      = getAncestors;\n\tPG.isLeafPage        = isLeafPage;\n\tPG.markupAt          = markupAt;\n\tPG.revisionAt        = revisionAt;\n//\tPG.getmutant          = getmutant;\n\tPG.toJSONString      = toJSONString;\n\tPG.findMarkup\t\t\t\t = findMarkup;\n\tPG.filterMarkup\t\t\t = filterMarkup;\n//\tPG.fission           = fission;\n\tPG.mergeMarkup       = mergeMarkup;\n\tPG.strikeout         = strikeout;\n\tPG.preview           = preview;\n\tPG.getOrigin       = getOrigin;\n\tPG.revertRevision = revertRevision;\n\tPG.offsprings       = offsprings;\n\tPG.compressedRevert=compressedRevert;\n\tObject.freeze(PG);\n\treturn PG;\n};\nvar createDocument = function(docjson,markupjson) {\n\tvar DOC={};\n\tvar pages=[];\n\tvar names={};\n\tvar meta={doctype:\"dg1.0\",filename:\"\"};\n\tvar dirty=0;\n\tvar tags={};\n\tvar sep=\"_.id\";\n\n\n\tvar createFromJSON=function(json) {\n\t\t\trootPage.clearRevisions();\n\t\t\tvar t=json.text||json.t ,page;\n\t\t\tif (t) {\n\t\t\t\trootPage.addRevision(0,0,json.text || json.t);\n\t\t\t\tpage=evolvePage(rootPage);\t\t\t\t\n\t\t\t} else {\n\t\t\t\tpage=createPage();\n\t\t\t}\n\t\t\tvar name=json.n||json.name||\"\";\n\t\t\tif (!names[name]) {\n\t\t\t\tnames[name]=pages.length-1;\n\t\t\t} else if (!json.p) {\n\t\t\t\tconsole.warn(\"repeat name \"+name);\n\t\t\t}\n\t\t\tpage.setName(name);\n\t\t\tif (json.p) page.__setParentId__(json.p);\n\t\t\tif (json.r) page.__setRevert__(json.r);\n\t\t\t/*\n\t\t\tif (json.ds) {\n\t\t\t\tpage.__setDaugther__(json.ds,json.dc);\n\t\t\t}\n\t\t\t*/\n\t\t\tpage.addMarkups(json.markups,true);\n\t\t\tpage.addRevisions(json.revisions,true);\n\t\t\treturn page;\n\t};\n\tvar endCreatePages=function(opts) {\n\t\t//build mutant array\n\t\tif (opts&&opts.clear) pages.map(function(P){\n\t\t\tvar mu=P.__mutant__();\n\t\t\tmu=[];\n\t\t});\n\t\tpages.map(function(P,idx,pages){\n\t\t\tif (P.parentId) pages[P.parentId].__mutant__().push(P);\n\t\t});\t\t\n\t}\n\tvar addMarkups=function(markups) {\n\t\tif (markups) for (var i=0;i<markups.length;i++){\n\t\t\tvar m=markups[i].doc;\n\t\t\tvar pageid=m.pageid;\n\t\t\tm.payload._rev = markups[i].doc._rev;\n\t\t\tpages[pageid].addMarkup(m.start,m.len,m.payload);\n\t\t}\n\t\t/*if (markups) for (var i=0;i<markups.length;i++){\n\t\t\tvar m=markups[i];\n\t\t\tvar pageid=m.i;\n\t\t\tpages[pageid].addMarkup(m.start,m.len,m.payload);\n\t\t}*/\t\t\n\t}\n\tvar createPages=function(json,markups) {\n\t\tvar count=0,i;\n\t\tfor (i=0;i<json.length;i++) {\n\t\t\tif (i==0 && !json[i].t) continue; //might be header\n\t\t\tcreatePage(json[i]);\n\t\t}\n\n\t\tendCreatePages({clear:true});\n\t\taddMarkups(markups);\n\t\treturn this;\n\t};\n\tvar createPage=function(input) {\n\t\tvar id=pages.length,page;\n\t\tif (typeof input=='undefined' || typeof input.getMarkup=='function') {\n\t\t\t//root page\n\t\t\tvar parent=input||0;\n\t\t\tpage=newPage({id:id,parent:parent,doc:DOC});\n\t\t\tpages.push(page) ;\n\t\t} else if (typeof input=='string') { \n\t\t\tpage=createFromJSON({text:input});\n\t\t} else {\n\t\t\tpage=createFromJSON(input);\n\t\t}\n\t\treturn page;\n\t};\n\tvar evolvePage=function(pg,opts) {//apply revisions and upgrate markup\n\t\tvar nextgen;\n\t\topts=opts||{};\n\t\tif (opts.preview) { \n\t\t\tnextgen=newPage({parent:pg,doc:DOC,id:-1});  //id cannot null\n\t\t} else {\n\t\t\tnextgen=createPage(pg);\t\n\t\t}\n\t\tif (pg.id) pg.__mutant__().push(nextgen);\n\t\tvar revisions=opts.revisions||pg.__revisions__();\n\t\tvar markups=opts.markups||pg.__markups__();\n\t\tnextgen.__selfEvolve__( revisions ,markups );\n\n\t\treturn nextgen;\n\t};\n\n\tvar findMRCA=function(pg1,pg2) {\n\t\tvar ancestors1=pg1.getAncestors();\n\t\tvar ancestors2=pg2.getAncestors();\n\t\tvar common=0; //rootPage id\n\t\twhile (ancestors1.length && ancestors2.length &&\n\t\t   ancestors1[0].id==ancestors2[0].id) {\n\t\t\tcommon=ancestors1[0];\n\t\t\tancestors1.shift();ancestors2.shift();\n\t\t}\n\t\treturn common;\n\t};\n\n\tvar migrate=function(from,to) { //migrate markups of A to B\n\t\tif (typeof from=='number') from=this.getPage(from);\n\t\tvar M=from.__markups__();\n\t\tvar out=null;\n\t\tif (typeof to=='undefined') {\n\t\t\tout=from.downgradeMarkups(M);\n\t\t} else {\n\t\t\tif (typeof to=='number') to=this.getPage(to);\n\t\t\tif (from.id===to.id) {\n\t\t\t\treturn M;\n\t\t\t} else if (to.hasAncestor(from)) {\n\t\t\t\tout=from.upgradeMarkupsTo(M,to);\n\t\t\t} else if (from.hasAncestor(to)){\n\t\t\t\tout=from.downgradeMarkupsTo(M,to);\n\t\t\t} else {\n\t\t\t\tvar ancestor=findMRCA(from,to);\n\t\t\t\tout=from.downgradeMarkupsTo(M,ancestor);\n\t\t\t\tout=ancestor.upgradeMarkupsTo(out,to);\n\t\t\t}\n\t\t}\n\t\treturn out;\n\t};\n\tvar findPage=function(name) {\n\t\tfor (var i=0;i<this.pageCount;i++) {\n\t\t\tif (name===pages[i].name) return pages[i];\n\t\t}\n\t\treturn null;\n\t};\n\tvar getLeafPages=function() {\n\t\tvar arr=[],i=0;\n\t\tfor (i=0;i<this.pageCount;i++) {arr[i]=true;}\n\t\tfor (i=0;i<this.pageCount;i++) {\n\t\t\tvar pid=pages[i].parentId;\n\t\t\tarr[pid]=false;\n\t\t}\n\t\tvar leafpages=[];\n\t\tarr.map(function(p,i){ if (p) leafpages.push(i); });\n\t\treturn {leafPages:leafpages, isLeafPages:arr};\n\t};\n\t/*\n\t\tconvert revert to a string.\n\t\tstarting with ascii 1\n\t*/\n\tvar toJSONString=function() {\n\t\tvar out=[\"[\"+JSON.stringify(meta)], s=\",\";\n\t\tvar isLeafPages=this.getLeafPages().isLeafPages;\n\t\tfor (var i=0;i<pages.length;i++) {\n\t\t\tif (i===0) continue;\n\t\t\ts+=pages[i].toJSONString({\"withtext\":isLeafPages[i]});\n\t\t\tout.push(s);\n\t\t\ts=\",\";\n\t\t}\n\t\tout[out.length-1]+=\"]\";\n\t\t//make line number save as version number\n\t\treturn out.join('\\n');\n\t};\n\n\t//get a page , if version is not specified, return lastest\n\t//version ==0 first version, version==1 second ..\n\tvar pageByName=function(name,version) {\n\t\tvar parr=names[name];\n\t\tif (!parr) {\n\t\t\treturn null; //pagename not found\n\t\t}\n\t\tif (typeof version==\"undefined\") {\n\t\t\tversion=-1; //lastest\n\t\t}\n\t\tvar pg=pages[parr];\n\t\tif (version==0) return pg; //the first version\n\t\twhile (pg.__mutant__().length) {\n\t\t\tvar mu=pg.__mutant__();\n\t\t\tpg=mu[mu.length-1];\n\t\t\tversion--; \n\t\t\tif  (version==0) break;\n\t\t}\n\t\treturn pg;\n\t};\n\n\tvar map=function(context,callback) {\n\t\tvar cb=callback,ctx=context;\n\t\tif (typeof context==\"function\") {\n\t\t\tcb=context;\n\t\t\tctx=this;\n\t\t}\n\t\tfor (var i=1;i<this.pageCount;i++) {\n\t\t\tvar pg=pages[i];\n\t\t\tif (pg.parentId!=0)  continue; //not a root page, \n\t\t\twhile (pg.__mutant__().length) {\n\t\t\t\tvar mu=pg.__mutant__();\n\t\t\t\tpg=mu[mu.length-1];\n\t\t\t}\n\t\t\tcb.apply(ctx,[pg,i-1]);\n\t\t}\n\t}\n\tvar pageNames=function() {\n\t\tvar out=[];\n\t\tfor (var i=1;i<this.pageCount;i++) {\n\t\t\tvar pg=pages[i];\n\t\t\tif (pg.parentId!=0)  continue; //not a root page, \n\t\t\tout.push(pg.name);\n\t\t}\n\t\treturn out;\n\t}\n\n\tvar rootPage=createPage();\n\n\tDOC.getPage=function(id) {return pages[id];};\n\tDOC.markDirty=function() {dirty++;};\n\tDOC.markClean=function() {dirty=0;};\n\tDOC.setTags=function(T)  {tags=T;};\n\tDOC.setSep=function(s)  {sep=s;};\n\t/*\n\t\texternal markups must be saved with version number.\n\t*/\n\n\n\tObject.defineProperty(DOC,'meta',{value:meta});\n\tObject.defineProperty(DOC,'maxInscriptionLength',{value:8192});\n\tObject.defineProperty(DOC,'version',{get:function(){return pages.length;}});\n\tObject.defineProperty(DOC,'pageCount',{get:function(){return pages.length;}});\n\tObject.defineProperty(DOC,'dirty',{get:function() {return dirty>0; }});\n\tObject.defineProperty(DOC,'ags',{get:function() {return tags;}});\n\tObject.defineProperty(DOC,'sep',{get:function() {return sep;}});\n\n\t\n\tDOC.createPage=createPage;\n\tDOC.createPages=createPages;\n\tDOC.addMarkups=addMarkups;\n\tDOC.evolvePage=evolvePage;\n\tDOC.findMRCA=findMRCA;\n\tDOC.migrate=migrate; \n\tDOC.downgrade=migrate; //downgrade to parent\n\tDOC.migrateMarkup=migrateMarkup; //for testing\n\tDOC.getLeafPages=getLeafPages;\n\tDOC.findPage=findPage;\n\tDOC.pageByName=pageByName;\n\tDOC.toJSONString=toJSONString;\n\n\tDOC.map=map;\n\tDOC.pageNames=pageNames;\n\tDOC.endCreatePages=endCreatePages;\n\n\tif (docjson) DOC.createPages(docjson,markupjson);\n\tdirty=0;\n\t\n\tObject.freeze(DOC);\n\treturn DOC;\n};\n/*\n\tTODO move user markups to tags\n*/\n/*\nvar splitInscriptions=function(doc,starts) {\n\tvar combined=\"\",j=0;\n\tvar inscriptions=[],oldunitoffsets=[0];\n\tfor (var i=1;i<doc.pageCount;i++) {\n\t\tvar page=doc.getPage(i);\n\t\tvar pageStart=doc.maxInscriptionLength*i;\n \t\tcombined+=page.inscription;\n\t\toldunitoffsets.push(combined.length);\n\t}\n\tvar last=0,newunitoffsets=[0];\n\tstarts.map(function(S){\n\t\tvar till=oldunitoffsets[ S[0] ]+ S[1];\n\t\tnewunitoffsets.push(till);\n\t\tinscriptions.push( combined.substring(last,till));\n\t\tlast=till;\n\t})\n\tinscriptions.push( combined.substring(last));\n\tnewunitoffsets.push(combined.length);\n\treturn {inscriptions:inscriptions,oldunitoffsets:oldunitoffsets , newunitoffsets:newunitoffsets};\n}\n\nvar sortedIndex = function (array, tofind) {\n  var low = 0, high = array.length;\n  while (low < high) {\n    var mid = (low + high) >> 1;\n    array[mid] < tofind ? low = mid + 1 : high = mid;\n  }\n  return low;\n};\n\nvar addOldUnit=function() {\n// convert old unit into tags \n}\n\nvar reunitTags=function(tags,R,newtagname) {\n\tvar out=[];\n\ttags.map(function(T){\n\t\tif (T.name===newtagname) return;\n\t\tvar tag=JSON.parse(JSON.stringify(T));\n\t\tvar pos=R.oldunitoffsets[T.sunit]+T.soff;\n\t\tvar p=sortedIndex(R.newunitoffsets,pos+1)-1;\n\t\tif (p==-1) p=0;\n\t\ttag.sunit=p;tag.soff=pos-R.newunitoffsets[p];\n\n\t\teunit=T.eunit||T.sunit;eoff=T.eoff||T.soff;\n\t\tif (eunit!=T.sunit || eoff!=T.soff) {\n\t\t\tpos=R.oldunitoffsets[eunit]+eoff;\n\t\t\tp=sortedIndex(R.newunitoffsets,pos)-1;\n\t\t\tif (p==-1) p=0;\n\t\t\tif (eunit!=T.sunit) tag.eunit=p;\n\t\t\tif (eoff!=T.soff)   tag.eoff=pos-R.newunitoffsets[p];\n\t\t}\n\t\tout.push(tag);\n\t});\n\treturn out;\n}\nvar reunit=function(doc,tagname,opts) {\n\tvar unitstarts=[];\n\tdoc.tags.map(function(T){\n\t\tif (T.name===tagname)\tunitstarts.push([T.sunit,T.soff]);\n\t});\n\n\tvar R=splitInscriptions(doc,unitstarts);\n\tvar newdoc=createDocument();\n\tR.inscriptions.map(function(text){newdoc.createPage(text)});\n\n\tnewdoc.tags=reunitTags(doc.tags,R,tagname);\n\treturn newdoc;\n}\n*/\n// reunit is too complicated, change to fission\n// a big chunk of text divide into smaller unit\n//\nmodule.exports={ createDocument: createDocument};",
    "/** @jsx React.DOM */\n/*\n  maintain selection state of a surface\n  context menu\n*/\nvar Surface=require(\"./docsurface.jsx\"); \n//var bootstrap=require(\"bootstrap\");\nvar cssgen=require(\"./cssgen\");\n//var linkbymenu=require(\"./linkbymenu.jsx\");\n//var linktomenu=require(\"./linktomenu.jsx\");//possible link to\nvar React=require(\"react\");\nvar Docview = React.createClass({displayName: \"Docview\",\n  componentWillMount:function() {\n    if (this.props.page) this.offsets=this.props.template.tokenize(this.props.page.inscription).offsets;\n    else this.offsets=[];\n  },\n  shouldComponentUpdate:function(nextProps,nextState) {\n    var p=this.props,np=nextProps;\n    var s=this.state,ns=nextState;\n    return (p.page!=np.page || p.pageid!=np.pageid ||\n     s.selstart!=ns.selstart || s.sellength!=ns.sellength\n     ||s.newMarkupAt!=ns.newMarkupAt\n     ||this.hits!=np.hits\n     ||this.state.linkby!=nextState.linkby\n     ||this.state.linkto!=nextState.linkto);\n\n  },\n  componentWillUpdate:function(nextProps,nextState) {\n    if (nextProps.pageid!=this.props.pageid) {\n      nextState.selstart=0;\n      nextState.sellength=0;\n      //nextState.newMarkupAt=null;\n    }\n     //if (nextProps.page) this.offsets=nextProps.template.tokenize(nextProps.page.inscription).offsets;\n     else this.offsets=nextProps.template.tokenize(nextProps.page.inscription).offsets; \n  },\n  componentDidUpdate:function() {\n    if (this.state.newMarkupAt) {\n      this.refs.surface.openinlinedialog(this.state.newMarkupAt);\n    }\n  },\n  getInitialState: function() { \n    var s=0,l=0,linktarget=null,linksource=null; \n    if (this.props.linktarget) {\n      s=this.props.linktarget.start;\n      l=this.props.linktarget.len;\n      linktarget=this.props.linktarget;\n      linksource=this.props.linksource;\n    }\n    return {selstart:s, sellength:l,newMarkupAt:null, linktarget:linktarget,linksource:linksource};\n  },\n  concatMarkups:function(m1,m2) { // m1 has higher priority\n    var out=[],positions={};\n    m1.map(function(m){ \n      out.push(m);\n      for (var i=0;i<m.len;i++) positions[m.start+i]=true;\n    });\n\n    for (var i=0;i<m2.length;i++) {\n      var m=m2[i],nom1=true;\n      for (var j=0;j<m.len;j++) {\n        nom1=nom1&&!positions[m.start+j];\n      }\n      if (nom1) out.push(m);\n    }\n    return out;\n  },  \n  getMarkups:function(M,offset) { //create dynamic markups from other users\n    var page=this.props.page;\n    var user=this.props.user;\n    M=M||page.filterMarkup(function(){return true});\n    if (!M.length) return []; \n    var filterCB=function(e){return e.payload.author===user.name};\n    var out=M.filter(filterCB);\n    if (user.admin) {\n      var merged=M.filter(function(e){return e.payload.author!=user.name});\n      merged=page.mergeMarkup(merged,this.offsets);\n      if (typeof offset!='undefined'){\n        merged=merged.filter(function(e){return offset>=e.start && offset<e.start+e.len});\n      }\n      out=this.concatMarkups(out,merged);\n      out.sort(function(m1,m2){return m1.start-m2.start});\n    }\n    return out;\n  } ,  \n  getMarkupsAt:function(offset) {\n    var M=this.props.page.markupAt(offset);\n    return this.getMarkups(M,offset);\n  },  \n  getSelectedText:function(s,l) {\n    if (!this.props.page || !this.props.page.inscription) return \"\";\n    s=s||this.state.selstart;\n    l=l||this.state.sellength;\n\n    return this.props.page.inscription.substr(s,l);\n  },\n  selectedToken:function() {\n    if (!this.offsets || !this.offsets.length) return {};\n    var s=this.offsets.indexOf(this.state.selstart);\n    var e=this.offsets.indexOf(this.state.selstart+this.state.sellength);\n    return {start:s,len:e-s};\n  },\n  openlinkmenu:function(x,y,name) {\n    var obj=this.refs[name];\n    if (obj) {\n      x=x-obj.getDOMNode().parentElement.offsetLeft;\n      var menu=obj.getDOMNode();\n      menu.classList.add(\"open\");\n      menu.style.left=x+'px';\n      menu.style.top=(y-this.getDOMNode().offsetTop)+'px'; \n      \n    }\n  }, \n  showlinkbymenu:function(e) {\n    var x=e.pageX, y=e.pageY;\n    this.setState({linkby:this.linkby});\n    setTimeout( this.openlinkmenu.bind(this,x,y,\"linkbymenu\"),200);\n  },\n  showlinktomenu:function(e) {\n    var x=e.pageX, y=e.pageY;\n    this.setState({linkto:this.linkto});\n    setTimeout( this.openlinkmenu.bind(this,x,y,\"linktomenu\"),200);\n  },\n  /*\n  linkByMenu:function() {\n    if (this.state.linkby && this.state.linkby.length) {\n      return linkbymenu({ref:\"linkbymenu\",linkby:this.linkby,action:this.action});\n    } else {\n      return <span></span>\n    }\n  },\n  linkToMenu:function() {\n    if (this.state.linkto && this.state.linkto.length) {\n      var linksource={\n        page:this.props.page\n        ,pagename:this.props.page.name\n        ,db:this.props.kde.dbname\n        ,file:this.props.page.doc.meta.filename\n        ,pageid:this.props.pageid\n        ,start:this.quote.start\n        ,len:this.quote.len\n        ,kde:this.props.kde\n      };\n      return linktomenu({ref:\"linktomenu\",linkto:this.linkto,  linksource:linksource,action:this.action});\n    } else {\n      return <span></span>\n    }\n  },\n  */\n  contextMenu:function() {\n    var sel=this.selectedToken();\n    if (this.props.template.contextmenu) {\n      var text=this.getSelectedText();\n      return React.createElement(this.props.template.contextmenu,\n        {ref:\"menu\",user:this.props.user, action:this.action, \n        start:sel.start,len:sel.len,\n        selstart:this.state.selstart,sellength:this.state.sellength,\n        text:this.getSelectedText()}\n      );  \n    } else {\n      return React.createElement(\"span\", null)\n    }    \n  },\n\n  onTagSet:function(tagset,uuid) {\n    if (!tagset || !tagset.length)return;\n    if (JSON.stringify(this.tagset)!=JSON.stringify(tagset)) {\n      this.tagset=tagset;\n      cssgen.applyStyles(this.props.styles,tagset,\"div[data-id='\"+uuid+\"'] \");\n    }\n  }, \n  addSuggestion:function(start,len,defaulttext) {\n    var text=this.getSelectedText(start,len)+defaulttext;\n    var payload={type:\"suggest\",\n                  author:this.props.user.name,\n                  text:text\n                };\n    this.props.page.clearMarkups(start,len,this.props.user.name);\n    this.props.page.addMarkup(start,len,payload);\n\n    this.setState({selstart:start+len,sellength:0,newMarkupAt:start});\n  },\n  findMistake:function(direction) {\n    var sel={start:0,len:0};\n    var M=this.getMarkups();\n    M =M.sort(function(m1,m2){return m1.start-m2.start});\n    var s=this.state.selstart+this.state.sellength;\n    if (!M.length) return sel;\n    if (direction>0) {\n      for (var i=0;i<M.length;i++) {\n\n        if (this.props.user.admin ==true && M[i].start>=s && M[i].payload.author != this.props.user.name) {\n          sel.start=M[i].start;sel.len=M[i].len;\n          break;\n        }\n        else if (this.props.user.admin !=true && M[i].start>=s && M[i].payload.author == this.props.user.name && M[i].payload.type == \"suggest\") {\n          sel.start=M[i].start;sel.len=M[i].len;\n          break;\n        }\n      }\n    } else if (direction<0) {\n      for (var i=M.length-1;i>-1;i--) {\n        if (M[i].start+M[i].len<s && M[i].payload.author != this.props.user.name) {\n          sel.start=M[i].start;sel.len=M[i].len;\n          break;\n        }\n         else if (this.props.user.admin !=true && M[i].start+M[i].len<s && M[i].payload.author == this.props.user.name && M[i].payload.type == \"suggest\") {\n          sel.start=M[i].start;sel.len=M[i].len;\n          break;\n        }\n      };\n    }\n    return sel;\n  },\n  goPrevMistake:function() {\n    var sel=this.findMistake(-1);\n    if (sel.start) {\n      this.setState({selstart:sel.start,sellength:sel.len,newMarkupAt:sel.start});\n    }\n    return sel.start;\n  },\n  goNextMistake:function() {\n    var sel=this.findMistake(1);\n    if (sel.start) {\n      this.setState({selstart:sel.start,sellength:sel.len,newMarkupAt:sel.start});\n    //return sel.start;\n    }\n  return sel.start;\n  },\n  goNextPageMistake:function(start,len) {\n  this.setState({selstart:start,sellength:len,newMarkupAt:start});\n  },\n  goPrevPageMistake:function(start,len) {\n  this.setState({selstart:start,sellength:len,newMarkupAt:start});\n  },\n  action:function() {\n    var maxlen=10;\n    var args = [],r,username=this.props.user.name;\n    var ss=this.state.selstart, sl=this.state.sellength;\n    var newstart=this.state.selstart+this.state.sellength;\n\n    Array.prototype.push.apply( args, arguments );\n    var action=args.shift();\n    if (action==\"strikeout\") {\n      if (sl>maxlen) return;\n      this.props.page.strikeout(ss,sl,username);\n      this.setState({selstart:newstart+1,sellength:0});\n    } else if (action==\"addsuggestion\") {\n      var ss=args[0]||this.state.selstart;\n      var sl=args[1]||this.state.sellength;\n      var text=args[2]||\"\";\n      if (sl>maxlen) return;\n      this.addSuggestion(ss,sl,text);\n    } else if (action==\"addmarkup\") {\n      var payload=args[0];\n      var silent=args[1];\n      payload.author=this.props.user.name;\n      if (sl>maxlen) return;\n      this.props.page.addMarkup(ss,sl,payload); \n      this.setState({selstart:newstart,sellength:0});\n      if (!silent) this.setState({newMarkupAt:ss});\n    } else if (action==\"addmarkupat\") {\n      var payload=args[2];\n      var silent=args[3];\n      payload.author=this.props.user.name;\n      if (args[1]>maxlen) return;\n      this.props.page.addMarkup(args[0],args[1],payload); \n      this.setState({selstart:newstart,sellength:0,newMarkupAt:null});\n    } else if (action==\"clearmarkup\") {\n      var filename=this.props.dbname+args[0];\n      var that=this;\n      this.props.page.clearMarkups(ss,sl,username,filename);\n      that.setState({selstart:newstart,sellength:0});\n    } else if (action==\"getmarkupsat\") {\n      return this.getMarkupsAt(args[0]);\n/*      \n    } else if (action==\"copy\") {\n      if (typeof process==\"undefined\") return;\n      var text=args[0];\n      var gui = nodeRequire('nw.gui');\n      var clipboard = gui.Clipboard.get();\n      clipboard.set(text);\n*/\n    } else if (action==\"caretmoved\") {\n      this.showLinkButtons(args[0],args[1],args[2]);\n    } else if (action==\"openlink\") { \n      if (this.quote) this.setState({selstart:this.quote.start,sellength:this.quote.len}); //select the quote\n      return this.props.action.apply(this,arguments); //pass to parent\n    } else {\n      return this.props.action.apply(this,arguments);\n    }\n  },\n  showLinkButtons:function(left,top,height) {\n    return;\n    if (this.linktimer) clearTimeout(this.linktimer);\n    var that=this;\n    this.linktimer=setTimeout(function(){\n      var linkto=that.refs.linkto.getDOMNode();\n      var linkby=that.refs.linkby.getDOMNode();\n      that.props.action(\"linkto\",that.state.selstart,that.state.sellength,function(arr,quote){\n        if (arr.length){\n          that.quote=quote;\n          that.linkto=arr;\n          linkto.style.top=top - Math.floor(linkto.offsetHeight/3); \n          linkto.style.left=left ;  \n          linkto.style.visibility=\"visible\";\n        } else linkto.style.visibility=\"hidden\";\n      });\n      that.props.action(\"linkby\",that.state.selstart,that.state.sellength,function(arr){\n        if (arr.length) {\n          that.linkby=arr;\n          linkby.style.top=top-height-linkto.offsetHeight-Math.floor(linkby.offsetHeight/1.5);\n          linkby.style.left=left-linkby.offsetWidth;\n          linkby.style.visibility=\"visible\";\n        } else linkby.style.visibility=\"hidden\";\n      }); \n    },500);\n  },  \n  closemenu:function() {\n    this.refs.menu.getDOMNode().classList.remove(\"open\");\n  },\n  openmenu:function(x,y) {\n    if (this.refs.menu) {\n      var menu=this.refs.menu.getDOMNode();\n      menu.classList.add(\"open\");\n      menu.style.left=x+30+'px';\n      //var menuheight=menu.querySelector(\".dropdown-menu\").offsetHeight;\n      //var yy=y-this.getDOMNode().offsetTop;\n      //if (yy+menuheight-30>this.getDOMNode().offsetHeight) {\n      //yy-=menuheight+30;\n      //}\n      //if (yy<0) yy=0;\n      menu.style.top=y-200+'px'; \n    }\n  },\n  onSelection:function(start,len,x,y,e) {\n    this.setState({selstart:start,sellength:len,newMarkupAt:null}); //open for jump next page\n    if (this.refs.menu && this.refs.menu.onPopup) {\n      if (len && e && e.button==2) {\n        var context={\n          text:this.getSelectedText(start,len),\n          selstart:start,\n          sellength:len\n        }\n        this.refs.menu.onPopup(context); //set menu context\n        setTimeout( this.openmenu.bind(this,x,y),200);\n      } else {\n        this.closemenu();\n      }\n    }\n\n    if (this.props.onSelection) {  \n      this.props.onSelection(start,len,x,y);\n    }\n    this.props.action(\"makingselection\",start,start+len);\n  },\n  render: function() {\n    //console.log(\"docview render\");\n    this.hits=this.props.hits;\n    return (\n      React.createElement(\"div\", {className: \"docview main-wrapper\"}, \n      this.contextMenu(), \n       React.createElement(Surface, {ref: \"surface\", \n                page: this.props.page, \n                user: this.props.user, \n                action: this.action, \n                template: this.props.template, \n                selstart: this.state.selstart, \n                sellength: this.state.sellength, \n                onSelection: this.onSelection, \n                onTagSet: this.onTagSet, \n                linktarget: this.state.linktarget, \n                linksource: this.state.linksource, \n                preview: this.props.preview, \n                isSkip: this.props.isSkip, \n                hits: this.props.hits\n                }\n       )\n      )\n    );\n  }\n});\nmodule.exports=Docview;\n/*\n      <div ref=\"linkto\" className=\"btnlinkto-container\">\n        <span onClick={this.showlinktomenu} className=\"btnlinkto\">{\"\\u21dd\"}</span>\n      </div> \n      <div ref=\"linkby\" className=\"btnlinkby-container\">\n        <span onClick={this.showlinkbymenu} className=\"btnlinkby\">{\"\\u21c7\"}</span>\n      </div>\n\n*/",
    "var React=require(\"react\");\nvar styles=require(\"./styles\")[0].markups;\nvar Docview=require(\"./docview.jsx\");\nvar imageview=require(\"./imageview.jsx\");\nvar D=require(\"./document\");\nvar M=require(\"./markup\");\nvar excerpt=require(\"ksana-search\").excerpt;\nvar isSkip=require(\"ksana-analyzer\").getAPI(\"tibetan1\").isSkip;\nvar legacy2014=require(\"./legacy2014\");\nvar pouch=require(\"./persistentmarkup_pouchdb\");\nvar Nav_tibetan=require(\"./nav_tibetan.jsx\");\n\nvar Docview_tibetan = React.createClass({displayName: \"Docview_tibetan\",\n  getInitialState: function() {\n    //var pageid=parseInt(this.props.pageid||localStorage.getItem(this.storekey())) || 1;\n    var pageid=1;\n    return {doc:null,pageid:pageid};\n  },\n  shouldComponentUpdate:function(nextProps,nextState) {\n      var samehit=JSON.stringify(this.state.activeHits)==JSON.stringify(nextState.activeHits);\n      var r=true;\n      if (nextProps.pageid!=this.props.pageid) {\n        nextState.pageid=nextProps.pageid;\n      } \n      else if \n         (this.state.doc==nextState.doc && this.state.pageid==nextState.pageid\n        &&this.state.selecting==nextState.selecting\n        &&samehit\n        &&this.state.preview==nextState.preview) return false;  //this is a work-around ... children under this component is causing recursive update\n\n      if (this.props.kde.activeQuery&&samehit) {\n        var that=this;\n        setTimeout(function(){\n          that.setState( {activeHits: that.getActiveHits()} );\n        },100)\n      }\n\n      return r;\n  },\n  storekey:function() {\n    return this.props.project.shortname+'.pageid';\n  },\n  saveMarkup:function() {\n        var doc=this.state.doc;\n    if (!doc || !doc.dirty) return;\n    var filename=this.state.doc.meta.filename; \n    var username=this.props.user.name;\n    var markups=this.page().filterMarkup(function(m){return m.payload.author==username});\n    markups = this.change_suggests(markups);\n    var dbid=this.props.kde.dbname;\n    this.saveMarkuptoPouchdb(filename,markups);\n    /*\n    this.$ksana(\"saveMarkup\",{dbid:dbid,markups:markups,filename:filename,i:this.state.pageid } ,function(data){\n      doc.markClean();\n    }); \n  */\n  },\n  saveMarkuptoPouchdb:function(filename,markups)\n    { \n      var dbname=filename.replace(\".xml\",\"\");\n      var ip = location.host.split(\":\")[0];\n      dbname=this.props.project.name+dbname.substring(4,dbname.length);\n      var db = new PouchDB('http://'+ip+':5984/'+dbname);\n      if (markups.length == 0)\n      {\n         pouch.readallfrompouch(db,this.showmessage,1);\n      }\n      else if(markups.length != 0){\n      for(var i=0;i<markups.length;i++)\n      {\n        markups[i]._id=dbname+\"_\"+markups[i].payload.author+\"_\"+markups[i].start;\n        markups[i].pageid=this.state.pageid;\n        markups[i]._rev = markups[i].payload._rev;\n      }\n      pouch.savealltopouch(db,markups,this.showmessage);\n    }\n  },\n   showmessage:function(err) {\n      if(this.state.handsavestate == true && !err) {\n                this.props.action(\"myalert\",0);\n                this.getMarkups();\n                this.state.handsavestate = false;\n      }\n      else if(this.state.handsavestate == true && err )\n      {\n                this.props.action(\"myalert\",1);\n                this.state.handsavestate = false;\n      }\n  },\n  change_suggests:function(markups,type) {\n    var length = markups.length;\n    if(length > 0 && this.props.user.admin == true)\n    {\n      for(var i=0;i<length;i++)\n      {\n        var suggest_markups=this.page().filterMarkup(function(m){return m.start==markups[i].start});\n        for(var j=0;j<suggest_markups.length;j++)\n        {\n          if(type == null && suggest_markups[j].payload.author == markups[i].payload.contributor) {\n            suggest_markups[j].payload.state = \"approve\";\n            markups[markups.length] = suggest_markups[j];\n          }\n          else if(type == null && suggest_markups[j].payload.type == \"suggest\" && suggest_markups[j].payload.author != this.props.user.name) {\n            suggest_markups[j].payload.state = \"reject\";\n            markups[markups.length] = suggest_markups[j];\n          } \n          else if(type != null && suggest_markups[j].payload.type == \"suggest\")\n          {\n            suggest_markups[j].payload.state = \"\";\n            markups[markups.length] = suggest_markups[j];\n          }\n          \n        }\n      }\n    }\n    return markups;\n  },\n  getActiveHits:function() { // get hits in this page and send to docsurface \n    if (!this.props.kde.activeQuery) return [];\n    //var po=this.props.kde.segOffset(this.getPageName());\n    var nfile=this.props.kde.findFile(this.props.filename);\n    var segoffsets=this.props.kde.getFileSegOffsets(nfile);\n\n    var start=segoffsets[this.state.pageid-2];\n    var end=segoffsets[this.state.pageid-1];\n    var Q=this.props.kde.activeQuery;\n    var relative_hits=[];\n    var absolute_hits=excerpt.hitInRange(Q,start,end); //vpos, phrase_width, phrase_id\n    var relative_hits=absolute_hits.map(function(h){  return [ h[0]-start,h[1],h[2]]; });\n\n    return relative_hits;\n  },\n  action:function(type) {\n    var args = Array.prototype.slice.call(arguments);\n    var type=args.shift();\n    var save=false;\n\n    var pageid=this.state.pageid;\n    if (type==\"next\") {\n      if (pageid+1<this.state.doc.pageCount) this.setState({pageid:pageid+1});\n      save=true;\n    } else if (type==\"prev\") {\n      if (pageid>1) this.setState({pageid:pageid-1});\n      save=true;\n    } else if (type==\"first\") {\n      save=true;\n      this.setState({pageid:1});\n    } else if (type==\"last\") {\n      this.setState({pageid:this.state.doc.pageCount-1});\n      save=true;\n    } else if (type==\"gopage\") {\n      var page=this.state.doc.pageByName(args[0])\n      if (page) {\n        this.setState({pageid:page.id});\n        save=true;\n        //this.forceUpdate();\n      }\n    } else if (type==\"nextpage\") {\n      var page=this.state.pageid;\n      var state = args[0];\n      if (page < this.state.doc.pageCount && state == \"null\") {\n        this.setState({pageid:page+1});\n        save=true;\n      }\n      else if (page > 0 && state == 0)\n      {\n        this.setState({pageid:page-1});\n        save=true;\n      }\n    }else if (type==\"markupupdate\") {\n      this.state.doc.markDirty();\n    } else if (type==\"addmarkup\") {\n      console.trace();\n      console.error(\"cannot call addmarkup here\")      \n    } else if (type==\"removemarkup\") {\n     var markup=args[0];\n      var dbname=this.props.filename.replace(\".xml\",\"\");\n      dbname=this.props.project.name+dbname.substring(4,dbname.length);\n      var markups = [markup];\n      markups = this.change_suggests(markups,1);\n      this.saveMarkuptoPouchdb(this.props.filename,markups);\n      this.page().clearMarkups(markup.start,markup.len,this.props.user.name,dbname);\n      //this.cancel_markup(markup.payload.author,markup.start,dbname);\n      this.forceUpdate();\n    } else if (type==\"dismissmarkup\") { \n      this.forceUpdate(); \n    }else if (type==\"prevmistake\") {\n      this.refs.docview.goPrevMistake();\n    }  else if (type==\"nextmistake\") {\n    //this.refs.docview.goNextMistake();\n    var arr = this.watch_suggest();\n    //if(this.props.user.admin == true)\n    //{\n      if(args[0] == \"next\")  type =  this.refs.docview.goNextMistake();\n      else type =  this.refs.docview.goPrevMistake();\n      if(this.props.user.admin == true && document.getElementById(\"applychange\")) document.getElementById(\"applychange\").getElementsByTagName(\"input\")[1].focus();\n      //else if(this.props.user.admin ==false && document.getElementById(\"suggest_tibetan\"))document.getElementById(\"suggest_tibetan\").getElementsByTagName(\"input\")[1].focus();\n      if(type==0 && !(arr[0][0] == pageid && args[0] == \"previous\") && type==0 && !(arr[0][arr[0].length-1] == pageid && args[0] == \"next\"))\n      {\n        save =true;\n        var nextstate,value = this.find_otherpage(args[0],this.state.pageid,arr,this.state.doc);\n        if(value[1] != \"\")\n        {\n          nextstate = value[1];\n          this.setState({pageid:value[0],selstart:nextstate.start,sellength:nextstate.len,newMarkupAt:nextstate.start});\n          var type =  this.refs.docview.goNextPageMistake(nextstate.start,nextstate.len);\n        } \n      }\n    //}\n    //else return;\n    } else if (type==\"preview\") {\n      this.setState({preview:true});\n    } else if (type==\"endpreview\") {\n      this.setState({preview:false});\n    } else if (type==\"makingselection\") {\n      this.setState({selecting: {start:args[0],end: args[1]}});\n    } else if (type==\"searchkeyword\") {\n      this.props.action(\"searchkeyword\",args[0],this.props.kde.dbname);\n    } else if (type==\"linkby\") {\n      var selstart=args[0],len=args[1],cb=args[2];\n      //this.props.kde.findLinkBy(this.page(),selstart,len,cb);\n    } else if (type==\"linkto\") {\n      //find surrounding text\n      //do fuzzy search\n    } else if (type==\"handsavemarkup\") {\n      this.state.handsavestate = true;\n      this.saveMarkup();\n    } else if (type==\"handUpdate\") {\n      this.getMarkups();\n    } else {\n      return this.props.action.apply(this,arguments);\n    }\n\n    if (save) \n      {\n        this.saveMarkup();\n        this.getMarkups();\n      }\n  }, \n  loadDocument:function(fromserver) {\n    return D.createDocument(fromserver.kd,fromserver.kdm);\n  }, \n  componentDidMount:function() {\n      this.getMarkups();\n  }, \n  cancel_markup:function(name,start,dbname)\n  {\n      var ip = location.host.split(\":\")[0];\n      //var dbname=this.props.filename.replace(\".xml\",\"\");\n      //dbname=this.props.project.name+dbname.substring(4,dbname.length);\n      var db = new PouchDB('http://'+ip+':5984/'+dbname);\n      var id = dbname+\"_\"+name+\"_\"+start;\n      pouch.removetopouch(db,id);\n  },\n  getMarkups:function()\n  {\n       var fn=this.props.filename;\n       var dbname=fn.replace(\".xml\",\"\");\n       var ip = location.host.split(\":\")[0];\n       dbname=this.props.project.name+dbname.substring(4,dbname.length);\n       var db = new PouchDB('http://'+ip+':5984/'+dbname);\n       var pagecount=-this.props.kde.pageCount;\n       var mydb = [];\n       pouch.readallfrompouch(db,this.getMarkupsformpouch,0);    \n      //persistentmarkup.loadMarkup(fn,-doc.pageCount,function(markups){\n      //  doc.addMarkups(markups);\n      //  that.setState({doc:doc,activeHits:that.getActiveHits()});  \n      //});\n      //if(mydb == \"\"){ db.destroy(function(err, info) { });}\n      //if (that.props.tab ) that.props.tab.instance=that; // for tabui \n      /*\n      that.$ksana(\"loadDocumentJSON\",{project:that.props.project,file:that.props.filename}).done(function(data){\n        doc.addMarkups(data.kdm);\n        doc.meta.filename=this.props.filename;\n        that.setState({doc:doc,activeHits:that.getActiveHits()});\n      });\n    */\n    /*\n    this.$ksana(\"loadDocumentJSON\",{project:this.props.project,file:this.props.filename}).done(function(data){\n      var doc=this.loadDocument(data);\n      doc.meta.filename=this.props.filename;\n      this.setState({doc:doc});\n    });*/\n    if (this.props.tab ) this.props.tab.instance=this; // for tabui \n  },\n  getMarkupsformpouch:function(res)\n  {\n    var that = this;\n    var fn = this.props.filename;\n    if(res!= null ) mydb = res.rows;\n    legacy2014.getDocument.call(this.props.kde,fn,function(doc){ \n        doc.meta.filename=fn;\n        doc.addMarkups(mydb);\n        that.setState({doc:doc,activeHits:that.getActiveHits()});\n    });\n  },\n  watch_suggest:function()\n  {\n    var myarr = [[],[]];\n      for(var i =0;i<this.state.doc.pageCount;i++)\n      {\n          var suggestarr =[],revisionarr = [];\n          for(var j=0;j<this.state.doc.getPage(i).__markups__().length;j++)\n          {    \n              var markup = this.state.doc.getPage(i).__markups__()[j];\n              if(this.props.user.admin == true)\n              {\n                if(markup.payload.type==\"suggest\" && markup.payload.author != this.props.user.name) suggestarr.push(markup.start);\n                if(markup.payload.type==\"revision\" && markup.payload.author == this.props.user.name) revisionarr.push(markup.start);\n              }\n              else \n              {\n                if(markup.payload.type==\"suggest\" && markup.payload.author == this.props.user.name) suggestarr.push(markup.start);\n              }\n          }\n          var result = $(suggestarr).not(revisionarr).get();\n          if(result != \"\" ) {\n            myarr[0].push(i);\n            myarr[1].push(result.sort());\n          }\n      }\n      return myarr;\n  },\n  find_otherpage:function(direction,pid,arr,data)\n  {\n      var revarr = [],temp = \"\",newpage;\n      if(direction == \"previous\" && arr[0].indexOf(pid)-1 == -2) newpage = arr[0].length -1;\n      else if(direction == \"previous\" && arr[0].indexOf(pid)-1 != -2) newpage =arr[0].indexOf(pid)-1;\n      else newpage = arr[0].indexOf(pid)+1;\n      var markups = data.getPage(arr[0][newpage]).__markups__();\n      for(var i=0;i<markups.length;i++)\n      {\n        if(direction == \"next\" && markups[i].start == arr[1][newpage].sort(function(a,b){return a - b})[0] ) temp = markups[i];\n        else if(direction == \"previous\" && markups[i].start == arr[1][newpage].sort(function(a,b){return a - b})[arr[1][newpage].length-1]) temp = markups[i];\n      }\n      return [arr[0][newpage],temp];\n  },\n  page:function() {\n    if (!this.state.doc) return null;\n    var page=this.state.doc.getPage(this.state.pageid);\n    var user=this.props.user.name;\n    var admin_viewable=this.props.project.tmpl.admin_viewable_tags || [];\n    if (this.state.preview) {\n      var suggestions=page.filterMarkup(function(m){\n        var p=m.payload;\n        return (p.author==user || admin_viewable.indexOf(p.type)>-1);\n      });\n      return page.preview({suggestions:suggestions});\n    } else {\n      return page;\n    }\n  },\n  getPageName:function() {\n    var n=this.page();\n    if (!n)return \"\"\n    return n.name;\n  },\n  /*\n  imagefilename:function() {\n    var pagename=this.getPageName();\n    if (!this.props.project.setting) return pagename;\n    return this.props.project.setting.getImage(pagename);\n  },*/\n  imagefilename:function() {\n    return this.getPageName();\n  },\n  componentDidUpdate:function() {\n    this.props.action(\"openimage\",this.imagefilename(),this.getPageName(),this.props.project);\n  },\n  componentWillUnmount:function() {\n    var today = new Date();\n    var lastfile={project:this.props.project.shortname,\n      file:this.props.filename,time:today};\n    localStorage.setItem(this.props.user.name+\".lastfile\",JSON.stringify(lastfile));\n    this.saveMarkup();\n  },\n  nav:function() {\n    var params={ref:\"navigator\" ,user:this.props.user, preview:this.state.preview,\n      page:this.page(), action:this.action,selecting:this.state.selecting};\n\n      return React.createElement(Nav_tibetan,params);\n      //return Require(this.props.project.tmpl.navigator)(params);\n  },\n  getPadding:function() {\n    var bodywidth = document.body.offsetWidth;\n    var imageheight = 307*(document.body.offsetWidth/1280)+30;\n    return imageheight;\n  },\n  getAlert:function() {\n    return  (React.createElement(\"div\", null, React.createElement(\"div\", {className: \"alert_ok alert-success\", style: {width:window.innerWidth*0.95}}, \n            React.createElement(\"strong\", null, \"Saved successfully!\")\n            ), React.createElement(\"div\", {className: \"alert_err alert-danger\", style: {width:window.innerWidth*0.95}}, \n            React.createElement(\"strong\", null, \"Saved failed!\")\n            )));\n  },\n  render: function() {\n    localStorage.setItem(this.storekey(),this.state.pageid);\n    if (!this.state.doc) return React.createElement(\"span\", null)\n    return ( \n      React.createElement(\"div\", null, \n      React.createElement(\"div\", {className: \"docview_tibetan\", style: {marginLeft:\"20px\",height:document.body.offsetHeight-68+\"px\"}}, \n        React.createElement(\"div\", null, this.getAlert()), \n        React.createElement(\"div\", null, this.nav()), \n        React.createElement(\"div\", {id: \"inlinetext\", style: {height:document.body.offsetHeight-(document.body.offsetWidth -20)/4.17-110+\"px\",overflowY:\"scroll\",overflowX:\"hidden\"}}, \n        React.createElement(Docview, {ref: \"docview\", \n            page: this.page(), \n            pageid: this.state.pageid, \n            user: this.props.user, \n            dbname: this.props.kde.dbname, \n            template: this.props.project.tmpl, \n            customfunc: this.props.kde.customfunc, \n            styles: styles, \n            isSkip: isSkip, \n            hits: this.state.activeHits, \n            autoselect: this.props.selection, \n            action: this.action\n          })\n          )\n      )\n      )\n    );\n  }\n});\nmodule.exports=Docview_tibetan;",
    "var React=require(\"react\");\nvar element_comment_tibetan = React.createClass({displayName: \"element_comment_tibetan\",\n  getInitialState: function() {\n    return {};\n  },\n  openViewonly:function(e) {\n    var dom=e.target;\n    if (dom.className!=\"viewonlyHolder\") dom=dom.parentElement;\n    $(dom).popover(\"show\");\n  },\n  render: function() {\n    return ( \n    React.createElement(\"span\", {tabindex: \"0\", href: \"#\", className: \"viewonlyHolder\", \n          \"data-toggle\": \"popover\", \n          onClick: this.openViewonly, \n          \"data-trigger\": \"focus\", \n          \"data-content\": this.props.payload.hint +\" by \"+this.props.payload.author, \n          title: this.props.payload.type+\" by \"+this.props.payload.author\n    }, React.createElement(\"span\", {className: \"author\"}, this.props.payload.author.substr(0,5)), \".\")\n    );\n  }\n});\nmodule.exports=element_comment_tibetan;",
    "var React=require(\"react\");\nvar FileListing = React.createClass({displayName: \"FileListing\",\n  getInitialState:function() {\n    return {selected:0,hovered:-1};\n  },\n  select:function(e) {\n    var ee=e.target.parentElement.attributes['data-i'];\n    if (!ee) return;\n    var selected=parseInt(ee.value);\n    this.setState({selected:selected});\n    this.props.onSelectFile(selected);\n  },\n  shouldComponentUpdate:function(nextProps,nextState) {\n\n    var shouldUpdate= (nextState.hovered != this.state.hovered || this.state.hovered==-1\n      ||nextState.selected!=this.state.selected || this.props.files!=nextProps.files);\n\n    if (this.props.files!=nextProps.files) {\n      if (nextProps.selected!=this.state.selected) {\n        nextState.selected=nextProps.selected;\n      }\n    }\n    return shouldUpdate;\n  },\n  leave:function(e) {\n    this.setState({hovered:-1});\n  },\n  openfile:function(e) {\n    var e=e.target;\n    while (e) {\n      if (e.attributes['data-i']) {\n        var i=parseInt(e.attributes['data-i'].value);\n        break;\n      } else e=e.parentElement;\n    }\n    this.setState({selected:i});\n    this.props.onOpenFile(i);\n  },\n  renderFiles:function() {\n    var cls=\"\",out=[], filestart=this.props.start;\n    for (var i=0;i<this.props.files.length;i++) {\n      var f=this.props.files[i],hit=\"\";\n      if (this.props.hits) hit=this.props.hits[filestart+i]?this.props.hits[filestart+i].length:\"\";\n      if (!hit) hit=\"\";\n      if (i==this.state.selected) cls=\"success\"; else cls=\"\";\n      out.push(React.createElement(\"tr\", {key: 'f'+i, onClick: this.select, \n           onMouseEnter: this.hoverFile, onMouseLeave: this.leave, \n           className: cls, \"data-i\": i}, \n        React.createElement(\"td\", {onDoubleClick: this.openfile}, f.substring(0,f.length-4), \n        \n        React.createElement(\"span\", {className: \"label label-info\"}, hit), \n        React.createElement(\"span\", {className: \"pull-right\", style: {visibility:this.state.hovered==i?\"\":\"hidden\"}}, \n        React.createElement(\"button\", {className: \"btn btn-success\", onClick: this.openfile}, \"Open\")\n        )\n        )\n        ));\n    };\n    return out;\n  }, \n  hoverFile:function(e) {\n    if (e.target.parentElement.nodeName!='TR') return;\n    var hovered=e.target.parentElement.attributes['data-i'].value;\n    if (this.state.hovered==hovered) return;\n\n    this.setState({hovered:hovered});\n  },\n  render:function() {\n    return React.createElement(\"div\", {className: \"fileList\"}, \n    React.createElement(\"table\", {className: \"table table-hover\"}, \n    React.createElement(\"tbody\", null, this.renderFiles())));\n  }\n});\n\nvar filelist = React.createClass({displayName: \"filelist\",\n  getInitialState: function() {\n    return {bar: \"world\",files:[],selectedFile:0};\n  },\n  shouldComponentUpdate:function(nextProps,nextState) {\n    return (nextProps.kde.activeQuery!=this.activeQuery || typeof this.activeQuery==\"undefined\"\n      || nextState.files!=this.state.files|| nextState.folders!=this.state.folders);\n  }, \n  selectFile:function(i) {\n    var f=this.state.folder+'/'+this.state.files[i];\n    this.props.kde.activeFile=f;\n    this.props.action(\"selectfile\",this.props.kde,f);\n  },\n  openFile:function(i) {\n    var f=this.state.folder+'/'+this.state.files[i];\n    var gotopageid,linktarget,linksource;\n    if (this.props.autoopen)  {\n      gotopageid=this.props.autoopen.pageid;\n      linktarget=this.props.autoopen.linktarget;\n      linksource=this.props.autoopen.linksource;\n    }\n    this.props.action(\"openfile\",this.props.kde.kdbid,f,gotopageid,null,linktarget,linksource);\n    if (this.props.autoopen) {\n      this.props.autoopen.pageid=\"\";\n      this.props.autoopen.linktarget=null;\n    }\n    this.setState({selectedFile:i});\n  },\n  getFileHits:function() {\n    if (!this.props.kde.activeQuery) return [];\n    return this.props.kde.activeQuery.byFile;\n  },\n  render: function() {\n    return (\n      React.createElement(\"div\", null, \n        React.createElement(FileListing, {files: this.state.files, \n            selected: this.state.selectedFile, \n            onSelectFile: this.selectFile, \n            onOpenFile: this.openFile, \n            start: this.state.filestart, \n            hits: this.getFileHits()}\n        )\n      )\n    );\n  },\n  componentDidMount:function() {\n    var that=this;\n    this.props.kde.get(\"fileNames\",function(files){\n      that.setState({\"files\":files});\n    })\n  }\n});\nmodule.exports=filelist;",
    "var React=require(\"react\"); \nvar imageview = React.createClass({displayName: \"imageview\",\n  getInitialState: function() {\n    return {bar: \"world\"};\n  },\n  expandFileName:function(src) {\n    if (src.substring(0,4)==\"http\") return src;\n    var s=src.split('.');\n    var folder=s[0];\n    var filename=s[1];\n    folder='00'+folder;\n    folder=folder.substring(folder.length-3);\n    filename='00'+filename;\n    filename=filename.substring(filename.length-4);\n\n    return \"http://dharma-treasure.org/kangyur_images/lijiang/\"\n    +folder+'/'+folder+'-'+filename+\".jpg\";\n  }, \n  adjustImage:function() {\n    //this.refs.imagediv.getDOMNode().style.height=\"740\";\n    var maxwidth=document.offsetWidth/2;\n    if (!this.props.project.setting) return ;\n    var adjustImage=this.props.project.setting.adjustImage;\n    var img=this.refs.image.getDOMNode();\n    var container=img.parentElement.parentElement;\n    if (adjustImage) adjustImage(img,this.props.pagename,container);\n  }, \n  componentDidMount:function() {\n    this.adjustImage(); \n  }, \n  componentDidUpdate:function() {\n    this.adjustImage();\n  },   \n  render: function() {\n    return (\n      React.createElement(\"div\", {ref: \"imagediv\", id: \"imagediv\"}, \n        React.createElement(\"img\", {ref: \"image\", className: \"sourceimage\", src: this.expandFileName(this.props.src)})\n      )\n    );\n  }\n}); \n//<button className=\"btn btn-default\">image control buttons</button>\nmodule.exports=imageview;",
    "var React=require(\"react\");\nvar inlinedialog_accept_tibetan = React.createClass({displayName: \"inlinedialog_accept_tibetan\",\n  apply:function(e) {\n    this.props.action(\"markupupdate\");\n  },\n  keyup:function(e) {\n    if (e.keyCode==13)  this.apply(e);\n    else if (e.keyCode==27) this.props.action(\"markupdate\");\n  },\n  clear:function() {\n    var n=this.refs.inputtext.getDOMNode();\n    n.focus();\n    n.value=\"\";\n  },\n  remove:function() {\n    this.props.action(\"removemarkup\",this.props.markup);\n  },\n  at_moveto:function() {\n    var target = document.getElementById(\"accept_tibetan\").style;\n    var range = window.innerWidth - 400;\n    var width = document.getElementById(\"points\").value*(range/10);\n    target.left = width+\"px\";\n  },\n  markup:function() {\n    return this.props.markup.payload;\n  },\n  contributor:function() {\n    if (this.markup().contributor){\n      return  React.createElement(\"span\", null, \n          React.createElement(\"span\", {className: \"col-sm-4\"}, React.createElement(\"h5\", null, \"contributor\")), \n          React.createElement(\"span\", {className: \"col-sm-6\"}, React.createElement(\"h5\", null, this.markup().contributor))\n        )\n    } else return null;\n  },\n  render: function() {\n    return ( \n      React.createElement(\"div\", {onKeyUp: this.onkeyup, id: \"accept_tibetan\", className: \"inlinedialog well accept_pos\", style: {marginTop:\"70px\"}}, \n        React.createElement(\"span\", {className: \"col-md-12\"}, this.props.text), \n        React.createElement(\"div\", null, \n           React.createElement(\"input\", {type: \"range\", id: \"points\", min: \"0\", max: \"10\", defaultValue: \"0\", style: {width:\"400px\"}, onMouseUp: this.at_moveto})\n          ), \n          React.createElement(\"span\", {className: \"col-md-12\"}, \n            React.createElement(\"span\", {className: \"col-md-4\"}, React.createElement(\"h5\", null, \"suggestion\")), \n            React.createElement(\"span\", {className: \"col-md-6\"}, React.createElement(\"h5\", null, this.markup().text)), \n            React.createElement(\"span\", {className: \"col-md-2\"}, React.createElement(\"input\", {checked: this.markup().insert, type: \"checkbox\"}))\n          ), \n         React.createElement(\"span\", {className: \"col-md-12\"}, this.contributor()), \n        React.createElement(\"span\", null, \n          React.createElement(\"span\", {className: \"col-md-4 col-md-offset-4\"}, \n            React.createElement(\"button\", {className: \"form-control btn btn-warning control_S-halfsize\", onClick: this.remove}, \"Reset\")\n          ), \n          React.createElement(\"span\", {className: \"col-md-4\"}, \n            React.createElement(\"button\", {className: \"form-control btn btn-success control_S-halfsize\", onClick: this.apply}, \"Ok\")\n          )\n        )\n      )\n    );\n  },\n  focus:function() {\n    if (this.refs.inputtext) this.refs.inputtext.getDOMNode().focus();\n  },\n  componentDidMount:function() {\n    setTimeout(  this.focus,300);\n  },\n});\nmodule.exports=inlinedialog_accept_tibetan;",
    "var React=require(\"react\");\nvar Change=React.createClass({displayName: \"Change\",\n  author_error:function(e) {\n     var img = e.target;\n     img.src= 'images/photo.png';\n  },\n  render:function() {\n    var opts={\n      \"className\":\"btn btn-success control_S-halfsize\",\n      \"data-choice\":this.props.i, \n      \"name\":this.props.name,\n      \"onClick\":this.props.select\n    }\n    return (\n     React.createElement(\"span\", {\"data-date\": this.props.now, className: \"col-md-12\"}, \n       React.createElement(\"span\", {className: \"col-md-2\"}, React.createElement(\"img\", {src: \"photo/\"+this.props.m.author+\".jpg?\"+ new Date().getTime(), onError: this.author_error, style: {height:\"40px\",width:\"40px\",backgroundColor:\"#dddddd\"}}), React.createElement(\"h6\", {className: \"pull-left\", style: {color:\"blue\"}}, this.props.m.author)), \n       React.createElement(\"span\", {className: \"col-md-7\", style: {wordBreak:\"break-all\",fontSize:\"80%\",display:\"inline-block\"}}, this.props.m.text, React.createElement(\"br\", null), React.createElement(\"h5\", null, this.props.m.reason)), \n       React.createElement(\"span\", {className: \"col-md-3\"}, React.DOM.button(opts,\"Approve\"))\n    ));\n  }\n})\nvar inlinedialog_applychange = React.createClass({displayName: \"inlinedialog_applychange\",\n  getInitialState: function() {\n    return {now : new Date()};\n  },\n  keyup:function(e) {\n    if (e.keyCode==13)  this.myanwser(e);\n    else if (e.keyCode==27) this.props.action(\"markupdate\");\n  },\n  markup:function() {\n    return this.props.markup.payload;\n  },\n  select:function(e) {\n    var selected=parseInt(e.target.attributes['data-choice'].value);\n    var accepted=this.markup().choices[selected];\n    var payload={type:\"revision\" ,text:accepted.text, \n        contributor:accepted.author};\n    var m=this.props.markup;\n    this.props.action(\"addmarkupat\",m.start,m.len,payload);\n    this.props.action(\"nextmistake\",\"next\");\n  },\n  myanwser:function() {\n    var inputtext=this.refs.inputtext.getDOMNode().value;\n    var payload={type:\"revision\" ,text:inputtext};\n    var m=this.props.markup;\n    this.props.action(\"addmarkup\",payload,true);\n    this.props.action(\"nextmistake\",\"next\");\n  },\n  choices:function(name) {\n    var out=[];\n    for (var i=0;i<this.markup().choices.length;i++) {\n      out.push(Change({\n        ref:'o'+i,\n        now:this.state.now,\n        select:this.select,\n        m:this.markup().choices[i],\n        i:i,name:name}));\n    }\n    return out;\n  },\n  setselected:function() {\n    if (this.markup().selected) {\n      this.refs['o'+(this.markup().selected-1)].getDOMNode()\n      .querySelector(\"input[type=radio]\").checked=true;\n    } else {\n      var radio=this.getDOMNode().querySelectorAll(\"input[type=radio]\");\n      for (var i=0;i<radio.length;i++) {\n        radio[i].checked=false;\n      }\n    }\n  },\n  ac_moveto:function() {\n    var target = document.getElementById(\"applychange\").style;\n    var range = window.innerWidth - 500;\n    var width = document.getElementById(\"points\").value*(range/10);\n    target.left = width+\"px\";\n  },\n  componentDidMount:function() {\n    this.setselected();\n  },\n  componentDidUpdate:function() {\n    this.setselected();\n  },\n  clear:function() {\n    var n=this.refs.inputtext.getDOMNode();\n    n.focus();\n    n.value=\"\";\n  },  \n  close:function() {\n    this.props.action(\"markupupdate\");\n    this.props.action(\"nextmistake\",\"next\");\n  },\n  otherAnswer:function() {\n    return (\n    React.createElement(\"span\", {className: \"col-md-12\"}, \n        React.createElement(\"span\", {className: \"col-md-2\", style: {fontSize:\"50%\",marginTop:\"8px\"}}, \"Suggestion\"), \n        React.createElement(\"span\", {className: \"col-md-7\"}, React.createElement(\"input\", {ref: \"inputtext\", className: \"focus form-control input-lg\"})), \n        React.createElement(\"span\", {className: \"col-md-3\"}, React.createElement(\"button\", {className: \"btn btn-success control_S-halfsize\", onClick: this.myanwser}, \"Mine is better\"))\n    ));\n  },\n  render: function() {\n    return (\n      React.createElement(\"div\", {onKeyUp: this.keyup, id: \"applychange\", className: \"col-md-12 inlinedialog well\", style: {width:\"500px\",marginTop:\"70px\"}}, \n      React.createElement(\"div\", null, \n        React.createElement(\"input\", {type: \"range\", id: \"points\", min: \"0\", max: \"10\", defaultValue: \"0\", style: {width:\"500px\"}, onMouseUp: this.ac_moveto})\n       ), \n      React.createElement(\"span\", {className: \"col-md-6\"}, this.props.text), \n      React.createElement(\"span\", {className: \"col-md-3\"}, React.createElement(\"button\", {className: \"btn btn-warning ignore_button control_S-halfsize\", style: {marginLeft:\"-8px\"}, onClick: this.close}, \"Ignore\")), \n      React.createElement(\"span\", {className: \"col-md-3\"}, React.createElement(\"button\", {className: \"btn btn-danger control_S-halfsize\", style: {marginLeft:\"-8px\"}, onClick: this.myanwser}, \"Reject\")), \n      React.createElement(\"hr\", null), \n      this.choices(\"radioname\"), \n      this.otherAnswer()\n      )\n    );\n  } \n});\nmodule.exports=inlinedialog_applychange;",
    "var React=require(\"react\");\nvar inlinedialog_comment_tibetan = React.createClass({displayName: \"inlinedialog_comment_tibetan\",\n  apply:function(e) {\n    this.markup().text=this.props.text;\n    this.markup().hint=this.refs.comment.getDOMNode().value;\n    this.props.action(\"markupupdate\");\n  },\n  keyup:function(e) {\n    if (e.keyCode==27) {\n      if (this.refs.comment.getDOMNode().value==\"\") {\n          this.remove();\n      } else {\n        this.props.action(\"markupdate\");  \n      }      \n    }\n  }, \n  ct_moveto:function() {\n    var target = document.getElementById(\"comment_tibetan\").style;\n    var range = window.innerWidth - 400;\n    var width = document.getElementById(\"points\").value*(range/10);\n    target.left = width+\"px\";\n  },\n  remove:function() {\n    if(this.props.markup.payload.hint == null) this.props.action(\"removemarkup\",this.props.markup);\n    else this.props.action(\"dismissmarkup\",this.props.markup);\n  },\n  markup:function() {\n    return this.props.markup.payload;\n  },\n  render: function() {\n    return (\n      React.createElement(\"div\", {onKeyUp: this.keyup, id: \"comment_tibetan\", className: \"inlinedialog well\", style: {marginTop:\"70px\"}}, \n        React.createElement(\"div\", null, \n           React.createElement(\"input\", {type: \"range\", id: \"points\", min: \"0\", max: \"10\", defaultValue: \"0\", style: {width:\"400px\"}, onMouseUp: this.ct_moveto})\n          ), \n        React.createElement(\"span\", {className: \"col-sm-12\"}, this.props.text), \n        React.createElement(\"span\", {className: \"col-sm-3\"}, React.createElement(\"h5\", null, \"Comment\")), \n        React.createElement(\"span\", {className: \"col-sm-9\"}, \n        React.createElement(\"span\", {className: \"col-sm-12\", style: {marginBottom:\"5px\"}}, React.createElement(\"textarea\", {rows: \"3\", ref: \"comment\", className: \"form-control input-lg\"})), \n        React.createElement(\"span\", {className: \"col-sm-6\"}, React.createElement(\"button\", {className: \"form-control btn btn-warning control_S-halfsize\", onClick: this.remove}, \"Cancel\")), \n        React.createElement(\"span\", {className: \"col-sm-6\"}, React.createElement(\"button\", {className: \"form-control btn btn-success control_S-halfsize\", onClick: this.apply}, \"Apply\"))\n        )\n      )\n    );\n  },\n  focus:function() {\n    if (this.refs.comment) this.refs.comment.getDOMNode().focus();\n  },\n  componentDidMount:function() {\n    this.refs.comment.getDOMNode().value = this.markup().hint;\n    setTimeout(this.focus,300);\n  },\n  componentDidUpdate:function() {\n    this.refs.comment.getDOMNode().value = this.markup().hint;\n  },\n});\nmodule.exports=inlinedialog_comment_tibetan;",
    "var React=require(\"react\");\nvar inlinedialog_makelink = React.createClass({displayName: \"inlinedialog_makelink\",\n  getInitialState: function() {\n    return {bar: \"world\"};\n  },\n  apply:function() {\n    this.props.action(\"makelink\",this.props.page,this.props.linktarget,this.props.linksource);\n  },\n  cancel:function() {\n    this.props.action(\"markupupdate\");\n  },\n  render: function() {\n    return ( \n      React.createElement(\"div\", {className: \"well\"}, \n        React.createElement(\"span\", {className: \"input-group input-group-lg\"}, \n          React.createElement(\"span\", {className: \"input-group-addon\"}, \"Makelink\")\n        ), \n\n        React.createElement(\"span\", {className: \"row\"}, \n          React.createElement(\"span\", {className: \"col-sm-4\"}, \n            React.createElement(\"button\", {className: \"form-control btn btn-danger\", onClick: this.cancel}, \"Cancel\")\n          ), \n          React.createElement(\"span\", {className: \"col-sm-8\"}, \n            React.createElement(\"button\", {className: \"pull-right form-control btn btn-success\", onClick: this.apply}, \"Create Link\")\n          )\n        )\n\n      )\n    );\n  }\n});\nmodule.exports=inlinedialog_makelink;",
    "var React=require(\"react\");\nvar inlinedialog_suggest_tibetan = React.createClass({displayName: \"inlinedialog_suggest_tibetan\",\n  apply:function() {    \n    var text=this.refs.inputtext.getDOMNode().value;\n    if (this.props.text==text) {\n      this.remove(); //no chances\n    } else {\n      this.markup().text=text;  \n      this.markup().reason=this.refs.reason.getDOMNode().value;\n      this.markup().state = \"\";\n    }\n    this.props.action(\"markupupdate\");\n  },\n  keyup:function(e) {\n    if (e.keyCode==13)  this.apply(e);\n    else if (e.keyCode==27) {\n      if (this.refs.inputtext.getDOMNode().value==this.props.text) {\n        this.props.action(\"removemarkup\",this.props.markup);\n      } else {\n        this.props.action(\"markupdate\");  //cancel\n      }\n    }\n  }, \n  clear:function() {\n    var n=this.refs.inputtext.getDOMNode();\n    n.focus();\n    n.value=\"\";\n  },\n  st_moveto:function() {\n    var target = document.getElementById(\"suggest_tibetan\").style;\n    var range = window.innerWidth - 400;\n    var width = document.getElementById(\"points\").value*(range/10);\n    target.left = width+\"px\";\n  },\n  remove:function() {\n    if(this.props.markup.payload.text == this.props.text) this.props.action(\"removemarkup\",this.props.markup);\n    else this.props.action(\"dismissmarkup\",this.props.markup);\n  },\n  markup:function() {\n    return this.props.markup.payload;\n  },\n  render: function() {\n    if (this.props.markup.payload.state == \"reject\") {\n      return (React.createElement(\"div\", {onKeyUp: this.keyup, id: \"suggest_tibetan\", className: \"inlinedialog well\", style: {marginTop:\"70px\"}}, \"This suggset has been rejected.\"));\n      }\n    else if (this.props.markup.payload.state == \"approve\") {\n      return (React.createElement(\"div\", {onKeyUp: this.keyup, id: \"suggest_tibetan\", className: \"inlinedialog well\", style: {marginTop:\"70px\"}}, \"This suggset has been approved.\"));\n      }\n    else return (\n       React.createElement(\"div\", {onKeyUp: this.keyup, id: \"suggest_tibetan\", className: \"inlinedialog well\", style: {marginTop:\"70px\"}}, \n        React.createElement(\"div\", null, \n           React.createElement(\"input\", {type: \"range\", id: \"points\", min: \"0\", max: \"10\", defaultValue: \"0\", style: {width:\"400px\"}, onMouseUp: this.st_moveto})\n          ), \n        React.createElement(\"span\", null, this.props.text), React.createElement(\"br\", null), \n        React.createElement(\"span\", null, \n        React.createElement(\"span\", {className: \"col-sm-4\"}, \n          React.createElement(\"h5\", {className: \"pull-right\"}, \"Suggestion\"), \n          React.createElement(\"h5\", {className: \"pull-right\"}, \"Reason\")\n        ), \n          React.createElement(\"span\", {className: \"col-sm-8\"}, \n            React.createElement(\"span\", {className: \"col-sm-12\", style: {marginBottom:\"10px\"}}, React.createElement(\"input\", {ref: \"inputtext\", type: \"text\", onMouseOver: this.st_moveto, className: \"focus form-control input-lg\", onKeyPress: this.change})), \n            React.createElement(\"span\", {className: \"col-sm-12\", style: {marginBottom:\"5px\"}}, React.createElement(\"textarea\", {rows: \"2\", ref: \"reason\", className: \"form-control input-lg\"})), \n            React.createElement(\"span\", {className: \"col-sm-6\"}, React.createElement(\"button\", {className: \"form-control btn btn-warning control_S-halfsize\", style: {marginLeft:\"-20px\"}, onClick: this.remove}, \"Cancel\")), \n            React.createElement(\"span\", {className: \"col-sm-6\"}, React.createElement(\"button\", {className: \"form-control btn btn-success control_S-halfsize\", onClick: this.apply}, \"Apply\"))\n          )\n        )\n      )\n    );\n  },\n  focus:function() {\n    if (this.refs.inputtext) {\n      var dn=this.refs.inputtext.getDOMNode();\n      dn.focus();\n      dn.selectionStart=dn.selectionEnd;\n    }\n  },\n  componentDidMount:function() {\n    if (this.refs.inputtext) {\n          this.refs.inputtext.getDOMNode().value = this.markup().text;\n          this.refs.reason.getDOMNode().value = this.markup().reason|| \"\";\n    }\n\n    setTimeout(this.focus,300);\n  },\n  componentDidUpdate:function() {\n    if (this.refs.inputtext) {\n      this.refs.inputtext.getDOMNode().value = this.markup().text;\n      this.refs.reason.getDOMNode().value = this.markup().reason || \"\";\n   }\n  },\n});\nmodule.exports=inlinedialog_suggest_tibetan;",
    "var toDoc=function(segnames,texts,others) {\n\tvar D=require(\"./document\");\t\n\tvar d=D.createDocument() ,revert=null;\n\tfor (var i=0;i<texts.length;i++) {\n\t\tif (others.reverts && others.reverts[i].trim()) revert=JSON.parse(others.reverts[i]);\n\t\telse revert=null;\n\t\tvar p=null;\n\t\tif (others.parents) p=others.parents[i];\n\t\td.createPage({n:segnames[i],t:texts[i],p:p,r:revert});\n\t}\n\tif (others.markups) d.addMarkups(others.markups);\n\td.endCreatePages();\n\treturn d;\n}\n\nvar getDocument=function(filename,markups,cb){\n\tvar engine=this;\n\tvar filenames=engine.get(\"filenames\");\n\n\tif (typeof markups==\"function\")  { //no markups\n\t\tcb=markups;\n\t\tmarkups=null;\n\t}\n\n\tvar i=filenames.indexOf(filename);\n\tif (i==-1) {\n\t\tcb(null);\n\t} else {\n\t\tvar segnames=engine.getFileSegNames(i);\n\t\tvar files=engine.get([\"files\",i],true,function(file){\n\t\t\tvar parentId=null,reverts=null;\n\t\t\tif (file) {\n\t\t\t\tparentId=file.parentId;\n\t\t\t\treverts=file.reverts;\n\t\t\t}\n\t\t\tengine.get([\"filecontents\",i],true,function(data){\n\t\t\t\tcb(toDoc(segnames,data,{parents:parentId,reverts:reverts,markups:markups}));\n\t\t\t});\t\t\t\n\t\t});\n\t}\n}\n\nmodule.exports={getDocument:getDocument};",
    "/** @jsx React.DOM */\n//var bootstrap=require('./bootstrap');\nvar Tabui=require(\"./tabui.jsx\"); \nvar styles=require(\"./styles\")[0].markups;\nvar Docview=require(\"./docview.jsx\"); \nvar imageview=require(\"./imageview.jsx\");\nvar mainmenu=require(\"./mainmenu.jsx\"); \nvar devmenu=require(\"./devmenu.jsx\"); \nvar reference=require(\"./referenceview.jsx\"); \nvar projectlist=require(\"./projectlist.jsx\"); \nvar projectview=require(\"./projectview.jsx\");\nvar filelist=require(\"./filelist.jsx\");\nvar project=require(\"./project\");\nvar About=require(\"./about.jsx\");\nvar Searchmain=require(\"./mainsearch.jsx\");\nvar userlogin=require(\"./userlogin.jsx\"); \nvar Buildindex=require(\"./buildindex.jsx\");\nvar kde=require(\"ksana-database\");\nvar kse=require(\"ksana-search\");\nvar pouch=require(\"./persistentmarkup_pouchdb\");\n\n//var passwords=require(\"./passwd\");\nvar React=require(\"react\"); \n//disable system right click menu\nwindow.document.oncontextmenu = function(e){\n    return false;\n}\nwindow.onbeforeunload = function(event){\n        return console.trace(\"reload\")\n};\n/*\nvar login=function(opts){\n  opts=opts||{};\n  var password=opts.password||opts.pw;\n  var out={name:opts.name,error:\"user not found\"};\n  for (var i=0;i<passwords.length;i++) {\n    var u=passwords[i];\n    if (u.name==opts.name) {\n      if (u.pw!=password) {\n        out.error=\"wrong password\";\n      } else {\n        out=JSON.parse(JSON.stringify(u));\n        delete out.pw;\n        out.error=\"\";\n        return out;\n      }\n    }\n  }\n  return out;\n}\n*/\nvar main = React.createClass({displayName: \"main\", \n  searchtab:0,\n  getProjects:function() {\n    return this.state.projects?this.state.projects:[];\n  },\n  defaultMainTabs:function(){\n    var tabs=[\n      {\"id\":\"tuser\",\"caption\":\"\",\"profile\":this.user,\"text\":this.user.name||\"Guest\",\"content\":userlogin,\"active\":true,\n        \"notclosable\":true,\"params\":{\"action\":this.action,\"user\":this.user,\"users\":this.users,\"getError\":this.getError,\"getpasswordError\":this.getpasswordError}}\n    ];\n    tabs.updated=true;\n    return tabs;\n  },\n  getError:function() {\n    if(this.state.error == \"Invalid Username\") return this.state.error;\n  },\n  getpasswordError:function() {\n    if(this.state.error == \"Invalid Password\") return this.state.error;\n  },\n  /*\n  defaultAuxTabs:function(db){\n    var auxs=[\n      {\"id\":\"about\",\"caption\":\"About\", \"content\":about,\n      \"active\":true,\"notclosable\":true,\"param\":{\"action\":this.action,\"user\":this.user}}\n      ];\n    return auxs;\n  },*/\n  getInitialState: function() {\n    try {\n      //this.user=JSON.parse(localStorage.getItem(\"user\"));      \n    }  catch (e) {\n      this.user={name:\"\",admin:false};\n    }\n    if (!this.user) this.user={name:\"\",admin:false};\n\n    var tabs=this.defaultMainTabs();\n    //var auxs=this.defaultAuxTabs();\n\n    return {settings:null,tabs:tabs/*, auxs:auxs*/,pageid:1,error:\"\",db:null,projects:null,keyword:null};\n  },\n  addProjectTab:function(projects) {\n      var tabs=this.state.tabs;\n      tabs.push({\"id\":\"projects\",\"pjname\":\"\",\"nowbambo\":\"\",\"profile\":this.state.tabs[0].profile,\"caption\":\"\",\"content\":projectlist,\"notclosable\":true,\n          \"params\":{\"action\":this.action, \"projects\":this.getProjects}});\n      tabs.updated=true;\n      this.setState({projects:projects,tabs:tabs});\n  }, \n  enumProjects:function() {\n      //var projects=JSON.parse(localStorage.getItem(\"projects\"));\n      kde.enumKdb(function(files){\n        var projects=files.map(function(f){\n          var name=f.substr(0,f.length-4);\n          return {name:name,shortname:name} \n        });\n        this.addProjectTab(projects);  \n      },this);      \n  }, \n  componentDidMount:function(usage,quota) {  \n    this.setState({dialog:false,quota:quota,usage:usage});\n    this.enumProjects();\n    this.makescrollable();\n  },\n  /*\n  newsearchtab:function(proj) {\n      var auxs=this.state.auxs;\n      for (var i=0;i<auxs.length;i++) {\n        if (auxs[i].dbid==proj.name) return;\n      }\n\n      auxs.push({\"id\":\"searchtab\"+(this.searchtab++),\"caption\":\"Search \"+proj.shortname, \n        \"content\":searchmain,\"active\":true,dbid:proj.shortname\n        , \"params\":{\"action\":this.action, \"project\":proj, \"db\":proj.shortname,\n                            }});\n\n      this.setState({\"layout\":proj.tmpl.layout,\"db\":proj.shortname,\"auxs\":auxs});\n  },\n  */\n  getProjectByName:function(projname) {\n    var projects=this.state.projects.filter(function(p){return p.shortname==projname});\n    return projects[0];\n  },\n  projecttab:function(name) {\n    /*\n    for (var i=0;i<this.state.auxs.length;i++) {\n      var t=this.state.auxs[i];\n      if (t.dbid==name && t.projectmain) return this.refs.auxtab;\n    }*/\n    for (var i=0;i<this.state.tabs.length;i++) {\n      var t=this.state.tabs[i];\n      if (t.dbid==name && t.projectmain) return this.refs.maintab;\n    }\n\n    return null;\n  },\n  openfile:function(engine,proj,filename,pageid,template,linktarget,linksource) {\n      this.addTab();\n      //var template= \"docview_default\"; //|| template || proj.tmpl.docview \n      //var docview=require(\"./\"+template+\".jsx\");\n      var docview=require(\"./docview_tibetan.jsx\");\n      var fileid = engine.get(1).filenames.indexOf(filename);\n      var tab=this.projecttab(proj.shortname);\n      var tabs = this.state.tabs;\n      tabs[1].nowbambo = filename;  \n      var obj={\"id\":\"f_\"+filename\n        ,\"caption\":\"　\"+proj.shortname+\"/\"+filename.replace(\".xml\",\"　　\")\n        ,\"content\":docview,\"active\":true\n        ,\"dbid\":proj.shortname\n        ,\"fid\":fileid\n        ,\"params\":{\"action\":this.action, filename:filename, project:proj\n                          ,user:this.user, pageid: pageid, kde:engine ,linktarget:linktarget,linksource:linksource}};\n        tab.newTab(obj);  \n        this.setState({tabs:tabs});   \n   },\n   addTab:function() {\n       var tab=this.refs.maintab; \n       var caption =React.createElement(\"span\", null, \"   +   \");\n       var obj={\"id\":\"addbutton\",\"caption\":caption,\"content\":userlogin,\"active\":true,\n        \"notclosable\":true,\"params\":{\"action\":this.action,\"user\":this.user,\"getError\":this.getError,\"getpassowrdError\":this.getpassowrdError}};\n        tab.newTab(obj);    \n   },\n   openlink:function(dbid,thelink) {\n     var  proj=this.getProjectByName(dbid);\n     if (this.projecttab(dbid)) {\n       this.action(\"openfile\",proj,thelink.file,thelink.pageid,null,thelink.linktarget,thelink.linksource);\n     } /*else {\n       this.action(\"openproject\",proj,thelink,this.refs.auxtab); \n     }*/\n   }, \n   excerpt2link:function(engine,excerpts,phraselen) {\n     var out=[];\n     var filenames=engine.get(\"fileNames\");\n     var files=engine.get(\"files\");\n     excerpts.map(function(e){\n        var file=files[e.file];\n        var start=e.hits[0][0]-e.start+phraselen*2; //don't know why???\n        var link={payload:{pagename:e.pagename,start:start,len:phraselen,i:e.page+1,\n                      db:\"ccc\",file: filenames[e.file],text:e.text}};\n        out.push(link)\n     });\n     return out;\n  },\n  action:function() {\n    var args = Array.prototype.slice.call(arguments);\n    var type=args.shift();\n\n    if (type===\"setdoc\") { \n      this.setState({doc:args[0]});\n    } else if (type==\"openproject\") { \n      var proj=args[0]; \n      var autoopen=args[1];\n      var tab=args[2]||this.refs.maintab;\n      var that=this; \n      var tabs = this.state.tabs;\n      tabs[1].pjname = proj.name;   \n      kde.open(proj.name,function(err,engine){\n        var meta=engine.get(\"meta\");\n        proj.template=meta.template;\n        project.openProject(proj);\n        var obj={\"id\":\"p_newtab\",\"caption\":\"\",dbid:proj.name,\n          \"content\":projectview,\"active\":true, \"projectmain\":true,\"notclosable\":true,\n          \"params\":{\"action\":that.action, \"project\":proj, \"autoopen\":autoopen, \"kde\":engine }};\n        //that.newsearchtab(proj);\n        tab.newTab(obj);\n        this.setState({tabs:tabs}); \n      },this);\n    } else if (type==\"newquery\") {\n      this.forceUpdate();\n    } else if (type==\"openfile\") {\n      var proj=args[0];    \n      var filename=args[1];\n      var pageid=args[2] ||\"2\";  \n      var template=args[3];\n      if (typeof proj==\"string\") {\n        proj=this.getProjectByName(proj);\n      } \n      kde.open(proj.shortname,function(err,engine){\n        this.openfile(engine,proj,filename,pageid,template);  \n      },this);\n    } else if (type==\"selectfile\" || type==\"selectfolder\") {\n      //this.state.auxs.updated=true;\n      this.forceUpdate();\n    } else if (type==\"openimage\") {\n      /*\n      var file=args[0];\n      var pagename=args[1];\n      var proj=args[2];\n      var obj={\"id\":\"sourceimage\"\n        ,\"caption\":'source'\n        ,\"content\":imageview\n        ,\"dbid\":proj.shortname\n        ,\"active\":false\n        ,\"params\":\n          {\"action\":this.action, src:file\n            ,project:proj,user:this.user,pagename:pagename}};\n        //this.refs.auxtab.newTab(obj);\n        */\n    } else if (type==\"login\") {\n      var status = args[1];\n      //var res={name:args[0].name,pw:args[3]};\n      if(status == true) {\n        localStorage.setItem(\"user\",JSON.stringify(args[0]));\n        this.user = args[0];\n        this.users = args[2];\n        this.setState({error:\"\",tabs:this.defaultMainTabs()}); \n        this.enumProjects(this.state.settings);\n        this.startforwork();\n      }\n      else if(status == \"failed\") {\n        this.setState({error:\"Invalid Password\",tabs:this.defaultMainTabs()})\n      }\n      else {\n        this.setState({error:\"Invalid Username\",tabs:this.defaultMainTabs()});\n      } \n    } else if (type==\"logout\") {\n      localStorage.setItem(\"user\",\"{}\");\n      this.user=JSON.parse(localStorage.getItem(\"user\")); \n      this.setState({tabs:this.defaultMainTabs()/*,auxs:this.defaultAuxTabs()*/});\n    } else if (type==\"start\") {\n        var that = this;\n        var ip = location.host.split(\":\")[0];\n        var db =  new PouchDB('http://'+ip+':5984/project');\n        pouch.readallfrompouch(db,this.gostart,0);\n    } else if (type==\"index\") {\n      this.refs.maintab.goTab(\"tuser\");\n    } else if (type==\"buildindex\") {\n      this.refs.builddialog.start(args[0].shortname);\n    } else if (type==\"searchkeyword\") {\n      kde.open(args[1],function(engine){\n      engine.activeTofind=args[0];\n      this.setState({keyword:args[0]});\n      if(this.state.tabs[0].search_pop == false)this.pop_search(args[0]);\n          else {this.search(args[0]);}\n          this.forceUpdate(); \n      },this);\n    } else if (type==\"searchquote\") {\n      var quote=args[0],cb=args[1];\n      var that=this;\n      kde.open(\"ccc\",function(engine){\n        kse.search(engine,quote.text,{range:{start:0}},function(data){\n          if (data.excerpt && data.excerpt.length) {\n            cb( that.excerpt2link(engine,data.excerpt,quote.text.length),quote);\n          } else cb([]);\n        });\n      });\n\n    } else if (type==\"closedb\") {\n      var dbid=args[0];\n      kde.close(dbid);\n    } else if (type==\"openlink\") {\n      var payload=args[0];\n      var thelink={file:payload.file,pageid:payload.i,\n                         linktarget:payload, linksource:args[1]};\n      this.openlink(payload.db,thelink);\n    } else if (type==\"makelink\") {\n      var targetpage=args[0];\n      var linktarget=args[1];\n      var linksource=args[2]; \n      sourcedb=linksource.db; \n      var payload=\n      {\"type\":\"linkby\",\"db\":linksource.db,\"file\":linksource.file\n      ,\"start\":linksource.start,\"len\":linksource.len,\"i\":linksource.pageid\n      ,\"pagename\":linksource.page.name,\n      \"author\":this.user.name};\n\n      targetpage.addMarkup(linktarget.start, linktarget.len, payload);\n\n      var payload2={\n        \"type\":\"linkto\",\"db\":linktarget.db,\"file\":linktarget.file\n        ,\"start\":linktarget.start,\"len\":linktarget.len,\"i\":linktarget.i\n        ,\"author\":this.user.name\n      }\n\n      linksource.page.addMarkup(linksource.start,linksource.len, payload2);\n\n      //save to\n      //console.log(args[0],args[1],args[2]);\n      //save link\n    } else if (type==\"myalert\") {\n        var type = args[0];\n        if(type == 0) {\n           $(\".alert_ok\").removeClass(\"in\").show();\n           $(\".alert_ok\").delay(200).addClass(\"in\").fadeOut(3000);}\n        else {\n           $(\".alert_err\").removeClass(\"in\").show();\n           $(\".alert_err\").delay(200).addClass(\"in\").fadeOut(3000);\n        }\n    } else if (type==\"myinput\") {\n        var status = args[0];\n        var id = args[1];\n        switch(status) {\n          case 0:\n             document.getElementById(id+\"_form\").className = \"form-group has-error has-feedback\";\n             document.getElementById(id+\"_icon\").className = \"glyphicon glyphicon-remove form-control-feedback\";\n          break;\n          case 1:\n             document.getElementById(id+\"_form\").className = \"form-group has-success has-feedback\";\n             document.getElementById(id+\"_icon\").className = \"glyphicon glyphicon-ok form-control-feedback\";\n          break;\n          case 2:\n             document.getElementById(id+\"_form\").className = \"form-group has-warning has-feedback\";\n             document.getElementById(id+\"_icon\").className = \"glyphicon glyphicon-warning-sign form-control-feedback\";\n          break;\n        }\n    } else if (type==\"change_mainphoto\") {\n           var that = this;\n           that.getDOMNode().querySelector('#tpic').src = \"photo/\"+this.state.tabs[0].text+\".jpg?\"+ new Date().getTime(); \n    }\n  },\n  page:function() {\n    return this.state.doc.getPage(this.state.pageid);\n  },\n  /*\n  newtab:function() {\n    this.state.tabs.push( {\"id\":\"t5\",\"caption\":\"About\",\"content\":about,\"notclosable\":true})\n    this.forceUpdate();\n  },*/\n   //<button onClick={this.newtab}>newtab</button>\n  makescrollable:function() {\n    /*\n    var f=this.refs.maintab.getDOMNode();\n    //var aux=this.refs.auxtab.getDOMNode();\n    //f.style.height='50%';\n    var contenttop=f.querySelector(\".tab-content\").offsetTop;\n    if (this.state.layout==\"vertical\") {\n      f.style.width='50%';\n      f.style.float='left';\n      f.style.height=document.body.offsetHeight-contenttop;\n      //aux.style.float='right';\n      //aux.style.width='50%';\n      //aux.style.height=document.body.offsetHeight-contenttop;\n    } else {\n      f.style.width='100%';\n      f.style.float='none';\n      //aux.style.width='100%';\n      //aux.style.float='none';\n      f.style.height='47%';\n      //aux.style.height='47%';\n    }\n    */\n  },\n  gostart:function() {\n      var lastfile=localStorage.getItem(this.user.name+\".lastfile\");\n      lastfile={file:\"\",project:\"\"};\n      this.refs.maintab.goTab(\"projects\",lastfile);  \n  },\n  startforwork:function() {\n    this.action(\"start\");\n  },\n  logoutwork:function() {\n    this.action(\"logout\");\n  },\n  componentDidUpdate:function() {\n    this.makescrollable();\n  },\n  pop_search:function() {\n    this.search(this.state.keyword);\n  },\n  user_profile:function() {\n    this.action(\"index\");\n  },\n  search:function(keyword) {\n    if(this.state.tabs[1].pjname == \"\") {this.action(\"myalert\",1);;return;}\n    var node=$(this.refs.btn1.getDOMNode());\n    node.popover({html:true});\n    node.data(\"content\", React.createElement(Searchmain, null) );\n    node.data(\"action\", this.action)\n    node.popover('show');\n    var $popcontent=node.siblings(\".popover\").find(\".popover-content\")\n    React.renderComponent(React.createElement(Searchmain, {action: this.action, keyword: keyword, bambos: this.state.tabs, db: this.state.tabs[1].pjname, engine: this.state.tabs[1].pjname}),$popcontent[0]);\n  },\n  pop_profile:function() {\n    var node=$(this.refs.btn2.getDOMNode());\n    node.popover({html:true});\n    node.data(\"content\", React.createElement(About, null) );\n    node.data(\"action\", this.action)\n    node.popover('show');\n    var $popcontent=node.siblings(\".popover\").find(\".popover-content\")\n    React.renderComponent(React.createElement(About, {action: this.action, db: this.state.projects[0].shortname, tab: this.state.tabs, project: this.state.projects[0]}),$popcontent[0]);\n  },\n  setting_button:function() {\n    if(this.state.tabs[0].profile.su == true) return React.createElement(\"span\", null, React.createElement(\"img\", {src: \"images/setting.png\", className: \"top_icon\", onClick: this.user_profile}))\n  },\n  barphoto_error:function() {\n     this.getDOMNode().querySelector('#tpic').src = 'images/photo.png';\n  },\n  rendersignin:function(){\n    $('html').on('click', function(e) {\n    if ((typeof $(e.target).data('original-title') == 'undefined'|| (typeof $(e.target).data('original-title') == 'string')) &&\n    !$(e.target).parents().is('.popover.in')) {\n    $('[data-original-title]').popover('destroy');\n    }\n  });\n  return React.createElement(\"div\", null, \n      React.createElement(\"div\", {className: \"container-fluid headerbar\"}, \n      React.createElement(\"div\", {className: \"alert_err alert-danger\", style: {width:window.innerWidth*0.97}}, \n            React.createElement(\"strong\", null, \"You need to open a project!\")\n      ), \n      React.createElement(\"div\", {className: \"col-md-8\"}, \n      React.createElement(\"img\", {src: \"images/s_logo.png\", className: \"top_icon\", onClick: this.startforwork}), \n      React.createElement(\"img\", {src: \"images/search.png\", className: \"top_icon\", ref: \"btn1\", onClick: this.pop_search, \"data-toggle\": \"popover1\", title: \"Search keyword\", \"data-placement\": \"bottom-right\"}), \n      this.setting_button()), \n      React.createElement(\"div\", {className: \"col-md-4\"}, \n      React.createElement(\"img\", {src: \"photo/\"+this.state.tabs[0].text+\".jpg?\"+ new Date().getTime(), id: \"tpic\", className: \"pull-right top_icon\", ref: \"btn2\", \"data-toggle\": \"popover2\", title: \"Open profile\", \"data-placement\": \"bottom-left\", onClick: this.pop_profile, onError: this.barphoto_error})\n      )\n    ), \n    React.createElement(\"div\", {className: \"maintab\"}, React.createElement(Tabui, {ref: \"maintab\", lastfile: this.state.lastfile, tabs: this.state.tabs}))\n    )\n  },\n  render:function() {\n      if (this.state.tabs[0].text != \"Guest\") {\n      return this.rendersignin();\n      }\n      return React.createElement(\"div\", {className: \"default_tab\"}, \n        React.createElement(Tabui, {ref: \"maintab\", lastfile: this.state.lastfile, tabs: this.state.tabs})\n      )\n  }\n});\nmodule.exports=main;",
    "var React=require(\"react\");\nvar Contentnavigator=require(\"./contentnavigator.jsx\"); \nvar BTN=React.createClass({displayName: \"BTN\",\n  render:function() {\n    return React.createElement(\"button\", {className: \"btn btn-primary\", onClick: this.props.onClick}, \n    this.props.caption)\n  }\n})\nvar mainmenu = React.createClass({displayName: \"mainmenu\",\n  getInitialState: function() {\n    return {bar: \"world\"};\n  },\n  chooseFile:function () {\n    var chooser = this.refs.fileDialog.getDOMNode();\n    chooser.click();  \n  },\n  componentDidMount:function() {\n    var chooser = this.refs.fileDialog.getDOMNode();\n    chooser.addEventListener(\"change\", function(evt) {\n      console.log(this.value);\n    }, false);\n  },\n  projectview:function() {\n      this.props.action(\"projectview\");\n  },\n  saveMarkup:function() {\n    this.props.action(\"savemarkup\");\n  },  \n  render: function() {\n    return (\n      React.createElement(\"div\", null, \n        React.createElement(\"button\", {className: \"btn btn-success\", onClick: this.projectview}, \"Project\"), \n\n        React.createElement(\"input\", {style: {\"display\":\"none\"}, ref: \"fileDialog\", type: \"file\", \n        accept: \".json,.js\"}), \n        React.createElement(Contentnavigator, {action: this.props.action}), \n        \n        React.createElement(BTN, {caption: \"Open File\", onClick: this.chooseFile}), \n        React.createElement(BTN, {caption: \"Open Markup\", onClick: this.chooseFile}), \n        React.createElement(BTN, {caption: \"Save Markup\", onClick: this.saveMarkup})\n\n      )\n    );\n  }\n});\nmodule.exports=mainmenu;",
    "/** @jsx React.DOM */\r\nvar Searchbox=require(\"./searchbox.jsx\"); \r\nvar Queryinfo=require(\"./queryinfo.jsx\"); \r\nvar Resultlist=require(\"./resultlist.jsx\");  \r\n//var bootstrap=require(\"bootstrap\");\r\nvar kde=require(\"ksana-database\");\r\nvar kse=require(\"ksana-search\");\r\n\r\nvar React=require(\"react\");\r\n//var Fileinstaller=Require(\"fileinstaller\"); \r\nvar mainsearch = React.createClass({displayName: \"mainsearch\", \r\n  getInitialState: function() {\r\n    return {engine:null,Q:null,Q2:null,page:null,progress:1,wildcard:0,quota:0}; \r\n  },  \r\n  componentWillMount:function() {\r\n  },\r\n  wildcardCount:function(Q) {\r\n    var wildcard=0;\r\n    if (!Q) return wildcard;\r\n    for (var i=0;i<Q.terms.length;i++) {\r\n      if (Q.terms[i].variants.length) {\r\n        wildcard++;\r\n        Q.wildcardterm=i;\r\n      }\r\n    }\r\n    return wildcard;\r\n  },\r\n  nextsearchphrase:function(Q) {\r\n    var newq=\"\";\r\n    Q.vidx=Q.vidx||0; \r\n    for (var i in Q.terms) {\r\n      var T=Q.terms[i];\r\n      if (T.variants.length) {\r\n        newq+=T.variants[Q.vidx][0]+\"་\";\r\n      } else {\r\n        newq+=T.raw+\"་\";\r\n      } \r\n    } \r\n    Q.vidx++;\r\n    return newq;\r\n  },  \r\n  updateProgress:function(that) {\r\n    var vidx=that.state.Q.vidx;\r\n    var wt=that.state.Q.terms[that.state.Q.wildcardterm];\r\n    var progress=vidx/wt.variants.length;\r\n    //sort again\r\n    that.setState({progress:progress});\r\n  },\r\n  findone:function(Q) {\r\n    var that=this;\r\n    var q=this.nextsearchphrase(Q);\r\n    kse.search(this.state.engine,q,{nogroup:true},function(err,QQ){\r\n      var w=Q.wildcardterm;\r\n      var wt=Q.terms[w];\r\n      var vidx=Q.vidx;\r\n      var nowbambo = that.state.engine.activeFile;\r\n      if(!nowbambo) nowbambo = that.props.bambos[4].caption+\".xml\";\r\n      if(that.props.bambos.length > 4){\r\n      var min = that.state.engine.getFileSegOffsets(that.state.engine.get(1).filenames.indexOf(nowbambo))[0];\r\n      var max = that.state.engine.getFileSegOffsets(that.state.engine.get(1).filenames.indexOf(nowbambo))[that.state.engine.getFileSegOffsets(that.state.engine.get(1).filenames.indexOf(nowbambo)).length-1];\r\n      var vcount =0;\r\n      for(var i=0;i<QQ.rawresult.length;i++)\r\n      {\r\n        if(QQ.rawresult[i]>= min && QQ.rawresult[i]<= max) vcount++;\r\n        else if(QQ.rawresult[i] > max) break;\r\n      }\r\n      wt.variants[vidx-1][1]=vcount; \r\n      }// update the variants hit\r\n      else {\r\n        wt.variants[vidx-1][1]=QQ.rawresult.length\r\n      }\r\n      if (vidx>=wt.variants.length) { //no more to do\r\n        that.stopFiltering();\r\n        wt.variants.sort(function(a,b){\r\n          return b[1]-a[1];\r\n        });        \r\n        that.setState({progress:1});\r\n      } else {\r\n        if (!that.stop) setTimeout( that.findone.bind(that,Q),0);    \r\n      }\r\n    })\r\n  },\r\n  filter:function(q) {\r\n     var opts={}; //raw search\r\n     var that=this;\r\n     this.stop=false;\r\n     kse.search(this.state.engine,q,opts,function(err,Q){\r\n        Q.vidx=0;\r\n        that.setState({Q:Q});\r\n        that.findone(Q);\r\n        that.timer1=setInterval( function(){\r\n          that.updateProgress(that);\r\n        }, 200);\r\n     });\r\n  },\r\n  stopFiltering:function(){\r\n    clearInterval(this.timer1);\r\n    this.stop=true;\r\n  },\r\n  action:function() {\r\n    if (!this.state.engine) kde.open(this.props.engine,function(err,engine){\r\n        this.setState({engine:engine});\r\n    },this);    \r\n    var args = Array.prototype.slice.call(arguments);\r\n    var type=args.shift();\r\n    var now_folder = this.props.bambos[1].nowbambo;\r\n    var folder_loc = this.state.engine.get(1).filenames.indexOf(now_folder);\r\n    var searchtype = 0;var end = 100;\r\n    var res=null, that=this;\r\n    if (type===\"search\") { \r\n       var q=args[0];\r\n       if(q.search('%') > -1) q = q.replace(/[ །།་]/g,\"\");\r\n       if(this.props.bambos.length > 4) {searchtype=folder_loc;end=1;}\r\n       var opts={range:{filestart:searchtype,maxfile:end,maxhit:1000}};\r\n       this.stopFiltering();\r\n       kse.search(this.state.engine,q,opts,function(err ,Q){\r\n          that.state.engine.activeQuery=Q;\r\n          var wc=that.wildcardCount(Q);\r\n          if (wc==1)  that.setState({Q:Q, wildcard:wc});\r\n          else  that.setState({Q2:Q});\r\n       });\r\n       if(q.search('%') > -1) this.filter(q);\r\n    } else if (type==\"tofindchange\") {\r\n      this.stopFiltering();\r\n      kse.search(this.state.engine,args[0],{},function(err,Q){\r\n        var wc=that.wildcardCount(Q);\r\n        that.setState({wildcard:wc});\r\n      });\r\n    } else if (type==\"gopage\") { \r\n      var pageid=args[0], fileid=args[1],pagename=args[2];\r\n      var fileNames=this.state.engine.get(\"filenames\");\r\n      this.props.action(\"openfile\",this.state.engine.dbname,fileNames[fileid] ,pageid+1 );\r\n      /*kse.highlightPage(this.state.engine,fileid,pageid,{fulltext:true,q:this.state.Q2.query},function(data){\r\n        that.setState({page:data,pagename:pagename});\r\n      });*/\r\n    } else if (type==\"filter\") {\r\n      var q=args[0];\r\n      if(q.search('%') > -1) q = q.replace(/[ །།་]/g,\"\");\r\n      this.stopFiltering();\r\n      this.filter(q);\r\n    }\r\n    return res;\r\n  },\r\n  render: function() { \r\n    return ( \r\n      React.createElement(\"div\", null, \r\n        React.createElement(\"div\", {className: \"row searcharea\"}, \r\n          React.createElement(\"div\", {className: \"col-md-12\"}, React.createElement(Searchbox, {action: this.action, kw: this.props.keyword, progress: this.state.progress, wildcard: this.state.wildcard})), \r\n          React.createElement(\"div\", {className: \"col-md-3\"}, \r\n            React.createElement(Queryinfo, {action: this.action, Q: this.state.Q})\r\n          ), \r\n          React.createElement(\"div\", {className: \"col-md-9\"}, \r\n            React.createElement(Resultlist, {action: this.action, Q: this.state.Q2, bambos: this.props.bambos})\r\n          )\r\n        )\r\n      )\r\n    );\r\n  }\r\n});\r\nmodule.exports=mainsearch;",
    "/*\n\tmerge needs token offset, not char offset\n*/\nvar splitDelete=function(m) {\n\tvar out=[];\n\tfor (i=0;i<m.l;i++) {\n\t\tvar m2=JSON.parse(JSON.stringify(m));\n\t\tm2.s=m.s+i;\n\t\tm2.l=1;\n\t\tout.push(m2);\n\t}\n\treturn out;\n}\nvar quantize=function(markup) {\n\tvar out=[],i=0,m=JSON.parse(JSON.stringify(markup));\n\tif (m.payload.insert) {\n\t\t\tm.s=m.s+m.l-1;\n\t\t\tm.l=1;\n\t\t\tout.push(m)\n\t} else {\n\t\tif (m.payload.text==\"\") { //delete\n\t\t\tout=splitDelete(m);\n\t\t} else { //replace\n\t\t\tif (m.l>1) {//split to delete and replace\n\t\t\t\tvar m2=JSON.parse(JSON.stringify(m));\n\t\t\t\tm.payload.text=\"\";\n\t\t\t\tm.l--;\n\t\t\t\tout=splitDelete(m);\n\t\t\t\tm2.s=m2.s+m2.l-1;\n\t\t\t\tm2.l=1;\n\t\t\t\tout.push(m2);\n\t\t\t} else {\n\t\t\t\tout.push(m);\n\t\t\t}\n\t\t}\n\t}\n\treturn out;\n}\nvar plural={\n\t\"suggest\":\"suggests\"\n}\nvar combinable=function(p1,p2) {\n\tvar t=\"\";\n\tfor (var i=0;i<p1.choices.length;i++) t+=p1.choices[i].text;\n\tfor (var i=0;i<p2.choices.length;i++) t+=p2.choices[i].text;\n\treturn (t===\"\");\n}\nvar combine=function(markups) {\n\tvar out=[],i=1,at=0;\n\n\twhile (i<markups.length) {\n\t\tif (combinable(markups[at].payload,markups[i].payload)) {\n\t\t\tmarkups[at].l++;\n\t\t} else {\n\t\t\tout.push(markups[at]);\n\t\t\tat=i;\n\t\t}\n\t\ti++;\n\t}\n\tout.push(markups[at]);\n\treturn out;\n}\nvar merge=function(markups,type){\n\tvar out=[],i=0;\n\tfor (i=0;i<markups.length;i++) {\n\t\tif (markups[i].payload.type===type)\tout=out.concat(quantize(markups[i]));\n\t}\n\tvar type=plural[type];\n\tif (typeof type==\"undefined\") throw \"cannot merge \"+type;\n\tif (!out.length) return [];\n\tout.sort(function(a,b){return a.s-b.s;});\n\tvar out2=[{s:out[0].s, l:1, payload:{type:type,choices:[out[0].payload]}}];\n\tfor (i=1;i<out.length;i++) {\n\t\tif (out[i].s===out2[out2.length-1].s ) {\n\t\t\tout2[out2.length-1].payload.choices.push(out[i].payload);\n\t\t} else {\n\t\t\tout2.push({s:out[i].s,l:1,payload:{type:type,choices:[out[i].payload]}});\n\t\t}\n\t}\n\treturn combine(out2);\n}\nvar addTokenOffset=function(markups,offsets) {\n\tfor (var i=0;i<markups.length;i++) {\n\t\tvar m=markups[i],at,at2;\n\t\tat=offsets.indexOf(m.start); //need optimized\n\t\tif (m.len) at2=offsets.indexOf(m.start+m.len);\n\t\tif (at==-1 || at2==-1) {\n\t\t\tconsole.trace(\"markup position not at token boundary\");\n\t\t\tbreak;\n\t\t}\n\n\t\tm.s=at;\n\t\tif (m.len) m.l=at2-at;\n\t}\n\treturn markups;\n}\n\nvar applyTokenOffset=function(markups,offsets) {\n\tfor (var i=0;i<markups.length;i++) {\n\t\tvar m=markups[i];\n\t\tm.start=offsets[m.s];\n\t\tm.len=offsets[m.s+m.l] - offsets[m.s];\n\t\tdelete m.s;\n\t\tdelete m.l;\n\t}\n\treturn markups;\n}\n\nvar suggestion2revision=function(markups) {\n\tvar out=[];\n\tfor (var i=0;i<markups.length;i++) {\n\t\tvar m=markups[i];\n\t\tvar payload=m.payload;\n\t\tif (payload.insert) {\n\t\t\tout.push({start:m.start+m.len,len:0,payload:payload});\n\t\t} else {\n\t\t\tout.push({start:m.start,len:m.len,payload:payload});\n\t\t}\n\t}\n\treturn out;\n}\n\nvar strikeout=function(markups,start,len,user,type) {\n\tvar payload={type:type,author:user,text:\"\"};\n\tmarkups.push({start:start,len:len,payload:payload});\n}\nmodule.exports={merge:merge,quantize:quantize,\n\taddTokenOffset:addTokenOffset,applyTokenOffset:applyTokenOffset,\n\tstrikeout:strikeout, suggestion2revision : suggestion2revision\n}",
    "var React=require(\"react\");\nvar nav_tibetan = React.createClass({displayName: \"nav_tibetan\",\n  getInitialState: function() {\n    return {pagename:this.pageName(),component:\"\"};\n  },\n  pageName:function() {\n    return  this.props.page?this.props.page.name:\"\";\n  },\n  setPageId:function() {\n    var pagename=this.refs.pageid.getDOMNode().value;\n    this.setState({pagename:pagename});\n    this.props.action(\"gopage\",pagename);\n    this.pageidtimer=null;\n  },\n  pageIdChange:function() {\n    clearTimeout(this.pageidtimer);\n    this.pageidtimer=setTimeout(this.setPageId.bind(this) ,500);\n  },\n  nextPage:function() {\n    this.props.action(\"next\");\n    this.scrolltoTop(); \n  },\n  prevPage:function() {\n    this.props.action(\"prev\");\n    this.scrolltoTop(); \n  },\n  firstPage:function() {\n    this.props.action(\"first\");\n    this.scrolltoTop(); \n  },\n  lastPage:function() {\n    this.props.action(\"last\");\n    this.scrolltoTop(); \n  },\n  nextMistake:function(e) {\n    var direction = e.target.id;\n    this.props.action(\"nextmistake\",direction);\n  },\n  componentDidUpdate:function() {\n    if (this.refs&&this.refs.pageid) {\n      this.refs.pageid.getDOMNode().value=this.pageName();\n    }\n  },\n  handsavemarkup:function() {\n    this.props.action(\"handsavemarkup\");\n  },\n  handUpdate:function() {\n    this.props.action(\"handUpdate\");\n  },\n  preview:function() {\n    this.props.action(\"preview\");\n  },\n  endpreview:function() {\n    this.props.action(\"endpreview\");\n  },\n  previewmenu:function() {\n    if (this.props.preview) {\n      return React.createElement(\"button\", {className: \"btn btn-warning button_style\", onClick: this.endpreview}, \"End Preview\")\n    } else {\n      return React.createElement(\"button\", {className: \"btn btn-success button_style\", onClick: this.preview}, \"Preview\")\n    }\n  },\n  scrolltoTop:function() {\n    document.getElementById(\"inlinetext\").scrollTop= 0;\n  },\n  imgerror:function() {\n     this.getDOMNode().querySelector('img').src = 'images/sorry.jpg';\n  },\n  zoom:function(e) {\n      for (var i = 0; i < this.state.component.length; i++){\n        if(this.state.component[i].style.fontSize == \"\")\n        {\n          if(e.target.id == \"zoomin\") this.state.component[i].style.fontSize = 1+0.2+'em';\n          else this.state.component[i].style.fontSize = 1-0.2+'em';\n        }\n        else \n        {\n          if(e.target.id == \"zoomin\")this.state.component[i].style.fontSize = parseFloat(this.state.component[i].style.fontSize.replace(\"em\",\"\"))+0.2+\"em\";\n          else if(e.target.id == \"zoomout\" && this.state.component[i].style.fontSize == \"0.6em\") return;\n          else this.state.component[i].style.fontSize = parseFloat(this.state.component[i].style.fontSize.replace(\"em\",\"\"))-0.2+\"em\";      \n        }\n      }\n  },\n  getDocview_style:function()\n  {\n      var defaultValue = 1;\n      var element = document.getElementsByTagName(\"div\");\n      var components = new Array();\n      var count = 0;\n      for(var i = 0; i < element.length; i++) {\n            var attribute = element[i].getAttribute(\"class\");\n            if(attribute == \"docview main-wrapper\") {\n              components[count] =element[i];count++;\n            }\n      }\n      this.setState({component:components});\n  },\n  expandFileName1:function(src) {\n    if (!src) return \"images/nf.png\";\n    if(src ==\"1.1a\" || src==\"_\") return \"images/nf.png\";\n    if (src.substring(0,4)==\"http\") return src;\n    var s=src.split('.');\n    var folder=s[0];\n    var filename=s[1];\n    var ip = location.host;\n    if(folder.length == 1) folder='00'+folder;\n    else if(folder.length == 2) folder='0'+folder;\n    folder=folder.substring(folder.length-4);\n    if(filename.length == 2) filename='00'+filename;\n    else if(filename.length == 3) filename='0'+filename;\n    filename=filename.substring(filename.length-4);\n\n    return \"http://\"+ip+\"/kangyur_images/lijiang/\"+folder+'/'+folder+'-'+filename+\".jpg\";\n  }, \n  renderStatus:function() {\n    if (!this.props.selecting)return;\n    var out=[];\n    out.push(React.createElement(\"span\", {key: \"s1\", className: \"label label-default\"}, this.props.selecting.start));\n    if (this.props.selecting.end!=this.props.selecting.start) {\n      out.push(React.createElement(\"span\", {key: \"s2\", className: \"label label-default\"}, this.props.selecting.end));\n    }\n      \n    return out;      \n  },\nrender: function() {\n     if (!this.props.page) return React.createElement(\"div\", null)\n    return (\n      React.createElement(\"div\", {className: \"row\", onLoad: this.getDocview_style}, \n      React.createElement(\"img\", {ref: \"image\", id: \"sourceimage\", className: \"sourceimage\", src: this.expandFileName1(this.props.page.name), onError: this.imgerror}), \n        React.createElement(\"div\", {className: \"col-md-2 col-md-offset-1\"}, \n          React.createElement(\"img\", {src: \"images/small.png\", id: \"zoomout\", style: {height:\"30px\",width:\"30px\",marginRight:\"10px\"}, onClick: this.zoom}), \n          React.createElement(\"img\", {src: \"images/large.png\", id: \"zoomin\", style: {height:\"30px\",width:\"30px\",marginRight:\"10px\"}, onClick: this.zoom}), \n          React.createElement(\"img\", {src: \"images/jump_previous.png\", id: \"previous\", style: {height:\"30px\",width:\"30px\",marginRight:\"10px\"}, onClick: this.nextMistake}), \n          React.createElement(\"img\", {src: \"images/jump_next.png\", id: \"next\", style: {height:\"30px\",width:\"30px\",marginRight:\"10px\"}, onClick: this.nextMistake})\n         ), \n        React.createElement(\"div\", {className: \"col-md-2 col-md-offset-1\"}, \n        React.createElement(\"div\", {className: \"input-group\"}, \n             React.createElement(\"span\", {className: \"input-group-btn\"}, \n              React.createElement(\"img\", {src: \"images/first.png\", onClick: this.firstPage}), \n              React.createElement(\"img\", {src: \"images/left.png\", onClick: this.prevPage})\n             ), \n            React.createElement(\"input\", {id: \"pageid\", ref: \"pageid\", defaultValue: this.pageName(), onChange: this.pageIdChange, className: \"form-control\"}), \n            React.createElement(\"span\", {className: \"input-group-btn\"}, \n              React.createElement(\"img\", {src: \"images/right.png\", onClick: this.nextPage}), \n              React.createElement(\"img\", {src: \"images/last.png\", onClick: this.lastPage})\n            )\n        )\n      ), \n      React.createElement(\"div\", {className: \"col-md-4\"}, \n        this.previewmenu(), \n        React.createElement(\"button\", {className: \"btn btn-success button_style\", onClick: this.handsavemarkup}, \"Save\"), \n        React.createElement(\"button\", {className: \"btn btn-success button_style\", onClick: this.handUpdate}, \"Refresh\")\n      )\n      )\n    );\n  }\n});\n\nmodule.exports=nav_tibetan;",
    "/*\nmarkup format:\n{\"start\":start_offset,\"len\":length_in_byte,\"payload\":{\"type\":\"markup_type\",author\":\"p1\",\"text\":\"\"},\"i\":page_id}\n*/\n//saveMarkup({dbid:dbid,markups:markups,filename:filename,i:this.state.pageid } ,function(data){\n\nvar combineMarkups=function(db,markups,fn,pageid,cb) {\n\n\tvar key=\"M!\"+pageid+\"!\"+fn;\n\tdb.get(key,function(err,res){\n\t\tvar existing=[] ;\n\t\tif (res && res.M) existing=res.M ;\n\t\tif (!markups || !markups.length) {\n\t\t\tif (err.error) cb([]);\n\t\t\telse cb(existing);\n\t\t\treturn;\n\t\t}\n\n\t\tvar author=markups[0].payload.author, others=[];\n\t\tif (existing) {\n\t\t\tothers=existing.filter(function(m){return m.i!=pageid || m.payload.author != author});\t\t\n\t\t}\n\t\tfor (var i=0;i<markups.length;i++) {\n\t\t\tmarkups[i].i=pageid;\n\t\t}\n\t\tothers=others.concat(markups);\n\t\tvar sortfunc=function(a,b) {\n\t\t\t//each page less than 64K\n\t\t\treturn (a.i*65536 +a.start) - (b.i*65536 +b.start);\n\t\t}\n\t\tothers.sort(sortfunc);\n\t\tcb(others,res._rev);\n\t});\n}\n\nvar saveMarkup=function(opts,cb){\n\tcombineMarkups(opts.db,opts.markups,opts.filename,opts.i,function(markups,rev){\n\t\tfor (var i=0;i<markups.length;i++) {\n\t\t\tmarkups[i].i=opts.i;\n\t\t}\n\t\tvar key=\"M!\"+opts.i+\"!\"+opts.filename;\n\t\tif (markups.length) {\n\t\t\topts.db.put({M:markups,_rev:rev,_id:key},function(err,response){\n\t\t\t\tcb();\n\t\t\t});\n\t\t} else {\n\t\t\tcb();\n\t\t}\n\t});\n}\nvar __loadMarkups=function(db,fn,pagecount,cb) {\n\tvar out=[],keys=[];\n\tfor (var i=1;i<pagecount;i++) {\n\t\tkeys.push(\"M!\"+i+\"!\"+fn);\n\t}\n\tdb.allDocs({include_docs:true,keys:keys},function(err,res){\n\t\t\tres.rows.map(function(r){\n\t\t\t\tif (r.error) return;\n\t\t\t\tout=out.concat(r.doc.M);\n\t\t\t})\n\t\t\tcb(out);\n\t});\n}\nvar loadMarkup=function(db,fn,pageid,cb) {\n\tif (pageid<0) {\n\t\t__loadMarkups(db,fn,-pageid,cb);\n\t\treturn;\n\t}\n\tvar key=\"M!\"+pageid+\"!\"+fn;\n\tdb.get(key,function(err,res){\n\t\tcb(res.M);\n\t});\n}\n\nvar savetopouch=function(db,data,cb) {\n\tdb.post(data, function(err, res) {\n\t\tcb(); \n    });\n}\nvar savealltopouch=function(db,data,cb) {\n\tdb.bulkDocs(data,function(err, res) {\n        cb(err);\n     });\n}\nvar readfrompouch=function(db,data,cb,state,data2) {\n\tdb.get(data, function(err,res) { \n\t\tif(state == 0)cb(err); \n\t\telse if(state == 1) cb(res);\n\t\telse if(state == 2) {\n\t\t\tdb.put(data2[0], data, res._rev ,function(err, response) { \n\t\t\t\tcb(data2[1]);\n\t\t\t});\n\t\t}\n\t});\n}\nvar readallfrompouch=function(db,cb,state) {\n\tdb.allDocs({include_docs: true},function(err, res) {\n\t    if(res.rows.length==0) db.destroy(function(err, info) { });\n        if(state == 0) cb(res);\n        else if(state == 1) cb(err);\n        else if(state == 2) {\n        \tvar data = cb(res);\n        \treturn data;\n        }\n    });\n}\nvar removetopouch=function(db,data) {\n\tdb.get(data,function(err,res) {\n\t\t\tif(!err) {\n\t\t\t\tdb.remove(res);\n\t\t\t}\n    });\n}\n\nmodule.exports={\n\tsaveMarkup:saveMarkup,\n\tloadMarkup:loadMarkup,\n\tsavetopouch:savetopouch,\n\treadfrompouch:readfrompouch,\n\treadallfrompouch:readallfrompouch,\n\tremovetopouch:removetopouch,\n\tsavealltopouch:savealltopouch\n\n}",
    "var project_settings={};\nvar tibetan={\n\t\"docview\":\"docview_tibetan\"\n\t,\"tokenize\": require('ksana-analyzer').getAPI('tibetan1').tokenize\n\t,\"inlinedialog\": {\n\t\t\"suggest\":require(\"./inlinedialog_suggest_tibetan.jsx\")\n\t\t,\"comment\":require(\"./inlinedialog_comment_tibetan.jsx\")\n\t\t,\"revision\":require(\"./inlinedialog_accept_tibetan.jsx\")\n\t\t,\"suggests\":require(\"./inlinedialog_applychange.jsx\")\n\t}\n\t,\"contextmenu\" : require(\"./contextmenu_tibetan.jsx\")\n\t,\"layout\":\"horizontal\"\n\t,\"navigator\":\"nav_tibetan\"\n\t,\"admin_viewable_tags\" :[\"comment\"]\n\t,\"surface_elements\": {\n\t\t\"comment\" : require(\"./element_comment_tibetan.jsx\")\n\t}\n}\nvar chinese={\n\t\"docview\":\"docview_chinese\",\n\t\"tokenize\":require('ksana-analyzer').getAPI('simple1').tokenize\n}\nvar classical={\n\t\"docview\":\"docview_classical\"\n\t,\"tokenize\":require('ksana-analyzer').getAPI('simple1').tokenize\n\t,\"inlinedialog\": {\n\t\t\"suggest\":require(\"./inlinedialog_suggest_tibetan.jsx\")\n\t}\n\t,\"makelinkdialog\" : require(\"./inlinedialog_makelink.jsx\")\n\t,\"contextmenu\" : require(\"./contextmenu_classical.jsx\")\n\t,\"layout\":\"vertical\"\n\t//,\"typeset\":require('./typeset').classical\n\t,\"navigator\":\"nav_classical\"\n\t,\"linebreak\":\"※\"\n}\n\nvar templates={tibetan:tibetan,chinese:chinese,classical:classical};\nvar openProject=function(proj) {\n\tproj.tmpl=templates[proj.template];\n\tproj.setting=project_settings[proj.name];\n\tif (!proj.tmpl) throw \"template not found:\"+proj.template;\n\treturn proj; \n}\n\nmodule.exports={openProject:openProject,templates:templates};",
    "var pouch=require(\"./persistentmarkup_pouchdb\");\nvar React=require(\"react\");\nvar projectlist = React.createClass({displayName: \"projectlist\",\n  getInitialState: function() {\n    return {bar: \"world\",hovered:-1,selected:-1,rev:\"\",ce:[],pr:[],cearr:[],prarr:[],projects:[],proj:false,first:true,edit:false,add:false,authority:false};\n  },\n  componentDidMount:function() {\n    if (this.props.tab ) this.props.tab.instance=this; // for tabui \n  },\n  selectproject:function(e) {\n    if (this.state.edit == true) return;\n    else if (!e.target.parentElement.attributes['data-i']) return;\n    var i=parseInt(e.target.parentElement.attributes['data-i'].value);\n    this.check_user(e.target.parentElement.id,i);\n    this.setState({selected:i,proj:e.target.parentElement.id});\n  },\n  hoverProject:function(e) {\n    if (e.target.parentElement.nodeName!='TR') return;\n    var hovered=e.target.parentElement.attributes['data-i'].value;\n    if (this.state.hovered==hovered) return;\n    this.setState({hovered:hovered});\n  },\n  renderProject:function(p,i) {\n    var d=p.lastModified;\n    var cls=(i==this.state.selected)?\"success\":\"\";\n   // var formatted=d.getDay()+'/'+d.getMonth()+'/'+d.getFullYear();\n    return (React.createElement(\"tr\", {key: 'p'+i, \"data-i\": i, className: cls, id: p.shortname, \n     onClick: this.selectproject, \n     onDoubleClick: this.openproject, \n     onMouseOver: this.hoverProject}, \n      React.createElement(\"td\", null, p.newname)\n    ));\n//<button onClick={this.buildindex} className=\"btn btn-warning\">Build Index</button>\n  },\n  sortHeader:function(e) {\n    var field=e.target.attributes['data-field'];\n    field=field?field.value: e.target.innerText;\n    this.state.projects.sort(function(a,b){\n      if (a[field]==b[field]) return 0;\n      if (a[field]>b[field]) return 1;\n      else return -1\n    })\n    this.forceUpdate();\n  },\n  openproject:function() {\n    if (this.state.edit == true) return;\n    if(this.state.edit == true) {this.canceledit();}\n    var p=this.state.projects[this.state.hovered];\n    if (!p || this.state.authority == false) return;\n    this.props.action(\"openproject\",p);\n    //open recently edited file automatically\n  },\n  onShow:function(params) {\n    if (!params || !this.state.projects) return;\n    var match=this.state.projects.filter( function(p) {return p.shortname==params.project; });\n    if(match.length) this.props.action(\"openproject\",match[0],params);\n  },\n  addproject:function() {\n    this.setState({add:true});\n    this.editproject();\n  },\n  editproject:function() {\n    var ip = location.host.split(\":\")[0];\n    var db = new PouchDB('http://'+ip+':5984/account');\n    pouch.readallfrompouch(db,this.getAllusers,0);\n  },\n  getAllusers:function(res) {\n    var temp_ce=[],temp_pr=[];\n    for(var i=0;i<res.rows.length;i++)\n         {\n            if(res.rows[i].doc.admin == true && res.rows[i].doc.su == false) temp_ce.push(res.rows[i].doc._id);\n            else if (res.rows[i].doc.admin == false && res.rows[i].doc.su == false) temp_pr.push(res.rows[i].doc._id);\n         }\n        if(this.state.add == false) this.setState({edit:true,ce:temp_ce,pr:temp_pr});\n        else this.setState({edit:true,ce:temp_ce,pr:temp_pr,cearr:[],prarr:[]});\n  },\n  canceledit:function() {\n    if(this.state.add == true) {\n      this.check_user(this.state.proj,this.state.selected);\n      this.setState({edit:false,add:false});\n    }\n    else this.setState({edit:false,add:false});\n  },\n  confirm:function(){\n     var project_info = this.state.projects;\n     project_info[0].ce = $('.btn-group2 > .btn.active').text();\n     project_info[0].pr = $('.btn-group1 > .btn.active').text();\n     project_info[0].desc = document.getElementById('desc').value;\n     var chiefeditor = this.tomyString(this.tomyArray(project_info[0].ce,\"  \"));\n     var proofreader = this.tomyString(this.tomyArray(project_info[0].pr,\"  \"));\n     if(this.state.add == true) this.addnewproject(chiefeditor,proofreader,project_info);\n     else if(this.state.add == false) this.saveproject(chiefeditor,proofreader,project_info);\n  },\n  check_photo:function(e) {\n     var img = e.target;\n     img.src= 'images/photo.png';\n  },\n  saveproject:function(ce,pr,pj) {\n    if(ce[1].length == 0 || pr[1].length == 0) {that.props.action(\"myalert\",1);return;}\n    var that = this;\n    var ip = location.host.split(\":\")[0];\n    var db = new PouchDB('http://'+ip+':5984/project');\n    var des = document.getElementById('desc').value;\n    var name = document.getElementById('name').value;\n    var projects = this.state.projects;\n    projects[that.state.selected].newname = name;\n    var data =[{name:name,chief:ce[0],desc:des,proofreader:pr[0]},{chief:ce[1],pf:pr[1],pj:pj}];\n    pouch.readfrompouch(db,this.state.proj,this.saveprojectstate,2,data);\n  },\n  tomyArray:function(str,del)\n  {\n     var arr = str.split(del);\n     return arr;\n  },\n  tomyString:function(data)\n  {\n      var mystring =\"\",arr =[],temparr=[];\n      for(var i=0;i<data.length-1;i++)\n      {\n        if(i == 0) {mystring += data[i];}\n        else mystring += \"+\"+data[i];\n        arr.push(data[i]);\n      }\n      temparr.push(mystring,arr);\n      return temparr;\n  },\n  saveprojectstate:function(data) {\n    this.setState({cearr:data.chief,prarr:data.pf,edit:false,projects:data.pj});\n  },\n  check_project:function(){\n     var pj =\"\";\n     if(this.state.projects == \"\") \n     {\n        var ip = location.host.split(\":\")[0];\n        var db = new PouchDB('http://'+ip+':5984/project');\n        pj = pouch.readallfrompouch(db,this.change_projname,2);\n\n     }\n     else {\n      pj = this.state.projects.map(this.renderProject);\n     }\n     return pj;\n  },\n  change_projname:function(res) {\n    var projects = this.props.projects();\n    var pj =\"\";\n     for(var i=0;i<res.rows.length;i++){  \n        for(var j=0;j<projects.length;j++){\n            if(projects[j].name == res.rows[i].doc._id) projects[j].newname = res.rows[i].doc.name;\n         }\n        }\n        this.setState({projects:projects});\n        pj = projects.map(this.renderProject);\n        return pj;\n  },\n  check_user:function(pj,i) {\n      var ip = location.host.split(\":\")[0];\n      var db = new PouchDB('http://'+ip+':5984/project');\n      pouch.readfrompouch(db,pj,this.splituserlist,1);\n        \n  },\n  splituserlist:function(res) {\n      var authority=\"\";\n      var project_info = this.state.projects;\n      project_info[0].ce = res.chief;\n      project_info[0].pr = res.proofreader;\n      project_info[0].desc = res.desc;\n      var cearr = res.chief.split(\"+\"),prarr = res.proofreader.split(\"+\");\n      var margearr = cearr.concat(prarr);\n      if(this.props.tab.profile.su == true || margearr.indexOf(this.props.tab.profile.name) >= 0) {authority = true;}\n      else { authority = false;}\n      this.setState({first:false,cearr:cearr,prarr:prarr,authority:authority,projects:project_info});\n  },\n  addnewproject:function(ce,pr,pj)\n  {\n      var ip = location.host.split(\":\")[0];\n      var file = document.getElementById(\"upload\").value;\n      var filename = file.split('\\\\');\n      var name = document.getElementById('name').value;\n      var des = document.getElementById('desc').value;\n      var data = {\n      _id:filename[filename.length-1],url:\"http://\"+ip+\"/ketaka/kdb/\"+filename[filename.length-1],desc:des}\n      var data2 = {\n      _id:filename[filename.length-1].replace(\".kdb\",\"\"),name:name,desc:des,chief:ce[0],proofreader:pr[0]}\n      this.writetodb(\"kdbs\",data);\n      this.writetodb(\"project\",data2);\n      this.setState({cearr:ce[1],prar:pr[1],projects:pj,edit:false});\n      this.check_user(this.state.proj,this.state.selected);\n\n  },\n  writetodb:function(dbname,todo)\n  {\n    var ip = location.host.split(\":\")[0];\n    var db = new PouchDB('http://'+ip+':5984/'+dbname);\n    pouch.savetopouch(db,todo,this.candosomething);\n  },\n  candosomething:function() {\n      //can dosomething here\n  },\n  member_list:function(data,status)\n  {\n    var cls=\"\",out=[];\n    if(data.length == 0) out.push(React.createElement(\"div\", null));\n    for (var i=0;i<data.length;i++) {\n      if(status == \"off\")  out.push(React.createElement(\"button\", {className: \"menber_style\"}, React.createElement(\"img\", {src: \"photo/\"+data[i]+\".jpg?\"+ new Date().getTime(), className: \"showphoto_style\", onError: this.check_photo}), React.createElement(\"br\", null), data[i]));\n      else if (status.indexOf(data[i]) > -1) out.push(React.createElement(\"button\", {type: \"checkbox\", id: data[i], className: \"btn picturebutton_style active\"}, React.createElement(\"img\", {src: \"photo/\"+data[i]+\".jpg?\"+ new Date().getTime(), onError: this.check_photo, className: \"showphoto_style\"}), React.createElement(\"br\", null), data[i], \"  \"));\n      else out.push(React.createElement(\"button\", {type: \"checkbox\", id: data[i], className: \"btn picturebutton_style\"}, React.createElement(\"img\", {src: \"photo/\"+data[i]+\".jpg?\"+ new Date().getTime(), className: \"showphoto_style\", onError: this.check_photo}), React.createElement(\"br\", null), data[i], \"  \"));\n    };\n    return out;\n    /*\n    return data.map(function(r,i){ // excerpt is an array \n      if (!r) return <div></div>;\n      else if(status == \"off\") return <button className=\"menber_style\"><img src={\"photo/\"+r+\".jpg\"} className=\"showphoto_style\"></img><br />{r}</button>\n      else if (status.indexOf(r) > -1) return <button type=\"checkbox\" id={r} className=\"btn picturebutton_style active\"><img src={\"images/\"+r+\".jpg\"} className=\"showphoto_style\" ></img><br />{r}&nbsp;&nbsp;</button>\n      else return <button type=\"checkbox\" id={r} className=\"btn picturebutton_style\"><img src={\"images/\"+r+\".jpg\"} className=\"showphoto_style\" ></img><br />{r}&nbsp;&nbsp;</button>\n    });*/ \n  },\n  showadd:function()\n  {\n    if(this.state.add == true)\n    {\n      return(\n        React.createElement(\"div\", null, \n        React.createElement(\"div\", {className: \"col-md-2\"}, React.createElement(\"h4\", null, \"Kdb file\")), \n        React.createElement(\"div\", {className: \"col-md-10\"}, React.createElement(\"form\", {action: \"upload.php\", method: \"post\", encType: \"multipart/form-data\"}, React.createElement(\"input\", {type: \"hidden\", name: \"folder\", value: \"kdb\"}), React.createElement(\"input\", {type: \"file\", name: \"upload\", id: \"upload\"}), \n        React.createElement(\"div\", null, React.createElement(\"input\", {type: \"submit\", className: \"btn btn-success btn-block pull-left\", name: \"button\", id: \"button\", value: \"Upload\", style: {width:\"110px\",marginBottom:\"10px\"}}))\n        )), \n        React.createElement(\"div\", {className: \"col-md-12\"}, React.createElement(\"br\", null))\n        )\n      );\n    }\n  },\n  editbutton:function()\n  {\n    if(this.props.tab.profile.su == true){\n      return React.createElement(\"button\", {className: \"btn btn-warning btn-lg button_default\", onClick: this.editproject}, \"Edit\")}\n  },\n  addbutton:function()\n  {\n    if(this.props.tab.profile.su == true){\n      return React.createElement(\"button\", {className: \"btn btn-success add_button_style\", onClick: this.addproject}, React.createElement(\"img\", {src: \"images/add.png\", style: {height:\"16px\",width:\"16px\"}}))}\n  },\n  buildindex:function() {\n  },\n  render_normal:function()\n  {//{this.props.projects()[0].pr}\n      return ( \n      React.createElement(\"div\", null, \n        React.createElement(\"div\", {className: \"col-md-2\"}, \n          React.createElement(\"h1\", {className: \"header_text\"}, \"Project\"), this.addbutton(), \n          React.createElement(\"div\", {className: \"folderList\"}, \n        React.createElement(\"table\", {className: \"table table-bordered table-hover\"}, \n        React.createElement(\"thead\", {onClick: this.sortHeader}\n        ), React.createElement(\"br\", null), \n        React.createElement(\"tbody\", null, \n         this.check_project()\n        )))), React.createElement(\"br\", null), React.createElement(\"br\", null), \n        React.createElement(\"div\", {className: \"col-md-10 leftborder\"}, \n        this.render_nan()\n        ))\n    );\n  },\n  render_edit:function()\n  {\n    var temp_desc,temp_name;\n    if(this.state.add != true) {temp_desc= this.state.projects[0].desc;temp_name = this.state.projects[this.state.selected].newname;}\n    return ( \n      React.createElement(\"div\", null, \n        React.createElement(\"div\", null, \n        React.createElement(\"div\", {className: \"alert_err alert-danger\", style: {width:window.innerWidth}}, \n            React.createElement(\"strong\", null, \"Need choose Proof Readers and Chief Editor!\")\n        )), \n        React.createElement(\"div\", {className: \"col-md-2\"}, \n          React.createElement(\"h1\", {className: \"header_text\"}, \"Project\"), \n          React.createElement(\"div\", {className: \"folderList\"}, \n        React.createElement(\"table\", {className: \"table table-bordered table-hover\"}, \n      React.createElement(\"thead\", {onClick: this.sortHeader}), React.createElement(\"br\", null), \n        React.createElement(\"tbody\", null, \n         this.check_project()\n        )))), \n        React.createElement(\"br\", null), React.createElement(\"br\", null), \n        React.createElement(\"div\", {className: \"col-md-10\"}, \n        React.createElement(\"div\", {className: \"col-md-12 leftborder\"}, \n        this.showadd(), \n        React.createElement(\"div\", {className: \"col-md-2\"}, React.createElement(\"h4\", null, \"Name\")), \n        React.createElement(\"div\", {className: \"col-md-10\"}, React.createElement(\"input\", {type: \"text\", id: \"name\", className: \"form-control\", placeholder: \"Name\", defaultValue: temp_name})), \n        React.createElement(\"div\", {className: \"col-md-12\"}, React.createElement(\"br\", null)), \n        React.createElement(\"div\", {className: \"col-md-2\"}, React.createElement(\"h4\", null, \" Discription\")), \n        React.createElement(\"div\", {className: \"col-md-10\"}, React.createElement(\"textarea\", {id: \"desc\", rows: \"2\", className: \"form-control\", placeholder: \"Discription\", resize: \"none\"}, temp_desc)), \n        React.createElement(\"div\", {className: \"col-md-12\"}, React.createElement(\"br\", null)), \n        React.createElement(\"div\", {className: \"col-md-2\"}, React.createElement(\"h4\", null, \"Proof Readers\")), \n        React.createElement(\"div\", {className: \"col-md-10\"}, \n        React.createElement(\"div\", {className: \"btn-group1\", \"data-toggle\": \"buttons\"}, this.member_list(this.state.pr,this.state.prarr))), \n        React.createElement(\"div\", {className: \"col-md-12\"}, React.createElement(\"br\", null)), \n        React.createElement(\"div\", {className: \"col-md-2\"}, React.createElement(\"h4\", null, \"Chief Editor\")), \n        React.createElement(\"div\", {className: \"col-md-10\"}, \n        React.createElement(\"div\", {className: \"btn-group2\", \"data-toggle\": \"buttons\"}, this.member_list(this.state.ce,this.state.cearr))), \n        React.createElement(\"div\", {className: \"col-md-12\"}, React.createElement(\"br\", null), React.createElement(\"br\", null), React.createElement(\"br\", null), React.createElement(\"br\", null)), \n        React.createElement(\"div\", {className: \"col-md-4 col-md-offset-8\"}, \n        React.createElement(\"button\", {className: \"btn btn-warning btn-lg button_default\", onClick: this.canceledit}, \"Cancel\"), \"   \", \n        React.createElement(\"button\", {className: \"btn btn-success btn-lg button_default\", onClick: this.confirm}, \"Save\")\n        )\n        )\n        )\n      )\n      );\n  },\n  render_nan:function(){\n    if(this.state.first ==true) {\n      return React.createElement(\"div\", null)}\n    else if(this.state.authority ==false){\n      return (\n        React.createElement(\"div\", {className: \"col-md-8 col-md-offset-4\"}, React.createElement(\"h1\", null, \"You havent been asign in this project.\")\n        )\n        );}\n    else {\n      return ( \n        React.createElement(\"div\", null, \n        React.createElement(\"div\", {className: \"col-md-2\"}, React.createElement(\"h4\", null, \" Name\")), \n        React.createElement(\"div\", {className: \"col-md-10\"}, React.createElement(\"h4\", null, this.state.projects[this.state.selected].newname)), \n        React.createElement(\"div\", {className: \"col-md-12\"}, React.createElement(\"br\", null), React.createElement(\"br\", null)), \n        React.createElement(\"div\", {className: \"col-md-2\"}, React.createElement(\"h4\", null, \" Discription\")), \n        React.createElement(\"div\", {className: \"col-md-10\"}, React.createElement(\"h4\", null, this.state.projects[0].desc)), \n        React.createElement(\"div\", {className: \"col-md-12\"}, React.createElement(\"br\", null), React.createElement(\"br\", null)), \n        React.createElement(\"div\", {className: \"col-md-12\"}, React.createElement(\"br\", null), React.createElement(\"br\", null)), \n        React.createElement(\"div\", {className: \"col-md-2\"}, React.createElement(\"h4\", null, \"Proof Readers\")), \n        React.createElement(\"div\", {className: \"col-md-10\"}, React.createElement(\"div\", {className: \"btn-group1\", \"data-toggle\": \"buttons\"}, this.member_list(this.state.prarr,\"off\"))), \n        React.createElement(\"div\", {className: \"col-md-12\"}, React.createElement(\"br\", null), React.createElement(\"br\", null)), \n        React.createElement(\"div\", {className: \"col-md-2\"}, React.createElement(\"h4\", null, \"Chief Editor\")), \n        React.createElement(\"div\", {className: \"col-md-10\"}, React.createElement(\"div\", {className: \"btn-group1\", \"data-toggle\": \"buttons\"}, this.member_list(this.state.cearr,\"off\"))), \n        React.createElement(\"div\", {className: \"col-md-12\"}, React.createElement(\"br\", null), React.createElement(\"br\", null), React.createElement(\"br\", null), React.createElement(\"br\", null)), \n        React.createElement(\"div\", {className: \"col-md-4 col-md-offset-8\"}, \n        this.editbutton(), \"   \", \n        React.createElement(\"button\", {className: \"btn btn-success btn-lg button_default\", onClick: this.openproject}, \"Open\"), \"   \"\n        ))\n       ); \n    } \n  },\n  render: function() {\n    if(this.state.edit==true){ return this.render_edit();}\n    else {return this.render_normal();}\n  }\n});\nmodule.exports=projectlist;",
    "var React=require(\"react\");\nvar FileControls=React.createClass({displayName: \"FileControls\",\n  render:function() {\n    return React.createElement(\"div\", null, React.createElement(\"h1\", {className: \"header_text\"}, \"Bambos\")) \n  }\n});\nvar FolderList = React.createClass({displayName: \"FolderList\",\n  getInitialState:function() {\n    return {selected:0};\n  },\n  shouldComponentUpdate:function(nextProps,nextState) {\n\n    return (nextProps.folders!=this.props.folders ||\n      this.state.selected!=nextState.selected || this.props.hits != nextProps.hits);\n  },\n  select:function(e) {\n    var i=e.target.parentElement.attributes['data-i'].value;\n    this.setState({selected:i});\n    this.props.onSelectFolder(i);\n  },\n  renderFolders:function() { \n    var folders = [];\n    if(this.props.folders != null) folders = this.props.folders.sort(); \n    var cls=\"\",out=[];\n    for (var i=0;i<this.props.folders.length;i++) {\n      var f=this.props.folders[i];\n      var hit=\"\";\n      if (this.props.hits&&this.props.hits[i]) hit=this.props.hits[i];\n      if (i==this.state.selected) cls=\"success\"; else cls=\"\";\n      out.push(React.createElement(\"tr\", {key: 'd'+i, className: cls, onClick: this.select, \"data-i\": i}, \n        React.createElement(\"td\", null, f, \n        React.createElement(\"span\", {className: \"label label-info\"}, hit)\n        )\n        ));\n    };\n    return out;\n  },\n\n  render:function() {\n    return React.createElement(\"div\", {className: \"folderList\"}, \n    React.createElement(\"table\", {className: \"table table-hover\"}, \n    React.createElement(\"tbody\", null, this.renderFolders())\n    )\n    );\n  }\n});\nvar FileList = React.createClass({displayName: \"FileList\",\n  getInitialState:function() {\n    return {selected:0,hovered:-1};\n  },\n  select:function(e) {\n    var ee=e.target.parentElement.attributes['data-i'];\n    if (!ee) return;\n    var selected=parseInt(ee.value);\n    this.setState({selected:selected});\n    this.props.onSelectFile(selected);\n  },\n  shouldComponentUpdate:function(nextProps,nextState) {\n\n    var shouldUpdate= (nextState.hovered != this.state.hovered || this.state.hovered==-1\n      ||nextState.selected!=this.state.selected || this.props.files!=nextProps.files);\n\n    if (this.props.files!=nextProps.files) {\n      if (nextProps.selected!=this.state.selected) {\n        nextState.selected=nextProps.selected;\n      }\n    }\n    return shouldUpdate;\n  },\n  leave:function(e) {\n    this.setState({hovered:-1});\n  },\n  openfile:function(e) {\n    var e=e.target;\n    while (e) {\n      if (e.attributes['data-i']) {\n        var i=parseInt(e.attributes['data-i'].value);\n        break;\n      } else e=e.parentElement;\n    }\n    this.setState({selected:i});\n    this.props.onOpenFile(i);\n  },\n  renderFiles:function() {\n    var cls=\"\",out=[], filestart=this.props.start;\n    for (var i=0;i<this.props.files.length;i++) {\n      var f=this.props.files[i],hit=\"\";\n      if (this.props.hits) hit=this.props.hits[filestart+i]?this.props.hits[filestart+i].length:\"\";\n      if (!hit) hit=\"\";\n      if (i==this.state.selected) cls=\"success\"; else cls=\"\";\n      out.push(React.createElement(\"tr\", {key: 'f'+i, onClick: this.select, \n           onMouseEnter: this.hoverFile, onMouseLeave: this.leave, \n           className: cls, \"data-i\": i}, \n        React.createElement(\"td\", {onDoubleClick: this.openfile}, f.substring(0,f.length-4), \n        \n        React.createElement(\"span\", {className: \"label label-info\"}, hit), \n        React.createElement(\"span\", {className: \"pull-right\", style: {visibility:this.state.hovered==i?\"\":\"hidden\"}}, \n        React.createElement(\"button\", {className: \"btn btn-success\", onClick: this.openfile}, \"Open\")\n        )\n        )\n        ));\n    };\n    return out;\n  }, \n  hoverFile:function(e) {\n    if (e.target.parentElement.nodeName!='TR') return;\n    var hovered=e.target.parentElement.attributes['data-i'].value;\n    if (this.state.hovered==hovered) return;\n\n    this.setState({hovered:hovered});\n  },\n  render:function() {\n    return React.createElement(\"div\", {className: \"fileList\"}, \n    React.createElement(\"table\", {className: \"table table-hover\"}, \n    React.createElement(\"tbody\", null, this.renderFiles())));\n  }\n});\nvar projectview = React.createClass({displayName: \"projectview\",\n  getInitialState: function() {\n    return {bar: \"world\",folders:[],files:[],selectedFile:0};\n  },\n  shouldComponentUpdate:function(nextProps,nextState) {\n    return (nextProps.kde.activeQuery!=this.activeQuery || typeof this.activeQuery==\"undefined\"\n      || nextState.files!=this.state.files|| nextState.folders!=this.state.folders);\n  }, \n  autoopen:function() {\n    //if (!this.props.autoopen || !this.props.autoopen.file) return;\n    var folders=this.state.folders;\n    if (this.props.autoopen && this.props.autoopen.file) {\n        var folder=this.props.autoopen.file;\n        folder=folder.substring(0,folder.lastIndexOf('/'));\n        for(var i=0;i<folders.length;i++) {\n          if (folders[i]==folder) {\n            this.selectFolder(i);\n            break;\n          }\n        }\n    } else {\n      if (!this.folderopen && this.state.folders.length) this.selectFolder( 0 ); \n      this.folderopen=true;\n    }\n  },\n  componentDidMount:function() {\n    var folders={};\n    var filenames=this.props.kde.get(\"filenames\");\n    if (!filenames) {\n      console.error(\"kde not loaded yet\");\n      return;\n    } \n    filenames.map(function(f) { folders[f.substring(0,f.indexOf('/'))]=true});\n    var _folders=Object.keys(folders);\n    this.setState({folders:_folders});\n    setTimeout( this.autoopen.bind(this),1); \n    if (this.props.tab ) this.props.tab.instance=this; // for tabui \n    this.activeQuery=this.props.kde.activeQuery;\n  },\n  selectFolder:function(i) {\n    var folder=this.state.folders[i];\n    var filenames=this.props.kde.get(\"filenames\");\n\n    var files=[],start;\n    filenames.map(function(f,idx) {\n      if(f.substring(0,folder.length)==folder) {\n        if (!files.length) start=idx;\n        files.push(f.substring(folder.length+1));\n      }\n    });\n\n    this.setState({files:files, filestart:start, folder:folder,selectedFile:0});\n\n    if (this.props.autoopen && this.props.autoopen.file) {\n      for(var i=0;i<files.length;i++) {\n        if (folder+'/'+files[i]==this.props.autoopen.file) {\n          this.openFile(i);\n          this.props.autoopen.file=\"\"; //prevent from click on folder autoopen\n          break;\n        }\n      }\n    }\n    this.props.kde.activeFolder=folder;\n    this.props.action(\"selectfile\",this.props.kde,folder);\n  },\n  selectFile:function(i) {\n    var f=this.state.folder+'/'+this.state.files[i];\n    this.props.kde.activeFile=f;\n    this.props.action(\"selectfile\",this.props.kde,f);\n  },\n  openFile:function(i) {\n    var f=this.state.folder+'/'+this.state.files[i];\n    var gotopageid;\n    if (this.props.autoopen)  {\n      gotopageid=this.props.autoopen.pageid;\n    }\n    this.props.action(\"openfile\",this.props.kde.dbname,f,gotopageid,null);\n    if (this.props.autoopen) {\n      this.props.autoopen.pageid=\"\";\n    }\n    this.setState({selectedFile:i});\n  },\n  \n  makescrollable:function() {\n    var tabheight=this.getDOMNode().getBoundingClientRect().height;\n    var f=this.refs.folderList.getDOMNode();\n    f.style.height=document.body.offsetHeight-130+\"px\";\n    //f.style.height='90%';//tabheight-f.getBoundingClientRect().top;\n//    f.style.height=document.body.offsetHeight/2-f.getBoundingClientRect().top;\n    f=this.refs.fileList.getDOMNode();\n//    f.style.height=document.body.offsetHeight/2-f.getBoundingClientRect().top;\n    //f.style.height='90%';//f.style.height=tabheight- f.getBoundingClientRect().top;\n    f.style.height=document.body.offsetHeight-130+\"px\";//f.style.height=tabheight- f.getBoundingClientRect().top;\n  },\n  componentDidUpdate:function() {\n    this.activeQuery=this.props.kde.activeQuery;\n    this.makescrollable();\n    var that=this;\n    if  (typeof this.state.folder==\"undefined\") {\n        setTimeout(function(){\n          that.selectFolder(0);\n       },100);\n    }\n  },\n  getFolderHits:function() {\n    if (!this.props.kde.activeQuery) return [];\n    return this.props.kde.activeQuery.byFolder;\n  },\n  getFileHits:function() {\n    if (!this.props.kde.activeQuery) return [];\n    return this.props.kde.activeQuery.byFile;\n  },\n  componentWillUnmount:function() {\n    return;\n    this.props.action(\"closedb\",this.props.kde.kdbid);\n  },\n  render: function() {\n    return (\n      React.createElement(\"div\", {className: \"projectview\"}, \n        React.createElement(\"div\", {className: \"row\"}, \n        React.createElement(\"div\", {className: \"col-md-3\"}, \n        React.createElement(\"div\", null, React.createElement(\"h1\", {className: \"header_text\"}, \"Volumes\")), \n        React.createElement(FolderList, {ref: \"folderList\", folders: this.state.folders, onSelectFolder: this.selectFolder, hits: this.getFolderHits()})\n        ), \n        React.createElement(\"div\", {className: \"col-md-9\"}, \n        React.createElement(FileControls, null), \n        React.createElement(FileList, {ref: \"fileList\", className: \"fileList\", \n           selected: this.state.selectedFile, \n            files: this.state.files, \n            onSelectFile: this.selectFile, onOpenFile: this.openFile, start: this.state.filestart, hits: this.getFileHits()})\n        )\n        )\n      )\n    );   \n  }\n});\nmodule.exports=projectview;",
    "/** @jsx React.DOM */\r\n\r\n//var othercomponent=Require(\"other\"); \r\nvar React=require(\"react\");\r\nvar ExpandedToken=React.createClass({displayName: \"ExpandedToken\",\r\n  tokenclick:function(e) {\r\n    var n=e.target;\r\n    if (n.tagName!=\"A\") n=n.parentElement;\r\n    var elements=n.parentNode.getElementsByClassName(\"active\");\r\n    for (var i=0;i<elements.length;i++){\r\n      elements[i].classList.remove(\"active\");\r\n    }\r\n    n.classList.toggle('active');\r\n    var ntoken=parseInt(n.attributes[\"data-ntoken\"].value);\r\n    var group=parseInt(n.attributes[\"data-group\"].value);\r\n    this.props.action(\"tokenclick\",ntoken, group);\r\n  },\r\n  showtokenwithhits:function(tokenwithhits,variants) {\r\n    if (tokenwithhits!=variants.length) {\r\n      return React.createElement(\"span\", null, React.createElement(\"span\", {className: \"label label-warning\"}, tokenwithhits), \"/\", \n      React.createElement(\"span\", {className: \"label label-info\"}, this.props.token.variants.length))\r\n    }else {\r\n      return React.createElement(\"span\", {className: \"label label-info\"}, this.props.token.variants.length)      \r\n    }\r\n  },\r\n  render:function() {\r\n    var that=this;\r\n    var token=this.props.token;\r\n    var tokenwithhits=0;\r\n    this.props.token.variants.map(function(v){\r\n      if (v[1]) tokenwithhits++\r\n    });\r\n    return React.createElement(\"div\", {className: \" col-md-12\"}, \r\n      React.createElement(\"span\", null, this.props.token.raw), this.showtokenwithhits(tokenwithhits,this.props.token.variants), \r\n       React.createElement(\"ul\", {className: \"expanded tokenlist list-group\"}, \r\n      token.variants.map(function(t,idx){\r\n        if (t[1]==0) return ; // variants without hit\r\n        var classes=\"list-group-item\";\r\n        if (idx==0) classes+=\" active\";\r\n        return React.createElement(\"a\", {href: \"#\", \"data-group\": that.props.group, \r\n            \"data-ntoken\": idx, title: t[1], \r\n            onClick: that.tokenclick, className: classes}, t[0]\r\n            )\r\n      })\r\n    ))\r\n  }\r\n});\r\n\r\n\r\nvar queryinfo = React.createClass({displayName: \"queryinfo\",\r\n  getInitialState: function() {\r\n    return {bar: \"world\",selected:[]};\r\n  },\r\n  help:function() {\r\n    return React.createElement(\"span\", null, React.createElement(\"strong\", null, \"Usage:\"), \r\n      React.createElement(\"br\", null), \"press enter for quick search.\", \n      React.createElement(\"br\", null), \"if the search phrase has only one wildcard syllable, hit [Filter] to eliminate impossible candidate.\", \n      React.createElement(\"br\", null), \"use space or shad to seperate multiple terms.\", \n      React.createElement(\"br\", null), React.createElement(\"strong\", null, \"Wildcard Syllable:\"), \r\n      React.createElement(\"br\", null), \"x% :  match syllable starts with x\", \n      React.createElement(\"br\", null), \"%y :  match syllable ends with y\", \n      React.createElement(\"br\", null), \"%x% :  match syllable containing x\", \n      React.createElement(\"br\", null), \"x%y :  match syllable starts with x and ends with y\", \n      React.createElement(\"br\", null), \"maximum 3 syllables can have wildcard.\", \n      React.createElement(\"br\", null), \r\n      React.createElement(\"br\", null), React.createElement(\"i\", null, \"Special thanks to Khenpo Karma Namgyal from leksheyling\")\r\n    )\r\n  },\r\n  newsearchphrase:function() {\r\n    var newq=\"\",group=0;\r\n    for (var i in this.props.Q.terms) {\r\n      var T=this.props.Q.terms[i];\r\n      if (T.variants.length) {\r\n        var selected=this.state.selected[group]||0;\r\n        newq+=T.variants[selected][0]+\"་\";\r\n        group++;\r\n      } else {\r\n        newq+=T.raw+\"་\";\r\n      }\r\n    }\r\n    return newq;\r\n  },\r\n  action:function() {\r\n   var args = Array.prototype.slice.call(arguments);\r\n    var type=args.shift();\r\n    var res=null, that=this;\r\n    if (type===\"tokenclick\") {\r\n      this.state.selected[args[1]]=args[0];\r\n      this.setState({selected:this.state.selected});\r\n      this.props.action(\"search\",this.newsearchphrase());\r\n    } else this.props.action(arguments);\r\n  },\r\n  showExpandedTokens:function() {\r\n    if (!this.props.Q) return;\r\n    var res=[],expanded=0;\r\n    for (var i in this.props.Q.terms) {\r\n      var T=this.props.Q.terms[i];\r\n\r\n      if (T.variants.length) {\r\n        res.push(React.createElement(ExpandedToken, {action: this.action, token: T, group: i}));\r\n        expanded++;\r\n        if (expanded>=3) break;\r\n      }\r\n    }\r\n    return res;\r\n  },\r\n  render: function() {\r\n    if (!this.props.Q || !this.props.Q.terms.length) return this.help();\r\n    else return (\r\n      React.createElement(\"div\", null, \r\n        this.showExpandedTokens()\r\n      )\r\n    );\r\n  }\r\n});\r\nmodule.exports=queryinfo;",
    "\nvar React=require(\"react\");\n//var othercomponent=Require(\"other\"); \nvar referenceview = React.createClass({displayName: \"referenceview\",\n  getInitialState: function() {\n    return {bar: \"world\"};\n  },\n  render: function() {\n    return (\n      React.createElement(\"div\", null, \n        \"Hello,\", this.state.bar\n      )\n    );\n  }\n});\nmodule.exports=referenceview;",
    "/** @jsx React.DOM */\r\nvar React=require(\"react\");\r\n//var othercomponent=Require(\"other\"); \r\nvar resultlist = React.createClass({displayName: \"resultlist\",\r\n  getInitialState: function() {\r\n    return {bar: \"world\"};\r\n  },\r\n  gopage:function(e) {\r\n    var pageid=parseInt(e.target.attributes[\"data-page\"].value);\r\n    var fileid=parseInt(e.target.attributes[\"data-file\"].value);\r\n    var pagename=e.target.innerHTML;\r\n    this.props.action(\"gopage\",pageid,fileid,pagename);\r\n  }, \r\n  warning:function() {\r\n    if (this.props.Q.rawresult.length>1000) {\r\n      return \",only first 1000 hits are shown\";\r\n    } else return \"\";\r\n  },\r\n  show:function() {\r\n    var that=this;\r\n    var bambo = this.getbambos();\r\n    var except = [];\r\n    var except_count =0;\r\n    if (!this.props.Q || !this.props.Q.excerpt) {\r\n      return React.createElement(\"div\", null)\r\n    }\r\n    else if(bambo.length >0){\r\n    for(var k=0;k<this.props.Q.excerpt.length;k++)\r\n    {\r\n          for(var j=0;j<bambo.length;j++)\r\n          {\r\n            if(this.props.Q.excerpt[k].file == bambo[j]) \r\n            {\r\n              except[except_count] = this.props.Q.excerpt[k];\r\n              except_count++;\r\n            }\r\n          }\r\n          if(this.props.Q.excerpt[k].file>bambo[bambo.length-1]) \r\n          {this.props.Q.excerpt = except; break;}\r\n      }\r\n\r\n    }\r\n    else\r\n    {\r\n        except = this.props.Q.excerpt;\r\n    }\r\n    if (except == \"\") {\r\n      return React.createElement(\"div\", null, React.createElement(\"h2\", null, \"No result in this bambo!\"))\r\n    }\r\n    return except.map(function(r,i){ // excerpt is an array \r\n      if (!r) return React.createElement(\"div\", null);\r\n      return React.createElement(\"div\", null, \r\n      r.seq+1, \" [\", React.createElement(\"a\", {href: \"#\", \"data-file\": r.file, \"data-page\": r.seg, onClick: that.gopage}, r.segname), \"]\", \n      React.createElement(\"div\", {className: \"result\", dangerouslySetInnerHTML: {__html:r.text}})\r\n      )\r\n    });  \r\n  },   \r\n  getbambos:function() {\r\n    var arr = [];\r\n    var count =0;\r\n    if(this.props.bambos.length >3)\r\n    {\r\n      for(var i=4;i<this.props.bambos.length;i++)\r\n      {\r\n        arr[count] = this.props.bambos[i].fid;\r\n        count++;\r\n      }\r\n    }\r\n    return arr;\r\n  },\r\n  showhit:function() {\r\n    if (!this.props.Q.rawresult|| !this.props.Q.rawresult.length) return \"0\";\r\n    else return this.props.Q.rawresult.length;\r\n  },\r\n  render: function() {\r\n      if (this.props.Q) return React.createElement(\"div\", {className: \"resultlist\"}, \r\n        this.show()\r\n      )\r\n      else return React.createElement(\"div\", null)\r\n  }\r\n});\r\nmodule.exports=resultlist;\r\n\r\n/*\r\nquerystring:<span className=\"query\">{this.props.Q.query}</span>\r\n          <span className=\"label label-info\">{this.showhit()}</span>{this.warning()}\r\n          */",
    "/** @jsx React.DOM */\r\n\r\n//var othercomponent=Require(\"other\"); \r\n//var tibetan=require(\"ksana-search\").languages.tibetan;\r\n\r\nvar React=require(\"react\"); \r\nvar searchbox = React.createClass({displayName: \"searchbox\",\r\n  getInitialState: function() {\r\n    return {bar: \"world\"};\r\n  },\r\n  getTofind:function() {\r\n      var tofind=this.refs.tofind.getDOMNode().value;\r\n      tofind=tofind.replace(/%/g,\"\\uffff\");\r\n      //tofind=tibetan.romanize.fromWylie(tofind,null,false); \r\n      tofind=tofind.replace(/\\uffff/g,\"%\");\r\n      return tofind;\r\n  },\r\n  tofindchange:function() {\r\n      var that=this;\r\n      clearTimeout(this.timer1);\r\n      this.timer1=setTimeout(function(){\r\n\r\n        that.props.action(\"tofindchange\",that.getTofind());\r\n      },300);\r\n  },\r\n  keypress:function(e) {\r\n    if (e.key==\"Enter\") this.dosearch();\r\n  },\r\n  dosearch:function() {\r\n    this.props.action(\"search\",this.getTofind());\r\n  },\r\n  insertwildcard:function() { \r\n    var dom=this.refs.tofind.getDOMNode();\r\n    var tofind=dom.value;\r\n    dom.value+=\"%\";\r\n    dom.focus();\r\n  },\r\n  componentDidMount:function() {\r\n    this.tofindchange();\r\n  },\r\n  componentDidUpdate:function() {\r\n    var that=this;\r\n    setTimeout(function(){\r\n      that.refs.tofind.getDOMNode().focus();\r\n    },300);\r\n  },\r\n  filter:function() {\r\n    this.props.action(\"filter\",this.getTofind());\r\n  },\r\n  showfilter:function() {\r\n    var disabled=\"\";\r\n    if (this.props.wildcard!=1) disabled=\" disabled\";\r\n    if (this.props.progress==1) {\r\n      return React.createElement(\"button\", {onClick: this.filter, className: \"btn btn-warning\"+disabled, type: \"button\"}, \"Filter\")  \r\n    } else {\r\n      return React.createElement(\"span\", null, Math.floor(this.props.progress*100)+\"%\")\r\n    }\r\n  },\r\n  render: function() {\r\n    return (\r\n      React.createElement(\"div\", {className: \"searchbox\"}, \r\n         React.createElement(\"div\", null, \r\n              React.createElement(\"div\", {className: \"input-group input-group-lg\"}, \r\n                React.createElement(\"input\", {defaultValue: this.props.kw, ref: \"tofind\", onKeyPress: this.keypress, type: \"text\", className: \"tofind\", style: {width:window.innerWidth*0.7}}), \r\n                React.createElement(\"span\", {className: \"input-group-btn\"}, \r\n                  React.createElement(\"button\", {className: \"btn btn-success btn-lg\", type: \"button\", onClick: this.dosearch}, \"Search\")\r\n              )\r\n              )\r\n          )\r\n      )\r\n    );\r\n  }\r\n});\r\nmodule.exports=searchbox;",
    "var styles = [\n  {\n    \"name\":\"part of speech\",\n    \"markups\": {\n      \"suggest\":  {'border-bottom': '2px solid orange','cursor': 'pointer'},\n      \"comment\":  {'border-bottom': '2px solid blue','cursor': 'pointer'},\n\n      \"revision\":  {'border-bottom': '2px solid green','cursor': 'pointer'},\n      \"verb\":  {\"background-image\":\"url('svg/overline.svg')\" },\n      \"verb_b\":  {\"background-image\":\"url('svg/overline_b.svg')\" },\n      \"verb_e\":  {\"background-image\":\"url('svg/overline_e.svg')\" },\n      \n      \"suggests\":  {\n          'border-bottom': '3px solid red','cursor': 'pointer'\n      },\n      //\"changes\":  {\"background-image\":\"url('svg/overline.svg')\" },\n      //\"changes_b\":  {\"background-image\":\"url('svg/overline_b.svg')\" },\n      //\"changes_e\":  {\"background-image\":\"url('svg/overline_e.svg')\" },\n\n      \"noun\":  {\"background-image\":\"url('svg/yellowcircle.svg')\"} ,\n      \"abstract\" :  {\"background-image\":\"url('svg/silvercircle.svg')\"},\n      \"comma\" :  {\"background-image\":\"url('svg/comma.svg')\"},\n      \"fullstop\" :  {\"background-image\":\"url('svg/fullstop.svg')\"},\n      \"redstrikeout\" :  {\"background-image\":\"url('svg/redstrikeout.svg')\"},\n      \"inserttext\" : {\"background-image\": \"url('svg/overline.svg')\"},\n      \"linkto\" : {\"cursor\": \"pointer\", \"background-image\": \"url('svg/underline.svg')\"},\n\n\n    }\n  }\n\n];\nmodule.exports=styles;",
    "var React=require(\"react\");\nvar contentpf=\"C_\";\nvar Tabui = React.createClass({displayName: \"Tabui\",\n  getInitialState:function(){\n    return { }\n  },\n  shouldComponentUpdate:function(nextProps,nextState) {\n    if (!this.props.tabs || !nextProps.tabs) return true;\n    return (nextProps.tabs.length!=this.props.tabs.length || this.props.tabs.updated);\n  },\n  tabnav:function(T) {\n    var closebutton=(T.notclosable)?\"\":\n       React.createElement(\"button\", {className: \"close\", type: \"button\", onClick: this.closeTab}, \n       String.fromCharCode(0xd7)\n       );\n    return (\n      React.createElement(\"li\", {ref: T.id, key: \"N\"+T.id}, \n        React.createElement(\"a\", {\"data-id\": T.id, \"data-target\": \"[data-id='C-\"+T.id+\"']\", \n          onClick: this.clickTab, href: \"#\"}, T.caption, closebutton\n        )\n      )\n    )\n  },\n  tabcontent:function(T) {\n  \n    if (T.params) T.params.tab = T;\n    return React.createElement(\"div\",{ref:contentpf+T.id, key:\"C\"+T.id,\"data-id\":\"C-\"+T.id\n    ,className:\"tab-pane\"},React.createElement(T.content,T.params));\n  },\n\n  render:function() {\n    var tabnav=this.tabnav, tabcontent=this.tabcontent;\n    return (\n    React.createElement(\"div\", null, \n      React.createElement(\"ul\", {className: \"nav nav-tabs\"}, \n       this.props.tabs.map(function(T){return tabnav(T) })  \n      ), \n      React.createElement(\"div\", {className: \"tab-content\"}, \n       this.props.tabs.map(function(T){return tabcontent(T) }) \n      )\n    )  \n  );\n  },\n  clickTab:function(e) {\n    var anchor=e.target;\n    if (anchor.nodeName!=='A') anchor=anchor.parentElement;\n    e.preventDefault();\n\n    var id=anchor.attributes['data-id'].value;\n    if(id==\"addbutton\") id=\"p_newtab\"; \n    this.props.tabs[1].nowbambo = id.substring(2,id.length); \n    this.goTab(id);\n  },\n  goTab:function(id,params) {\n    $(this.refs[id].getDOMNode()).find(\"a\").tab('show');\n    var activated=this.props.tabs.filter(function(t){return t.id==id});\n    if (activated.length && activated[0].params&&\n      activated[0].params.tab &&\n      activated[0].params.tab.instance&&\n      activated[0].params.tab.instance.onShow) {\n      activated[0].params.tab.instance.onShow(params);\n    }\n  },\n  goActiveTab:function() {\n    var goTab=this.goTab;\n    var t=this.props.tabs.some(function(T){ \n      return T.active?goTab(T.id):false;\n    });\n    this.props.tabs.map(function(T){T.active=false});\n  },\n  closeTab:function(e) {\n    var anchor=e.target.parentElement;\n    var id=anchor.attributes['data-id'].value;\n    var tabs=this.props.tabs;\n    for (var i=0;i<tabs.length;i++) {\n      if (tabs[i].id==id) {\n        tabs.splice(i,1);\n        //if (i) tabs[i-1].active=true;\n        if (i && tabs.length > 4) \n        { \n            tabs[i-1].active=true; \n          } \n          else if (i && tabs.length  == 4)  \n          { \n            tabs.splice(i-1,1); \n           tabs[i-3].active=true; \n          }  \n         this.forceUpdate();\n        //this.setState({\"tabs\":tabs});\n        break;\n      }\n    }\n  }, \n  newTab:function(T,idx) {\n    var tabs=this.props.tabs;\n    var idx=idx||tabs.length;\n    var tabexists=false;\n    for (var i=0;i<tabs.length;i++) {\n      if (tabs[i].id==T.id) {\n        tabs[i]=T;\n        tabexists=true;\n      } else {\n        tabs[i].active=false;  \n      }\n    }\n    if (!tabexists) tabs.splice(idx,0,T);\n    //this.setState({\"tabs\":tabs});\n    this.forceUpdate();\n  },\n  makeScrollable:function() {\n    var h=document.body.offsetHeight-70; \n    var w=this.getDOMNode().offsetWidth;\n    for (var i in this.refs) {\n      if (i.substring(0,contentpf.length)!=contentpf)continue;\n      var t=this.refs[i].getDOMNode();\n      t.style.height=h;\n      t.style.width=w;\n      t.style.overflow=\"auto\";\n    }\n  },\n  componentDidMount:function() {\n    this.goActiveTab();\n  },\n  componentDidUpdate:function() {\n    this.props.tabs.updated=false;\n    this.makeScrollable();\n    this.goActiveTab();\n  }\n});\n\nmodule.exports=Tabui;",
    "var pouch=require(\"./persistentmarkup_pouchdb\");\nvar React=require(\"react\");\n//var crypto=require('./crypto');\nvar userinfo = React.createClass({displayName: \"userinfo\",\ngetInitialState: function() {\n    return {bar: \"world\",pwtype:\"\"};\n  },\n  changepassword:function() {\n      if(this.state.pwtype == \"\") this.setState({pwtype:\"change\"});\n      else this.setState({pwtype:\"\"});\n  },\n  savepassword:function() {\n    var ip = location.host.split(\":\")[0];\n    var pwd = this.refs.new_password.getDOMNode().value,cpwd=this.refs.confirm_new_signup_pass.getDOMNode().value;\n    if(this.refs.old_password.getDOMNode().value != this.props.user.pwd) {that.props.action(\"myinput\",2,\"confirm_new\");return;}\n    else if(pwd != cpwd || pwd ==\"\" || cpwd == \"\") {return;}\n    var db = new PouchDB('http://'+ip+':5984/account');\n    var data = [{name:this.props.user.name,su:this.props.user.su,admin:this.props.user.admin,pwd:pwd},{pwd:pwd}];\n    pouch.readfrompouch(db,this.props.user.name,this.changepasswrordstate,2,data);\n  },\n  changepasswrordstate:function(res) {\n      this.setState({pwtype:\"\",pwd:res.pwd});\n  },\n  saveprofile:function(id,admin,pwd,type) {\n    var that =this;\n    var ip = location.host.split(\":\")[0];\n    var nowloc = document.getElementById(id).rowIndex;\n    var db = new PouchDB('http://'+ip+':5984/account');\n    if(type == true) {\n       that.props.users.splice(parseInt(nowloc)-1,1);\n       that.setState({pwtype:\"\"});\n       pouch.removetopouch(db,id);\n    }\n    else {\n     for(var i=0;i<this.props.users.length;i++) {\n          if(this.props.users[i].id == id) {\n            var data = [{name:id,su:this.props.users[i].doc.su,admin:admin,pwd:pwd||this.props.users[i].doc.pwd}];\n            break;}\n     }\n     pouch.readfrompouch(db,id,this.showalert,2,data);\n    }\n  },\n  showalert:function() {\n     this.props.action(\"myalert\",0);\n  },\n  select_chief:function(e){\n    this.saveprofile(e.target.id,true);\n  },\n  select_proof:function(e){\n    this.saveprofile(e.target.id,false);\n  },\n  select_password:function(e){\n    var arr = e.target.id.split(\"+\");\n    this.saveprofile(arr[0],arr[1],document.getElementById(arr[2]).value);\n  },\n  delete_user:function(e){\n    var arr = e.target.id.split(\"+\");\n    this.saveprofile(arr[0],arr[1],document.getElementById(arr[2]).value,true);\n  },\n  role_list:function(f) {\n    if (f.doc.admin == true) {return React.createElement(\"div\", null, \n    React.createElement(\"div\", {className: \"btn-group\", \"data-toggle\": \"buttons\"}, \n      React.createElement(\"label\", {className: \"btn active rolebutton_style\", onClick: this.select_chief, id: f.id}, React.createElement(\"input\", {type: \"radio\", name: f.id, value: \"Chief Editor\"}, \"Chief Editor\")), \n      React.createElement(\"label\", {className: \"btn rolebutton_style\", onClick: this.select_proof, id: f.id}, React.createElement(\"input\", {type: \"radio\", name: f.id, value: \"Proof Reader\"}, \"Proof Reader\"))\n    ))}\n    else {return React.createElement(\"div\", null, \n      React.createElement(\"div\", {className: \"btn-group\", \"data-toggle\": \"buttons\"}, \n      React.createElement(\"label\", {className: \"btn rolebutton_style\", onClick: this.select_chief, id: f.id}, React.createElement(\"input\", {type: \"radio\", name: f.id, value: \"Chief Editor\"}, \"Chief Editor\")), \n      React.createElement(\"label\", {className: \"btn active rolebutton_style\", onClick: this.select_proof, id: f.id}, React.createElement(\"input\", {type: \"radio\", name: f.id, value: \"Proof Reader\"}, \"Proof Reader\"))\n    ))\n    }\n  },\n  user_list:function() {\n    if(this.props.user.su == true){\n    var cls=\"\",out=[];\n    if(this.props.users) {\n       out.push(React.createElement(\"tr\", null, React.createElement(\"td\", null, \n          React.createElement(\"div\", {className: \"col-md-1\"}), \n          React.createElement(\"div\", {className: \"col-md-2\"}, React.createElement(\"h4\", null, \"Name\")), \n          React.createElement(\"div\", {className: \"col-md-4\"}, React.createElement(\"h4\", null, \"Password\")), \n          React.createElement(\"div\", {className: \"col-md-4 pull-right\"}, React.createElement(\"h4\", null, \"Role\"))\n        )));\n      for (var i=0;i<this.props.users.length;i++) {\n      var f=this.props.users[i];\n      if(f.doc.su == true)  out.push(React.createElement(\"tr\", null));\n      else {\n      out.push(React.createElement(\"tr\", {id: f.id}, React.createElement(\"td\", null, \n          React.createElement(\"div\", {className: \"col-md-1\"}, React.createElement(\"img\", {src: \"photo/\"+this.props.users[i].id+\".jpg?\"+ new Date().getTime(), ref: \"user_photo\", id: \"user\"+i, className: \"showphoto_style\", onError: this.photo_error})), \n          React.createElement(\"div\", {className: \"col-md-2\"}, React.createElement(\"h4\", null, f.id)), \n          React.createElement(\"div\", {className: \"col-md-4\"}, React.createElement(\"input\", {type: \"text\", defaultValue: f.doc.pwd, id: i}), React.createElement(\"button\", {className: \"btn btn-success btn-block control_D-halfsize pull-right\", id: f.id+\"+\"+f.doc.admin+\"+\"+i, onClick: this.select_password}, \"Change Password\")), \n          React.createElement(\"div\", {className: \"col-md-4 pull-right\"}, this.role_list(f)), \n          React.createElement(\"div\", {className: \"col-md-1\"}, React.createElement(\"button\", {className: \"btn btn-danger btn-block pull-right\", style: {width:\"80px\"}, id: f.id+\"+\"+f.doc.admin+\"+\"+i, onClick: this.delete_user}, \"Delete\"))\n        )));\n      }\n    };\n    return out;\n   }\n  }\n  },\n  refresh_photo:function(e) {\n    var that = this;\n    setTimeout(function(){\n      that.getDOMNode().querySelector('#photo_1').src = \"photo/\"+that.props.user.name+\".jpg?\"+ new Date().getTime(); \n      that.props.action(\"change_mainphoto\");\n    },1000); \n  },\n  photo_error:function(e) {\n     var img = e.target;\n     img.src= 'images/photo.png';\n  },\n  checkoldpassword:function() {\n     if(this.refs.old_password.getDOMNode().value != this.props.user.pwd) this.props.action(\"myinput\",0,\"old_password\");\n     else this.props.action(\"myinput\",1,\"old_password\");\n  },\n  confirmnewpwd:function() {\n    if(this.refs.new_password.getDOMNode().value != this.refs.confirm_new_signup_pass.getDOMNode().value) {this.props.action(\"myinput\",2,\"confirm_new\");}\n    else {this.props.action(\"myinput\",1,\"confirm_new\");}\n  },\n  password:function() {\n      if(this.state.pwtype == \"change\") return React.createElement(\"div\", null, \n        React.createElement(\"div\", {className: \"col-md-2 col-md-offset-1\"}, React.createElement(\"br\", null), \n        React.createElement(\"div\", {className: \"form-group has-feedback\", id: \"old_password_form\"}, \n          React.createElement(\"input\", {ref: \"old_password\", type: \"password\", className: \"form-control control_D-halfsize\", placeholder: \"Old Password\", onBlur: this.checkoldpassword}), React.createElement(\"br\", null), \n          React.createElement(\"span\", {className: \"glyphicon form-control-feedback\", id: \"old_password_icon\", style: {left:\"120px\"}})), \n         React.createElement(\"div\", {className: \"form-group has-feedback\", id: \"new_password_from\"}, \n          React.createElement(\"input\", {ref: \"new_password\", type: \"password\", className: \"form-control control_D-halfsize\", placeholder: \"New Password\"}), React.createElement(\"br\", null), \n          React.createElement(\"span\", {className: \"glyphicon form-control-feedback\", id: \"new_password_icon\", style: {left:\"120px\"}})), \n         React.createElement(\"div\", {className: \"form-group has-feedback\", id: \"confirm_new_form\"}, \n          React.createElement(\"input\", {ref: \"confirm_new_signup_pass\", type: \"password\", className: \"form-control control_D-halfsize\", placeholder: \"Confirm Password\", onChange: this.confirmnewpwd}), \n          React.createElement(\"span\", {className: \"glyphicon form-control-feedback\", id: \"confirm_new_icon\", style: {left:\"120px\"}}))\n        ), React.createElement(\"div\", {className: \"col-md-2 col-md-offset-3\"}, React.createElement(\"button\", {className: \"btn btn-success btn-block changepassword\", onClick: this.savepassword}, \"Save\")), \n        React.createElement(\"div\", {className: \"col-md-2 col-md-offset-3\"}, React.createElement(\"button\", {className: \"btn btn-warning btn-block changepassword\", onClick: this.changepassword}, \"Cancel\")))\n      else return React.createElement(\"div\", null, React.createElement(\"div\", {className: \"col-md-3 col-md-offset-1\"}, React.createElement(\"button\", {className: \"btn btn-success btn-block changepassword\", onClick: this.changepassword}, \"Change Password\")))\n  },\n  render: function() {\n     return React.createElement(\"div\", null, \n            React.createElement(\"div\", {className: \"alert_ok alert-success\", style: {width:window.innerWidth}}, \n              React.createElement(\"strong\", null, \"Saved successfully!\")\n            ), \n           React.createElement(\"div\", {className: \"col-md-4 col-md-offset-4\"}, \n            React.createElement(\"div\", null, React.createElement(\"div\", {className: \"col-md-5\"}, React.createElement(\"img\", {src: \"photo/\"+this.props.user.name+\".jpg?\"+ new Date().getTime(), id: \"photo_1\", className: \"photostyle\", onError: this.photo_error}))), \n            React.createElement(\"div\", {className: \"col-md-6\"}, React.createElement(\"form\", {action: \"upload.php\", method: \"post\", encType: \"multipart/form-data\"}, React.createElement(\"h4\", null, \"Change your photo\"), React.createElement(\"input\", {type: \"hidden\", name: \"number\", value: this.props.user.name}), React.createElement(\"input\", {type: \"hidden\", name: \"folder\", value: \"photo\"}), React.createElement(\"input\", {type: \"file\", name: \"upload\"}), \n            React.createElement(\"div\", null, React.createElement(\"input\", {type: \"submit\", className: \"btn btn-success btn-block pull-left\", name: \"button\", id: \"button\", value: \"Upload\", style: {width:\"110px\",marginBottom:\"10px\"}, onClick: this.refresh_photo}))\n            )), \n            React.createElement(\"div\", {className: \"col-md-3 col-md-offset-1\"}, React.createElement(\"h3\", null, \"Username:\")), React.createElement(\"div\", {className: \"col-md-7 col-md-offset-1\"}, React.createElement(\"h3\", null, this.props.user.name)), \n            React.createElement(\"div\", {className: \"col-md-3 col-md-offset-1\"}, React.createElement(\"h3\", null, \"Password:\")), React.createElement(\"div\", null, this.password())\n          ), \n          React.createElement(\"div\", {className: \"fileList col-md-11 col-md-offset-1\", style: {height:window.innerHeight-380}}, \n          React.createElement(\"table\", {className: \"table table-hover\", id: \"user_table\"}, \n            React.createElement(\"tbody\", null, this.user_list())))\n        );\n  }\n});\nmodule.exports=userinfo;",
    "var Signup=require(\"./usersignup.jsx\");\nvar Info=require(\"./userinfo.jsx\");\nvar pouch=require(\"./persistentmarkup_pouchdb\");\nvar React=require(\"react\");\n//var crypto=require('./crypto');\nvar userlogin = React.createClass({displayName: \"userlogin\",\ngetInitialState: function() {\n    return {bar: \"world\",type:\"\",file:\"\",pwd:\"\"};\n  },\n  login:function() {\n    var ip = location.host.split(\":\")[0];\n    var db = new PouchDB('http://'+ip+':5984/account');\n    pouch.readallfrompouch(db,this.login_check,0);\n  },\n  login_check:function(res) {\n    var userinfo = \"\";\n    var loginfo =false;\n    var user=this.refs.username.getDOMNode().value;\n    var pswd=this.refs.password.getDOMNode().value;\n    for(var i=0;i<res.rows.length;i++){       \n        if(res.rows[i].doc._id == user && res.rows[i].doc.pwd == pswd)\n        {\n          userinfo = res.rows[i].doc;\n          loginfo = true;\n        }\n        if(res.rows[i].doc._id == user && res.rows[i].doc.pwd != pswd)\n        {\n          loginfo = \"failed\";\n          this.props.action(\"myinput\",0,\"loginpwd\");\n          this.props.action(\"myinput\",1,\"loginname\");\n          }\n        } \n        if(loginfo == false) {\n         this.props.action(\"myinput\",0,\"loginname\");\n        }\n        this.props.action(\"login\",userinfo,loginfo,res.rows,pswd);\n  },\n  /*\n  logout:function() {\n    this.props.action(\"logout\");\n  },\n  */\n  /*\n  startwork:function() {\n    this.props.action(\"start\");\n  },*/\n  /*\n  isAdmin:function() {\n    if (this.props.user.admin) {\n      return  <span className=\"label label-success\">admin</span>\n    }   \n  },*/\n  singup:function() {\n    this.refs.password.getDOMNode().value = \"\";\n    this.setState({type:\"signup\"});\n  },\n  cancel_signup:function() {\n    //this.refs.confirm_signup_pass.getDOMNode().value = \"\";\n    //aaa\n    this.setState({type:\"\"});\n  },\n  passwordchange:function() {\n    this.forceUpdate(); \n  },\n  enterusername:function(e) {\n    if (e.charCode==13) {\n      this.refs.password.getDOMNode().focus();\n    }\n  },\n  enterpassword:function(e) {\n    if (e.charCode==13) this.login();\n  },\n  encryptedpassword:function() {\n    if (!this.refs.password) return \"\";\n    var password=this.refs.password.getDOMNode().value;\n    //return password+\"!\"\n    //return crypto.SHA1(password).toString();\n    return password;\n  },\n  renderLogin:function() {\n  return (\n   React.createElement(\"div\", null, \n     React.createElement(\"div\", {className: \"col-md-12 marginTop\"}), \n      React.createElement(\"div\", {className: \"col-md-6 col-md-offset-4\"}, \n      React.createElement(\"div\", {className: \"col-md-offset-1\"}, \n        React.createElement(\"img\", {src: \"images/logo.jpg\", className: \"logostyle\"}), \n        React.createElement(\"div\", {className: \"form-group has-feedback\", id: \"loginname_form\"}, \n          React.createElement(\"input\", {onKeyPress: this.enterusername, id: \"loginname\", ref: \"username\", className: \"form-control control_size\", placeholder: \"Username\", required: \"true\", autofocus: \"true\"}), \n          React.createElement(\"span\", {className: \"glyphicon form-control-feedback\", style: {left:\"220px\"}, id: \"loginname_icon\"})), \n        React.createElement(\"h2\", {className: \"label label-danger\"}, this.props.getError()), React.createElement(\"br\", null), \n        React.createElement(\"div\", {className: \"form-group has-feedback\", id: \"loginpwd_form\"}, \n          React.createElement(\"input\", {onKeyPress: this.enterpassword, ref: \"password\", type: \"password\", className: \"form-control control_size\", placeholder: \"Password\"}), \n          React.createElement(\"span\", {className: \"glyphicon form-control-feedback\", style: {left:\"220px\"}, id: \"loginpwd_icon\"})), \n        React.createElement(\"h2\", {className: \"label label-danger\"}, this.props.getpasswordError()), React.createElement(\"br\", null), \n        React.createElement(\"button\", {ref: \"encrypted\", id: \"btnlogin\", className: \"btn btn-lg btn-success btn-block control_size\", onClick: this.login}, \"Log in\"), \n        React.createElement(\"div\", {className: \"create_acc\"}, React.createElement(\"a\", {onClick: this.singup}, React.createElement(\"h4\", null, \"Create account\")))\n        )\n       )\n       )\n    );\n  },\n  render: function() {\n    if (this.props.user.name) {\n      return React.createElement(Info, {action: this.props.action, user: this.props.user, users: this.props.users});\n    }else if(!this.props.user.name && this.state.type==\"signup\") {\n      return React.createElement(Signup, {action: this.props.action, cancel: this.cancel_signup});\n    }else {\n      return this.renderLogin();\n    }\n  }\n});\nmodule.exports=userlogin;",
    "var pouch=require(\"./persistentmarkup_pouchdb\");\nvar React=require(\"react\");\n//var crypto=require('./crypto');\nvar usersignup = React.createClass({displayName: \"usersignup\",\ngetInitialState: function() {\n    return {unametype:\"error\"};\n  },\n  signup:function() {\n    var user = [this.refs.signup_username.getDOMNode().value,this.refs.signup_pass.getDOMNode().value,this.refs.confirm_signup_pass.getDOMNode().value];\n    var target = [\"signupname\",\"signuppwd\",\"signupconfirmpwd\"];\n    var unametype = this.state.unametype;\n    for(var i = 0;i<user.length;i++) {\n      if(user[i] == \"\") {\n        this.props.action(\"myinput\",0,target[i]);\n        unametype = \"error\";\n        break;\n      }\n    }\n    if(user[1] != user[2] || unametype==\"error\") return;\n    else {\n      var ip = location.host.split(\":\")[0];\n      var db = new PouchDB('http://'+ip+':5984/account');\n      var todo ={_id:user[0], admin:false, su:false, name:user[0], pwd:user[1]};\n      pouch.savetopouch(db,todo,this.signup_success);\n    }\n  },\n  signup_success:function() {\n    this.setState({unametype:\"error\"});\n    this.cancelsignup();\n  },\n  checkuname_response:function(msg) {\n    if(msg == null) {this.props.action(\"myinput\",0,\"signupname\");this.setState({unametype:\"error\"});\n      document.getElementById(\"name_error\").innerHTML = \"Username has already been taken\";}\n      else {this.props.action(\"myinput\",1,\"signupname\");this.setState({unametype:\"ok\"});\n      document.getElementById(\"name_error\").innerHTML = \"\";}\n  },\n  checkname:function() {\n    var ip = location.host.split(\":\")[0];\n    if(this.refs.signup_username.getDOMNode().value == \"\") return;\n    var name = this.refs.signup_username.getDOMNode().value;\n    var db = new PouchDB('http://'+ip+':5984/account');\n    pouch.readfrompouch(db,name,this.checkuname_response,0);\n  },\n  checkpwd:function() {\n    if(this.refs.signup_pass.getDOMNode().value == \"\") {this.props.action(\"myinput\",0,\"signuppwd\");}\n    else {this.props.action(\"myinput\",1,\"signuppwd\");}\n  },\n  Confirmpwd:function() {\n    var user = [this.refs.signup_pass.getDOMNode().value,this.refs.confirm_signup_pass.getDOMNode().value];\n    if(user[0] != user[1]) {this.props.action(\"myinput\",2,\"signupconfirmpwd\");}\n    else {this.props.action(\"myinput\",1,\"signupconfirmpwd\");}\n  },\n  cancelsignup:function() {\n    this.refs.confirm_signup_pass.getDOMNode().value = \"\";\n    this.props.cancel();\n    //this.setState({type:\"\"});\n  },\n  render: function() {\n    return (  \n    React.createElement(\"div\", null, \n      React.createElement(\"div\", {className: \"col-md-4 col-md-offset-4\"}, \n        React.createElement(\"div\", {className: \"col-md-12\"}, \n        React.createElement(\"form\", {action: \"upload.php\", method: \"post\", encType: \"multipart/form-data\"}, React.createElement(\"h3\", null, \"Select a photo\"), React.createElement(\"input\", {type: \"hidden\", name: \"folder\", value: \"photo\"}), React.createElement(\"input\", {type: \"file\", name: \"upload\"}), \n        React.createElement(\"div\", {className: \"form-group has-feedback\", id: \"signupname_form\"}, \n          React.createElement(\"label\", {className: \"control-label\", id: \"name_error\", style: {color:\"red\"}}, \" \"), \n          React.createElement(\"input\", {ref: \"signup_username\", className: \"form-control control_size\", name: \"number\", placeholder: \"Username\", required: \"true\", autofocus: \"true\", onBlur: this.checkname}), React.createElement(\"br\", null), \n          React.createElement(\"span\", {className: \"glyphicon form-control-feedback\", id: \"signupname_icon\", style: {left:\"220px\"}})), \n          React.createElement(\"div\", {className: \"form-group has-feedback\", id: \"signuppwd_form\"}, \n          React.createElement(\"label\", null), \n          React.createElement(\"input\", {ref: \"signup_pass\", type: \"password\", className: \"form-control control_size\", placeholder: \"Password\", onBlur: this.checkpwd}), React.createElement(\"br\", null), \n          React.createElement(\"span\", {className: \"glyphicon form-control-feedback\", id: \"signuppwd_icon\", style: {left:\"220px\",top:\"20px\"}})), \n          React.createElement(\"div\", {className: \"form-group has-feedback\", id: \"signupconfirmpwd_form\"}, \n          React.createElement(\"label\", {className: \" control-label\", id: \"confirm_error\", style: {color:\"red\"}}), \n          React.createElement(\"input\", {ref: \"confirm_signup_pass\", type: \"password\", className: \"form-control control_size\", placeholder: \"Confirm Password\", onChange: this.Confirmpwd}), React.createElement(\"br\", null), React.createElement(\"div\", null, \n          React.createElement(\"span\", {className: \"glyphicon form-control-feedback\", id: \"signupconfirmpwd_icon\", style: {left:\"220px\",top:\"20px\"}}))\n        ), \n        React.createElement(\"div\", {style: {width:\"260px\"}}, \n        React.createElement(\"div\", null, React.createElement(\"input\", {type: \"submit\", className: \"btn btn-success btn-block pull-left\", name: \"button\", id: \"button\", value: \"Confirm\", onClick: this.signup, style: {width:\"110px\"}})), \n        React.createElement(\"div\", null, React.createElement(\"button\", {className: \"btn btn-warning btn-block control_S-halfsize pull-right\", onClick: this.cancelsignup}, \"Cancel\"))\n        )\n        )\n        ))\n    )\n    );\n  }\n});\nmodule.exports=usersignup;"
  ]
}